\input texinfo   @c -*-texinfo-*-
@c %**start of header
@setfilename chinual2nd.info
@settitle Lisp Machine Manual
@c %**end of header

@ifnottex
@node Top
@top Lisp Machine Manual
@end ifnottex

@c DSK:LMMAN;TITLE 20

@titlepage
@center @titlefont{Lisp Machine Manual}

@sp 4
@center Second Preliminary Version

@sp 1
@center January 1979

@sp 5
@center Daniel Weinreb
@center David Moon

@sp 12
This report describes research done at the Artificial Intelligence Laboratory
of the Massachusetts Institute of Technology.  Support for the laboratory's artificial
intelligence research is provided in part by the Advanced Research Projects Agency
of the Department of Defense under Office of Naval Research Contract number N00014-75-C-0643.
@page

@vskip 0pt plus 1filll
@copyright{} Copyright by the Massachusetts Institute of Technology; Cambridge, Mass. 02139

All rights reserved.
@page

@sp 2
@center @titlefont{Preface}

This is a preliminary version of the Lisp Machine manual, describing
both the dialect of Lisp used by the Lisp Machine, and the software
environment of the Lisp Machine system.  Several chapters have
not been written, due to the early stage of the software they describe;
this includes chapters on Graphics, the Mouse, Menus, the Eine editor, the
network control program and higher level network programs, and the
file system.  Some of the chapters that are included describe software
that is still in a state of flux, and are likely to change drastically
in the next revision of this manual.
The authors also plan to produce a document describing
the internal formats of data objects and the instruction set of the
machine.

This version of the Lisp machine manual contains only minor editorial
corrections from the version of November, 1978.

Any comments, suggestions, or criticisms will be welcomed.
The authors can be reached by any of the following communication paths:

@sp 1
@verbatim
        ARPA Network mail to BUG-LMMAN@@MIT-AI

        U.S. Mail to
                Daniel L. Weinreb or David A. Moon
                545 Technology Square
                Cambridge, Mass. 02139

        MIT Multics mail to Weinreb.SIPB
@end verbatim

@sp 2
@center @titlefont{Note}

The software described herein was written by the Lisp Machine Group,
whose current members are Alan Bawden, Howard Cannon, Bruce Edwards,
Richard Greenblatt, Jack Holloway, Thomas Knight,
Michael McMahon, David Moon, Michael Patton,
Richard Stallman, and Daniel Weinreb.

@c ********************
This document was edited with the Emacs editor, and formatted
by the Bolio text justifier.  It was printed on the MIT A.I.
Lab's Xerox Graphic Printer.
@end titlepage

@c DSK:LMMAN;I.NTRO 28
@c This file is part of the Lisp Machine Manual.  -*-Text-*-
@c Introduction: The Manual, etc.   I.NTRO

@chapter Introduction

@section General Information

The Lisp Machine is a new computer system designed to provide
a high performance and economical implementation of the Lisp language.
It is a personal computation system, which means that processors and
main memories are not time-multiplexed: each person gets his own for
the duration of the session.  It is designed this way to relieve the
problems of the running of large Lisp programs on time-sharing
systems.  Everything on the Lisp Machine is written in Lisp, including
all system programs; there is never any need to program in machine
language.  The system is highly interactive.

@c This seems not to be true currently

This document is intended to serve both as a User's Guide and
as a Reference Manual for the language and the Lisp Machine itself.
It is hoped that anyone with some previous programming experience (not
necessarily in Lisp) could learn all about the Lisp language and the
Lisp Machine from this manual.

This is a @i{preliminary} version of the Manual.  The authors
are well aware that several sections are missing.  Some small sections
were left out in the interest of publishing a manual as quickly
as possible.  Several full chapters have not been written because the
corresponding software has not settled down enough for a meaningful
document to be written; these include chapters on the Chaos network,
the mouse, and menus.  Many more major software changes are expected
in both the language and the system; this manual is far from the last word.

The Lisp Machine executes a new dialect of Lisp called Lisp
Machine Lisp, developed at the M.I.T. Artificial Intelligence
Laboratory for use in artificial intelligence research and related
fields.  It is closely related to the Maclisp dialect, and attempts to
maintain a good degree of compatibility with Maclisp, while also
providing many improvements and new features.  Maclisp, in turn, is
based on Lisp 1.5.

@section Structure of the Manual

This manual attempts to document both the dialect of Lisp used
on the Lisp Machine, and the system itself.  The manual starts out with
an explanation of the language.  Chapter 2 presents some basic @i{predicate}
functions, Chapter 3 explains the process of evaluation, and Chapter 4
introduces the basic Lisp control structures.

Next, in Chapters 4 through 12, various Lisp data types are presented,
along with functions for manipulating objects of those types.  These nine
chapters discuss list structure, symbols, numbers, strings, arrays, closures,
stack groups, and locatives.

Chapter 13 explains the "subprimitive" functions, which are primarily
useful for implementation of the Lisp language itself and the Lisp Machine's
"operating system".  Chapter 14 explains @i{areas}, which give
the programmer control over storage and locality of reference.

Chapter 15 discusses the Lisp compiler, which converts Lisp programs
into "machine language".  Chapter 16 explains the Lisp macro facility, which
allows users to write their own extensions to Lisp, and Chapter 17 goes into
detail about one such extension that provides @i{structures}.

Chapter 18 explains the Lisp Machine's Input/Output system, including
@i{streams} and the @i{printed representation} of Lisp objects.  Chapter 19
describes the @i{package} system, which allows many name spaces within
a single Lisp environment.  Chapter 20 talks about how files from a file
system are used from Lisp.

Chapter 21 discusses the @i{job system}, which allows shared access
to the TV screen, and multiple processes.  Chapter 22 goes into detail on
the TV display itself.  Chapter 23 explains how exceptional conditions (errors)
can be handled by programs, handled by users, and debugged.  Chapter 24
contains other miscellaneous functions and facilities.

@section Notational Conventions and Helpful Notes

There are several conventions of notation, and various points
that should be understood before reading the manual, particularly the
reference sections, to avoid confusion.
@c The reference sections are the ONLY sections?

Most numbers shown are in octal radix (base eight).  Spelled out
numbers and numbers followed by a decimal point are in decimal.  This is
because, by default, Lisp Machine Lisp types out numbers in base 8; don't
be surprised by this.  To change it, see the documentation on the symbols
@code{ibase} and @code{base} ((ibase-var)).

The symbol " => " will be used to indicate evaluation in
examples.  Thus, when you see " @code{foo} => @code{nil}", this means the
same thing as "the result of evaluating @code{foo} is (or would have
been) @code{nil}".

All uses of the phrase "Lisp reader", unless further qualified,
refer to the part of Lisp which reads characters from I/O streams
(the @code{read} function), and not the person reading this manual.

There are several terms which are used widely in other
references on Lisp, but are not used much in this document since they have become
largely obsolete and misleading.  For the benefit of those who may
have seen them before, they are: "S-expression", which means a Lisp
object;  "Dotted pair", which means a cons, and "Atom", which means,
roughly, symbols and numbers and sometimes other things, but not
conses.
@cindex S-expression
@cindex dotted pair
@cindex atom

The characters acute accent (@code{'}) (also called "single quote") and
semicolon (@code{;}) have special meanings when typed to Lisp; they are
examples of what are called @i{macro characters}.  Though the
mechanism of macro characters is not of immediate interest to the new
user, it is important to understand the effect of these two, which are
used in the examples.

When the Lisp reader encounters a "@code{'}", it reads in the next
Lisp object and encloses it in a @code{quote} special form.  That
is, @code{'foo-symbol} turns into @code{(quote foo-symbol)}, and @code{'(cons 'a 'b)}
turns into @code{(quote (cons (quote a) (quote b)))}.  The reason
for this is that "@code{quote}" would otherwise have to be typed in very
frequently, and would look ugly.

The semicolon is used as a commenting character.  When the
Lisp reader sees one, the remainder of the line is
discarded.

The character "@code{/}" is used for quoting strange characters so
that they are not interpreted in their usual way by the Lisp reader,
but rather are treated the way normal alphabetic characters are treated.
So, for example, in order to give a "@code{/}" to the reader, you must type "@code{//}",
the first "@code{/}" quoting the second one.  When a character
is preceeded by a "@code{/}" it is said to be @i{slashified}.  Slashifying
also turns off the effects of macro characters such as "@code{'}" and "@code{;}".

The following characters also have special meanings,
and may not be used in symbols without slashification.  These characters
are explained in detail in the section on printed-representation
((reader)).

@table @code
@item "
String quote
@item #
Introduces miscellaneous reader macros
@item ,
See @code{`}
@item :
Package prefix
@item `
List structure construction
@item |
Symbol quoter
@item 
Octal escape
@end table

All Lisp code in this manual is written in lower case.
In fact, the reader turns all symbols into upper-case, and consequently
everything prints out in upper case.  You may write programs in whichever
case you prefer.

By convention, all "keyword" symbols in the Lisp machine system
have names starting with a colon (@code{:}).  The colon character is not
actually part of the print name, but is a package prefix indicating
that the symbol belongs to the package with a null name, which means
the @code{user} package.  If you are not using packages, that is, you are
doing everything in the @code{user} package, it is not necessary to type the
colon.  However, it is recommended that you always put in the colon so
that you will not have problems if you later put your program into a
package.  But it is necessary to leave out the colon in programs that
must run in both Maclisp and Lisp Machine Lisp.   The colon can usually
be omitted when you are simply typing at the top-level of Lisp, since
your typein is being read in the @code{user} package, but it is better to type
it so you will get used to it.  In this manual the colon will always
be included.

Lisp Machine Lisp is descended from Maclisp, and a good deal
of effort was gone through to try to allow Maclisp programs to run
in Lisp Machine Lisp.  There is an extensive section explaining the
differences between the dialects, and how to convert Maclisp programs
to work in the Lisp Machine.  For the new user, it is important
to note that many functions herein exist solely for Maclisp compatibility;
they should @i{not} be used in new programs.  Such functions are
clearly marked in the text.

The Lisp Machine character set is not quite the same as that used
on I.T.S. nor on Multics; it is described in all detail elsewhere
in the manual.  The important thing to note for now is that the
character "newline" is the same as "return", and is represented by
the number 215 octal.

When the text speaks of "typing Control-Q" (for example),
this means to hold down the CTRL key on the keyboard (either of
the two), and, while holding it down, to strike the "Q" key.
Similarly, to type "Meta-P", hold down either of the META keys
and strike "P".  To type "Control-Meta-T" hold down both CTRL
and META.  Unlike the PDP-10, there are no "control characters"
in the character set; Control and Meta are merely things
that can be typed on the keyboard.

Many of the functions refer to "areas".  The @i{area} feature
is only of interest to writers of large systems, and can be safely
disregarded by the casual user.  It is described elsewhere.

@c DSK:LMMAN;I.LISP 31
@c This file is part of the Lisp Machine Manual.  -*-Text-*-
@c Introduction: The Lisp Machine dialect, etc.   I.LISP

@page

The rest of this chapter explains more of the details of the Lisp Machine
Lisp dialect.  This section is also suitable for the Maclisp user, as
it goes into detail about important differences between the dialects.
Those Maclisp users who have skipped the previous sections should definitely
read this one.

@section Data Types

This section enumerates the various different types of objects
in Lisp Machine Lisp.  The types explained below include symbols, conses,
various types of numbers, two kinds of compiled code object, locatives,
arrays, stack groups, and closures.  With each is given the associated
symbolic name, which is returned by the function @code{data-type} ((data-type-fun)).

@cindex data-type
@cindex symbol
@cindex print name
@cindex binding
@cindex definition
@cindex property list

A @i{symbol} (these are sometimes called "atoms" or "atomic
symbols" by other texts) has a @i{print name}, a @i{binding}, a
@i{definition}, a @i{property list}, and a @i{package}.

The print name is a string, which may be obtained by the
function @code{get-pname} ((get-pname-fun)).
This string serves as the @i{printed representation}
(see (printer)) of the symbol.  The binding
(sometimes also called the "value") may be any object.  It is also
referred to sometimes as the "contents of the value cell", since
internally every symbol has a cell called the @i{value cell} which
holds the binding.  It is accessed by the @code{symeval}
function ((symeval-fun)), and updated by the @code{set} function ((set-fun)).
(That is, given a
symbol, you use @code{symeval} to find out what its binding is,
and use @code{set} to change its binding.)  The definition may
also be any Lisp object.  It is also referred to as the "contents of
the function cell", since internally every symbol has a cell called
the @i{function cell} which holds the definition.  The
definition can be accessed by the @code{fsymeval} function ((fsymeval-fun)), and updated
with @code{fset} ((fset-fun)).  The property list is a list of an even number of
elements; it can be accessed directly by @code{plist} ((plist-fun)), and updated
directly by @code{setplist} ((setplist-fun)), although usually the functions @code{get},
@code{putprop}, and @code{remprop} ((get-fun)) are used.
The property list is used to associate any number
of additional attributes with a symbol--attributes not used frequently enough
to deserve their cells as the value and definition do.
Symbols also have a package cell, which indicates which "package" of names
the symbol belongs to.  This is explained further in the section on packages
and can be disregarded by the casual user.

The primitive function for creating symbols is
@code{make-symbol} ((make-symbol-fun))
(currently named @code{make-atom}), although most symbols
are created by @code{read}, @code{intern}, or
@code{fasload} (who call @code{make-symbol} themselves.)

A @i{cons} is an object that cares about two
other objects, arbitrarily named the @i{car} and the @i{cdr}.
These objects can be accessed with @code{car} and @code{cdr} ((car-fun)), and updated
with @code{rplaca} and @code{rplacd} ((rplaca-fun)).  The primitive function for creating
conses is @code{cons} ((cons-fun)).

There are several kinds of numbers in Lisp Machine Lisp.
@i{Fixnums} represent integers in the range of -2^23 to 2^23-1.
@i{Bignums} represent integers of arbitrary size, with more overhead than fixnums.
The system automatically converts between fixnums and bignums as required.
@i{Flonums} are floating-point numbers.  @i{Small-flonums} are another
kind of floating-point numbers, with less range and precision, but less
computational overhead.
Other types of numbers are likely to be added in the future.
See (number) for full details.

@cindex fef
The usual form of compiled code is a Lisp object
called a "Function Entry Frame" or "FEF".  A FEF contains the code
for one function.  This is analogous to what Maclisp calls a "subr pointer".
FEFs are produced by the Lisp Compiler ((compiler)), and are usually found
as the definitions of symbols.  The printed representation of a FEF
includes its name, so that it can be identified.

Another Lisp object which represents executable code is
a "micro-code entry".
These are the microcoded primitive functions of the Lisp system,
and user functions compiled into microcode.

About the only useful thing to do with one of these objects
is to @i{apply} it to arguments.  However, some functions are
provided for examining such objects, for user convenience.  See
@code{arglist} ((arglist-fun)),
@code{args-info} ((args-info-fun)),
@code{describe} ((describe-fun)),
and @code{disassemble} ((disassemble-fun)).

A @i{locative} (see (locative)) is a kind of a pointer to a single cell
anywhere in the system.  The contents of this cell can be accessed by
either @code{car} or @code{cdr} (both do the same thing for a locative)
(see (car-fun))
and updated by either @code{rplaca} or @code{rplacd} (see (rplaca-fun)).

An @i{array} (see (array))
is a set of cells indexed by a tuple of integer subscripts.
The contents of cells may be accessed and changed individually.  There are several
types of arrays.  Some have cells which may contain any object, while others (numeric
arrays) may only contain small positive numbers.  Strings are a type of array;
the elements are 8-bit positive numbers which encode characters.

@section Lambda Lists
@cindex lambda lists

Note: the examples in this section are examples of lambda-lists,
not of Lisp forms!

A @i{lambda-expression} is the form of a user-defined function
in Lisp.  It looks like @code{(lambda @i{lambda-list} . @i{body})}.  The
@i{body} may be any number of forms.  In Maclisp and Lisp 1.5, the
@i{lambda-list} (also called a @i{bound-variable list}) is simply a
list of symbols (which act like @i{formal parameters} in some other
languages).  When the lambda-expression is @i{applied} to its
arguments (which act like @i{actual parameters} in other languages),
the symbols are bound to the arguments, and the forms of the body
are evaluated sequentially; the result of the last of these evaluations
is returned.  If the number of arguments is not the same as the
length of the lambda-list, an error is generated.

In Lisp Machine Lisp the same simple lambda-lists may be used,
but there are additional features accessible via certain keywords (which start
with @code{&}) and by using lists as elements of the lambda-list.

The principle weakness of the simple scheme is that any
function must only take a certain, fixed number of arguments.  As we
know, many very useful functions, such as @code{list}, @code{append}, @code{+},
and so on, may take a varying number of arguments.  Maclisp
solved this problem by the use of @i{lexpr}s and @i{lsubr}s, which
were somewhat inelegant since the parameters had to be referred to by
numbers instead of names (e.g. @code{(arg 3)}).  (For compatibility
reasons, Lisp Machine Lisp supports @i{lexpr}s, but they should not be
used in new programs).

In general, a function in Lisp Machine Lisp has zero or more
@i{required} parameters, followed by zero or more @i{optional}
parameters, followed by zero or one @i{rest} parameter.
This means that the caller must provide enough arguments so that each
of the required parameters gets bound, but he may provide some extra
arguments for each of the optional parameters.  Also, if there is a
rest parameter, he can provide as many extra arguments as he wants,
and the rest parameter will be bound to a list of all these extras.
Also, optional parameters may have a @i{default-form}, which is a
form to be evaluated to produce the default argument if none is supplied.

Here is the exact explanation of how this all works.  When
@code{apply} matches up the arguments with the parameters, it follows the
following algorithm:

The first required parameter is bound to the first
argument.  @code{apply} continues to bind successive required parameters
to the successive arguments.  If, during this process, there are no
arguments left but there are still some required parameters which have
not been bound yet, then an error is caused ("too few arguments").

Next, after all required parameters are handled, @code{apply}
continues with the optional parameters, binding each argument to each
successive parameter.  If, during this process, there are no arguments
left, each remaining optional parameter's default-form is evaluated,
and the parameter is bound to it.  This is done one parameter at a time;
that is, first one default-form is evaluated, and then the parameter is
bound to it, then the next default-form is evaluated, and so on.
This allows the default for an argument to depend on the previous argument.

Finally, if there is no rest parameter and there are no
remaining arguments, we are finished.  If there is no rest parameter
but there are still some arguments remaining, an error is caused ("too
many arguments").  But if there @i{is} a rest parameter, it is bound
to a list of all of the remaining arguments.  (If there are no
remaining arguments, it gets bound to @code{nil}.)

The way you express which parameters are required, optional,
and rest is by means of specially recognized symbols, which are called
@code{&-@i{keywords}}, in the lambda-list.  All such symbols' print names
begin with the character "@code{&}".  A list of all such symbols is the value of
the symbol @code{lambda-list-keywords}.

The keywords used here are @code{&optional} and @code{&rest}.
The way they are used is best explained by means of examples;
the following are typical lambda-lists, followed by descriptions
of which parameters are required, optional, and rest.

@table @code
@item (a b c)
@code{a}, @code{b}, and @code{c} are all required.  This function must be
passed three arguments.
@item (a b &optional c)
@code{a} and @code{b} are required, @code{c} is optional.  The function
may be passed either two or three arguments.
@item (&optional a b c)
@code{a}, @code{b}, and @code{c} are all optional.  The function may
be passed any number of arguments between zero and three, inclusively.
@item (&rest a)
@code{a} is a rest parameter.  The function may be passed any number of arguments.
@item (a b &optional c d &rest e)
@code{a} and @code{b} are required, @code{c} and @code{d} are optional,
and @code{e} is rest.  The function may be passed two or more arguments.
@end table

In all of the cases above, the @i{default-forms} for each parameter
were @code{nil}.  To specify your own default forms, instead
of putting a symbol as the element of a lambda-list, put in a list
whose first element is the symbol (the parameter itself) and
whose second element is the default-form.  For example:

@table @code
@item (a &optional (b 3))
The default-form for @code{b} is @code{3}.  @code{a} is a required parameter, and
so it doesn't have a default form.
@item (&optional (a 'foo) b (c (symeval a)) &rest d)
@code{a}'s default-form is @code{'foo}, @code{b}'s is @code{nil}, and @code{c}'s is
@code{(symeval a)}.  Note that if
the function whose lambda-list this is were called on no arguments,
@code{a} would be bound to the symbol @code{foo}, and @code{c} would be bound
to the binding of the symbol @code{foo}; this illustrates the fact
that each variable is bound immediately after its default-form is evaluated,
and so later default-forms may take advantage of earlier parameters
in the lambda-list.  @code{b} and @code{d} would be bound to @code{nil}.
@end table

It is also possible to include, in the lambda-list, some other
symbols which are bound to the values of their default-forms upon
entry to the function.  These are @i{not} parameters, and they are
never bound to arguments;  they are like "prog variables".

To include such symbols, put them after any parameters, preceeded
by the @code{&}-keyword @code{&aux}.  Examples:

@table @code
@item (a &optional b &rest c &aux d (e 5) (f (cons a e)))
@code{d}, @code{e}, and @code{f} are bound, when the function is
called, to @code{nil}, @code{5}, and a cons of the first argument and 5.
@end table

Note that aux-variables are bound sequentially rather than
in parallel.

It is important to realize that the list of arguments to which
a rest-parameter is bound is set up in whatever way is most efficiently
implemented, rather than in the way that is most convenient for the
function receiving the arguments.  It is guaranteed neither to be a "real" list, nor to be
a temporary object which may be freely modified.  Sometimes the rest-args list
is stored in the function-calling stack, and loses its validity when the
function returns; if a rest-argument is to be returned or made part
of permanent list-structure, it must first be copied (see @code{append}).
The system will not detect the error of omitting to copy a rest-argument;
you will simply find that you have a value which seems to change behind your back.

At other times the rest-args list will be an argument that was given to @code{apply};
therefore it is not safe to @code{rplaca} this list as you may modify permanent
data structure.  An attempt to @code{rplacd} a rest-args list will be unsafe
in this case, while in the first case it would cause an error.

@c DSK:LMMAN;FD.DTP 28
@c  This file is part of the Lisp Machine Manual.  -*-Text-*-
@c  Function Description: Data Type Predicates. >

@chapter Predicates
@cindex predicate

A @i{predicate} is a function which tests for some condition involving
its arguments and returns the symbol @code{t} if the condition is true, or
the symbol @code{nil} if it is not true.

By convention, the names of predicates usually end in the letter "p" (which
stands for "predicate").  (See [section on naming conventions]).
@cindex naming convention

The following predicates are for testing data types.  These predicates
return @code{t} if the argument is of the type indicated by the name of the function,
@code{nil} if it is of some other type.
@cindex data-type

@defun symbolp arg
@cindex symbol
@code{symbolp} returns @code{t} if its argument is a symbol, otherwise @code{nil}.
@end defun

@defun nsymbolp arg
@code{nsymbolp} returns @code{nil} if its argument is a symbol, otherwise @code{t}.
@end defun

@defun listp arg
@cindex cons
@code{listp} returns @code{t} if its argument is a cons, otherwise @code{nil}.
@code{(listp nil)} is @code{nil} even though @code{nil} is the empty list.
@end defun

@defun nlistp arg
@code{nlistp} returns @code{t} if its argument is anything besides a cons,
otherwise @code{nil}.
This is the recommended predicate for terminating iterations or recursions
on lists.  It is, in fact, identical to @code{atom}.
@end defun

@defun atom arg
@cindex atom
The predicate @code{atom} returns @code{t} if its argument is not a cons,
otherwise @code{nil}.
@end defun

@defun fixp arg
@code{fixp} returns @code{t} if its argument is a fixnum or a bignum, otherwise
@code{nil}.
@end defun

@defun floatp arg
@code{floatp} returns @code{t} if its argument is a flonum or a small flonum,
otherwise @code{nil}.
@end defun

@defun small-floatp arg
@code{small-floatp} returns @code{t} if @i{arg} is a small flonum, otherwise @code{nil}.
@end defun

@defun bigp arg
@code{bigp} returns @code{t} if @i{arg} is a bignum, otherwise @code{nil}.
@end defun

@defun numberp arg
@cindex number
@code{numberp} returns @code{t} if its argument is any kind of number,
otherwise @code{nil}.
@end defun

@defun stringp arg
@cindex string
@code{stringp} returns @code{t} if its argument is a string, otherwise @code{nil}.
@end defun

@defun arrayp arg
@cindex array
@code{arrayp} returns @code{t} if its argument is an array, otherwise @code{nil}.
Note that strings are arrays.
@end defun

@defun subrp arg
@code{subrp} returns @code{t} if its argument is any compiled code object,
otherwise @code{nil}.  The Lisp Machine system doesn't use the term "subr",
but the name of this function comes from Maclisp.
@end defun

@defun closurep arg
@cindex closure
@code{closurep} returns @code{t} if its argument is a closure, otherwise @code{nil}.
@end defun

@defun locativep arg
@cindex locative
@code{locativep} returns @code{t} if its argument is a locative, otherwise @code{nil}.
@end defun

@defun typep arg
@code{typep} is not really a predicate, but it is explained here because it is
used to determine the datatype of an object.  It returns a symbol describing the
type of its argument, one of the following:

@table @code
@item :symbol
A symbol.
@item :fixnum
A fixnum.
@item :flonum
A flonum.
@item :small-flonum
A small flonum.
@item :bignum
A bignum.
@item :list
A cons.
@item :string
A string.
@item :array
An array that is not a string.
@item :random
Any built-in data type that does not fit into one of the above categories.
@item @i{foo}
An object of user-defined data-type @i{foo} (any symbol).
See Named Structures, (named-structure).
@end table

See also @code{data-type}, (data-type-fun).
@end defun

@c DSK:LMMAN;FD.OP 23
@c This file is part of the Lisp Machine Manual.  -*-Text-*-
@c Function Description: Other Predicates.

The following functions are some other general purpose predicates.

@defun eq x y
@code{(eq @i{x y}) => t} if and only if @i{x} and @i{y} are the same object.
It should be noted that things that print the same are not necessarily @code{eq} to each other.
In particular, numbers with the same value
need not be @code{eq}, and two similar lists are usually not @code{eq}.
@cindex eq versus equal

@lisp
@exdent Examples:
(eq 'a 'b) => nil
(eq 'a 'a) => t
(eq (cons 'a 'b) (cons 'a 'b)) => nil
(setq x '(a . b)) (eq x x) => t
@end lisp

Note that in Lisp Machine Lisp equal fixnums are @code{eq}; this is not true in Maclisp.
Equality does not imply @code{eq}-ness for other types of numbers.
@end defun

@defmac neq x y
@code{(neq @i{x y})} = @code{(not (eq @i{x y}))}.  This is provided
simply as an abbreviation for typing convenience.
@end defmac

@defun equal x y
The @code{equal} predicate returns @code{t} if its arguments are similar
(isomorphic) objects. (cf. @code{eq})

@cindex eq versus equal
Two numbers are @code{equal} if they have the same value (a flonum
is never @code{equal} to a fixnum though).
Two strings are @code{equal} if they have the same length,
and the characters composing them are the same.  Alphabetic case is ignored.
For conses, @code{equal} is defined recursively as
the two @code{car}'s being @code{equal} and the two @code{cdr}'s being equal.
All other objects are @code{equal} if and only if they are @code{eq}.
Thus @code{equal} could have been defined by:

@lisp
(defun equal (x y)
       (or (eq x y)
           (and (numberp x) (numberp y) (= x y))
           (and (stringp x) (stringp y) (string-equal x y))
           (and (listp x)
                (listp y)
                (equal (car x) (car y))
                (equal (cdr x) (cdr y)))))
@end lisp

As a consequence of the above definition, it can be seen that
@code{equal} need not terminate when applied to looped list structure.
In addition, @code{eq} always implies @code{equal}; that is, if @code{(eq a b)}
then @code{(equal a b)}.  An intuitive definition of @code{equal} (which is
not quite correct) is that two objects are @code{equal} if they look the
same when printed out.  For example:

@lisp
(setq a '(1 2 3))
(setq b '(1 2 3))
(eq a b) => nil
(equal a b) => t
(equal "Foo" "foo") => t
@end lisp
@end defun

@defun not x
@defunx null x
@code{not} returns @code{t} if @i{x} is @code{nil}, else @code{nil}.
@code{null} is the same as @code{not}; both functions are included for the sake
of clarity.  Use @code{null} to check whether something is @code{nil}; use @code{not}
to invert the sense of a logical value.  Even though Lisp uses the symbol
@code{nil} to represent falseness, you shouldn't make understanding of your program
depend on this fortuitously.  For example, one often writes:

@lisp
(cond ((not (null lst)) ... )
      ( ... ))
@r{rather than}
(cond (lst ... )
      ( ... ))
@end lisp

There is no loss of efficiency, since these will compile into exactly
the same instructions.
@end defun

@c DSK:LMMAN;FD.EVA 42
@c This file is part of the Lisp Machine Manual.  -*-Text-*-
@c  Function Description: Evaluator >

@chapter Evaluation
@cindex evaluation

The following is a complete description of the actions taken by the
evaluator, given a @i{form} to evaluate.

If @i{form} is a number, the result is @i{form}.

If @i{form} is a string, the result is @i{form}.

If @i{form} is a symbol, the result is the binding
of @i{form}.  If @i{form} is unbound, an error is signalled.

If @i{form} is not any of the above types, and is not a list,
an error is signalled.

If @i{form} is a special form, indentified by a distinguished
symbol as its car, it is handled accordingly; each special form works
differently.  All of them are documented in this manual.

If @i{form} is not a special form, it calls for the @i{application}
of a function to @i{arguments}.  The @i{car} of the form is a function or
the name of a function.  The @i{cdr} of the form is a list of forms which
are evaluated to produce arguments, which are fed to the function.  Whatever
results the function @i{returns} is the value of the original @i{form}.

@c Someone should do this but I don't want to do it right now.
[Here there should be the rest of the moby description of evaluation and application,
particularly multiple values.  Explain the term "variables", also a very
brief bit about locals and specials (fluids and lexicals??).
The nature of functions should be revealed;
including compiled-code, interpreted-code, arrays, stack-groups, closures,
symbols.  Discuss macros.
Talk about function-calling in compiled code, how this is essentially
identical to the @code{apply} function, and no need for @code{(sstatus uuolinks)}
and the like.]

@section Functions and Special Forms

@defun eval x
@code{(eval @i{x})} evaluates @i{x}, and returns the result.

@lisp
@exdent Example:
(setq x 43 foo 'bar)
(eval (list 'cons x 'foo))
    => (43 . bar)
@end lisp

It is unusual to explicitly call @code{eval}, since usually
evaluation is done implicitly.  If you are writing a simple Lisp program and
explicitly calling @code{eval}, you are probably doing something wrong.
@code{eval} is primarily useful in programs which deal with Lisp itself,
rather than programs about knowledge or mathematics or games.

Also, if you are only interested in getting at the value of a
symbol (that is, the contents of the symbol's value cell), then you
should use the primitive function @code{symeval}.
@findex symeval

Note: the actual name of the compiled code for @code{eval} is "@code{si:*eval}";
this is because use of the @i{evalhook} feature binds the function cell of @code{eval}.
If you don't understand this, you can safely ignore it.
@cindex evalhook
@findex evalhook

Note: unlike Maclisp, @code{eval} never takes a second argument; there
are no "binding context pointers" in Lisp Machine Lisp.
They are replaced by Closures (see (closure)).
@end defun

@defun apply fn arglist
@code{(apply @i{fn arglist})} applies the function @i{fn} to the list of
arguments @i{arglist}.  @i{arglist} should be a list; @i{fn} can be a
compiled-code object, or a "lambda expression", i.e., a list whose @code{car}
is the symbol @code{lambda}, or a symbol, in which case its definition (the contents
of its function cell) is used.

@lisp
@exdent Examples:
(setq f '+) (apply f '(1 2)) => 3
(setq f '-) (apply f '(1 2)) => -1
(apply 'cons '((+ 2 3) 4)) =>
                ((+ 2 3) . 4)   @i{not} (5 . 4)
@end lisp

Of course, @i{arglist} may be @code{nil}.

Note: unlike Maclisp, @code{apply} never takes a third argument; there
are no "binding context pointers" in Lisp Machine Lisp.

Compare @code{apply} with @code{funcall} and @code{eval}.
@end defun

@defun funcall f &rest args
@code{(funcall @i{f a1 a2 ... an})} applies the function @i{f} to the arguments
@i{a1, a2, ..., an}.
@code{f} may not
be a special form nor a macro; this would not be meaningful.

@lisp
@exdent Example:
(cons 1 2) => (1 . 2)
(setq cons 'plus)
(funcall cons 1 2) => 3
@end lisp
@end defun

@defun lexpr-funcall f &rest args
@code{lexpr-funcall} is like a cross between @code{apply} and @code{funcall}.
@code{(lexpr-funcall @i{f a1 a2 ... an list})} applies the function @i{f}
to the arguments @i{a1} through @i{an} followed by the elements of
@i{list}.

@lisp
@exdent Examples:
(lexpr-funcall 'plus 1 1 1 '(1 1 1)) => 6

(defun report-error (&rest args)
   (lexpr-funcall (function format) error-output args))
@end lisp
@end defun

Note:  the Maclisp functions @code{subrcall}, @code{lsubrcall}, and @code{arraycall}
are not needed on the Lisp Machine; @code{funcall} is just as efficient.
@c  Are these provided anyway, though? NO.
@findex subrcall
@findex lsubrcall
@findex arraycall

@defspec quote
@cindex quote
@code{(quote @i{x})} simply returns @i{x}.  It is useful because it takes the
argument @i{quoted}, so that it is not evaluated by @code{eval}.  @code{quote} is used
to include constants in a form.

@lisp
@exdent Examples:
(quote x) => x
(setq x (quote (some list)))   x => (some list)
@end lisp

Since @code{quote} is so useful but somewhat cumbersome to type, the reader normally
converts any form preceded by a single quote (@code{'}) character into a @code{quote} form.

@lisp
@r{For example,}
(setq x '(some list))
@r{is converted by read into}
(setq x (quote (some list)))
@end lisp
@end defspec

@defspec function
@code{(function @i{x})} is similar to @code{quote}, except that it implies
to the compiler that @i{x} is a function.  In the interpreter, if @i{x} is a symbol
@code{(function @i{x})} returns @i{x}'s definition;
otherwise @i{x} itself is returned.
Because of this, using @code{function} rules out the possibility of later
changing the function definition of @i{x}, including tracing it.  Care is required!
@end defspec

@defspec comment
@code{comment} ignores its form and returns the symbol @code{comment}.

@lisp
@exdent Example:
(defun foo (x)
    (cond ((null x) 0)
          (t (comment x has something in it)
             (1+ (foo (cdr x))))))
@end lisp

Usually it is preferable to comment code using the
semicolon-macro feature of the standard input syntax.  This allows the
user to add comments to his code which are ignored by the lisp reader.

@lisp
@exdent Example:
(defun foo (x)
    (cond ((null x) 0)
          (t (1+ (foo (cdr x))))     ;x has something in it
      ))
@end lisp

A problem with such comments is that they are discarded when the S-expression
is read into lisp.  If the function is read into Lisp, modified, and printed
out again, the comment will be lost.  However, this style of operation is hardly
ever used; usually the source of a function is kept in an editor buffer and
any changes are made to the buffer, rather than the actual list structure
of the function.  Thus, this is not a real problem.
@end defspec

@defmac @@define
This macro turns into @code{nil}.  It exists for the sake of the
@@ listing generation program, which uses it to declare names of special forms
which define objects (such as functions) which @@ should cross-reference.
@end defmac

@defspec progn
A progn-form looks like @code{(progn @i{form1 form2 ...})}.
The @i{forms} are evaluated in order from left to right and the value
of the last one is the result of the progn.
@code{progn} is the primitive control structure construct for "compound
statements".  Although lambda-expressions, cond-forms, do-forms, and
many other control structure forms use @code{progn} implicitly, that is,
they allow multiple forms in their bodies, there are occasions when
one needs to evaluate a number of forms for their side-effects and
make them appear to be a single form.

@lisp
@exdent Example:
(foo (cdr a)
     (progn (setq b (extract frob))
            (car b))
     (cadr b))
@end lisp
@end defspec

@defspec prog1
@code{prog1} is similar to @code{progn}, but it returns the value of its @i{first} form.
It is most commonly used to evaluate an expression with side effects, and return
a value which must be computed @i{before} the side effects happen.

@lisp
@exdent Example:
(setq x (prog1 y (setq y x)))
@end lisp

which interchanges the values of the variables @i{x} and @i{y}.

@code{prog1} could have been defined as:

@lisp
(defun prog1 (&rest values)
    (car values))
@end lisp

It is actually implemented as a macro which expands into a @code{prog2}.
@end defspec

@defspec prog2
@code{prog2} is similar to @code{progn} and @code{prog1},
but it returns its @i{second} argument.
It is included largely for Maclisp compatibility.  It has two purposes: to evaluate
two forms sequentially, which can be done more generally with @code{progn}, or
to do what @code{prog1} is used for (c.f. @code{prog1} above).
@end defspec

@defspec let
@code{let} is used to bind some variables for some objects.
A @code{let} form looks like

@lisp
(let ((@i{var1} @i{vform1})
      (@i{var2} @i{vform2})
      ...)
  @i{bform1}
  @i{bform2}
  ...)
@end lisp

When this form is evaluated, first the @i{vform}s are evaluated.
Then the @i{var}s are bound to the values returned by the
corresponding  @i{vform}s.  Finally, the @i{bform}s are evaluated sequentially
and the result of the last one returned.

@code{let} is implemented as a macro which expands into a lambda-combination;
however, it is preferable
to use @code{let} rather than @code{lambda} because the variables and the corresponding forms
appear textually close to each other, which increases readability
of the program.
@end defspec

See also @code{let-globally}, (let-globally-fun).

@defspec progv
@code{progv} is a special form to provide the user with extra control
over lambda-binding.  It binds a list of symbols to a list of values,
and then evaluates some forms.  The lists of symbols and values
are computed quantities; this is what makes @code{progv} different from
@code{lambda}, @code{let}, @code{prog}, and @code{do}.

@lisp
(progv @i{symbol-list value-list form1 form2 }... )
@end lisp

first evaluates @i{symbol-list} and @i{value-list}.  Then the symbols
are bound to the values.  In compiled code the symbols must be @i{special},
since the compiler has no way of knowing what symbols might appear in the
@i{symbol-list}.  If too few values are supplied, the remaining symbols
are bound to @code{nil}.  If too many values are supplied, the
excess values are ignored.

After the symbols have been bound to the values, the @i{form}s are
evaluated, and finally the symbols' bindings are undone.
The result returned is the value of the last form.  Note that the
"body" of a @code{progv} is similar to that of @code{progn}, not that of @code{prog}.

@lisp
@exdent Example:
(setq a 'foo b 'bar)

(progv (list a b 'b) (list b) (list a b foo bar))
    => (foo nil bar nil)
@end lisp

During the evaluation of the body of this @code{progv}, @code{foo}
is bound to @code{bar}, @code{bar} is bound to @code{nil}, @code{b} is
bound to @code{nil}, and @code{a} remains bound to @code{foo}.
@end defspec

See also @code{bind} (see (bind-fun)), which is a
subprimitive which gives you maximal control over binding.

The following three functions (@code{arg}, @code{setarg}, and @code{listify})
exist only for compatibility with Maclisp @i{lexprs}.
@cindex lexpr

@defun arg x
@code{(arg nil)}, when evaluated during the application of
a lexpr, gives the number of arguments supplied to that
lexpr.
This is primarily a debugging aid, since lexprs also receive their number of arguments
as the value of their @code{lambda}-variable.

@code{(arg @i{i})}, when evaluated during the application of a lexpr, gives the value of the
@i{i}'th argument to the lexpr.  @i{i} must be a fixnum in this case. It is an error if @i{i} is less than 1 or greater than the number
of arguments supplied to the lexpr.

@lisp
@exdent Example:
(defun foo nargs            ;@r{define a lexpr }foo.
    (print (arg 2))         ;@r{print the second argument.}
    (+ (arg 1)              ;@r{return the sum of the first}
       (arg (- nargs 1))))  ;@r{and next to last arguments.}
@end lisp
@end defun

@defun setarg i x
@code{setarg} is used only during the application of a lexpr.
@code{(setarg @i{i x})} sets the
lexpr's @i{i}'th argument to @i{x}.
@i{i} must be greater than zero
and not greater than the number of arguments passed to the lexpr.
After @code{(setarg @i{i x})} has been done, @code{(arg @i{i})} will return @i{x}.
@end defun

@defun listify n
@code{(listify @i{n})} manufactures a list of @i{n} of the
arguments of a lexpr.  With a positive argument @i{n}, it returns a
list of the first @i{n} arguments of the lexpr.  With a negative
argument @i{n}, it returns a list of the last @code{(abs @i{n})}
arguments of the lexpr.  Basically, it works as if defined as follows:

@lisp
    (defun listify (n)
         (cond ((minusp n)
                (listify1 (arg nil) (+ (arg nil) n 1)))
               (t
                (listify1 n 1)) ))

    (defun listify1 (n m)      ;@r{ auxiliary function.}
         (do ((i n (1- i))
              (result nil (cons (arg i) result)))
             ((< i m) result) ))
@end lisp
@end defun

@section Multiple Values

The Lisp machine includes a facility by which the evaluation of a form
can produce more than one value.  When a function needs to return more
than one result to its caller, multiple values are a cleaner way of doing
this than returning a list of the values or @code{setq}'ing special variables
to the extra values.

In the normal case, multiple values are not used.  Special syntax is
required both to @i{produce} multiple values and to @i{receive} them.
If the caller does not receive multiple values, the first of the
multiple values will be received as the ordinary value.

The primitive for producing multiple values is @code{return}, which when
given more than one argument returns all its arguments as the values of
the @code{prog} or @code{do} from which it is returning.  The variant
@code{return-from} also can produce multiple values.  Many system functions
produce multiple values, but they all do it via the @code{return} primitive.
@c This could be phrased better. *******

The special forms for receiving multiple values are @code{multiple-value},
@code{multiple-value-list}, and @code{multiple-value-bind}.  These include
a form and an indication of where to put the values returned by that form.

@defspec multiple-value
@code{(multiple-value @i{var-list} @i{form})} is a special
form used for calling a function which
is expected to return more than one value.
@cindex multiple value
@cindex returning multiple values

@i{var-list} should be a list of variables.
@i{form} is evaluated, and the variables in @i{var-list}
will be @i{set} (not lambda-bound) to the values returned by @i{form}.  If more values
are returned than there are variables in @i{var-list}, then the extra values
are ignored.  If there are more variables than values returned,
extra values of @code{nil} are supplied.  It is allowed to have @code{nil}
in the @i{var-list}, which means that the corresponding value is to be
ignored (you can't use @code{nil} as a variable.)

@lisp
@exdent Example:
(multiple-value (symbol already-there-p)
        (intern "goo"))
@end lisp

@code{intern} returns a second value, which is @code{t} if the symbol returned as the
first value was already on the obarray, or else @code{nil} if it just put it there.
So if the symbol @code{goo} was already on the obarray, the variable @code{already-there-p}
will be set to @code{t}, else it will be set to @code{nil}.

@code{multiple-value} is usually used for effect rather than for value, however
its value is defined to be the first of the values returned by @i{form}.
@end defspec

@defspec multiple-value-bind
This is similar to @code{multiple-value}, but locally binds the variables which
receive the values, rather than @code{setq}ing them.  The form looks like:

@lisp
(multiple-value-bind (@i{var1 var2...})
     (@i{function} @i{args...})
  @i{body...})
@end lisp

The scope of the binding of @i{var1}, @i{var2}, etc. is @i{body}; they are
not bound until after the function call.
@end defspec

@defspec multiple-value-list
@code{(multiple-value-list @i{form})} evaluates @i{form}, and returns a list of
the values it returned.  This is useful for when you don't know how many values
to expect.

@lisp
@exdent Example:
(setq a (multiple-value-list (intern "goo")))
a => (goo nil #<Package User>)
@end lisp

This is similar to the example of @code{multiple-value} above; @code{a} will be set
to a list of three elements, the three values returned by @code{intern}.
The first is the newly interned symbol @code{goo}, the second is
@code{nil} to indicate that it is newly-interned, and the third is
the package on which it was interned.
@end defspec

Due to the syntactic structure of Lisp, it is often the case that the value
of a certain form is the value of a sub-form of it.  For example, the
value of a @code{cond} is the value of the last form in the selected clause.
In most such cases, if the sub-form produces multiple values, the original
form will also produce all of those values.  This @i{passing-back} of
multiple values of course has no effect unless eventually one of the
special forms for receiving multiple values is reached.
The exact rule governing passing-back of multiple values is as follows:

If @i{X} is a form, and @i{Y} is a sub-form of @i{X}, then if the value
of @i{Y} is unconditionally returned as the value of @i{X}, with no
intervening computation, then all the multiple values returned by @i{Y}
are returned by @i{X}.  In all other cases, multiple values or only
single values may be returned at the discretion of the implementation;
users should not depend on this.  The reason we don't guarantee
non-transmission of multiple values is because such a guarantee would
not be very useful and the efficiency cost of enforcing it would be
high.  Even @code{setq}'ing a variable to the result of a form, then
returning the value of that variable might be made to pass multiple
values by an optimizing compiler which realized that the @code{setq}ing of
the variable was unnecessary.

Note that use of a form as an argument to a function never passes-back
multiple values.  We choose not to generate several separate arguments
from the several values, because this would make the source code
obscure; it would not be syntactically obvious that a single form does
not coorrespond to a single argument.  Instead the first value of a
form is used as the argument and the remaining values are discarded.
Passing-back of multiple values happens only with special forms.
For clarity, the interaction of several common special forms with
multiple values is described.  This can all be deduced from the rule
given above.

The body of a @code{defun} or a @code{lambda}, and variations such as the
body of a function, the body of a @code{let}, etc. pass back multiple
values from the last form in the body.

@code{eval}, @code{apply}, @code{funcall}, @code{lexpr-funcall}, and @code{<-}
pass back multiple values from the function called.

@code{progn} passes back multiple values from its last form.
@code{progv} does so also.
@code{prog1} and @code{prog2} however do not pass back multiple values.

@code{and} and @code{or} pass back multiple values from their last form,
but not from previous forms since the return is conditional.

@code{cond} passes back multiple values from the last form in the
selected clause, but not if the clause is only one long (i.e. the
returned value is the value of the predicate) since the return is
conditional.  This applies even to the last clause where the return
is not really conditional (the implementation is allowed to pass
or not to pass multiple values in this case).

The variants of @code{cond}, @code{if}, @code{select}, @code{selectq}, and
@code{dispatch} pass back multiple values.

@code{prog} passes back the number of values given as arguments to
the @code{return} that returns from it.  @code{(return @i{form})}
may return 1 value or may return all the values of @i{form}; as always
the implementation is not constrained not to return extra values.
@code{(multiple-value-return @i{form})} returns from a @code{prog},
passing back all the values of @i{form}.

@code{do} behaves like @code{prog} with respect to @code{return}.
All the values of the last @i{exit-form} are returned.
[This is the "right" thing unless you think of the implementation
in terms of @code{return}; what should we do?] *******

@code{unwind-protect} does @i{not} pass back multiple values.
It clearly should, however this is currently difficult to implement.
This should be fixed later. *******

@section Evalhook

@defvar evalhook
If the value of @code{evalhook} is non-@code{nil}, then special things
happen in the evaluator.  When a form (even an atom) is to be evaluated,
@code{evalhook} is bound to @code{nil} and the function which
was @code{evalhook}'s value is applied to one argument--the form that was trying
to be evaluated.  The value it returns is then returned from the evaluator.
This feature is used by the @code{step} program (see (step-fun)).
@end defvar

@code{evalhook} is bound to @code{nil} by @code{break} and by
the error handler,
and @code{setq}'ed
to @code{nil} by errors that go back to top level and print @code{*}.
This provides the ability to escape from this mode if something bad
happens.

In order not to impair the efficiency of the Lisp interpreter,
several restrictions are imposed on @code{evalhook}.
It only applies to evaluation -- whether in a read-eval-print loop,
internally in evaluating arguments in forms, or by explicit use
of the function @code{eval}.  It @i{does not} have any effect
on compiled function references, on use of the function @code{apply},
or on the "mapping" functions.
(On the Lisp Machine, as opposed to Maclisp, it is not
necessary to do @code{(*rset t)} nor @code{(sstatus evalhook t)}.)
@c This is from the Maclisp manual, in case we ever support this feature.
@c Also, as a special case, the array reference which is the first
@c argument to @code{store} is never seen by the @code{evalhook} function;
@c however, the subexpressions of the array reference (the indices) will
@c be seen.  (This special treatment avoids a problem with the way @code{store}
@c works.)
(Also, Maclisp's special-case check for @code{store} is not implemented.)

@defun evalhook form hook
@code{evalhook} is a function which helps
exploit the @code{evalhook} feature.  The @i{form} is evaluated
with @code{evalhook} lambda-bound to the functional form @code{hook}.
The checking of @code{evalhook} is bypassed in the evaluation
of @i{form} itself, but not in any subsidiary evaluations,
for instance of arguments in the @i{form}.
This is like a "one-instruction proceed" in a machine-language
debugger.

@lisp
@exdent Example:
@r{;; This function evaluates a form while printing debugging information.}
(defun hook (x)
   (terpri)
   (evalhook x 'hook-function))

@r{;; Notice how this function calls @code{evalhook} to evaluate the form @code{f},}
@r{;; so as to hook the sub-forms.}
(defun hook-function (f)
   (let ((v (evalhook f 'hook-function)))
     (format t "form: ~s~%value: ~s~%" f v)
     v))
@end lisp

The following output might be seen from @code{(hook '(cons (car '(a . b)) 'c))}:

@lisp
form: (cons (car (quote (a . b))) (quote c))
form: (car (quote (a . b)))
form: (quote (a . b))
value: (a . b)
value: a
form: (quote c)
value: c
value: (a . c)

(a . c)
@end lisp
@end defun

@c DSK:LMMAN;FD.FLO 65
@c This file is part of the Lisp Machine Manual.  -*-Text-*-
@c Function Description: Flow of Control

@c All of the error stuff has been omitted for the time being, since it
@c is pretty variable.  Fix it up later.

@chapter Flow of Control
@cindex control structure
@cindex flow of control

Lisp provides a variety of structures for flow of control.

Function application is the basic method for construction of
programs.  Operations are written as the application of a function
to its arguments.  Usually, Lisp programs are written as a large collection
of small functions, each of which implements a simple operation.
These functions operate by calling one another, and so larger
operations are defined in terms of smaller ones.

@cindex recursion
A function may always call itself in Lisp.  The calling of
a function by itself is known as @i{recursion}; it is analogous
to mathematical induction.

@cindex iteration
The performing of an action repeatedly (usually with some
changes between repetitions) is called @i{iteration}, and is provided
as a basic control structure in most languages.  The @i{do} statement
of PL/I, the @i{for} statement of ALGOL/60, and so on are examples
of iteration primitives.  Lisp provides a general iteration facility
called @code{do}, which is explained below.

@cindex conditional
A @i{conditional} construct is one which allows a program
to make a decision, and do one thing or another based on some logical
condition.  Lisp provides @code{and} and @code{or}, which are simple
conditionals, and @code{cond}, which is a more general conditional.

@cindex non-local exit
@cindex exits
Non-local exits are similar to the @i{leave}, @i{exit}, and
@i{escape} constructs in many modern languages.
'c French, Italian, ...
They are similar to
a @i{return}, but are more general.  In Lisp, their scope is
determined at run-time.  They are implemented as the @code{catch} and
@code{*throw} functions.

Lisp Machine Lisp also provides a multiple-process or coroutine capability.
This is explained in the section on @i{stack-groups} ((stack-group)).

@section Conditionals

@defspec and
@code{(and @i{form1 form2} ... )} evaluates the @i{form}s one at a time,
from left to right.  If any @i{form} evaluates to @code{nil}, @code{and}
immediately returns @code{nil} without evaluating the remaining
@i{forms}.  If all the @i{forms} evaluate non-@code{nil}, @code{and} returns
the value of the last @i{form}.  @code{and} can be used both for logical operations,
where @code{nil} stands for @i{False} and @code{t} stands for @i{True}, and as a
conditional expression.

@lisp
@exdent Examples:
(and x y)

(and (setq temp (assq x y))
     (rplacd temp z))

(and (not error-p)
     (princ "There was no error."))
@end lisp

Note: @code{(and) => t}, which is the identity for this operation.
@end defspec

@defspec or
@code{(or @i{form1 form2} ...)} evaluates the @i{form}s one by one from left to right.
If a @i{form} evaluates to @code{nil}, @code{or} proceeds to evaluate the
next @i{form}.  If there are no more @i{form}s, @code{or} returns @code{nil}.
But if a @i{form} evaluates non-@code{nil}, @code{or} immediately returns
that value without evaluating any remaining @i{form}s.  @code{or} can
be used both for logical operations, where @code{nil} stands for False
and @code{t} for True, and as a conditional expression.

Note:  @code{(or) => nil}, the identity for this operation.
@end defspec

@defspec cond
The @code{cond} special form consists of the symbol @code{cond} followed by
several @i{clauses}.  Each clause consists of a @i{predicate} followed
by zero or more @i{forms}.  Sometimes the predicate is called the
@i{antecedent} and the forms are called the @i{consequents}.

@lisp
(cond (@i{antecedent consequent consequent}...)
      (@i{antecedent})
      (@i{antecedent consequent} ...)
      ... )
@end lisp

The idea is that each clause represents a case which
is selected if its antecedent is satisfied and the antecedents
of all preceding clauses were not satisfied.  When a clause
is selected, its consequent forms are evaluated.

@code{cond} processes its clauses in order from left to right.  First,
the antecedent of the current clause is evaluated.  If the result is
@code{nil}, @code{cond} advances to the next clause.  Otherwise, the cdr of
the clause is treated as a list of forms, or consequents, which are
evaluated in order from left to right.  After evaluating the
consequents, @code{cond} returns without inspecting any remaining
clauses.  The value of the @code{cond} special form is the value of the
last consequent evaluated, or the value of the antecedent if there
were no consequents in the clause.  If @code{cond} runs out of clauses,
that is, if every antecedent is @code{nil}, that is, if no case is
selected, the value of the @code{cond} is @code{nil}.

@lisp
@exdent Example:
    (cond ((zerop x)    ;@r{First clause:}
           (+ y 3))     ; (zerop x)@r{ is the antecedent.}
                        ; (+ y 3)@r{ is the consequent.}
          ((null y)     ;@r{A clause with 2 consequents:}
           (setq y 4)   ;@r{ this}
           (cons x z))  ;@r{ and this.}
          (z)           ;@r{A clause with no consequents:}
                        ;@r{ the antecedent is just z.}
          (t            ;@r{An antecedent of }t
           105)         ;@r{ is always satisfied.}
       )                ;@r{This is the end of the cond.}
@end lisp
@end defspec

@defmac if
@code{if} allows a simple "if-then-else" conditional to
be expressed as @code{(if @i{pred-form} @i{then-form} @i{else-form})}.
@code{if} is provided for stylistic reasons; some people think
it looks nicer than @code{cond} for the simple case it handles.
@code{(if @i{x y z})} expands into @code{(cond (@i{x} @i{y}) (t @i{z}))}.
@end defmac

@defmac selectq
Many programs require @code{cond} forms which check various
specific values of a form.

@lisp
@r{A typical example:}
(cond ((eq x 'foo) ...)
      ((eq x 'bar) ...)
      ((memq x '(baz quux mum)) ...)
      (t ...))
@end lisp

The @code{selectq} macro can be used for such tests.
Its form is as follows:

@lisp
(selectq @i{key-form}
         (@i{pattern consequent consequent} ...)
         (@i{pattern consequent consequent} ...)
         (@i{pattern consequent consequent} ...)
         ...)
@end lisp

Its first "argument" is a form, which is evaluated (only once) as the
first thing @code{selectq} does.  The resulting value is called the @i{key}.  It is
followed by any number of @i{clauses}.  The @code{car} of each clause is
compared with the key, and if it matches, the consequents of this
clause are evaluated, and @code{selectq} returns the value of the last
consequent.  If there are no matches, @code{selectq} returns @code{nil}.
Note that the patterns are @i{not} evaluated; if you want them to
be evaluated use @code{select} rather than @code{selectq}.

A @i{pattern} may be any of:

@table @r
@item 1) A symbol
If the @i{key} is @code{eq} to the symbol, it matches.
@item 2) A number
If the @i{key} is @code{eq} to the number, it matches.
Only small numbers (@i{fixnums}) will work.
@item 3) A list
If the @i{key} is @code{eq} to one of the elements of the list,
then it matches.  The elements of the list should be symbols
or fixnums.
@item 4) @code{t} or @code{otherwise}
The symbols @code{t} and @code{otherwise} are special keywords which match anything.
Either symbol may be used, it makes no difference.
@code{t} is accepted for compatibility with Maclisp's @code{caseq} construct.
@end table

@lisp
@exdent Example:
(selectq x              ;@r{This is the same as the @code{cond} example}
         (foo ...)      ;@r{ above.}
         (bar ...)
         ((baz quux mum) ...)
         (otherwise ...))
@end lisp
@end defmac

@defmac select
@code{select} is the same as @code{selectq}, except that the elements of the
patterns are evaluated before they are used.

@lisp
@exdent Example:
(select (frob x)
   (foo 1)
   ((bar baz) 2)
   (otherwise 3))
@r{is equivalent to}
(let ((var (frob x)))
  (cond ((eq var foo) 1)
        ((or (eq var bar) (eq var baz)) 2)
        (t 3)))
@end lisp
@end defmac

@defmac selector
@code{selector} is the same as @code{select}, except that you get to specify the function
used for the comparison instead of @code{eq}.  For example,

@lisp
(selector (frob x) equal
   (('(one . two)) (frob-one x))
   (('(three . four)) (frob-three x))
   (otherwise (frob-any x)))
@end lisp
@end defmac

@defmac dispatch
@code{(dispatch @i{byte-specifier} @i{n} @i{clauses...})} is the same
as @code{select} (not @code{selectq}), but the key is obtained by evaluating
@code{(ldb @i{byte-specifier n})}.
@findex ldb
@i{byte-specifier} and @i{n} are both evaluated.

@lisp
@exdent Example:
(princ (dispatch 0202 cat-type
           (0 "Siamese.")
           (1 "Persian.")
           (2 "Alley.")
           (3 (ferror nil
                      "~S is not a known cat type."
                      cat-type))))
@end lisp

@c This example borrowed from DuMouchel.CatData
It is not necessary to include all possible values of the byte which
will be dispatched on.
[This function may get flushed.]
@end defmac

@section Iteration
@cindex iteration

@defspec prog
@code{prog} is a special form which provides temporary variables,
sequential evaluation of forms, and a "goto" facility.  A typical @code{prog}
looks like:

@lisp
(prog (@i{var1 var2} (@i{var3 init3}) @i{var4} (@i{var5 init5}))
 @i{tag1}
     @i{statement1}
     @i{statement2}
 @i{tag2}
     @i{statement2}
     . . .
    )
@end lisp

@i{var1, var2, ...} are temporary variables.  When the @code{prog} is entered, the
values of these variables are saved.  When the @code{prog} is finished,
the saved values are restored.  The initial value of a variable inside
the @code{prog} depends on whether the variable had an associated @i{init}
form or not; if it did, then the @i{init} form is evaluated and becomes
the initial value of the corresponding variable.  If there was no @i{init} form,
the variable is initialized to @code{nil}.

@lisp
@exdent Example:
(prog ((a t)  b  (c 5)  (d (car '(zz . pp))))
      @i{<body>}
      )
@end lisp

The initial value of @code{a} is @code{t}, that of @code{b} is @code{nil}, that of @code{c} is
the fixnum 5, and that of @code{d} is the symbol @code{zz}.
The binding and initialization of the variables is done in
@i{parallel}; that is,
all the initial values are computed before any of the variables are changed.

The part of a @code{prog} after the variable list is called the @i{body}.
An item in the body may be a symbol or a number, in which case it is called a
@i{tag}, or some other form (i.e. a list), in which case it is called a
@i{statement}.

After @code{prog} binds the temporary variables, it processes each form
in its body sequentially.  @i{tags} are skipped over.  @i{Statements}
are evaluated, and their returned values discarded.  If the end of the body
is reached, the @code{prog} returns @code{nil}.  However, two special forms
may be used in @code{prog} bodies to alter the flow of control.
If @code{(return @i{x})} is evaluated,
@code{prog} stops processing its body, evaluates @i{x}, and returns the result.
If @code{(go @i{tag})} is evaluated, @code{prog} jumps to the part of the body
labelled with the @i{tag}.  @i{tag} is not evaluated.
The "computed-@code{go}" (mis)feature of Maclisp is not supported.

The compiler requires that @code{go} and @code{return} forms be
@i{lexically} within the scope of the @code{prog}; it is not possible for
one function to @code{return} to a @code{prog} which is in progress in its
caller.  This restriction happens not to be enforced in the interpreter.
Thus, a program which contains a @code{go} which is not
contained within the body of a @code{prog} (or a @code{do}, see below)
cannot be compiled.  Since virtually all programs will be compiled
at some time, the restriction should be adhered to.

Sometimes code which is lexically within more than one @code{prog}
(or @code{do}) form wants to @code{return} from one of the outer @code{prog}s.
However, the @code{return} function normally returns from the innermost
@code{prog}.  In order to make @code{return}ing from outer @code{prog}s more
convenient, a @code{prog} may be given a @i{name} by which it may be
referenced by a function called @code{return-from}, which is similar to
@code{return} but allows a particular @code{prog} to be specified.
If the first subform of a @code{prog} is a non-@code{nil} symbol
(rather than a variable list), it is the name of the @code{prog}.
See the description of the @code{return-from} special form,
on (return-from-fun).

@lisp
@exdent Example:
(prog george (a b d)
      (prog (c b)
            ...
            (return-from george (cons b d))
            ...))
@end lisp

If the symbol @code{t} is used as the name
of a @code{prog}, then it will be made "invisible" to @code{return}s;
@code{return}s inside that @code{prog} will return to the next outermost level
whose name is not @code{t}.  @code{(return-from t ...)} will return
from a @code{prog} named @code{t}.

See also the @code{do} special form, which uses a body similar to
@code{prog}. The @code{do}, @code{*catch}, and @code{*throw} special forms are
included in Lisp Machine Lisp as an attempt to encourage goto-less programming
style, which often leads to more readable, more easily maintained code.  The
programmer is recommended to use these functions instead of @code{prog}
wherever reasonable.

@lisp
@exdent Example:
(prog (x y z)  ;x, y, z @r{are prog variables  - temporaries.}
   (setq y (car w) z (cdr w))     ;w@r{ is a free variable.}
loop
   (cond ((null y) (return x))
         ((null z) (go err)))
rejoin
   (setq x (cons (cons (car y) (car z))
                 x))
   (setq y (cdr y)
         z (cdr z))
   (go loop)
err
   (break are-you-sure? t)
   (setq z y)
   (go rejoin))
@end lisp
@end defspec

@defspec prog*
The @code{prog*} special form is almost the same as @code{prog}.  The only
difference is that the binding and initialization of the temporary
variables is done @i{sequentially}, so each one can depend on the
previous ones.  For example,

@lisp
(prog ((y z) (x y)) (return x))
@end lisp

returns the value of @code{z}.
@end defspec

@defspec do
The @code{do} special form provides a generalized iteration facility,
with an arbitrary number of "index variables" whose values are saved
when the @code{do} is entered and restored when it is left, i.e. they are
bound by the @code{do}.  The index variables are used in the iteration
performed by @code{do}.  At the beginning, they are initialized to
specified values, and then at the end of each trip around the loop the
values of the index variables are changed according to specified
rules.  @code{do} allows the programmer to specify a predicate which
determines when the iteration will terminate.  The value to be
returned as the result of the form may, optionally, be specified.

@code{do} comes in two varieties.

The newer variety of
@code{do} looks like:

@lisp
(do ((@i{var init repeat})...)
    (@i{end-test exit-form}...)
    @i{body}...)
@end lisp

The first item in the form is a list of zero or more index variable
specifiers.  Each index variable specifier is a list of the name of a
variable @i{var}, an initial value @i{init}, which defaults to @code{nil}
if it is omitted, and a repeat value @i{repeat}.  If @i{repeat} is
omitted, the @i{var} is not changed between repetitions.

In index variable specifier can also be just the name of a variable.
In this case, the variable has an initial value of @code{nil}, and is
not changed between repetitions.

All assignment to the index variables is done in parallel.  At the
beginning of the first iteration, all the @i{init}s are evaluated,
then the @i{var}s are saved, then the @i{var}s are @i{set} to the
values of the @i{init}s.  To put it another way, the @i{var}s are
@code{lambda}-bound to the values of the @i{init}s.  Note that the
@i{init}s are evaluated @i{before} the @i{var}s are bound, i.e.
lexically @i{outside} of the @code{do}.
At the beginning of each succeeding iteration those @i{var}s that have
@i{repeat}s get @code{setq}'ed to the values of their respective
@i{repeat}s.  Note that all the @i{repeat}s are evaluated before any
of the @i{var}s is changed.

The second element of the @code{do}-form is a list of an end-testing
predicate @i{end-test}, and zero or more forms, called the
@i{exit-form}s.  At the beginning of each iteration, after processing
of the @i{repeat}s, the @i{end-test} is evaluated.  If the result is
@code{nil}, execution proceeds with the body of the @code{do}.  If the
result is not @code{nil}, the @i{exit-forms} are evaluated from left to
right and then @code{do} returns.  The value of the @code{do} is the value
of the last @i{exit-form}, or @code{nil} (@i{not} the value of the
@i{end-test} as you might expect) if there were no @i{exit-form}s.
Note that the second element of the @code{do}-form resembles a @code{cond}
clause.

If the second element of the form is @code{nil}, there is no @i{end-test}
nor @i{exit-form}s, and the @i{body} of the @code{do} is executed only
once.  In this type of @code{do} it is an error to have @i{repeat}s.
This type of @code{do} is a "@code{prog} with initial values."

If the second element of the form is @code{(nil)}, the @i{end-test} is never
true and there are no @i{exit-form}s.  The @i{body} of the @code{do}
is executed over and over.
The infinite loop can be terminated by use of @code{return} or @code{*throw}.

The remainder of the @code{do}-form constitutes a @code{prog}-body; that is,
@code{go}'s and @code{return} forms are understood within the @code{do} body,
as if it were a @code{prog} body.  When the end of the body is reached,
the next iteration of the @code{do} begins.  If a @code{return} form is evaluated,
@code{do} returns the indicated value and no more iterations occur.

The older variety of @code{do} is:

@lisp
(do @i{var} @i{init} @i{repeat} @i{end-test} @i{body}...)
@end lisp

The first time through the loop @i{var} gets the value of @i{init};
the remaining times through the loop it gets the value of @i{repeat},
which is re-evaluated each time.  Note that @i{init} is evaluated
before the value of @i{var} is saved, i.e. lexically @i{outside} of the @code{do}.
Each time around the loop, after @i{var} is set,
@i{end-test} is evaluated.  If it is non-@code{nil}, the @code{do} finishes
and returns @code{nil}.  If the @i{end-test} evaluated to @code{nil}, the @i{body} of
the loop is executed.  The @i{body} is like a @code{prog} body.  @code{go}
may be used.  If @code{return} is used, its argument is the value of the
@code{do}.  If the end of the @code{prog} body is reached, another loop
begins.

@lisp
@exdent Examples of the older variety of @code{do}:
(setq n (array-length foo-array))
(do i 0 (1+ i) (= i n)
  (aset 0 foo-array i))         @r{;zeroes out the array foo-array}

(do zz x (cdr zz) (or (null zz)
                      (zerop (f (car zz)))))
                   @r{; this applies f to each element of x
                   ; continuously until f returns zero.
                   ; Note that the @code{do} has no body.}

@r{@code{return} forms are often useful to do simple searches:}

(do i 0 (1+ i) (= i n)  @r{; Iterate over the length of @code{foo-array}.}
  (and (= (aref foo-array i) 5) @r{; If we find an element which
                                ;equals @code{5},}
       (return i)))     @r{;  then return its index.}

@end lisp

@lisp
@exdent Examples of the new form of @code{do}:
(do ((i 0 (1+ i))       @r{; This is just the same as the above example,}
     (n (array-length foo-array)))
    ((= i n))           @r{; but written as a new-style @code{do}.}
  (aset 0 foo-array i))

(do ((z list (cdr z)) @r{; z starts as @code{list} and is @i{cdr}'ed each time.}
     (y other-list)   @r{; y starts as @code{other-list}, and is unchanged by the do.}
     (x))             @r{; x starts as @code{nil} and is not changed by the @code{do}.}
    (nil)             @r{; The end-test is @code{nil}, so this is an infinite loop.}
  @i{body})

(do ((x) (y) (z)) (nil) @i{body})

@r{is like}

(prog (x y z) @i{body})
@r{except that when it runs off the end of the @i{body},
@code{do} loops but @code{prog} returns @code{nil}.

On the other hand,}

     (do ((x) (y) (z)) nil @i{body})

@r{is identical to the @code{prog} above (it does not loop.)}
@end lisp

The construction

@lisp
(do ((x e (cdr x))
     (oldx x x))
    ((null x))
  @i{body})
@end lisp

exploits parallel assignment to index variables.  On the first
iteration, the value of @code{oldx} is whatever value @code{x} had before
the @code{do} was entered.  On succeeding iterations, @code{oldx} contains
the value that @code{x} had on the previous iteration.

In either form of @code{do}, the @i{body} may contain no forms at all.
Very often an iterative algorithm can be most clearly expressed entirely
in the @i{repeats} and @i{exit-forms} of a new-style @code{do},
and the @i{body} is empty.

@lisp
(do ((x x (cdr x))
     (y y (cdr y))
     (z nil (cons (f x y) z))) ;@r{exploits parallel}
    ((or (null x) (null y))    ;@r{ assignment.}
     (nreverse z))             ;@r{typical use of }nreverse.
    )                          ;@r{no @code{do}-body required.}

@r{is like} (maplist 'f x y).
@end lisp
@end defspec

@defspec do-named
@code{do-named} is just like @code{do} except that its first subform
is a symbol, which is interpreted as the @i{name} of the @code{do}.
The @code{return-from} special form allows a @code{return} from
a particular @code{prog} or @code{do-named} when several are nested.
See the description of such names in the explanation of the @code{prog}
special form on (prog-fun), and that of @code{return-from} on (return-from-fun).
@end defspec

@defspec dotimes
@code{dotimes} is a convenient abbreviation for the most common integer iteration.
@code{(dotimes (@i{index} @i{count}) @i{body...})} performs @i{body}
the number of times given by the value of @i{count}, with @i{index} bound
to @code{0}, @code{1}, etc. on successive iterations.

@lisp
@exdent Example:
(dotimes (i (// m n)
  (frob i))
@exdent @r{is equivalent to:}
(do ((i 0 (1+ i))
     (count (// m n)))
    (( i count))
  (frob i))
@exdent @r{except that the name @code{count} is not used.}
@end lisp
@end defspec

@defspec dolist
@code{dolist} is a convenient abbreviation for the most common list iteration.
@code{(dolist (@i{item} @i{list}) @i{body...})} performs @i{body}
once for each element in the list which is the value of @i{list}, with
@i{item} bound to the successive elements.

@lisp
@exdent Example:
(dolist (item (frobs foo))
  (mung item))
@exdent @r{is equivalent to:}
(do ((lst (frobs foo) (cdr lst))
     (item))
    ((null lst))
  (setq item (car lst))
  (mung item))
@exdent @r{except that the name @code{lst} is not used.}
@end lisp
@end defspec

@defspec go
The @code{(go @i{tag})} special form is used to do a "go-to" within the
body of a @code{do} or a @code{prog}.  The @i{tag} must be a symbol.
It is not evaluated. @code{go} transfers control to the point in the body labelled by a
tag @code{eq} to the one given.  If there is no such tag in the body, the
bodies of lexically containing @code{prog}s and @code{do}s (if any) are examined as well.
If no tag is found, an error is signalled.

Note that the @code{go} form is a very special form: it does not ever
return a value.  A @code{go} form may not appear as an argument to a regular
function, but only at the top level of a @code{prog} or @code{do},
or within certain special forms such as conditionals which are within
a @code{prog} or @code{do}.
A @code{go} as an argument to a regular function would be not only useless but
possibly meaningless.  The compiler does not bother to know how to compile it
correctly.  @code{return} and @code{*throw} are similar.

@lisp
@exdent Example:
(prog (x y z)
  (setq x @i{some frob})
loop
  @i{do something}
  (and @i{some predicate} (go endtag))
  @i{do something more}
  (and (minusp x) (go loop))
endtag
  (return z))
@end lisp
@end defspec

@defun return arg
@code{return} is used to return from a @code{prog} or a @code{do}.  The value
of @code{return}'s argument is returned by @code{prog} or @code{do} as its
value.  In addition, @code{break} recognizes the typed-in S-expression
@code{(return @i{value})} specially.  If this form is typed at a
@code{break}, @i{value} will be evaluated and returned as the value of
@code{break}.  If not at the top level of a form typed at a @code{break},
and not inside a @code{prog} or @code{do}, @code{return} will cause an
error.
@c  Does our BREAK hack this yet?

@lisp
@exdent Example:
(do ((x x (cdr x))
     (n 0 (* n 2)))
    ((null x) n)
 (cond ((atom (car x))
        (setq n (1+ n)))
       ((memq (caar x) '(sys boom bleah))
        (return n))))
@end lisp

@code{return} is, like @code{go}, a special form which does not return a value.

@code{return} can also be used to return multiple values from a @code{prog} or
@code{do}, by giving it multiple arguments.  For example,

@lisp
(defun assqn (x table)
  (do ((l table (cdr l))
       (n 0 (1+ n)))
      ((null l) nil)
    (and (eq (caar l) x)
         (return (car l) n))))
@end lisp

This function is like @code{assq}, but it returns an additional value
which is the index in the table of the entry it found.
See the special forms @code{multiple-value} ((multiple-value-fun))
and @code{multiple-value-list} ((multiple-value-list-fun)).
@end defun

@defspec return-from
A @code{return-from} form looks like @code{(return-from @i{name form1 form2 form3})}.
The @i{form}s are evaluated sequentially, and then are returned
from the innermost containing @code{prog} or @code{do-named} whose name
is @i{name}.  See the description of @code{prog} ((prog-fun)) in which
named @code{prog}s and @code{do}s are explained, and that of @code{do-named} ((do-named-fun)).
@end defspec

@defun return-list list
@i{list} must not be @code{nil}.  This function is like @code{return} except
that the @code{prog} returns all of the elements of @i{list}; if
@i{list} has more then one element, the @code{prog} does a multiple-value
return.
@c What is this good for?

To direct the returned values to a @code{prog} or @code{do-named} of a specific
name, use @code{(return-from @i{name} (return-list @i{list}))}.
@end defun

@defspec multiple-value-return
@code{(multiple-value-return (@i{function} @i{arg1} @i{arg2} ...))}
applies the function to the arguments, and returns from the current @code{prog} or @code{do}
with the same values as @i{function} returns.
@end defspec

@defmac defunp
Usually when a function uses @code{prog}, the @code{prog} form is
the entire body of the function; the definition of such a function
looks like @code{(defun @i{name} @i{arglist} (prog @i{varlist} ...))}.
For convenience, the @code{defunp} macro can be used to produce such definitions.
A @code{defunp} form expands as follows:

@lisp
(defunp fctn (args)
    form1
    form2
    ...
    formn)
@end lisp

expands into

@lisp
(defun fctn (args)
  (prog nil
        form1
        form2
        ...
        (return formn)))
@end lisp
@end defmac

@section Non-local Exits
@cindex non-local exit
@cindex catch
@cindex throw

@defun *catch tag form
@code{*catch} is the Lisp Machine Lisp function for doing structured
non-local exits.  @code{(*catch @i{tag form})} evaluates @i{form} and
returns its value, except that if, during the evaluation of @i{form},
@code{(*throw @i{tag y})} should be evaluated, @code{*catch} immediately returns
@i{y} without further evaluating @i{x}.  Note that the @i{form} argument
is @i{not} evaluated twice; the special action of @code{*catch} happens
during the evaluation of its arguments, not during the execution of @code{*catch}
itself.

The @i{tag}'s are used to match up @code{*throw}'s with @code{*catch}'s.
@code{(*catch 'foo @i{form})} will catch a @code{(*throw 'foo @i{form})} but
not a @code{(*throw 'bar @i{form})}.  It is an error if @code{*throw} is done
when there is no suitable @code{*catch} (or @code{catch-all}; see below).

The values @code{t} and @code{nil} for @i{tag} are special and mean that all
throws are to be caught.  These are used by @code{unwind-protect} and @code{catch-all}
respectively.  The only difference between @code{t} and @code{nil} is in the
error checking; @code{t} implies that after a "cleanup handler" is executed
control will be thrown again to the same tag, therefore it is an error if a specific
catch for this tag does not exist higher up in the stack.

@code{*catch} returns up to four values; trailing null values are not
returned for reasons of microcode simplicity, however the values not
returned will default to @code{nil} if they are received with the
@code{multiple-value} special form.
If the catch completes normally,
the first value is the value of @i{form} and the second is @code{nil}.
If a @code{*throw} occurs, the first value is the second argument to
@code{*throw}, and the second value is the first argument to @code{*throw},
the tag thrown to.  The third and fourth values are the third and fourth
arguments to @code{*unwind-stack} if that was used in place of @code{*throw},
otherwise @code{nil}.
To summarize, the four values returned by @code{*catch} are the value,
the tag, the active-frame-count, and the action.

@lisp
@exdent Example
(*catch 'negative
        (mapcar (function (lambda (x)
                            (cond ((minusp x)
                                   (*throw 'negative x))
                                  (t (f x)) )))
               y)
     )
@end lisp

which returns a list of @code{f} of each element of @code{y} if they are all
positive, otherwise the first negative member of @code{y}.

Note: The Lisp Machine Lisp functions @code{*catch} and @code{*throw} are
improved versions of the Maclisp functions @code{catch} and @code{throw}.
The Maclisp ones are similar in purpose, but take their arguments in
reversed order, do not evaluate the @i{tag}, and may be used in an older form
in which no @i{tag} is supplied.  Compatibility macros are supplied so
that programs using the Maclisp functions will work.
@end defun

@defun *throw tag value
@code{*throw} is used with @code{*catch} as a structured non-local exit mechanism.

@code{(*throw @i{tag x})} throws the value of @i{x} back to the most recent @code{*catch}
labelled with @i{tag} or @code{t} or @code{nil}.  Other @code{*catches} are skipped over.
Both @i{x} and @i{tag} are evaluated, unlike the Maclisp @code{throw} function.

The values @code{t} and @code{nil} for @i{tag} are reserved.  @code{nil} may not
be used, because it would cause an ambiguity in the returned values of @code{*catch}.
@code{t} invokes a special feature whereby the entire stack is unwound, and then
a coroutine transfer to the invoking stack-group is done.  During this process
@code{unwind-protect}s receive control, but @code{catch-all}s do not.  This feature
is provided for the benefit of system programs which want to completely unwind a stack.
It leaves the stack-group in a somewhat inconsistent state; it is best to
do a @code{stack-group-preset} immediately afterwards.

See the description of @code{*catch} for further details.
@end defun

@defmac catch
@defmacx throw
@code{catch} and @code{throw} are provided only for Maclisp compatibility.
They expand as follows:

@lisp
(catch @i{form} @i{tag}) ==> (*catch (quote @i{tag}) @i{form})
(throw @i{form} @i{tag}) ==> (*throw (quote @i{tag}) @i{form})
@end lisp

The forms of @code{catch} and @code{throw} without tags are not supported.
@end defmac

@cindex unwinding a stack
@defun *unwind-stack tag value active-frame-count action
This is a generalization of @code{*throw} provided for program-manipulating
programs such as the error handler.

@i{tag} and @i{value} are the same as the corresponding arguments to
@code{*throw}.

@i{active-frame-count}, if non-@code{nil}, is the number of frames
to be unwound.  If this counts down to zero before a suitable @code{*catch}
is found, the @code{*unwind-stack} terminates and
@i{that frame} returns @i{value} to whoever called it.
This is similar to Maclisp's @code{freturn} function.
@findex freturn

If @i{action} is non-@code{nil}, whenever the @code{*unwind-stack} would be
ready to terminate (either due to @i{active-frame-count} or due to
@i{tag} being caught as in @code{*throw}), instead, a stack-group call is
forced to the previous stack-group, generally the error handler.  The
unwound stack-group is left in @i{awaiting-return} state, such that the
value returned when the stack-group is resumed will become the value
returned by the frame, (i.e. the @i{value} argument to
@code{*unwind-stack} will be ignored in this case, and the value passed to
the stack group when it is resumed will be used instead.)

Note that if both @i{active-frame-count} and @i{action} are @code{nil},
@code{*unwind-stack} is identical to @code{*throw}.
@end defun

@cindex unwind protection
@cindex cleanup handlers
@defmac unwind-protect
Sometimes it is necessary to evaluate a form and make sure that
certain side-effects take place after the form is evaluated;
a typical example is:

@lisp
(progn
   (turn-on-water-faucet)
   (hairy-function 3 nil 'foo)
   (turn-off-water-faucet))
@end lisp

The non-local exit facility of Lisp creates a situation in which
the above code won't work, however: if @code{hairy-function} should
do a @code{*throw} to a @code{*catch} which is outside of the @code{progn}
form, then @code{(turn-off-water-faucet)} will never be evaluated
(and the faucet will presumably be left running).

In order to allow the above program to work, it can
be rewritten using @code{unwind-protect} as follows:

@lisp
(unwind-protect
  (progn (turn-on-water-faucet)
         (hairy-function 3 nil 'foo))
  (turn-off-water-faucet))
@end lisp

If @code{hairy-function} does a @code{*throw} which attempts to quit
out of the evaluation of the @code{unwind-protect}, the
@code{(turn-off-water-faucet)} form will be evaluated in between
the time of the @code{*throw} and the time at which the @code{*catch} returns.
If the @code{progn} returns normally, then the @code{(turn-off-water-faucet)}
is evaluated, and the @code{unwind-protect} returns the result of the @code{progn}.
One thing to note is that @code{unwind-protect} cannot return multiple values.

The general form of @code{unwind-protect} looks like

@lisp
(unwind-protect @i{protected-form}
                @i{form1}
                @i{form2}
                ...)
@end lisp

@i{protected-form} is evaluated, and when it returns or when it
attempts to quit out of the @code{unwind-protect}, the @i{form}s
are evaluated.
@end defmac

@defmac let-globally
@code{let-globally} is similar in form to @code{let} (see (let-fun)).
The difference is that @code{let-globally} does not @i{bind} the
variables; instead, it @i{sets} them, and sets up an @code{unwind-protect}
(see (unwind-protect-fun)) to set them back.  The important
difference between @code{let-globally} and @code{let} is that when
the current stack group (see (stack-group)) cocalls some other stack
group, the old values of the variables are @i{not} restored.
@end defmac

@defmac catch-all
@code{(catch-all @i{form})} is like @code{(*catch @i{some-tag form})}
except that it will catch a
@code{*throw} to any tag at all.  Since the tag thrown to
is the second returned value, the caller of @code{catch-all} may continue
throwing to that tag if he wants.  The one thing that @code{catch-all}
will not catch is a @code{*throw} to @code{t}.
@code{catch-all} is a macro which expands into @code{*catch} with a @i{tag} of @code{nil}.
@end defmac

@section Mapping
@cindex mapping

@defun map fcn &rest lists
@defunx mapc fcn &rest lists
@defunx maplist fcn &rest lists
@defunx mapcar fcn &rest lists
@defunx mapcon fcn &rest lists
@defunx mapcan fcn &rest lists
Mapping is a type of iteration in which a function is
successively applied to pieces of a list.
There are several options for the way in which the pieces of the list are
chosen and for what is done with the results returned by the applications of
the function.

For example, @code{mapcar} operates on successive @i{elements} of the list.
As it goes down the list, it calls the function giving it an element
of the list as its one argument:  first the @code{car}, then the
@code{cadr}, then the @code{caddr}, etc., continuing until the end of the
list is reached.  The value returned by @code{mapcar} is a list of the
results of the successive calls to the function.  An example of the
use of @code{mapcar} would be @code{mapcar}'ing the function @code{abs} over
the list @code{(1 -2 -4.5 6.0e15 -4.2)}, which would be written as
@code{(mapcar (function abs) '(1 -2 -4.5 6.0e15 -4.2))}.
The result is @code{(1 2 4.5 6.0e15
4.2)}.

In general, the mapping functions take any number of arguments.  For example,

@lisp
(mapcar @i{f x1 x2 ... xn})
@end lisp

In this case @i{f} must be a function of @i{n} arguments.
@code{mapcar} will proceed
down the lists @i{x1, x2, ..., xn} in parallel.
The first argument to @i{f} will
come from @i{x1}, the second from @i{x2}, etc.
The iteration stops as soon as
any of the lists is exhausted.

There are five other mapping functions besides @code{mapcar}.  @code{maplist}
is like @code{mapcar} except that the function is applied to the list and
successive cdr's of that list rather than to successive elements of the
list.  @code{map} and @code{mapc} are like @code{maplist} and @code{mapcar}
respectively, except that they don't return any useful value.  These
functions are used when the function is being called merely for its
side-effects, rather than its returned values.  @code{mapcan} and
@code{mapcon} are like @code{mapcar} and @code{maplist} respectively, except
that they combine the results of the function using @code{nconc} instead
of @code{list}.  That is,

@lisp
(defun mapcon (f x y)
    (apply 'nconc (maplist f x y)))
@end lisp

Of course, this definition is less general than the real one.

Sometimes a @code{do} or a straightforward recursion is preferable to a
map;  however, the mapping functions should be used wherever they
naturally apply because this increases the clarity of the code.

Often @i{f} will be a lambda-expression, rather than a symbol;
for example,

@lisp
(mapcar (function (lambda (x) (cons x something)))
        some-list)
@end lisp

The functional argument to a mapping function must be acceptable
to @code{apply} - it cannot be a macro or the name of a special form.
Of course, there is nothing wrong with using functions which have optional
and rest parameters.

Here is a table showing the relations between
the six map functions.

@verbatim
                              applies function to

                         |  successive  |   successive  |
                         |   sublists   |    elements   |
          ---------------+--------------+---------------+
              its own    |              |               |
              second     |     map      |     mapc      |
             argument    |              |               |
          ---------------+--------------+---------------+
            list of the  |              |               |
returns      function    |    maplist   |    mapcar     |
              results    |              |               |
          ---------------+--------------+---------------+
            nconc of the |              |               |
              function   |    mapcon    |    mapcan     |
              results    |              |               |
          ---------------+--------------+---------------+
@end verbatim

There are also functions (@code{mapatoms} and @code{mapatoms-all})
for mapping over all symbols in certain
packages.  See the explanation of packages ((package)).
@end defun

@c DSK:LMMAN;FD.CON 93
@c This file is part of the Lisp Machine Manual.  -*-Text-*-
@c Function Description: Conses and List Manipulation

@c NLEFT omitted.
@c Should this discuss the use of locatives yet, or should that be confined to a section?

@chapter Manipulating List Structure
@cindex conses
@cindex lists

@section Conses

@defun car x
Returns the @i{car} of @i{x}.

@lisp
@exdent Example:
(car '(a b c)) => a
@end lisp
@end defun

@defun cdr x
Returns the @i{cdr} of @i{x}.

@lisp
@exdent Example:
(cdr '(a b c)) => (b c)
@end lisp
@end defun

Officially @code{car} and @code{cdr} are only applicable to conses and locatives.
However, as a matter of convenience, a degree of control is provided
over the action taken when there is an attempt to apply one of them to
a symbol or a number.  There are four mode-switches known as the
@i{car-number mode, cdr-number mode, car-symbol mode,} and
@i{cdr-symbol mode}.  Here are the meanings of the values of these
mode switches:

@table @r
@item car-number = 0
@i{car} of a number is an error. This is the default.
@item car-number = 1
@i{car} of a number is @code{nil}.
@item cdr-number = 0
@i{cdr} of a number is an error. This is the default.
@item cdr-number = 1
@i{cdr} of a number is @code{nil}.
@item car-symbol = 0
@i{car} of a symbol is an error.
@item car-symbol = 1
@i{car} of @code{nil} is @code{nil}, but the @i{car} of any other
symbol is an error.  This is the default.
@item car-symbol = 2
@i{car} of any symbol is @code{nil}.
@item car-symbol = 3
@i{car} of a symbol is its print-name.
@item cdr-symbol = 0
@i{cdr} of a symbol is an error.
@item cdr-symbol = 1
@i{cdr} of @code{nil} is @code{nil}, but the @i{cdr} of any other
symbol is an error.  This is the default.
@item cdr-symbol = 2
@i{cdr} of any symbol is @code{nil}.
@item cdr-symbol = 3
@i{cdr} of @code{nil} is @code{nil}, @i{cdr} of
any other symbol is its property list.
@end table

The values of the mode switches can be altered with the function @code{set-error-mode}
(see (set-error-mode-fun)).
@findex set-error-mode
They are stored as byte fields in the special variable @code{%m-flags}.
@vindex %m-flags
The reason that the two @i{symbol} modes default in that fashion is
to allow programs to @code{car} and @code{cdr} off the ends of lists without
having to check, which is sometimes useful.  A few system functions depend
on @code{car} and @code{cdr} of @code{nil} being @code{nil}, although they
hadn't ought to, so things may break if you change these modes.

The value of 3 for the @i{symbol} modes
exists for compatibility with ancient versions of Maclisp, and should not be used for
any other reasons.  (The appropriate functions are @code{get-pname}
(see (get-pname-fun)) and @code{plist} (see (plist-fun)).)
@findex get-pname
@findex plist
Note: unlike Maclisp, the values of the symbols @code{car} and @code{cdr} are not
used; the various mode switches above serve their purpose.
@vindex car
@vindex cdr
Also unlike Maclisp, this error checking is always done, even in compiled code,
regardless of the value of @code{*rset}.
@vindex *rset

@defun c...r x
@findex caaaar
@findex caaadr
@findex caaar
@findex caadar
@findex caaddr
@findex caadr
@findex caar
@findex cadaar
@findex cadadr
@findex cadar
@findex caddar
@findex cadddr
@findex caddr
@findex cadr
@findex cdaaar
@findex cdaadr
@findex cdaar
@findex cdadar
@findex cdaddr
@findex cdadr
@findex cdar
@findex cddaar
@findex cddadr
@findex cddar
@findex cdddar
@findex cddddr
@findex cdddr
@findex cddr
All of the compositions of up to four @i{car}'s and @i{cdr}'s are defined as
functions in their own right.  The names of these functions begin with "@code{c}" and end
with "@code{r}", and in between is a sequence of "@code{a}"'s and "@code{d}"'s corresponding to
the composition performed by the function.

@lisp
@exdent Example:
(cddadr x) @r{is the same as} (cdr (cdr (car (cdr x))))
@end lisp

The error checking for these functions is exactly the same as for @code{car} and @code{cdr}
above.
@end defun

@defun cons x y
@code{cons} is the primitive function to create a new @i{cons}, whose
@i{car} is @i{x} and whose @i{cdr} is @i{y}.

@lisp
@exdent Examples:
(cons 'a 'b) => (a . b)
(cons 'a (cons 'b (cons 'c nil))) => (a b c)
(cons 'a '(b c d)) => (a b c d)
@end lisp
@end defun

@defun ncons x
@code{(ncons @i{x})} is the same as @code{(cons @i{x} nil)}.
The name of the function is from "nil-cons".
@end defun

@defun xcons x y
@code{xcons} ("exchanged cons") is like @code{cons} except that the order of
the arguments is reversed.

@lisp
@exdent Example:
(xcons 'a 'b) => (b . a)
@end lisp

There are two reasons this exists: one is that you might want the arguments
to @code{cons} evaluated in the other order, and the other is that the compiler
might convert calls to @code{cons} into calls to @code{xcons} for efficiency.  In fact,
it doesn't.
@end defun

@defun cons-in-area x y area-number
@cindex area
This function creates a @i{cons} in a specific @i{area}.  (@i{Areas}
are an advanced feature of storage management; if you aren't interested in them,
you can safely skip all this stuff).  The first two arguments are the same as the
two arguments to @code{cons},  and the third is the number of the area in which
to create the @i{cons}.

@lisp
@exdent Example:
(cons-in-area 'a 'b my-area) => (a . b)
@end lisp
@end defun

@defun ncons-in-area x area-number
@code{(ncons-in-area @i{x area-number})} = @code{(cons-in-area @i{x} nil @i{area-number})}
@end defun

@defun xcons-in-area x y area-number
@code{(xcons-in-area @i{x y area-number}) = (cons-in-area @i{y x area-number})}
@end defun

The backquote reader macro facility is also generally useful
for creating list structure, especially mostly-constant list structure,
or forms constructed by plugging variables into a template.
It is documented in the chapter on Macros, see (macro).

@defun car-location cons
@code{car-location} returns a locative pointer to the cell containing
the car of @i{cons}.
@end defun

Note: there is no @code{cdr-location} function; it is difficult
because of the cdr-coding scheme.

@section Lists
@cindex cons vs list

The following section explains some of the basic functions
provided for dealing with @i{lists}.  There has been some confusion
about the term @i{list} ever since the beginnings of the language: for
the purposes of the following descriptions, a list is the symbol
@code{nil}, or a cons whose cdr is a list.  Note well that although we
consider @code{nil} to be a @i{list} (the list of zero elements), it is a
symbol and not a cons, and the @code{listp} predicate is not true of it
(but perhaps @code{listp} will be changed in the future).

@defun last list
@code{last} returns the last cons of @i{list}.  If @i{list} is @code{nil},
it returns @code{nil}.

@lisp
@exdent Example:
(setq x '(a b c d))
(last x) => (d)
(rplacd (last x) '(e f))
x => '(a b c d e f)
@end lisp

@code{last} could have been defined by:

@lisp
(defun last (x)
    (cond ((atom x) x)
          ((atom (cdr x)) x)
          ((last (cdr x))) ))
@end lisp
@end defun

@defun length list
@code{length} returns the length of @i{list}.  The length of a list
is the number of top-level conses in it.

@lisp
@exdent Examples:
(length nil) => 0
(length '(a b c d)) => 4
(length '(a (b c) d)) => 3
@end lisp

@code{length} could have been defined by:

@lisp
(defun length (x)
    (cond ((atom x) 0)
          ((1+ (length (cdr x)))) ))
@r{or by:}

(defun length (x)
    (do ((n 0 (1+ n))
         (y x (cdr y)))
        ((atom y) n) ))
@end lisp
@end defun

@defmac first
@defmacx second
@defmacx third
@defmacx fourth
@defmacx fifth
@defmacx sixth
@defmacx seventh
@lisp
(first x) ==> (car x)
(second x) ==> (cadr x)
(third x) ==> (caddr x)
(fourth x) ==> (cadddr x)
@r{etc.}
@end lisp
@end defmac

@defmac rest1
@defmacx rest2
@defmacx rest3
@defmacx rest4
@lisp
(rest1 x) ==> (cdr x)
(rest2 x) ==> (cddr x)
(rest3 x) ==> (cdddr x)
(rest4 x) ==> (cddddr x)
@end lisp
@end defmac

@defun nth n list
@code{(nth @i{n list})} returns the @i{n}'th element of @i{list}, where
the zeroth element is the @i{car} of the list.

@lisp
@exdent Examples:
(nth 1 '(foo bar gack)) => bar
(nth 3 '(foo bar gack)) => nil
@end lisp

Note: this is not the same as the InterLisp function called @code{nth},
which is similar to but not exactly the same as the Lisp Machine function
@code{nthcdr}.
Also, some people have used macros and functions called @code{nth} of their own in
their Maclisp programs, which may not work the same way; be careful.

@code{nth} could have been defined by:

@lisp
(defun nth (n list)
  (do ((i n (1- i))
       (l list (cdr l)))
      ((zerop i) (car l))))
@end lisp
@end defun

@defun nthcdr n list
@code{(nthcdr @i{n list})} @i{cdr}s @i{list} @i{n} times,
and returns the result.

@lisp
@exdent Examples:
(nthcdr 0 '(a b c)) => (a b c)
(nthcdr 2 '(a b c)) => (c)
@end lisp

In other words, it returns the @i{n}'th @i{cdr} of the list.
This is the similar to InterLisp's function @code{nth}, except that the
InterLisp function is one-based instead of zero-based; see the
InterLisp manual for details.
@code{nthcdr} is defined by:

@lisp
(defun nthcdr (n list)
    (do ((i 0 (1+ i))
         (list list (cdr list)))
        ((= i n) list)))
@end lisp
@end defun

@defun list &rest args
@code{list} constructs and returns a list of its arguments.

@lisp
@exdent Example:
(list 3 4 'a (car '(b . c)) (+ 6 -2)) => (3 4 a b 4)
@end lisp

@code{list} could have been defined by:

@lisp
(defun list (&rest args)
    (let ((list (make-list default-cons-area (length args))))
      (do ((l list (cdr l))
           (a args (cdr a)))
          ((null a) list)
        (rplaca l (car a)))))
@end lisp
@end defun

@defun list* &rest args
@code{list*} is like @code{list} except that the last @i{cons}
of the constructed list is "dotted".  It must be given at least
two arguments.

@lisp
@exdent Example:
(list* 'a 'b 'c 'd) => (a b c . d)
@r{This is like}
(cons 'a (cons 'b (cons 'c 'd)))
@end lisp
@end defun

@defun list-in-area area-number &rest args
@code{list-in-area} is exactly the same as @code{list} except that it takes
an extra argument, an area number, and creates the list in that area.
@end defun

@defun make-list area size
This creates and returns a list containing @i{size} elements, each
of which is @code{nil}.  @i{size} should be a fixnum.  The list
is allocated in the area specified; if you are not using areas in any special
way, just use the value of the symbol @code{default-cons-area}.

@lisp
@exdent Example:
(make-list default-cons-area 3) => (nil nil nil)
@end lisp

Of course, this function is not usually used when the value of the second argument
is a constant; if you want a list of three @code{nil}s, it is easy enough
to type @code{(nil nil nil)}.  @code{make-list} is used when the number
of elements is to be computed while the program is being run.

@code{make-list} and @code{cons} are the two primitive list-creation functions
which all the other functions call.  The difference is that @code{make-list}
creates a @i{cdr-coded} list (see (cdr-code)).
@end defun

@defun circular-list &rest args
@code{circular-list} constructs a circular list whose elements are @code{args}, repeated
infinitely.  @code{circular-list} is the same as @code{list} except that the list itself
is used as the last cdr, instead of @code{nil}.
@code{circular-list} is especially useful with @code{mapcar}, as in the expression

@lisp
(mapcar (function +) foo (circular-list 5))
@end lisp

which adds each element of @code{foo} to 5.
@end defun

@defun append &rest lists
The arguments to @code{append} are lists.  The result is a list which is the
concatenation of the arguments.
The arguments are not changed (cf. @code{nconc}).

@lisp
@exdent Example:
(append '(a b c) '(d e f) nil '(g)) => (a b c d e f g)
@end lisp

Note that @code{append} copies the top-level list structure of each of its
arguments except the last.  Thus, to copy
a list but not its elements, use @code{(append @i{x} nil)}.
The @code{copylist} function is equivalent.

A version of @code{append} which only accepts two arguments could have been defined by:

@lisp
(defun append2 (x y)
    (cond ((null x) y)
          ((cons (car x) (append2 (cdr x) y)) )))
@end lisp

The generalization to any number of arguments could then be made:

@lisp
(defun append (&rest args)
    (and args (append2 (car args)
                       (apply (function append) (cdr args)))))
@end lisp

These definitions do not express the full functionality of @code{append}; the
real definition minimizes storage utilization by cdr-coding the list it produces,
using @i{cdr-next} except at the end where a full node is used to link to
the last argument, unless the last argument was @code{nil} in which case
@i{cdr-nil} is used.
@end defun

@defun copylist list &optional area
Returns a list which is @code{equal} to @i{list}, but not @code{eq}.
Only the top level of list-structure is copied, i.e. @code{copylist}
copies in the @code{cdr} direction but not in the @code{car} direction.
The returned list is fully cdr-coded to minimize storage.
If the list is "dotted", that is, @code{(cdr (last @i{list}))}
is a non-@code{nil} atom, this will be true of the returned list also.
You may optionally specify the area in which to create the new copy.
@end defun

@defun copylist* list &optional area
This is the same as @code{copylist} except that the last cons of the
resulting list is never cdr-coded.  This makes for increased efficiency
if you @code{nconc} something onto the list later.
@end defun

@defun copyalist list &optional area
@code{copyalist} is for copying association lists.  The top level of
list structure of @i{list} is copied, just as @code{copylist} does.
In addition, each element of @i{list} which is a cons is replaced
in the copy by a new cons with the same car and cdr.
You may optionally specify the area in which to create the new copy.
@end defun

@defun reverse list
@code{reverse} creates a new list whose elements
are the elements of @i{list} taken in reverse order.
@code{reverse} does not modify its argument, unlike @code{nreverse} which is faster
but does modify its argument.

@lisp
@exdent Example:
(reverse '(a b (c d) e)) => (e (c d) b a)
@end lisp

@code{reverse} could have been defined by:

@lisp
(defun reverse (x)
    (do ((l x (cdr l))         ;@r{ scan down argument,}
         (r nil                ;@r{ putting each element}
            (cons (car l) r))) ;@r{ into list, until}
        ((null l) r)))         ;@r{ no more elements.}
@end lisp
@end defun

@defun nconc &rest lists
@code{nconc} takes lists as arguments.  It returns a list which is the arguments
concatenated together.  The arguments are changed, rather than copied.
(cf. @code{append}, (append-fun))

@lisp
@exdent Example:
(setq x '(a b c))
(setq y '(d e f))
(nconc x y) => (a b c d e f)
x => (a b c d e f)
@end lisp

Note that the value of x is now different, since its last cons has been @code{rplacd}'d to
the value of @code{y}.
If the nconc form is evaluated again, it would yield a piece of "circular" list
structure, whose printed representation would be
@code{(a b c d e f d e f d e f ...)}, repeating forever.

@code{nconc} could have been defined by:

@lisp
(defun nconc (x y)               ;@r{for simplicity, this definition}
    (cond ((null x) y)           ;@r{only works for 2 arguments.}
          (t (rplacd (last x) y) ;@r{hook @code{y} onto }x
              x)))               ;@r{and return the modified @code{x}.}
@end lisp
@end defun

@defun nreverse list
@code{nreverse} reverses its argument, which should be a list.  The argument
is destroyed by @code{rplacd}'s all through the list (cf. @code{reverse}).

@lisp
@exdent Example:
(nreverse '(a b c)) => (c b a)
@end lisp

@code{nreverse} could have been defined by:

@lisp
(defun nreverse  (x)
    (cond ((null x) nil)
          ((nreverse1 x nil))))

(defun nreverse1 (x y)          ;@r{auxiliary function}
    (cond ((null (cdr x)) (rplacd x y))
          ((nreverse1 (cdr x) (rplacd x y)))))
          ;;@r{ this last call depends on order of argument evaluation.}
@end lisp

Currently, @code{nreverse} does something inefficient with @i{cdr-coded}
lists, however this will be changed.  In the meantime @code{reverse} might
be preferable in some cases.
@end defun

@defun nreconc x y
@code{(nreconc @i{x y})} is exactly the same as
@code{(nconc (nreverse @i{x}) @i{y})} except that it is more
efficient.  Both @i{x} and @i{y} should be lists.

@code{nreconc} could have been defined by:

@lisp
(defun nreconc (x y)
    (cond ((null x) y)
          ((nreverse1 x y)) ))
@end lisp

using the same @code{nreverse1} as above.
@end defun

@defmac push
The form is @code{(push @i{item place})}, where @i{item} is an
arbitrary object and @i{place} is a reference to a cell containing
a list.  Usually @i{place} is the name of a variable.  @i{item}
is consed onto the front of the list.

The form

@lisp
(push (hairy-function x y z) variable)
@end lisp

replaces the commonly-used construct

@lisp
(setq variable (cons (hairy-function x y z) variable))
@end lisp

and is intended to be more explicit and esthetic.
In general, @code{(push @i{item place})} expands into
@code{(setf @i{place} (cons @i{item place}))}.
(See (setf-fun) for an explanation of @code{setf}.)
@end defmac

@defmac pop
The form is @code{(pop @i{place})}.  The result is
the @code{car} of the contents of @i{place}, and as a side-effect
the @code{cdr} of the contents is stored back into @i{place}.

@lisp
@exdent Example:
(setq x '(a b c))
(pop x) => a
x => (b c)
@end lisp

In general, @code{(pop @i{place})} expands into
@code{(prog1 (car @i{place}) (setf @i{place} (cdr @i{place})))}.
(See (setf-fun) for an explanation of @code{setf}.)
@end defmac

@defun butlast list
This creates and returns a list with the same elements as @i{list},
excepting the last element.

@lisp
@exdent Examples:
(butlast '(a b c d)) => (a b c)
(butlast '((a b) (c d)) => ((a b))
(butlast '(a)) => nil
(butlast nil) => nil
@end lisp

The name is from the phrase "all elements but the last".
@end defun

@defun nbutlast list
This is the destructive version of @code{butlast}; it changes the cdr of
the second-to-last cons of the list to nil.  If there is no
second-to-last cons (that is, if the list has fewer than two elements)
it returns @code{nil}.

@lisp
@exdent Examples:
(setq foo '(a b c d))
(nbutlast foo) => (a b c)
foo => (a b c)
(nbutlast '(a)) => nil
@end lisp
@end defun

@defun firstn n list
@code{firstn} returns a list of length @i{n}, whose elements are the
first @i{n} elements of @code{list}.  If @i{list} is fewer than
@i{n} elements long, the remaining elements of the returned list
will be @code{nil}.

@lisp
@exdent Example:
(firstn 2 '(a b c d)) => (a b)
(firstn 0 '(a b c d)) => nil
(firstn 6 '(a b c d)) => (a b c d nil nil)
@end lisp
@end defun

@defun ldiff list sublist
@i{list} should be a list, and @i{sublist} should be a sublist
of @i{list}, i.e. one of the conses that make up @i{list}.
@code{ldiff} (meaning List Difference) will return a new list,
whose elements are those elements of @i{list} that appear before
@i{sublist}.

@lisp
@exdent Examples:
(setq x '(a b c d e))
(setq y (cdddr x)) => (d e)
(ldiff x y) => (a b c)
@r{but}
(ldiff '(a b c d) '(c d)) => (a b c d)
@r{since the sublist was not @code{eq} to any part of the list.}
@end lisp
@end defun

@section Alteration of List Structure

The functions @code{rplaca} and @code{rplacd}
are used to make alterations in already-existing
list structure; that is, to change the cars and cdrs of existing conses.
  The structure is not copied but is physically altered;
hence caution should be exercised when using these functions, as
strange side-effects can occur if portions of list structure become
shared unbeknownst to the programmer.
The @code{nconc}, @code{nreverse}, @code{nreconc}, and @code{nbutlast} functions already
described, and the @code{delq} family described later,
have the same property.  However, they are normally not
used for this side-effect; rather, the list-structure modification
is purely for efficiency and compatible non-modifying functions
are provided.

@defun rplaca x y
@code{(rplaca @i{x y})} changes the car of @i{x} to @i{y} and returns
(the modified) @i{x}.  @i{x} should be a cons, but @i{y} may be any Lisp object.

@lisp
@exdent Example:
(setq g '(a b c))
(rplaca (cdr g) 'd) => (d c)
@r{Now} g => (a d c)
@end lisp
@end defun

@defun rplacd x y
@code{(rplacd @i{x y})} changes the cdr of @i{x} to @i{y} and returns
(the modified) @i{x}.  @i{x} should be a cons, but @i{y} may be any Lisp object.

@lisp
@exdent Example:
(setq x '(a b c))
(rplacd x 'd) => (a . d)
@r{Now} x => (a . d)
@end lisp

Note to Maclisp users: @code{rplacd} should not be used to set the property
list of a symbol, although there is a compatibility mode in which it will work.
See @code{car} ((car-fun)).  The right way to set a property list is with
@code{setplist} (see (setplist-fun)).
@findex setplist
@end defun

@cindex substitution
@defun subst new old s-exp
@code{(subst @i{new old s-exp})} substitutes @i{new} for all occurrences of @i{old}
in @i{s-exp}, and returns the modified copy of @i{s-exp}.  The original @i{s-exp}
is unchanged, as @code{subst} recursively copies all of @i{s-exp} replacing
elements @code{equal} to @i{old} as it goes.  If @i{new} and @i{old} are @code{nil},
@i{s-exp} is just copied, which is a convenient way to copy arbitrary list
structure.

@lisp
@exdent Example:
(subst 'Tempest 'Hurricane
       '(Shakespeare wrote (The Hurricane)))
    => (Shakespeare wrote (The Tempest))
@end lisp

@code{subst} could have been defined by:

@lisp
(defun subst (new old s-exp)
    (cond ((equal s-exp old) new) ;@r{if item eq to old, replace.}
          ((atom s-exp) s-exp)    ;@r{if no substructure, return arg.}
          ((cons (subst new old (car s-exp))  ;@r{otherwise recurse.}
                 (subst new old (cdr s-exp))))))
@end lisp

Note that this function is not "destructive"; that is, it does not change
the @i{car} or @i{cdr} of any already-existing list structure.
@end defun

@defun nsubst new old s-exp
@code{nsubst} is a destructive version of @code{subst}.  The list structure of
@i{s-exp} is altered by replacing each occurrence of @i{old} with
@i{new}.  @code{nsubst} could have been defined as

@lisp
(defun nsubst (new old s-exp)
    (cond ((eq s-exp old) new)    ;@r{If item eq to old, replace.}
          ((atom s-exp) s-exp)    ;@r{If no substructure, return arg.}
          (t ;; @r{Otherwise, recurse.}
             (rplaca s-exp (nsubst new old (car s-exp)))
             (rplacd s-exp (nsubst new old (cdr s-exp)))
             s-exp)))
@end lisp
@end defun

@defun sublis alist S-expression
@code{sublis} makes substitutions for symbols in an S-expression
(a structure of nested lists).
The first argument to @code{sublis} is an association list (see the next
section).  The second argument is the S-expression in which
substitutions are to be made.  @code{sublis} looks at all symbols
in the S-expression; if a symbol appears in the association
list occurrences of it are replaced by the object it is associated
with.  The argument is not modified; new conses are created where
necessary and only where necessary, so the newly created structure
shares as much of its substructure as possible with the old.  For
example, if no substitutions are made, the result is @code{eq} to the old
S-expression.

@lisp
@exdent Example:
(sublis '((x . 100) (z . zprime))
        '(plus x (minus g z x p) 4))
   => (plus 100 (minus g zprime 100 p) 4)
@end lisp
@end defun

@defun nsublis alist S-expression
@code{nsublis} is like @code{sublis} but changes the original list structure
instead of creating new.
@end defun

@section Cdr-Coding

There is an issue which those who must be concerned with
efficiency will need to think about.  In the Lisp Machine there are
actually two kinds of lists; normal lists and @i{cdr-coded} lists.  Normal
lists take two words for each @i{cons}, while cdr-coded lists require
only one word for each @i{cons}.  The saving is achieved by taking
advantage of the usual structure of lists to avoid storing the redundant cdrs
which link together the conses which make up the list.  Ordinarily,
@code{rplacd}'ing such a list would be impossible, since there is no explicit
representation of the cdr to be modified.  However, in the Lisp machine system
it is merely somewhat expensive; a 2-word ordinary
cons must be allocated and linked into the list by an invisible pointer.
This is slower than an ordinary @code{rplacd},
uses extra space, and slows down future accessing of the list.

One should try to use normal lists for those data structures that will
be subject to @code{rplacd}ing operations, including @code{nconc} and
@code{nreverse}, and cdr-coded lists for other structures.
The functions @code{cons}, @code{xcons}, @code{ncons}, and their area variants make normal lists.
The functions @code{list}, @code{list*}, @code{list-in-area}, @code{make-list},
and @code{append} make cdr-coded lists.  The other list-creating functions,
including @code{read},
currently make normal lists, but this should not be relied upon.
Some functions, such as @code{sort}, take special care to operate
efficiently on cdr-coded lists (@code{sort} treats them as arrays).
@code{nreverse} is rather slow on cdr-coded lists, currently, since it
simple-mindedly uses @code{rplacd}, however this will be changed.

It is currently @i{not} planned that the garbage collector
compact ordinary lists into cdr-coded lists.  @code{(append @i{x} nil)}
is a suitable way to copy a list, converting it into cdr-coded form.

@section Tables

Lisp Machine Lisp includes several functions which simplify the maintenance
of tabular data structures of several varieties.  The simplest is
a plain list of items, which models (approximately) the concept of a @i{set}.
@cindex set

There are functions to add (@code{cons}), remove (@code{delete}, @code{delq},
@code{del}, @code{del-if}, @code{del-if-not}, @code{remove}, @code{remq}, @code{rem},
@code{rem-if}, @code{rem-if-not}),
and search for (@code{member}, @code{memq}, @code{mem}) items in a list.
Set union, intersection, and difference functions are easily written using these.

@cindex association lists
@i{Association lists} are very commonly used.  An association list
is a list of conses.  The car of each cons is a "key" and the cdr
is a "datum", or a list of associated data.  The functions
@code{assoc}, @code{assq}, @code{ass}, @code{memass}, and @code{rassoc}
may be used to retrieve the data, given the key.

@i{Structured records} can be stored as association lists or as
stereotyped cons-structures where each element of the structure has a certain
car-cdr path associated with it.  However, these are better implemented
using structure macros (see (defstruct)).

Simple list-structure is very convenient, but may not be efficient enough
for large data bases because it takes a long time to search a long list.
Lisp Machine lisp includes a hashing function (@code{sxhash}) which
aids in the construction of more efficient, hairier structures.

@defun memq item list
@code{(memq @i{item list})} returns @code{nil} if @i{item} is not one of the elements of
@i{list}.  Otherwise, it returns the portion of @i{list} beginning
with the first occurrence of @i{item}.  The comparison is made by
@code{eq}.  @i{list} is searched on the top level only.
Because @code{memq} returns @code{nil} if it doesn't find anything,
and something non-@code{nil} if it finds something, it is often used as a predicate.

@lisp
@exdent Examples:
(memq 'a '(1 2 3 4)) => nil
(memq 'a '(g (x y) c a d e a f)) => (a d e a f)
@end lisp

Note that the value returned by @code{memq} is @code{eq} to the portion of the list
beginning with @i{a}.
Thus @code{rplaca} on the result of @code{memq} may be used,
if you first check to make sure @code{memq} did not return @code{nil}.

@lisp
@exdent Example:
(*catch 'lose
        (rplaca (or (memq x z)
                    (*throw 'lose nil))
                y)
        )
@end lisp

@code{memq} could have been defined by:

@lisp
(defun memq (item list)
    (cond ((atom list) nil)
          ((eq item (car list)) list)
          ((memq item (cdr list))) ))
@end lisp

@code{memq} is hand-coded in microcode and therefore especially fast.
@end defun

@defun member item list
@code{member} is like @code{memq}, except @code{equal} is used for the comparison,
instead of @code{eq}.

@code{member} could have been defined by:

@lisp
(defun member (item list)
    (cond ((null list) nil)
          ((equal item (car list)) list)
          ((member item (cdr list))) ))
@end lisp
@end defun

@defun mem predicate item list
@code{mem} is the same as @code{memq} except that it takes an extra argument
which should be a predicate of two arguments, which is used for the
comparison instead of @code{eq}.  @code{(mem 'eq a b)} is the same as
@code{(memq a b)}.  @code{(mem 'equal a b)} is the same as @code{(member a b)}.

@code{mem} is usually used with equality predicates other than
@code{eq} and @code{equal}, such
as @code{=}, @code{char-equal} or @code{string-equal}.
@end defun

@defun tailp tail list
A @i{tail} of a list is anything that can be obtained by taking @code{cdr} of it zero
or more times.  @code{tailp} is used to ask whether @i{tail} is a tail of
@i{list}.  That is, it @code{cdr}'s down @i{list} checking at each step
whether what it has got is @code{eq} to @i{tail}.  If so, the value is @code{t}.
@end defun

@defun delq item list &optional n
@code{(delq @i{item list})} returns the @i{list} with all top-level
occurrences of @i{item} removed.  @code{eq} is used for the comparison.
The argument @i{list} is actually modified (@code{rplacd}'ed) when instances
of @i{item} are spliced out.  @code{delq} should be used for value, not
for effect.  That is, use

@lisp
(setq a (delq 'b a))
@end lisp

rather than

@lisp
(delq 'b a)
@end lisp

The latter is @i{not} equivalent when the first element
of the value of @code{a} is @code{b}.

@code{(delq @i{item list n})} is like @code{(delq @i{item list})} except only the first
@i{n} instances of @i{item} are deleted.  @i{n} is allowed to be zero.
If @i{n} is greater than the number of occurrences of @i{item} in the
list, all occurrences of @i{item} in the list will be deleted.

@lisp
@exdent Example:
(delq 'a '(b a c (a b) d a e)) => (b c (a b) d e)
@end lisp

@code{delq} could have been defined by:

@lisp
(defun delq (item list &optional (n 7777777))  ;@r{7777777 as infinity.}
    (cond ((or (atom list) (zerop n)) list)
          ((eq item (car list))
           (delq item (cdr list) (1- n)))
          ((rplacd list (delq item (cdr list) n)))))
@end lisp
@end defun

@defun delete item list &optional n
@code{delete} is the same as @code{delq} except that @code{equal} is used for the comparison
instead of @code{eq}.
@end defun

@defun del predicate item list &optional n
@code{del} is the same as @code{delq} except that it takes an extra argument
which should be a predicate of two arguments, which is used for the
comparison instead of @code{eq}.  @code{(del 'eq a b)} is the same as
@code{(delq a b)}. (c.f. @code{mem}, (mem-fun))
@end defun

@defun remq item list &optional n
@code{remq} is similar to @code{delq}, except that the list is not altered;
rather, a new list is returned.

@lisp
@exdent Examples:
(setq x '(a b c d e f))
(remq 'b x) => (a c d e f)
x => (a b c d e f)
(remq 'b '(a b c b a b) 2) => (a c a b)
@end lisp
@end defun

@defun remove item list &optional n
@code{remove} is the same as @code{remq} except that @code{equal} is used for the
comparison instead of @code{eq}.
@end defun

@defun rem predicate item list &optional n
@code{rem} is the same as @code{remq} except that it takes an extra argument
which should be a predicate of two arguments, which is used for the
comparison instead of @code{eq}.  @code{(rem 'eq a b)} is the same as
@code{(remq a b)}. (c.f. @code{mem} (mem-fun))
@end defun

@defun rem-if predicate list
@i{predicate} should be a function of one argument.
@code{rem-if} makes a new list by applying @i{predicate} to
all of the elements of @i{list} and removing the ones for which the predicate
returns non-@code{nil}.  The function's name
means "remove if this condition is true".
@end defun

@defun rem-if-not predicate list
@i{predicate} should be a function of one argument.
@code{rem-if-not} makes a new list by applying @i{predicate} to
all of the elements of @i{list} and removing the ones for which the predicate
returns @code{nil}.  The function's name
means "remove if this condition is not true"; i.e. it keeps the elements
for which @i{predicate} is true.
@end defun

@defun del-if predicate list
@code{del-if} is just like @code{rem-if} except that it modifies @i{list}
rather than creating a new list.  See @code{rem-if}.
@end defun

@defun del-if-not predicate list
@code{del-if-not} is just like @code{rem-if-not} except that it modifies @i{list}
rather than creating a new list.  See @code{rem-if-not}.
@end defun

@defun every list predicate &optional step-function
@code{every} returns @code{t} if @i{predicate} returns
non-@code{nil} when applied to every element of @i{list},
or @code{nil} if @i{predicate} returns @code{nil} for some element.
If @i{step-function} is present, it replaces @code{cdr}
as the function used to get to the next element of the list.
@end defun

@defun some list predicate &optional step-function
@code{some} returns a tail of @i{list} such that the car
of the tail is the first element that the @i{predicate} returns
non-@code{nil} when applied to,
or @code{nil} if @i{predicate} returns @code{nil} for every element.
If @i{step-function} is present, it replaces @code{cdr}
as the function used to get to the next element of the list.
@end defun

@defun tailp sublist list
Returns @code{t} if @i{sublist} is a sublist of @i{list} (i.e.
one of the conses that makes up @i{list}).  Otherwise returns @code{nil}.
@end defun

@defun sxhash S-expression
@cindex hash table
@code{sxhash} computes a hash code of an S-expression, and returns it as
a fixnum, which may be positive or negative.  A property of @code{sxhash}
is that @code{(equal @i{x y})} implies @code{(= (sxhash @i{x}) (sxhash @i{y}))}.  The
number returned by @code{sxhash} is some possibly large number in the
range allowed by fixnums.  It is guaranteed that:

@enumerate
@item
@code{sxhash} for a symbol will always be positive.

@item
@code{sxhash} of any particular expression will be constant
in a particular implementation for all time, probably.

@item
@code{sxhash} of any object of type @code{random} will be zero.

@item
@code{sxhash} of a fixnum will @code{=} that fixnum.
@end enumerate

Here is an example of how to use @code{sxhash} in maintaining
hash tables of S-expressions:

@lisp
(defun knownp (x)    ;@r{look up x in the table}
  (prog (i bkt)
    (setq i (plus 76 (remainder (sxhash x) 77)))
      ;The remainder should be reasonably randomized between
      ;-76 and 76, thus table size must be > 175 octal.
    (setq bkt (aref table i))
      ;bkt is thus a list of all those expressions that hash
      ;into the same number as does x.
    (return (memq x bkt))))
@end lisp

To write an "intern" for S-expressions, one could

@lisp
(defun sintern (x)
  (prog (bkt i tem)
    (setq bkt (aref table
                    (setq i (+ 2n-2 (\ (sxhash x) 2n-1)))))
        ;2n-1 and 2n-2 stand for a power of 2 minus one and
        ;minus two respectively.  This is a good choice to
        ;randomize the result of the remainder operation.
    (return (cond ((setq tem (memq x bkt))
                   (car tem))
                  (t (aset (cons x bkt) table i)
                     x)))))
@end lisp
@end defun

@defun assq item alist
@cindex association lists
@code{(assq @i{item alist})} looks up @i{item} in the association list
(list of conses) @i{alist}.  The value is the first cons whose @code{car}
is @code{eq} to @i{x}, or @code{nil} if there is none such.

@lisp
@exdent Examples:
(assq 'r '((a . b) (c . d) (r . x) (s . y) (r . z)))
        =>  (r . x)

(assq 'fooo '((foo . bar) (zoo . goo))) => nil

(assq 'b '((a b c) (b c d) (x y z))) => (b c d)
@end lisp

It is okay to @code{rplacd} the result of @code{assq} as long as it is not @code{nil},
if your intention is to "update" the "table" that was @code{assq}'s second argument.

@lisp
@exdent Example:
(setq values '((x .  100) (y  . 200) (z .  50)))
(assq 'y values) => (y . 200)
(rplacd (assq 'y values)  201)
(assq 'y values)  => (y . 201) @r{now}
@end lisp

A typical trick is to say
@code{(cdr (assq x y))}.
Assuming the cdr of @code{nil} is guaranteed to be @code{nil},
this yields @code{nil} if no pair is found (or if a pair is
found whose cdr is @code{nil}.)

@code{assq} could have been defined by:

@lisp
(defun assq (item list)
    (cond ((null list) nil)
          ((eq item (caar list)) (car list))
          ((assq item (cdr list))) ))
@end lisp
@end defun

@defun assoc item alist
@code{assoc} is like @code{assq} except that the comparison uses @code{equal} instead of @code{eq}.

@lisp
@exdent Example:
(assoc '(a b) '((x . y) ((a b) . 7) ((c . d) .e)))
        => ((a b) . 7)
@end lisp

@code{assoc} could have been defined by:

@lisp
(defun assoc (item list)
    (cond ((null list) nil)
          ((equal item (caar list)) (car list))
          ((assoc item (cdr list))) ))
@end lisp
@end defun

@defun ass predicate item alist
@code{ass} is the same as @code{assq} except that it takes an extra argument
which should be a predicate of two arguments, which is used for the
comparison instead of @code{eq}.  @code{(ass 'eq a b)} is the same as
@code{(assq a b)}. (c.f. @code{mem} (mem-fun))
@end defun

@defun memass predicate item alist
@code{memass} searches @i{alist} just like @code{ass}, but returns
the portion of the list beginning with the pair containing @i{item},
rather than the pair itself.  @code{(car (memass @i{x y z})) =
(ass @i{x y z})}.
@end defun

@defun rassoc item alist
@code{rassoc} means @i{reverse assoc}.  It is like @code{assoc}, but
it tries to find an element of @i{alist} whose @i{cdr} (not car)
is @i{equal} to @i{item}.  @code{rassoc} is defined by:

@lisp
(defun rassoc (item in-list)
    (do l in-list (cdr l) (null l)
      (and (equal item (cdar l))
           (return (car l)))))
@end lisp
@end defun

@defun sassq item alist fcn
@code{(sassq @i{item alist fcn})} is like @code{(assq @i{item alist})} except
that if @i{item} is not found in @i{alist}, instead of returning @code{nil},
@code{sassq} calls the function @i{fcn} with no arguments.  @code{sassq} could
have been defined by:

@lisp
(defun sassq (item alist fcn)
    (or (assq item alist)
        (apply fcn nil)))
@end lisp

@code{sassq} and @code{sassoc} (see below) are of limited use.
These are primarily leftovers from Lisp 1.5.
@end defun

@defun sassoc item alist fcn
@code{(sassoc @i{item alist fcn})} is like @code{(assoc @i{item alist})} except that if
@i{item} is not found in @i{alist}, instead of returning @code{nil}, @code{sassoc} calls
the function @i{fcn} with no arguments.  @code{sassoc} could have been
defined by:

@lisp
(defun sassoc (item alist fcn)
    (or (assoc item alist)
        (apply fcn nil)))
@end lisp
@end defun

@defun pairlis cars cdrs
@code{pairlis} takes two lists and makes an association list which associates
elements of the first list with corresponding elements of the second
list.

@lisp
@exdent Example:
(pairlis '(beef clams kitty) '(roast fried yu-shiang))
   => ((beef . roast) (clams . fried) (kitty . yu-shiang))
@end lisp
@end defun

@defun find-position-in-list item list
@code{find-position-in-list} looks down @i{list} for an element which
is @code{eq} to @i{item}, like @code{memq.}  However, it returns the numeric index
in the list at which it found the first occurence of @i{item}, or
@code{nil} if it did not find it at all.

@lisp
@exdent Examples:
(find-position-in-list 'a '(a b c)) => 0
(find-position-in-list 'c '(a b c)) => 2
(find-position-in-list 'e '(a b c)) => nil
@end lisp
@end defun

@defun find-position-in-list-equal item list
@code{find-position-in-list-equal} is exactly the same as
@code{find-position-in-list}, except that the comparison is done
with @code{equal} instead of @code{eq}.
@end defun

@section Property Lists
@cindex Property list

[The stuff in FD.SYM will get moved here, leaving a pointer behind, and
will be generalized for disembodied property lists and made to clarify
the distinction between a plist and a paired list.]

@section Hash Tables
@cindex hash table

A hash table is a Lisp object that works something like a property list.
Each hash table has a set of @i{entries}, each of which associates a
particular @i{key} with a particular @i{value}.  The basic functions
that deal with hash tables can create entries, delete entries, and find
the value that is associated with a given key.  Finding the value is
very fast even if there are many entries, because hashing is used; this
is an important advantage of hash tables over property lists.

A given hash table can only associate one @i{value} with a given
@i{key}; if you try to add a second @i{value} it will replace the
first.

Hash tables are created with the function @code{make-hash-table}, which
takes various options.  New entries are added to hash tables with the
@code{puthash} function.  To look up a key and find the associated value,
the @code{gethash} function is used.  To remove an entry, use @code{remhash}.
Here is a simple example.

@lisp
(setq a (make-hash-table))

(puthash 'color 'brown a)

(puthash 'name 'fred a)

(gethash 'color a) => brown

(gethash 'name a) => fred
@end lisp

In this example, the symbols @code{color} and @code{name} are being used as
keys, and the symbols @code{brown} and @code{fred} are being used as the
associated values.  The hash table has two items in it, one of which
associates from @code{color} to @code{brown}, and the other of which
associates from @code{name} to @code{fred}.

Keys do not have to be symbols; they can be any Lisp object.  Likewise
values can be any Lisp object.  The Lisp function @code{eq} is used to
compare keys, rather than @code{equal}.  This means that keys are really
objects, but it means that it is not reasonable to use numbers other
than fixnums as keys.  Hash tables are properly interfaced to the
relocating garbage collector so that garbage collection will have no
perceptible effect on the functionality of hash tables.

When a hash table is first created, it has a @i{size}, which is the
maximum number of entries it can hold.  Usually the actual capacity of
the table is somewhat less, since the hashing is not perfectly
collision-free.  With the maximum possible bad luck, the capacity could
be very much less, but this rarely happens.  If so many entries are
added that the capacity is exceeded, the hash table will automatically
grow, and the entries will be @i{rehashed} (new hash values will be
recomputed, and everything will be rearranged so that the fast hash
lookup still works).  This is transparent to the caller; it all happens
automatically.

If the calling program is using multiprocessing, it must be careful to
make sure that there are never two processes both referencing the hash
table at the same time.  There is no locking built into hash tables; if
you have two processes that both want to reference the same hash table,
you must arrange mutual exclusion yourself by using a lock or some other
means.  Don't worry about this if you don't use multiprocessing; but if
you do use multiprocessing, you will have a lot of trouble if you don't
understand this.

@defun make-hash-table &rest options
This creates a new hash table.  Valid option keywords are:

@table @code
@item :size
Set the initial size of the hash table, in entries, as a fixnum.  The
default is 100 (octal).  The actual size is rounded up from the size
you specify to the next "good" size.
You won't necessarily be able to store this many entries into the table
before it overflows and becomes bigger; but except in the case of extreme
bad luck you will be able to store almost this many.
@item :area
Specify the area in which the hash table should be created.  This is
just like the first argument to @code{make-array} (see (make-array-fun)).
Defaults to @code{nil} (i.e. @code{default-cons-area}).
@item :rehash-function
Specify the function to be used for rehashing when the table becomes
full.  Defaults to the internal rehashing function that does the usual
thing.  If you want to write your own rehashing function, you will
have to understand all the internals of how hash tables work.  These
internals are not documented here, as the best way to learn them is
to read the source code.
@item :rehash-size
Specifies how much to increase the size of the hash table when it becomes
full.  This can be a fixnum which is the number of entries to add, or
it can be a flonum which is the ratio of the new size to the old size.
The default is @code{1.3}, which causes the table to be made 30% bigger
each time it has to grow.
@end table

@end defun

@defun gethash key hash-table
Find the entry in @i{hash-table} whose key is @i{key}, and return the
associated value.  If there is no such entry, return @code{nil}.
Returns a second value, which is @code{t} if an entry was found or @code{nil} if there
is no entry for @i{key} in this table.
@end defun

@defun puthash key value hash-table
Create an entry associating @i{key} to @i{value}; if there is already an
entry for @i{key}, then replace the value of that entry with @i{value}.
Returns @i{value}.
@end defun

@defun remhash key hash-table
Remove any entry for @i{key} in @i{hash-table}.  Returns @code{t} if there was an
entry or @code{nil} if there was not.
@end defun

@defun maphash function hash-table
For each entry in @i{hash-table}, call @i{function} on two arguments:
the key of the entry and the value of the entry.
@end defun

@defun clrhash hash-table
Remove all the entries from @i{hash-table}.  Returns the hash table itself.
@end defun

The @code{describe} function (see (describe-fun)) prints a variety of
useful information when applied to a hash table.

This hash table facility is similar to the hasharray facility of Interlisp,
and some of the function names are the same.  However, it is @i{not} compatible.
The exact details and the order of arguments are designed to be consistent
with the rest of the Lisp machine rather than with Interlisp.  For instance,
the order of arguments to @code{maphash} is different, we do not have the Interlisp
"system hash table", and we do not have the
Interlisp restriction that keys and values may not be @code{nil}.

@section Sorting
@cindex sorting

Several functions are provided for sorting arrays and lists.  These
functions use algorithms which always terminate no matter what sorting
predicate is used, provided only that the predicate always terminates.
The array sort is not necessarily @i{stable}; that is, equal items may
not stay in their original order.  However the list sort @i{is}
stable.

After sorting, the argument (be it list or array) is rearranged
internally so as to be completely ordered.  In the case of an array
argument, this is accomplished by permuting the elements of the array,
while in the list case, the list is reordered by @code{rplacd}'s in the
same manner as @code{nreverse}.  Thus if the argument should not be
clobbered, the user must sort a copy of the argument, obtainable by
@code{fillarray} or @code{append}, as appropriate.

Should the comparison predicate cause an error, such as a wrong type
argument error, the state of the list or array being sorted is
undefined.  However, if the error is corrected the sort will, of
course, proceed correctly.

The sorting package is smart about cdr-coded lists.

@defun sort table predicate
The first argument to @code{sort} is an array or a list.  The second
is a predicate, which must be applicable to
all the objects in the array or list.  The predicate should take two
arguments, and return non-@code{nil} if and only if the first argument is
strictly less than the second (in some appropriate sense).
@c Sorting works on n-bit arrays and so on, right?

The @code{sort} function proceeds to sort the contents of the array or
list under the ordering imposed by the predicate, and returns the
array or list modified into sorted order, i.e. its modified first
argument.  Note that since sorting requires many comparisons, and thus
many calls to the predicate, sorting will be much faster if the
predicate is a compiled function rather than interpreted.

@lisp
@exdent Example:
(defun mostcar (x)
    (cond ((symbolp x) x)
          ((mostcar (car x)))))

(sort 'fooarray
      (function (lambda (x y)
          (alphalessp (mostcar x) (mostcar y)))))
@end lisp

If @code{fooarray} contained these items before the sort:

@lisp
(Tokens (The lion sleeps tonight))
(Carpenters (Close to you))
((Rolling Stones) (Brown sugar))
((Beach Boys) (I get around))
(Beatles (I want to hold your hand))
@end lisp

then after the sort @code{fooarray} would contain:

@lisp
((Beach Boys) (I get around))
(Beatles (I want to hold your hand))
(Carpenters (Close to you))
((Rolling Stones) (Brown sugar))
(Tokens (The lion sleeps tonight))
@end lisp
@end defun

@defun sortcar x predicate
@code{sortcar} is exactly like @code{sort}, but the items in the array or
list being sorted should all be conses.  @code{sortcar} takes the
@code{car} of each item before handing two items to the predicate.  Thus
@code{sortcar} is to @code{sort} as @code{mapcar} is to @code{maplist}.
@end defun

The spelling of the names of the next two functions will be corrected at some point.

@defun sort-grouped-array array group-size predicate
@code{sort-grouped-array} considers its array argument to
be composed of records of @i{group-size} elements each.
These records are considered as units, and are sorted with respect
to one another.  The @i{predicate} is applied to the first element
of each record; so the first elements act as the keys on which
the records are sorted.
@end defun

@defun sort-grouped-array-group-key array group-size predicate
This is like @code{sort-grouped-array} except that the
@i{predicate} is applied to four arguments:  an array,
an index into that array, a second array, and an index into
the second array.  @i{predicate} should consider each index
as a subscript of the first element of a record in the corresponding
array, and compare the two records.  This is more general
than @code{sort-grouped-array} since the function can get at
all of the elements of the relevant records, instead of only the first element.
@end defun

@c DSK:LMMAN;FD.SYM 47
@c This file is part of the Lisp Machine Manual.  -*-Text-*-
@c Function Description: Symbols

@c Remember to go back and try to figure out INTERN and REMOB.

@chapter Symbols
@cindex symbol

@section The Value Cell
@cindex value cell

Each symbol has associated with it a @i{value cell}, which refers
to one Lisp object.  This object is called the symbol's @i{binding} or @i{value},
since it is what you get when you evaluate the symbol.  The binding of symbols to values
allows symbols to be used as the implementation of @i{variables} in programs.

The value cell can also be @i{empty}, referring to @i{no} Lisp
object, in which case the symbol is said to be @i{unbound}.  This is the initial
state of a symbol when it is created.  An attempt to evaluate an unbound symbol
causes an error.

The binding of a symbol can be changed either by @i{lambda-binding} or by
@i{assignment}.  The difference is that when a symbol is lambda-bound, its previous
value is saved away, to be restored later, whereas assignment discards the previous
value.

The symbols @code{nil} and @code{t} are always bound to themselves; they
may not be assigned nor lambda-bound.  (The error of changing the value of
@code{t} or @code{nil} is not yet detected, but it will be.)

When @i{closures} are in use, the situation is a little more complicated.
See the section on closures.

When a Lisp function is @i{compiled}, most of its variables are compiled
into @i{local variables}, which are not represented by means of symbols.  However
the compiler recognizes usage of the @code{setq} special form, and of the @code{set}
and @code{value-cell-location} functions with a quoted argument, as referring to
variables rather than symbols, and generates the appropriate code to access the
corresponding local variable rather than the symbol.

@defspec defvar symbol &optional initial-value
@code{defvar} is the recommended way to declare the use of a global variable in a
program.  Placed at top level in a file, it serves to initialize the variable,
declare it special for the sake of compilation, and record the location for the
sake of the editor so that you can ask to see where the variable is defined.
It also provides a good place to put a comment describing the meaning of the
variable (whereas an ordinary @code{declare} offers the temptation to declare
several variables at once and not have room to describe them all).
If the variable has a value already, that value is not changed.
If @i{initial-value} is omitted, the variable is left unbound.
@code{defvar} should be used only at top level, never in function definitions,
and only for global variables (used by more than one function).
@code{(defvar foo 'bar)} is equivalent to

@lisp
(declare (special foo))
(or (boundp 'foo)
    (setq foo 'bar))
@end lisp
@end defspec

@defun set symbol value
@code{set} is the primitive for assignment of symbols.  The @i{symbol}'s value
is changed to @i{value}; @i{value} may be any Lisp object.  @i{set} returns
@i{value}.

@lisp
@exdent Example:
(set (cond ((eq a b) 'c)
           (t 'd))
     'foo)
@end lisp

will either set @code{c} to @code{foo} or set @code{d} to @code{foo}.
@end defun

@defspec setq
The special form @code{(setq @i{var1 form1 var2 form2...})} is the
"variable assignment statement" of Lisp.  First @i{form1} is evaluated
and the result is assigned to @i{var1}, using @code{set}, then @i{form2}
is evaluated and the result is assigned to @i{var2}, and so forth.
@code{setq} returns the last value assigned, i.e. the result of the
evaluation of its last argument.

@lisp
@exdent Example:
(setq x (+ 3 2 1) y (cons x nil))
@end lisp

@code{x} is set to @code{6}, @code{y} is set to @code{(6)}, and the @code{setq}
returns @code{(6)}.  Note that the first assignment was performed before
the second form was evaluated, allowing that form to use the new value of @code{x}.
@end defspec

@defmac psetq
A @code{psetq} form is just like a @code{setq} form, except
that the assignments happen in parallel; first all of the forms
are evaluated, and then the symbols are set to the resulting
values.

@lisp
@exdent Example:
(setq a 1)
(setq b 2)
(psetq a b b a)
a => 2
b => 1
@end lisp
@end defmac

@defun symeval sym
@code{symeval} is the basic primitive for retrieving a symbols's value.
@code{(symeval @i{sym})} returns @i{sym}'s current binding.
This is the function called by @code{eval} when it is given a symbol
to evaluate.  If the symbol is unbound, then @code{symeval} causes
an error.
@end defun

@defun boundp sym
@code{boundp} returns @code{t} if @i{sym} is bound; otherwise, it returns @code{nil}.
@end defun

@defun makunbound sym
@code{makunbound} causes @i{sym} to become unbound.

@lisp
@exdent Example:
(setq a 1)
a => 1
(makunbound 'a)
a => @r{causes an error.}
@end lisp

@code{makunbound} returns its argument.
@end defun

@defun value-cell-location sym
@code{value-cell-location} returns a locative pointer to @i{sym}'s value cell.
See the section on locatives.

[Must explain about external vs internal value cell.]
@end defun

@section The Function Cell
@cindex function cell

Every symbol also has associated with it a @i{function cell}.  The @i{function}
cell is similar to the @i{value} cell; it refers to a Lisp object.
When a function is referred to by name, that is, when a symbol is @i{applied}
or appears as the car of a form to be evaluated, that symbol's function cell
is used to find its @i{definition}, the functional object which is to be applied.
For example, when evaluating @code{(+ 5 6)},
the evaluator looks in @code{+}'s function cell to find the definition of @code{+},
in this case a @i{FEF} containing a compiled program, to apply to 5 and 6.

Maclisp does not have function cells; instead, it looks for special
properties on the property list.  This is one of the major incompatibilities
between the two dialects.

Like the value cell, a function cell can be empty, and it can be lambda-bound
or assigned.  The following functions are analogous to the value-cell related
functions in the previous section.

@defun fsymeval sym
@code{fsymeval} returns @i{sym}'s definition, the contents of its function cell.
If the function cell is empty, @code{fsymeval} causes an error.
@end defun

@defun fset sym x
@code{fset} stores @i{x}, which may be any Lisp object, into @i{sym}'s
function cell.  It returns @i{x}.
@end defun

@defun fboundp sym
@code{fboundp} returns @code{nil} if @i{sym}'s function cell is empty,
i.e. @i{sym} is undefined.
Otherwise it returns @code{t}.
@end defun

@defun fmakunbound sym
@code{fmakunbound} causes @i{sym}'s to be undefined, i.e. its
function cell to be empty.
It returns @i{sym}.
@end defun

@defun function-cell-location sym
@code{function-cell-location} returns a locative pointer to @i{sym}'s function
cell.  See the section on locatives.
@end defun

@cindex definition
The usual means of putting a function in a symbol's function
cell (@i{defining} the symbol) is by means of the @code{defun} special
form.  Macros are put in a symbol's function cell by means of the
@code{macro} special form.  Substitutable functions can be put there with the
@code{defsubst} special form.  Anything else requires the @code{deff} special form.

@defspec defun
@code{defun} is used for defining functions.  A
@code{defun} form looks like:

@lisp
(defun @i{name type lambda-list
       body})
@end lisp

The @i{type} is only for Maclisp
compatibility, and is optional and usually absent.  The @i{lambda-list}
is as described on (lambda-list) and may contain "&-keywords".

@lisp
@exdent Examples:
(defun addone (x)
       (1+ x))

(defun foo (a &optional (b 5) c &rest e &aux j)
        (setq j (+ a b))
        (cond ((not (null c))
               (cons j e))
              (t j)))
@end lisp

A list  @code{(named-lambda @i{name} @i{lambda-list . body})} is left in
the function cell of @i{name}.

For compatibility, the Maclisp @i{type}s @code{expr}, @code{fexpr}, and @code{macro},
and Maclisp @i{lexprs} (which have an atomic lambda-list)
are recognized and the corresponding Lisp Machine flavor of @code{defun} is assumed.
@end defspec

@defspec defsubst
@code{defsubst} is used for defining substitutable functions.  It is used just
like @code{defun}

@lisp
(defsubst @i{name} @i{lambda-list} . @i{body})
@end lisp

and does almost the same thing.  It defines a function which executes
identically to the one which a similar call to @i{defun} would define.  The
difference comes when a function which @i{calls} this one is compiled.  Then,
the call will be open-coded by substituting the substitutable function's
definition into the code being compiled.  Substitutable
functions are a sort of cross between ordinary functions and macros; they can be
applied like functions, but act like macros for the compiler.  The actual
definition looks like @code{(subst @i{lambda-list} . @i{body})}.  For example, if
we define

@lisp
(defsubst square (x) (* x x))

(defun foo (a b) (square (+ a b)))
@end lisp

then if @code{foo} is used interpreted, @code{square} will work just as if it had
been defined by @code{defun}.  If @code{foo} is compiled, however, the squaring
will be substituted into it and it will compile just like

@lisp
(defun foo (a b) (* (+ a b) (+ a b)))
@end lisp

You will notice that the substitution performed is very simple and takes no care
about the possibility of computing an argument twice when it really ought to be
computed once.
@end defspec

@defspec macro
@code{macro} is used for defining macros.  Its form is:

@lisp
(macro @i{name} (@i{arg})
       @i{body})
@end lisp

@lisp
@exdent Examples:
(macro addone (x)
       (list '1+ (cadr x)))

(macro increment (x)
       (list 'setq (cadr x) (list '1+ (cadr x))))
@end lisp

In the function cell of @i{name} is placed a cons whose car is
the symbol @code{macro}, and whose cdr is a @code{lambda}-expression of the
form @code{(lambda (@i{arg}) . @i{body})}.

Much of the time it is more convenient and clear to use a macro-defining
macro such as @code{defmacro} (see (defmacro-fun)) to define macros.
@end defspec

@defspec deff
@code{deff} is used for giving a function a definition which is not obtainable
with the specific defining forms such as @code{defun} and @code{macro}.  It looks
like

@lisp
(deff @i{name} @i{definition})
@end lisp

where @i{definition} is @i{evaluated} so you can get any object you want.
For example,

@lisp
(deff foo 'bar)
@end lisp

will make @code{foo} equivalent to @code{bar}, with an indirection so that if
@code{bar} changes @code{foo} will likewise change;

@lisp
(deff foo (function bar))
@end lisp

copies the definition of @code{bar} into @code{foo} with no indirection, so that
further changes to @code{bar} will have no effect on @code{foo}.
@end defspec

@defspec def
[from what's explained here, nobody would understand why def is useful.
The whole section towards functions and definitions needs to be rewritten].
@end defspec

@defun fset-carefully symbol definition &optional force-flag
This is the same as @code{(fset @i{symbol} @i{definition})} except that it
makes some checks and saves the old definition.  @code{defun}, @code{macro},
@code{undefun}, @code{load}, and the compiler call @code{fset-carefully} when
they define functions.

@code{fset-carefully} prints a message and asks the user if the current
package (value of @code{package}) is not allowed to redefine the
@i{symbol}.  Specifying @i{force-flag} non-@code{nil} suppresses this
check.

The previous definition, if any, of @i{symbol} is saved on the
@code{:previous-definition} property.  If it is a list, it is also saved
on the @code{:previous-expr-definition} property.  These properties are
used by the @code{undefun} function ((undefun-fun)), which restores the
previous definition, and the @code{uncompile} function ((uncompile-fun)),
which restores the previous interpreted definition.

If @i{symbol} is not a symbol, but a list @code{(@i{name} @i{prop})},
then the definition is put on @i{name}'s @i{prop} property, the
package error check is not done, and the old definition is not saved.
This is used to implement the @code{(defun (@i{name} @i{prop}) ...)} feature.
@end defun

@defun undefun symbol
If @i{symbol} has a @code{:previous-definition} property,
@code{undefun} interchanges it with @i{symbol}'s function definition.
This undoes the effect of a @code{defun}, @code{compile}, etc.
@end defun

@defun arglist function &optional literal-flag
@code{arglist} is given a function, and returns its best guess at the nature of the function's
@i{lambda}-list.

If @i{function} is a symbol, @code{arglist}
of its function definition is used.

If the @i{function} is an actual @i{lambda}-expression,
its @i{cadr}, the lambda-list, is returned.  But if @i{function}
is compiled, @code{arglist} attempts to reconstruct the @i{lambda}-list of the original
definition, using whatever debugging information was saved by the compiler.
Sometimes the actual names of the bound variables are not available, and
@code{arglist} uses the symbol @code{*unknown*} for these.  Also, sometimes
the initialization of an optional parameter is too complicated
for @code{arglist} to reconstruct; for these it returns the symbol
@code{*hairy*}.

Some functions' real argument lists are not what would be most
descriptive to a user.  A function may take a &rest argument for
technical reasons even though there are standard meanings for the
first element of that argument.  For such cases, the definition of the
function can specify a value to be returned when the user asks about
the argument list, with a @code{local-declare}.  Example:

@lisp
(def foo                ;So the definition of foo can be found
  (local-declare ((arglist x y &rest z))
    (defun foo (&rest rest-arg) .....)))
@end lisp

@code{literal-flag} allows the caller of @code{arglist} to say that
declared arglists of this sort should not be used.

@code{arglist} cannot be relied upon to return the exactly
correct answer, since some of the information may have been lost.
Programs interested in how many and what kind of arguments there are
should use @code{args-info} instead.  @code{arglist} is a reliable way
of getting the names of the arguments, if that information is
available, provided the @code{literal-flag} argument is @code{t}.  This
inhibits use of @code{arglist} declarations.
@end defun

@defun args-info function
@code{args-info} returns a fixnum called the "numeric argument descriptor"
of the @i{function}, which describes the way the function takes arguments.
The information in it is stored in various bits and byte fields in the
fixnum, which are referenced by the symbolic names shown below.
By the usual Lisp Machine convention, those starting with a single "%"
are bit-masks (meant to be @code{logand}ed with the number), and those
starting with "%%" are byte descriptors (meant to be used with @code{ldb}).

Here are the fields:

@table @code
@item %arg-desc-quoted-rest
If this bit is set, the function has a "rest" argument, and it is "quoted".
Most special forms have this bit.
@item %arg-desc-evaled-rest
If this bit is set, the function has a "rest" argument, and it is not "quoted".
@item %arg-desc-fef-quote-hair
If this bit is set, there are some quoted arguments other
than the "rest" argument (if any), and the pattern of quoting is too complicated
to describe here.  The ADL (Argument Description List) in the FEF should be consulted.
@item %arg-desc-interpreted
This function is not a compiled-code object, and a numeric argument descriptor
cannot be computed.
Usually @code{args-info} will not return this bit, although @code{%args-info} will.
@item %arg-desc-fef-bind-hair
There is argument initialization, or something else too
complicated to describe here.
The ADL (Argument Description List) in the FEF should be consulted.
@item %%arg-desc-min-args
This is the minimum number of arguments which may be passed
to this function, i.e., the number of "required" parameters.
@item %%arg-desc-max-args
This is the maximum number of arguments which may be passed
to this function, i.e., the sum of the number of "required"
parameters and the number of "optional" paramaters.
If there is a rest argument, this is not really the maximum
number of arguments which may be passed; an arbitrarily-large
number of arguments is permitted, subject to limitations on
the maximum size of a stack frame.
@end table

Note that @code{%arg-desc-quoted-rest} and @code{%arg-desc-evaled-rest} cannot both be set.
@end defun

@defun %args-info function
This is an internal function of @code{args-info}; it is like @code{args-info} but only
works for compiled-code objects.  It exists because it has to be in the microcode
anyway, for @code{apply}.
@end defun

@section The Property List
@cindex property list
@cindex indicator
@cindex attribute

Every symbol has associated with it a @i{property list}, which
is a list used for associating "attributes" with symbols.  A property
list has an even number of elements.  Each pair of elements constitutes a
@i{property};  the first of the pair is a symbol called the
@i{indicator}, and the second is a Lisp object called the @i{value}
or, more loosely, the @i{property}.  The indicator serves as the name
of the property, and the value as the value of the property. Here is
an example of the property list of a symbol named @code{b1} which is
being used by a program which deals with blocks:
@cindex blocks

@lisp
        (color blue on b6 associated-with (b2 b3 b4))
@end lisp

There are three properties, and so the list has six elements.
The first property's indicator is the symbol @code{color}, and its value
is the symbol @code{blue}.  One says that "the value of @code{b1}'s @code{color}
property is @code{blue}", or, informally, that "@code{b1}'s @code{color} property
is @code{blue}."  The program is probably representing the information that
the block represented by @code{b1} is blue.  Similarly, it is probably
representing in the rest of the property list that block @code{b1} is on
top of block @code{b6}, and that @code{b1} is associated with blocks
@code{b2}, @code{b3}, and @code{b4}.

When a symbol is created, its property list is initially @code{nil}.

Because of the existence of print-name, value, function, and package cells,
none of the Maclisp system property names (@code{expr}, @code{fexpr}, @code{macro}, @code{array},
@code{subr}, @code{lsubr}, @code{fsubr}, and in former times @code{value} and
@code{pname}) exist in Lisp Machine lisp.  The compiler (see (compiler))
and the editor use several properties, which are documented in those sections.

@cindex disembodied property list
It is also possible to have a "disembodied" property list,
which is not associated with any symbol.
A disembodied property list is a cons.  Its car may be used for any purpose.
The property list resides in its cdr.
The way to create a disembodied property list is with @code{(ncons nil)}.
In all of the functions in this section, disembodied property lists
may be used as well as symbols; for brevity, the text speaks only of symbols.

@defun get sym indicator
@i{get} looks up @i{sym}'s @i{indicator} property.  If it finds such a property,
it returns the value; otherwise, it returns @code{nil}.

@lisp
@exdent Example: If the property list of @code{foo} is @code{(baz 3)}, then
(get 'foo 'baz) => 3
(get 'foo 'zoo) => nil
@end lisp

@c What if sym is a number?  What happens?
@c a list or locative?? disembodied property list******
@end defun

@defun getl sym indicator-list
@code{getl} is like @code{get}, except that the second argument is a list
of indicators.  @code{getl} searches down @i{sym}'s property list for any
of the indicators in @i{indicator-list}, until it finds a property whose
indicator is one of the elements of @i{indicator-list}.

@code{getl} returns the portion of @i{sym}'s property list beginning
with the first such property which it found.  So the @i{car} of the returned
list is an indicator, and the @i{cadr} is the property value.  If none
of the indicators on @i{indicator-list} are on the property list, @code{getl}
returns @code{nil}.

@lisp
@exdent Example:
@r{If the property list of} foo @r{were}
(bar (1 2 3) baz (3 2 1) color blue height six-two)
@r{then}
(getl 'foo '(baz height))
  => (baz (3 2 1) color blue height six-two)
@end lisp
@end defun

@defun putprop sym x indicator
This gives @i{sym} an @i{indicator}-property of @i{x}.
After this is done, @code{(get @i{sym indicator})} will return @i{x}.

@lisp
@exdent Example:
(putprop 'Nixon 'not 'crook)
@end lisp

If @i{sym} already has a property with the name @i{indicator},
then that property is removed first; this insures that @code{getl} will always
find the property that was added most recently.
@end defun

@defspec defprop
@code{defprop} is a form of @code{putprop} with unevaluated arguments,
which is sometimes more convenient for typing.

@lisp
@exdent Example:
(defprop foo bar next-to)
@end lisp

is the same as

@lisp
(putprop 'foo 'bar 'next-to)
@end lisp
@end defspec

@defun remprop sym indicator
This removes @i{sym}'s @i{indicator} property, by splicing it out of the property
list.  It returns that portion of @i{sym}'s property list of which the
former @i{indicator}-property was the @code{car}.

@lisp
@exdent Example:
@r{If the property list of @code{foo} was}
(color blue height six-three near-to bar)
@r{then}
(remprop 'foo 'height) => (six-three near-to bar)
@r{and @code{foo}'s property list would be}
(color blue near-to bar)
@end lisp

If @i{sym} has no @i{indicator}-property, then @code{remprop} has no side-effect
and returns @code{nil}.
@end defun

@defun plist sym
This returns the property list of @i{sym}.
@end defun

@defun setplist sym property-list
This sets the property list of @i{sym} to @i{property-list}.  @code{setplist} is to be used
with caution, since property lists sometimes contain internal system properties, which
are used by many useful system functions.  Also it is inadvisable to have the property
lists of two different symbols be @code{eq}, since the shared list structure will
cause unexpected effects on one symbol if @code{putprop} or @code{remprop} is done to the other.
@end defun

@defun property-cell-location sym
This returns a locative pointer to the location of @i{sym}'s property-list
cell.  See the section on locatives.
@end defun

@section The Print Name
@cindex print name

Every symbol has an associated string called the @i{print-name}, or @i{pname}
for short.  This string is used as the external representation of the symbol:
if the string is typed in to @code{read}, it is read as a reference to that symbol
(if it is interned), and if the symbol is @i{print}ed, @code{print} types out the
print-name.
For more information, see the section on the @i{reader}
(see (reader)) and @i{printer} (see (printer)).

@defun samepnamep sym1 sym2
This predicate returns @code{t} if the two symbols @i{sym1} and @i{sym2} have
@code{equal} print-names; that is, if their printed representation is the same.
Upper and lower case letters are normally considered the same.
If either or both of the arguments is a string instead of a symbol, then that
string is used in place of the print-name.

@lisp
@exdent Examples:
(samepnamep 'xyz (maknam '(x y z)) => t

(samepnamep 'xyz (maknam '(w x y)) => nil

(samepnamep 'xyz "xyz") => t
@end lisp

This is the same function as @code{string-equal} (see (string-equal-fun)).
@end defun

@defun get-pname sym
This returns the print-name of the symbol @i{sym}.

@lisp
@exdent Example:
(get-pname 'xyz) => "xyz"
@end lisp
@end defun

@defun print-name-cell-location sym
This returns a locative pointer to the location of @i{sym}'s
print-name cell.  See the section on locatives.
Note that the contents of this cell is not actually the print name,
but the symbol header, an object which may not be directly manipulated.
Use @code{get-pname}, the microcode primitive which knows how to
extract the pname from the symbol header.
@end defun

@section The Creation and Interning of Symbols
@cindex intern

Normally, one wants to refer to the same symbol every
time the same print-name-like string is typed.  So, when
@code{read} sees such a character-string in the input to Lisp,
it looks in a table called the @i{obarray} for some symbol
with that print-name.  If it finds such a symbol, then that is what it
returns; otherwise, it creates a symbol with that print-name (using
the @code{make-symbol} function, see below), enters that symbol
on the obarray, and returns it.  The sub-function of @code{read} which performs
these functions is called @code{intern}, and when a symbol has been entered
on the obarray it is said to be @i{interned}.

A symbol can also be @i{uninterned}, indicating that it is not
on the obarray and cannot be referred to simply by typing its print
name.  Such symbols can be used as objects within a data-structure,
but can cause trouble during debugging because they cannot be "typed in"
directly, yet they look just like interned symbols when "typed out".

Actually there can be many obarrays; the Lisp Machine system
includes a feature called the @i{package system} (see (package)) which keeps track
of multiple @i{packages} or @i{name spaces} and their interrelationships,
using separate obarrays for each package.

@defun make-symbol pname &optional permanent-p
This creates a new uninterned symbol, whose print-name is the string @i{pname}.
The value and function bindings will be unbound, the property list will be empty,
and the package will be @code{nil}.  If @i{permanent-p} is specified, the symbol
is going to be interned and kept around forever; in this case it and its pname
will be put in the proper areas.  If @i{permanent-p} is @code{nil} (the default),
nothing special is done with areas.

@lisp
@exdent Examples:
(setq a (make-symbol "foo")) => foo
(symeval a) => ERROR!
@end lisp

Note that the symbol is @i{not} interned; it is simply created and returned.
@end defun

@defun copysymbol sym copy-p
This returns a new uninterned symbol with the same print-name
as @i{sym}.  If @i{copy-p} is non-@code{nil}, then the initial
value and function-definition of the new symbol will
be the same as those of @i{sym}, and the property list of
the new symbol will be a copy of @i{sym}'s.  If @i{copy-p}
is @code{nil}, then the new symbol will be unbound and undefined, and
its property list will be @code{nil}.
@end defun

@defun gensym &optional x
@code{gensym} invents a print-name, and creates a new symbol with that print-name.
It returns the new, uninterned symbol.

The invented print-name is a character prefix (the value of @code{si:*gensym-prefix})
followed by the decimal representation of a number (the value of @code{si:*gensym-counter}),
e.g. "g0001".  The number is increased by one every time @code{gensym} is called.

If the argument @i{x} is present and is a fixnum, then @code{si:*gensym-counter} is
set to @i{x}.  If @i{x} is a string or a symbol, then @code{si:*gensym-prefix} is set to
the first character of the string or of the print-name.
After handling the argument, @code{gensym} creates a symbol as it would with no argument.

@lisp
@exdent Examples:
@r{if}   (gensym) => g0007
@r{then} (gensym 'foo) => f0008
     (gensym 40) => f0032
     (gensym) => f0033
@end lisp

Note that the number is in decimal and always has four digits, and the prefix is
always one character.

@code{gensym} is usually used to create a symbol which should not normally
be seen by the user, and whose print-name is unimportant, except to
allow easy distinction by eye between two such symbols.
The optional argument is rarely supplied.
The name comes from "generate symbol", and the symbols produced by it
are often called "gensyms".
@end defun

@defun package-cell-location symbol
Returns a locative pointer to @i{symbol}'s package cell, which contains
the package (see (package)) which owns @i{symbol}.
@end defun

@c DSK:LMMAN;FD.NUM 54
@c This file is part of the Lisp Machine Manual.  -*-Text-*-
@c Function Description: Numbers

@c TRUE and FALSE omitted; unclear why LMNUC thinks they belong here.
@c FALSE at least does not seem to be on SYSTEM package.
@c
@c Missing explanation of the random number algorithm.

@chapter Numbers
@cindex number

Lisp Machine Lisp includes several types of numbers, with different
characteristics.  Most numeric functions will accept any type of numbers as
arguments and do the right thing.  That is to say, they are @i{generic}.
In Maclisp, there are generic numeric functions (like @code{plus}) and there
are specific numeric functions (like @code{+}) which only operate on a certain
type.  In Lisp Machine Lisp, this distinction does not exist; both function
names exist for compatibility but they are identical.  The microprogrammed
structure of the machine makes it possible to have only the generic
functions without loss of efficiency.

The types of numbers in Lisp Machine Lisp are:

@table @r
@item fixnum
Fixnums are 24-bit 2's complement binary integers.  These are the "preferred,
most efficient" type of number.
@item bignum
Bignums are arbitrary-precision binary integers.
@item flonum
Flonums are floating-point numbers.  They have a mantissa of 32 bits and an exponent
of 11 bits, providing a precision of about 9 digits and a range of about 10^300.
Stable rounding is employed.
@item small-flonum
Small flonums are another form of floating-point number, with a mantissa of
18 bits and an exponent of 7 bits, providing a precision of about 5 digits
and a range of about 10^19.  Small flonums are useful because, like fixnums,
they don't require any storage.  Computing with small flonums is
more efficient than with regular flonums.
@end table

Numbers are different from other objects in that they don't "have
identity." To put it another way, @code{eq} does not work on them.
Numbers do not behave "like objects." Fixnums and small flonums are
exceptions to this rule; some system code knows that @code{eq} works on
fixnums used to represent characters or small integers, and uses
@code{memq} or @code{assq} on them.

The Lisp machine automatically converts between fixnums and bignums
as necessary when computing with integers.  That is, if the result
of a computation with fixnums is too large to be represented as a fixnum,
it will be represented as a bignum.  If the result of a computation
with bignums is small enough to be represented as a fixnum, it will be.

The Lisp machine never automatically converts between flonums and small
flonums, since this would lead  either to inefficiency or to unexpected
numerical inaccuracies.  The user controls whether floating-point
calculations are done in large or small precision by the type of the
original input data.

Integer computations cannot "overflow", except for division by zero,
since bignums can be of arbitrary size.  Floating-point computations
can get exponent overflow or underflow, if the result is too large or small
to be represented.  This will signal an error.

When an arithmetic function of more than one argument is given arguments of
different numeric types, uniform @i{coercion rules} are followed to convert
the arguments to a common type, which is also the type of the result (for
functions which return a number).  When a fixnum meets a bignum, the result
is (usually) a bignum.  When a fixnum or a bignum meets a small flonum or a flonum,
the result is a small flonum or a flonum (respectively).  When a small flonum
meets a regular flonum, the result is a regular flonum.

Unlike Maclisp, Lisp Machine Lisp does not have number declarations in the compiler.
Note that because fixnums and small flonums are "inums" (require no associated
storage) they are as efficient as declared numbers in Maclisp.

The different types of numbers are distinguished by their printed
representations.  A leading or embedded decimal point, and/or an exponent
separated by "e", indicates a flonum.  If a number has an exponent
separated by "s", it is a small flonum.  Small flonums require a special
indicator so that naive users will not be accidentally tricked into
computing with the lesser precision.  Fixnums and bignums have similar
printed representations; the number is a bignum if it is too big to be a
fixnum.

@section Numeric Predicates

@defun zerop x
Returns @code{t} if @i{x} is zero.  Otherwise it returns @code{nil}.
If @i{x} is not a number, @code{zerop} causes an error.
@end defun

@defun plusp x
Returns @code{t} if its argument is a positive number, strictly greater
than zero.  Otherwise it returns @code{nil}.
If @i{x} is not a number, @code{plusp} causes an error.
@end defun

@defun minusp x
Returns @code{t} if its argument is a negative number, strictly
less than zero.  Otherwise it returns @code{nil}.
If @i{x} is not a number, @code{minusp} causes an error.
@end defun

@defun oddp number
Returns @code{t} if @i{number} is odd, otherwise @code{nil}.
If @i{number} is not a fixnum or a bignum, @code{oddp} causes an error.
@end defun

@defun evenp number
Returns @code{t} if @i{number} is even, otherwise @code{nil}.
If @i{number} is not a fixnum or a bignum, @code{evenp} causes an error.
@end defun

@defspec signp
@i{signp} is used to test the sign of a number.  It is present
only for Maclisp compatibility, and is not recommended for use in new
programs.  @code{(signp @i{test x})} returns @code{t} if @i{x} is a number
which satisfies the @i{test}, @code{nil} if it is not.  @i{test} is not
evaluated, but @i{x} is.
@i{test} can be one of the following:

@table @code
@item l
x < 0
@item le
x  0
@item e
x = 0
@item n
x  0
@item ge
x  0
@item g
x > 0
@end table

@lisp
@exdent Examples:
(signp le 12) => t
(signp n 0) => nil
(signp g 'foo) => nil
@end lisp
@end defspec

See also the data-type predicates @code{fixp}, @code{floatp}, @code{bigp},
@code{small-floatp}, and @code{numberp} ((fixp-fun)).

All of these functions require that their arguments be numbers, and signal
an error if given a non-number.  They work on all types of numbers,
automatically performing any required coercions.

@defun = x y
Returns @code{t} if @i{x} and @i{y} are numerically equal.
@end defun

@defun greaterp x y &rest more-args
@code{greaterp} compares its arguments from left to right.  If any argument
is not greater than the next, @code{greaterp} returns @code{nil}.  But if the
arguments are monotonically strictly decreasing, the result is @code{t}.

@lisp
@exdent Examples:
(greaterp 4 3) => t
(greaterp 4 3 2 1 0) => t
(greaterp 4 3 1 2 0) => nil
@end lisp
@end defun

@defun > x y
Returns @code{t} if @i{x} is strictly greater than @i{y}, and @code{nil}
otherwise.
@end defun

@defmac >= x y
@defmacx  x y
Returns @code{t} if @i{x} is greater than or equal to @i{y}, and @code{nil}
otherwise.
@end defmac

@defun lessp x y &rest more-args
@code{lessp} compares its arguments from left to right.  If any argument
is not less than the next, @code{lessp} returns @code{nil}.  But if the
arguments are monotonically strictly increasing, the result is @code{t}.

@lisp
@exdent Examples:
(lessp 3 4) => t
(lessp 1 1) => nil
(lessp 0 1 2 3 4) => t
(lessp 0 1 3 2 4) => nil
@end lisp
@end defun

@defun < x y
Returns @code{t} if @i{x} is strictly less than @i{y}, and @code{nil}
otherwise.
@end defun

@defmac <= x y
@defmacx  x y
Returns @code{t} if @i{x} is less than or equal to @i{y}, and @code{nil}
otherwise.
@end defmac

@defmac  x y
Returns @code{t} if @i{x} is not equal to @i{y}, and @code{nil} otherwise.
@end defmac

@section Arithmetic

All of these functions require that their arguments be numbers, and signal
an error if given a non-number.  They work on all types of numbers,
automatically performing any required coercions.

@defun plus &rest args
@defunx + &rest args
@defunx +$ &rest args
Returns the sum of its arguments.  If there are no arguments, it returns
0, which is the identity for this operation.
@end defun

@defun difference arg &rest args
Returns its first argument minus all of the rest of its arguments.
@end defun

@defun - arg &rest args
@defunx -$ arg &rest args
With only one argument, @code{-} is the same as @code{minus}; it
returns the negative of its argument.
With more than one argument, @code{-} is the same as @code{difference};
it returns its first argument minus all of the rest of its arguments.
@end defun

@defun times &rest args
@defunx * &rest args
@defunx *$ &rest args
Returns the product of its arguments.  If there are no arguments, it
returns 1, which is the identity for this operation.
@end defun

@defun quotient arg &rest args
Returns the first argument divided by all of the rest of its arguments.
@end defun

@defun // arg &rest args
@defunx //$ arg &rest args
The name of this function is written @code{//} rather than @code{/} because
@code{/} is the quoting character in Lisp syntax and must be doubled.
With more than one argument, @code{//} is the same as @code{quotient};
it returns the first argument divided by all of the rest of its arguments.
With only one argument, @code{(// @i{x})} is the same as @code{(// 1 @i{x})}.

@lisp
@exdent Examples:
(// 3 2) => 1       @r{;Fixnum division truncates.}
(// 3 2.0) => 1.5
(// 3 2.0s0) => 1.5s0
(// 4 2) => 2
(// 12. 2. 3.) => 2
@end lisp
@end defun

@defun add1 x
@defunx 1+ x
@defunx 1+$ x
@code{(add1 x)} is the same as @code{(plus x 1)}.
@end defun

@defun sub1 x
@defunx 1- x
@defunx 1-$ x
@code{(sub1 x)} is the same as @code{(difference x 1)}.  Note that the
short name may be confusing: @code{(1- x)} does @i{not} mean 1-x;
rather, it means x-1.
@end defun

@defun remainder x y
@defunx \ x y
Returns the remainder of @i{x} divided by @i{y}.
@i{x} and @i{y} may not be flonums nor small flonums.
@end defun

@defun gcd x y
@defunx \\ x y
Returns the greatest common divisor of @i{x} and @i{y}.
@i{x} and @i{y} may not be flonums nor small flonums.
@end defun

@defun expt x y
@defunx ^ x y
@defunx ^$ x y
Returns @i{x} raised to the @i{y}'th power.  @i{y} must be a fixnum.
[I guess this is incompatible with Maclisp.]
@end defun

@defun exp x
Returns @i{e} raised to the @i{x}'th power, where @i{e} is the base of natural logarithms.
@end defun

@defun log x
Returns the natural logarithm of @i{x}.
@end defun

@defun sin x
Returns the sine of @i{x} in radians.
@end defun

@c bletch, do we want these in here?
@defun sind x
Returns the sine of @i{x} in degrees.
@end defun

@defun cos x
Returns the cosine of @i{x} in radians.
@end defun

@c bletch do we want these in here?
@defun cosd x
Returns the cosine of @i{x} in degrees.
@end defun

@defun sqrt x
Returns the square root of @i{x}.
@end defun

@defun atan y x
Returns the arctangent of the angle @i{y/x}. It always returns a
non-negative number between zero and /2.
@end defun

@defun atan2 y x
Returns the arctangent of the angle @i{y/x}, except that it returns a
number between -/2 and /2.
@end defun

@defun max &rest args
@code{max} returns the largest of its arguments.

@lisp
@exdent Example:
(max 1 3 2) => 3
@end lisp

@code{max} requires at least one argument.
@end defun

@defun min &rest args
@code{min} returns the smallest of its arguments.

@lisp
@exdent Example:
(min 1 3 2) => 1
@end lisp

@code{min} requires at least one argument.
@end defun

@defun abs x
Returns @code{|@i{x}|}, the absolute value of the number @i{x}.
@code{abs} could have been defined by:

@lisp
(defun abs (x)
    (cond ((minusp x) (minus x))
          (t x)))
@end lisp
@end defun

@defun minus x
Returns the negative of @i{x}.

@lisp
@exdent Examples:
(minus 1) => -1
(minus -3) => 3
@end lisp
@end defun

@defun *dif x y
@defunx *plus x y
@defunx *quo x y
@defunx *times x y
These are the internal micro-coded arithmetic functions.  There is no
reason why anyone should need to refer to these explicitly, since the
compiler knows how to generate the appropriate code for @code{plus},
@code{+}, etc.  These names are only here for Maclisp compatibility.
@end defun

The following functions are provided to allow specific conversions of data
types to be forced, when desired.

@defun fix x
Converts @i{x} from a flonum (or small-flonum) to an integer, by truncation.
The result is a fixnum or a bignum as appropriate.  If @i{x} is already
a fixnum or a bignum, it is returned unchanged.
@end defun

@defun fixr x
Converts @i{x} from a flonum (or small-flonum) to an integer, by truncation.
@end defun

@defun float x
Converts @i{x} to a flonum.  @i{x} may be a fixnum, a bignum, a small-flonum,
or a flonum.
@end defun

@defun small-float x
Converts @i{x} to a small flonum.  @i{x} may be a fixnum, a bignum, a small-flonum,
or a flonum.
@end defun

@c Lots of trig functions missing as of this writing.

@section Random Functions

@defun random &optional arg (array @code{si:random-array})
@code{(random)} returns a random fixnum, positive or negative.
If @i{arg} is present, a fixnum between 0 and @i{arg}-1 inclusive is returned.
If @i{array} is present, the given array is used instead of the default
one (see below).
[The random algorithm should be described.]
@end defun

@defun si:random-create-array size offset seed &optional (area @code{default-array-area})
Creates, initializes and returns a random-number-generator array.
This is used for more advanced applications of the pseudo-random
number generator, in which it is desirable to have several different
controllable resettable sources of random numbers.  For the exact
meaning of the arguments, read the code.
@c For now.
@i{size} is the size of the array, @i{offset} is an integer less than
@i{size}, @i{seed} is a fixnum.
This calls @code{si:random-initialize} on the random array before returning it.
@end defun

@defun si:random-initialize array
@i{array} must be a random-number-generator array, such as
is created by @code{si:random-create-array}.  It reinitializes the
contents of the array from the seed (calling @code{random} changes
the contents of the array and the pointers, but not the seed).
@end defun

@defvar si:random-array
The value of @code{si:random-array} is the default random-number-generator array.
It is created if @code{random} is called and @code{si:random-array} is unbound.
A random-number-generator array has a leader which is a structure with
the following elements:

@table @code
@item si:random-fill-pointer
The fill-pointer, the length of the array.
@item si:random-seed
The seed from which to initialize the contents.
@item si:random-pointer-1
The first pointer.
@item si:random-pointer-2
The second pointer.
@end table

@end defvar

@section Logical Operations on Numbers

Except for @code{lsh} and @code{rot}, these functions operate on either
fixnums or bignums.  @code{lsh} and @code{rot} have an inherent word-length
limitation and hence only operate on 24-bit fixnums.  Negative numbers
are operated on in their 2's-complement representation.  (Negative
numbers used to be disallowed in some cases.)

@defun logior &rest args
Returns the bit-wise logical @i{inclusive or} of its arguments.
A minimum of one argument is required.

@lisp
@exdent Example:
(logior 4002 67) => 4067
@end lisp
@end defun

@defun logxor &rest args
Returns the bit-wise logical @i{exclusive or} of its arguments.
A minimum of one argument is required.

@lisp
@exdent Example:
(logxor 2531 7777) => 5246
@end lisp
@end defun

@defun logand &rest args
Returns the bit-wise logical @i{and} of its arguments.
A minimum of one argument is required.

@lisp
@exdent Examples:
(logand 3456 707) => 406
(logand 3456 -100) => 3400
@end lisp
@end defun

@defun boole fn &rest args
@code{boole} is the generalization of @code{logand}, @code{logior}, and @code{logxor}.
@i{fn} should be a fixnum between 0 and 17 octal inclusive;
it controls the function which is computed.  If the binary representation
of @i{fn} is @i{abcd} (@i{a} is the most significant bit, @i{d} the least)
then the truth table for the Boolean operation is as follows:

@lisp
       y
   | 0  1
---------
  0| a  c
x  |
  1| b  d
@end lisp

If @code{boole} has more than three arguments, it is associated left
to right; thus,

@lisp
(boole fn x y z) = (boole fn (boole fn x y) z)
@end lisp

With two arguments, the result of @code{boole} is simply its second argument.
A minimum of two arguments is required.

@lisp
@exdent Examples:
(boole 1 x y) = (logand x y)
(boole 6 x y) = (logxor x y)
@end lisp

@code{logand}, @code{logior}, and @code{logxor} are usually preferred over @code{boole}.
@end defun

@defun bit-test x y
@code{bit-test} is a predicate which returns @code{t} if any of
the bits designated by the 1's in @i{x} are 1's in @i{y}.
@code{bit-test} is implemented as a macro which expands as follows:

@lisp
(bit-test @i{x} @i{y}) ==> (not (zerop (logand @i{x} @i{y})))
@end lisp
@end defun

@defun ldb-test ppss y
@code{ldb-test} is a predicate which returns @code{t} if any of
the bits designated by the byte specifier @i{ppss} are 1's in @i{y}.
That is, it returns @code{t} if the designated field is non-zero.
@code{ldb-test} is implemented as a macro which expands as follows:

@lisp
(ldb-test @i{ppss} @i{y}) ==> (not (zerop (ldb @i{ppss} @i{y})))
@end lisp
@end defun

@defun lsh x y
Returns @i{x} shifted left @i{y} bits if @i{y} is positive or zero,
or @i{x} shifted right @code{|@i{y}|} bits if @i{y} is negative.
Zero bits are shifted in (at either end) to fill unused positions.
@i{x} and @i{y} must be fixnums.

@lisp
@exdent Examples:
(lsh 4 1) => 10    @r{;(octal)}
(lsh 14 -2) => 3
(lsh -1 1) => -2
@end lisp
@end defun

@defun ash x y
Shifts @i{x} arithmetically left @i{y} bits, or right @i{-y} bits,
depending on the sign of @i{y}.  @i{x} may be a fixnum or a bignum.
The sign of the result is always the same as the sign of @i{x}.
@end defun

@defun rot x y
Returns @i{x} rotated left @i{y} bits if @i{y} is positive or zero,
or @i{x} rotated right @code{|@i{y}|} bits if @i{y} is negative.
The rotation considers @i{x} as a 24-bit number (unlike Maclisp,
which considers @i{x} to be a 36-bit number in both the pdp-10
and Multics implementations).
@i{x} and @i{y} must be fixnums.

@lisp
@exdent Examples:
(rot 1 2) => 4
(rot 1 -2) => 20000000
(rot -1 7) => -1
(rot 15 24.) => 15
@end lisp
@end defun

@defun haipart x n
Returns the high @i{n} bits of the binary representation of @code{|@i{x}|},
or the low @code{|@i{n}|} bits if @i{n} is negative.
@i{x} may be a fixnum or a bignum; note that if @i{x} is negative
its absolute value is used.
@c Is there a better description of this in the Maclisp manual?
@end defun

@defun haulong x
This returns the number of significant bits in @i{x}.  @i{x} may be a fixnum or a bignum.
The result does not depend on the sign of @i{x}.
The result is the least integer not less than the base-2 logarithm of @code{|@i{x}|+1}.

@lisp
@exdent Examples:
(haulong 0) => 0
(haulong 3) => 2
(haulong -7) => 3
@end lisp
@end defun

@section Byte Manipulation Functions
@cindex byte

Several functions are provided for dealing with an arbitrary-width field of
contiguous bits appearing anywhere in an integer (a fixnum or a bignum).
Such a contiguous set of bits is called a @i{byte}.  Note that
we are not using the term @i{byte} to mean eight bits, but rather
any number of bits within a number.
These functions use numbers called @i{byte specifiers} to
@cindex byte specifiers
designate a specific byte position within any word.  Byte specifiers are fixnums
whose two lowest octal digits represent the @i{size} of the
byte, and whose higher (usually two, but sometimes more)
octal digits represent the @i{position}
of the byte within a number, counting from the right in bits.  A position
of zero means that the byte is at the right end of the number.
For example, the byte-specifier 0010 (i.e., 10 octal) refers to the lowest
eight bits of a word, and the byte-specifier 1010 refers to the next eight
bits.  These byte-specifiers will be stylized below as @i{ppss}.
@cindex ppss
The maximum value of the @i{ss} digits is 27 (octal), since a byte must
fit in a fixnum although bytes can be loaded from and deposited into bignums.
(Bytes are always positive numbers.)
The format of byte-specifiers is taken from the pdp-10 byte instructions.

@defun ldb ppss num
@i{ppss} specifies a byte of @i{num}, which is returned as a number,
right-justified.  The @i{ss} bits of the byte starting at bit @i{pp}
are the lowest @i{ss} bits in the returned value, and the rest of the
bits in the returned value are zero.  The name of the function,
@code{ldb}, means "load byte".  @i{num} may be a fixnum or a bignum.

@lisp
@exdent Example:
(ldb 0306 4567) => 56
@end lisp
@end defun

@defun mask-field ppss num
This is similar to @code{ldb}; however, the specified byte
of @i{num} is returned as a number in position @i{pp} of
the returned word, instead of position 0 as with @code{ldb}.
@i{num} must be a fixnum.

@lisp
@exdent Example:
(mask-field 0306 4567) => 560
@end lisp
@end defun

@defun dpb byte ppss num
Returns a number which is the same as @i{num} except in the
bits specified by @i{ppss}.  The low
@i{ss} bits of @i{byte} are placed in those bits.  @i{byte} is interpreted as
being right-justified, as if it were the result of @code{ldb}.
@i{num} may be a fixnum or a bignum.

@lisp
@exdent Example:
(dpb 23 0306 4567) => 4237
@end lisp
@end defun

@defun deposit-field byte ppss num
This is like @code{dpb}, except that @i{byte} is not taken to
be left-justified; the @i{ppss} bits of @i{byte} are used
for the @i{ppss} bits of the result, with the rest of the
bits taken from @i{num}.  @i{num} must be a fixnum.

@lisp
@exdent Example:
(deposit-field 230 0306 4567) => 4237
@end lisp
@end defun

@defun %logldb ppss fixnum
@code{%logldb} is like @code{ldb} except that it only loads out of fixnums and
allows a byte size of 30 (octal), i.e. the whole fixnum.
@end defun

@defun %logdpb byte ppss fixnum
@code{%logdpb} is like @code{dpb} except that it only deposits into fixnums.
Using this to change the sign-bit will leave the result as a fixnum,
while @code{dpb} would produce a bignum result for arithmetic correctness.
@code{%logdpb} is good for manipulating fixnum bit-masks such as are used
in some internal system tables and data-structures.
@end defun

@section 24-Bit Numbers

Sometimes it is desirable to have a form of arithmetic which has no
overflow checking (which would produce bignums),
and truncates results to the word size of the machine.
In Lisp Machine Lisp, this is provided by the following set of functions.
Their answers are only correct modulo 2^24.

These functions should @i{not} be used for "efficiency";
they are probably less efficient than the functions which @i{do} check for
overflow.  They are intended for algorithms which require this sort of
arithmetic, such as hash functions and pseudo-random number generation.

@defun %24-bit-plus x y
Returns the sum of @i{x} and @i{y} modulo 2^24.  Both arguments should
be fixnums.
@end defun

@defun %24-bit-difference x y
Returns the difference of @i{x} and @i{y} modulo 2^24.  Both arguments should
be fixnums.
@end defun

@defun %24-bit-times x y
Returns the product of @i{x} and @i{y} modulo 2^24.  Both arguments should
be fixnums.
@end defun

@section Double-Precision Arithmetic

These peculiar functions are useful in programs that don't want to use
bignums for one reason or another.

@defun %multiply-fractions num1 num2
Returns bits 24 through 46 (the most significant half)
of the product of @i{num1} and @i{num2}.
If you call this and @code{%24-bit-times} on the same arguments @i{num1}
and @i{num2}, regarding them as integers, you can combine
the results into a double-precision product.
If @i{num1} and @i{num2} are regarded as fractions, @code{-1  @i{num} < 1},
@code{%multiply-fractions} returns 1/2 of their correct product as a fraction.
(The name of this function isn't too great.)
@end defun

@defun %divide-double dividend[24:46] dividend[0:23] divisor
Divides the double-precision number given by the first two
arguments by the third argument, and returns the single-precision
quotient.  Causes an error if division by zero or if the quotient won't
fit in single precision.
@end defun

@defun %remainder-double dividend[24:46] dividend[0:23] divisor
Divides the double-precision number given by the first two
arguments by the third argument, and returns the
remainder.  Causes an error if division by zero.
@end defun

@defun %float-double high24 low24
@i{high24} and @i{low24}, which must be fixnums, are concatenated
to produce a 48-bit unsigned positive integer.  A flonum containing the
same value is constructed and returned.  Note that only the 31 most-significant
bits are retained (after removal of leading zeroes.)  This function is
mainly for the benefit of @code{read}.
@end defun

@c DSK:LMMAN;FD.STR 65
@c This file is part of the Lisp Machine Manual.		-*-Text-*-

@chapter Strings
@cindex string

Strings are a type of array which are constants (they self-evaluate)
and have as their printed representation a sequence of characters enclosed
in quote marks, for example @code{"foo bar"}.  Strings are the right data type
to use for text-processing.

The functions described in this section provide a variety of
useful operations on strings.  Several of the functions actually work
on any type of 1-dimensional array and may be useful for other than string processing.
@code{art-16b} arrays (arrays of 16-bit positive numbers) are often used
as strings; the extra bits allow for an expanded character set.

In place of a string, most of these functions will accept a symbol or a fixnum
as an argument, and will coerce it into a string.  Given a symbol, its print name,
which is a string, will be used.  Given a fixnum, a 1 character long string
containing the character designated by that fixnum will be used.

Note that the length of a string is computed using @code{array-active-length},
so that if a string has an array-leader, element 0 of the leader (called the
@i{fill pointer}) will be taken as the length.

Since strings are arrays, the usual array-referencing function @code{aref}
is used to extract the characters of the string as fixnums.  For example,

@lisp
(aref "frob" 1) => 162  @r{;lower-case r}
@end lisp

It is also legal to store into strings (using @code{aset}).
As with @code{rplaca} on lists, this changes the actual object; one must be careful
to understand where side-effects will propagate to.

@section String Manipulation

@defun character x
@code{character} coerces @i{x} to a single character,
represented as a fixnum.  If @i{x} is a number, it is returned.  If
@i{x} is a string or an array, its first element is returned.  If
@i{x} is a symbol, the first character of its pname is returned.
Otherwise, an error occurs.
@end defun

@defun char-equal ch1 ch2
This is the primitive for comparing characters for equality;
many of the string functions call it.  @i{ch1} and @i{ch2}
must be fixnums.  The result is @code{t} if the characters are equal ignoring
case and font, otherwise @code{nil}.
@code{%%ch-char} is the byte-specifier for the portion of a character
which excludes the font information.
@end defun

@defun char-lessp ch1 ch2
This is the primitive for comparing characters for order;
many of the string functions call it.  @i{ch1} and @i{ch2}
must be fixnums.  The result is @code{t} if @i{ch1} comes before @i{ch2}
ignoring case and font, otherwise @code{nil}.
@end defun

@defvar alphabetic-case-affects-string-comparison
This variable is normally @code{nil}.  If it is @code{t}, @code{char-equal},
@code{char-lessp}, and the string searching and comparison functions will
distinguish between upper-case and lower-case letters.  It is alright
to bind this to @code{t}, but changing its global value to @code{t} will
break many system functions and user interfaces and so is not recommended.
@end defvar

@defun string x
@code{string} coerces @i{x} into a string.  Most of the string
functions apply this to their string arguments.
If @i{x} is a string or an array, it is returned.  If @i{x} is
a symbol, its pname is returned.  If @i{x} is a number, a 1-character
long string containing it is returned.  Otherwise, an error occurs.
@end defun

@defun string-length string
@code{string-length} returns the number of characters in @i{string}.  This is 1
if @i{string} is a number, the @code{array-active-length}
(see (array-active-length-fun))
if @i{string}
is an array, or the @code{array-active-length} of the pname if @i{string} is a symbol.
@end defun

@defun string-equal string1 string2 &optional (idx1 0) (idx2 0) lim1 lim2
@code{string-equal} compares two strings, returning @code{t} if
they are equal and @code{nil} if they are not.  The comparison ignores
the extra "font" bits in 16-bit strings
and ignores alphabetic case.  @code{equal} calls @code{string-equal} if
applied to two strings.

The optional arguments @i{idx1} and @i{idx2} are the starting
indices into the strings.  The optional arguments @i{lim1} and @i{lim2}
are the final indices; the comparison stops just @i{before} the final index.
@i{lim1} and @i{lim2} default to the lengths of the strings.  These arguments are provided
so that you can efficiently compare substrings.

@lisp
@exdent Examples:
(string-equal "Foo" "foo") => t
(string-equal "foo" "bar") => nil
(string-equal "element" "select" 0 1 3 4) => t
@end lisp
@end defun

@defun %string-equal string1 idx1 string2 idx2 count
@code{%string-equal} is the microcode primitive which @code{string-equal} calls.
It returns @code{t} if the @i{count} characters of @i{string1} starting
at @i{idx1} are @code{char-equal} to the @i{count} characters of @i{string2}
starting at @i{idx2}, or @code{nil} if the characters are not equal or
if @i{count} runs off the length of either array.

Instead of a fixnum, @i{count} may also be @code{nil}.  In this case,
@code{%string-equal} compares
the substring from @i{idx1} to @code{(string-length @i{string1})}
against the substring from @i{idx2} to @code{(string-length @i{string2})}.
If the lengths of these substrings differ, then they are not equal and
@code{nil} is returned.

@lisp
@exdent Examples:
@r{To compare the two strings @i{foo} and @i{bar}:}
(%string-equal @i{foo} 0 @i{bar} nil)
@r{To see if the string @i{foo} starts with the characters @code{"bar"}:}
(%string-equal @i{foo} 0 "bar" 0 3)
@end lisp
@end defun

@defun string-lessp string1 string2
@code{string-lessp} compares two strings using dictionary order.
The result is @code{t} if @i{string1} is the lesser, and @code{nil}
if they are equal or @i{string2} is the lesser.
@end defun

@defun substring string start &optional end area
This extracts a substring of @i{string}, starting at the
character specified by @i{start} and going up to but not including
the character specified by @i{end}.  @i{start} and @i{end} are
0-origin indices.  The length of the returned string is @i{end} minus
@i{start}.  If @i{end} is not specified it defaults to the length
of @i{string}.  The area in which the result is to be consed may be
optionally specified.

@lisp
@exdent Example:
(substring "Nebuchadnezzar" 4 8) => "chad"
@end lisp
@end defun

@defun nsubstring string start &optional end area
@code{nsubstring} is the same as @code{substring} except that the substring
is not copied; instead an indirect array (see (indirect-array)) is created which shares part
of the argument @i{string}.  Modifying one string will modify the other.

Note that @code{nsubstring} does not necessarily use less storage than
@code{substring}; an @code{nsubstring} of any length uses the same amount of
storage as a @code{substring} 12 characters long.
@end defun

@defun string-append &rest strings
Any number of strings are copied and concatenated into a single string.
With a single argument, @code{string-append} simply copies it.
If the first argument is an array, the result will be an array of the same type.
Thus @code{string-append} can be
used to copy and concatenate any type of 1-dimensional array.

@lisp
@exdent Example:
(string-append 41 "foo" 41) => "!foo!"
@end lisp
@end defun

@defun string-trim char-list string
This returns a @code{substring} of @i{string}, with all characters
in @i{char-list} stripped off of the beginning and end.

@lisp
@exdent Example:
(string-trim '(40) "  Dr. No  ") => "Dr. No"
@end lisp
@end defun

@defun string-left-trim char-list string
This returns a @code{substring} of @i{string}, with all characters
in @i{char-list} stripped off of the beginning.
@end defun

@defun string-right-trim char-list string
This returns a @code{substring} of @i{string}, with all characters
in @i{char-list} stripped off of the end.
@end defun

@defun char-upcase ch
If @i{ch}, which must be a fixnum, is a lower-case alphabetic
character its upper-case form is returned; otherwise, @i{ch} itself is
returned.  If font information is present it is preserved.
@end defun

@defun char-downcase ch
If @i{ch}, which must be a fixnum, is a upper-case alphabetic
character its lower-case form is returned; otherwise, @i{ch} itself is
returned.  If font information is present it is preserved.
@end defun

@defun string-upcase string
Returns a copy of @i{string}, with all lower case alphabetic
characters replaced by the corresponding upper case characters.
@end defun

@defun string-downcase string
Returns a copy of @i{string}, with all upper case alphabetic
characters replaced by the corresponding lower case characters.
@end defun

@defun string-reverse string
Returns a copy of @i{string} with the order of characters reversed.
This will reverse a 1-dimensional array of any type.
@end defun

@defun string-nreverse string
Returns @i{string} with the order of characters reversed,
smashing the original string, rather than creating a new one.
If @i{string} is a number, it is simply
returned without consing up a string.
This will reverse a 1-dimensional array of any type.
@end defun

@defun string-search-char char string &optional (from 0) to
@code{string-search-char} searches through @i{string} starting at the index @i{from},
which defaults to the beginning, and returns the index of the first
character which is @code{char-equal} to @i{char}, or @code{nil} if none is found.
If the @i{to} argument is supplied, it is used in place of @code{(string-length @i{string})}
to limit the extent of the search.

@lisp
@exdent Example:
(string-search-char 101 "banana") => 1
@end lisp
@end defun

@defun %string-search-char char string from to
@code{%string-search-char} is the microcode primitive which @code{string-search-char}
and other functions call.  @i{string} must be an array and @i{char}, @i{from},
and @i{to} must be fixnums.  Except for this lack of type-coercion, and the fact
that none of the arguments is optional, @code{%string-search-char} is the same as
@code{string-search-char}.
@end defun

@defun string-search-not-char char string &optional (from 0) to
@code{string-search-not-char} searches through @i{string} starting at the index @i{from},
which defaults to the beginning, and returns the index of the first
character which is @i{not} @code{char-equal} to @i{char}, or @code{nil} if none is found.
If the @i{to} argument is supplied, it is used in place of @code{(string-length @i{string})}
to limit the extent of the search.

@lisp
@exdent Example:
(string-search-char 102 "banana") => 1
@end lisp
@end defun

@defun string-search key string &optional (from 0) to
@code{string-search} searches for the string @i{key} in the string
@i{string}.  The search begins at @i{from}, which defaults to the
beginning of @i{string}.  The value returned is the index of the first
character of the first instance of @i{key}, or @code{nil} if none is
found.
If the @i{to} argument is supplied, it is used in place of @code{(string-length @i{string})}
to limit the extent of the search.

@lisp
@exdent Example:
(string-search "an" "banana") => 1
(string-search "an" "banana" 2) => 3
@end lisp
@end defun

@defun string-search-set char-list string &optional (from 0) to
@code{string-search-set} searches through @i{string} looking for
a character which is in @i{char-list}.  The search begins at the index @i{from},
which defaults to the beginning.  It returns the index of the first
character which is @code{char-equal} to some element of @i{char-list},
or @code{nil} if none is found.
If the @i{to} argument is supplied, it is used in place of @code{(string-length @i{string})}
to limit the extent of the search.

@lisp
@exdent Example:
(string-search-set '(116 117) "banana") => 2
@end lisp
@end defun

@defun string-search-not-set char-list string &optional (from 0) to
@code{string-search-not-set} searches through @i{string} looking for
a character which is not in @i{char-list}.  The search begins at the index @i{from},
which defaults to the beginning.  It returns the index of the first
character which is not @code{char-equal} to any element of @i{char-list},
or @code{nil} if none is found.
If the @i{to} argument is supplied, it is used in place of @code{(string-length @i{string})}
to limit the extent of the search.

@lisp
@exdent Example:
(string-search-not-set '(141 142) "banana") => 2
@end lisp
@end defun

@defun string-reverse-search-char char string &optional from (to 0)
@code{string-reverse-search-char} searches through @i{string} in reverse order, starting
from the index one less than @i{from}, which defaults to the length of @i{string},
and returns the index of the first character which is @code{char-equal}
to @i{char}, or @code{nil} if none is found.  Note that the index returned
is from the beginning of the string, although the search starts from the end.
If the @i{to} argument is supplied, it limits the extent of the search.

@lisp
@exdent Example:
(string-reverse-search-char 156 "banana") => 4
@end lisp
@end defun

@defun string-reverse-search-not-char char string &optional from (to 0)
@code{string-reverse-search-not-char} searches through @i{string} in reverse order, starting
from the index one less than @i{from}, which defaults to the length of @i{string},
and returns the index of the first character which is @i{not} @code{char-equal}
to @i{char}, or @code{nil} if none is found.  Note that the index returned
is from the beginning of the string, although the search starts from the end.
If the @i{to} argument is supplied, it limits the extent of the search.

@lisp
@exdent Example:
(string-reverse-search-not-char 101 "banana") => 4
@end lisp
@end defun

@defun string-reverse-search key string &optional from (to 0)
@code{string-reverse-search} searches for the string @i{key} in the string @i{string}.
The search proceeds in reverse order, starting
from the index one less than @i{from}, which defaults to the length of @i{string},
and returns the index of the first (leftmost) character of the first instance found,
or @code{nil} if none is found.  Note that the index returned
is from the beginning of the string, although the search starts from the end.
The @i{from} condition, restated, is that the instance of @i{key} found
is the rightmost one whose rightmost character is before the @i{from}'th character
of @i{string}.
If the @i{to} argument is supplied, it limits the extent of the search.

@lisp
@exdent Example:
(string-reverse-search "na" "banana") => 4
@end lisp
@end defun

@defun string-reverse-search-set char-list string &optional from (to 0)
@code{string-reverse-search-set} searches through @i{string} in reverse order, starting
from the index one less than @i{from}, which defaults to the length of @i{string},
and returns the index of the first character which is @code{char-equal}
to some element of @i{char-list}, or @code{nil} if none is found.
Note that the index returned
is from the beginning of the string, although the search starts from the end.
If the @i{to} argument is supplied, it limits the extent of the search.

@lisp
(string-reverse-search-set '(141 142) "banana") => 5
@end lisp
@end defun

@defun string-reverse-search-not-set char-list string &optional from (to 0)
@code{string-reverse-search-not-set} searches through @i{string} in reverse order, starting
from the index one less than @i{from}, which defaults to the length of @i{string},
and returns the index of the first character which is not @code{char-equal}
to any element of @i{char-list}, or @code{nil} if none is found.
Note that the index returned
is from the beginning of the string, although the search starts from the end.
If the @i{to} argument is supplied, it limits the extent of the search.

@lisp
(string-reverse-search-not-set '(141 156) "banana") => 0
@end lisp
@end defun

See also @code{intern} ((intern-fun)), which given a string will return "the" symbol
with that print name.

@section I/O to Strings

The special forms in this section allow you to create I/O streams which
input from or output to a string rather than a real I/O device.
See (streams) for documentation of I/O streams.

@defspec with-input-from-string
The form

@lisp
(with-input-from-string (@i{var string})
    @i{body})
@end lisp

evaluates the forms in @i{body} with the variable @i{var} bound to a stream
which reads characters from the string which is the value of the form
@i{string}.  The value of the special form is the value of the last
form in its body.

The stream is a "downward closure", so be careful what you do with it.
You cannot use it after control leaves the body, and you cannot nest
two @code{with-input-from-string} special forms and use both streams
since the special-variable bindings associated with the stream will
conflict.  It is done this way to avoid any consing.

After @i{string} you may optionally specify two additional "arguments".

@lisp
(with-input-from-string (@i{var string index})
    @i{body})
@end lisp

uses @i{index} as the starting index into the string, and updates
it when it is done to the index of the first character not read (the
length of the string if all of it was read.)  Since @i{index} is
updated it may not be a general expression; it must be a variable
or a @code{setf}-able reference.  The @i{index} is not updated
in the event of an abnormal exit from the body, such as a @code{*throw}.

Use of the @i{index} feature prevents multiple values from being
returned out of the body, currently.

@lisp
(with-input-from-string (@i{var string index limit})
    @i{body})
@end lisp

uses the value of the form @i{limit} in place of the length of the
string if it is not @code{nil}.  If you want to specify a @i{limit}
but not an @i{index}, put @code{nil} for @i{index}.
@end defspec

@defspec with-output-to-string
This special form provides a variety of ways to send output to a string
through an i/o stream.

@lisp
(with-output-to-string (@i{var})
  @i{body})
@end lisp

evaluates the forms in @i{body} with @i{var} bound to a stream
which saves the characters output to it in a string.  The value of
the special form is the string.

@lisp
(with-output-to-string (@i{var string})
  @i{body})
@end lisp

will append its output to the string which is the value of the form @i{string}.
(This is like the @code{string-nconc} function.)
The value returned is the value of the last form in the body, rather than the string.
Multiple values are not returned.  If @i{string} has an array-leader,
element 0 of the array-leader will be used as the fill-pointer.  If @i{string}
is too small to contain all the output, @code{adjust-array-size} will be used to
make it bigger.

@lisp
(with-output-to-string (@i{var string index})
  @i{body})
@end lisp

is similar to the above except that @i{index} is a variable or @code{setf}-able
reference which contains the index of the next character to be stored into.
It must be initialized outside the @code{with-output-to-string} and will be updated
upon normal exit.

The stream is a "downward closure", so be careful what you do with it.
You cannot use it after control leaves the body, and you cannot nest
two @code{with-input-from-string} special forms and use both streams
since the special-variable bindings associated with the stream will
conflict.  It is done this way to avoid any consing.
@end defspec

@section Maclisp-compatible Functions

@defun alphalessp string1 string2
@code{(alphalessp @i{string1 string2})} is equivalent to
@code{(string-lessp @i{string1 string2})}.
@end defun

@defun getchar string index
Returns the @i{index}'th character of @i{string}
as a symbol.  Note that 1-origin indexing is used.  This function
is mainly for Maclisp compatibility; @code{aref} should be used
to index into strings (however @code{aref} will not coerce symbols
or numbers into strings).
@end defun

@defun getcharn string index
Returns the @i{index}'th character of @i{string}
as a fixnum.  Note that 1-origin indexing is used.  This function
is mainly for Maclisp compatibility; @code{aref} should be used
to index into strings (however @code{aref} will not coerce symbols
or numbers into strings).
@end defun

@defun ascii x
@code{ascii} is like @code{character}, but returns a symbol
whose printname is the character instead of returning a fixnum.

@lisp
@exdent Examples:
(ascii 101) => A
(ascii 56) => /.
@end lisp

The symbol returned is interned in the @code{user} package.
@end defun

@defun maknam char-list
@code{maknam} returns
an uninterned symbol whose print-name is a string made up of the characters in @i{char-list}.

@lisp
@exdent Example:
(maknam '(a b 60 d)) => ab0d
@end lisp
@end defun

@defun implode char-list
@code{implode} is like @code{maknam} except that the returned symbol
is interned in the current package.
@end defun

The @code{samepnamep} function is also provided; see (samepnamep-fun).

@section Formatted Output
@cindex formatted output
@c Should grind be in here?

@defun format destination control-string &rest args
@code{format} is used to produce formatted output.
@code{format} outputs the characters of @i{control-string}, except
that a tilde ("~") introduces a directive.  The character after
the tilde, possibly preceded by arguments and modifiers, specifies
what kind of formatting is desired.  Some directives use one or more
elements of @i{args} to create their output.

The output is sent to @i{destination}.  If @i{destination} is
@code{nil}, a string is created which contains the output; this string is
returned as the value of the call to @code{format}.  If @i{destination} is
a stream, the output is sent to it.  If @i{destination} is @code{t}, the
output is sent to @code{standard-output}.  If @i{destination} is a string
with an array-leader, such as would be acceptable to @code{string-nconc},
the output is added to the end of that string.

A directive consists of a tilde, optional decimal numeric parameters
separated by commas, optional colon ("@code{:}") and atsign ("@code{@@}") modifiers,
and a single character indicating what kind of directive this is.
The alphabetic case of the character is ignored.
Examples of control strings:

@lisp
"~S"        ; @r{This is an S directive with no parameters.}
"~3,4:@@s"   ; @r{This is an S directive with two parameters, 3 and 4,}
            ; @r{   and both the colon and atsign flags.}
@end lisp

Sometimes a numeric parameter is used to specify a character,
for instance the padding character in a right- or left-justifying
operation.  In this case a single quote ("@code{'}") followed by the
desired character may be used as a numeric argument.  For example,
you can use

@lisp
"~5,'0d"
@end lisp

to print a decimal number in five columns with leading zeros.

The kinds of directives will now be described.
@i{arg} will be used to refer to the next argument from @i{args}.

@table @code
@item ~D
@i{arg}, a number, is printed as a decimal integer.
@code{~@i{n}D} uses a column width of @i{n}; spaces are inserted on
the left if the number requires less than @i{n} columns for its digits
and sign.  If the number doesn't fit in @i{n} columns, additional columns
are used as needed. @code{~@i{n},@i{m}D} uses @i{m} as the pad character
instead of 40 (space).  If @i{arg} is not a number, it is printed
in @code{~A} format.
The @code{@@} modifier causes the number's sign to be printed always; the default
is only to print it if the number is negative.
The @code{:} modifier causes commas to be printed between groups of three digits;
the third numeric parameter may be used to change the character used as the comma.
Thus the most general form of @code{~D} is @code{~@i{mincol},@i{padchar},@i{commachar}D}.
@item ~O
This is just like @code{~D} but prints in octal instead of decimal.

@item ~F
@i{arg} is printed in floating point.  @code{~@i{n}F} rounds @i{arg} to a precision
of @i{n} digits.  The minimum value of @i{n} is 2, since a decimal point is
always printed.  If the magnitude of @i{arg} is too large or too small, it is printed
in exponential notation.  If @i{arg} is not a number, it is printed in
@code{~A} format.

@item ~E
@i{arg} is printed in exponential notation.  This is identical to @code{~F},
including the use of a numeric parameter to specify the number of digits,
except that the number is always printed with a trailing exponent,
even if it is within a reasonable range.

@item ~A
@i{arg}, any Lisp object, is printed without slashification (like @code{princ}).
@code{~:A} prints @code{()} if @i{arg} is @code{nil}; this is useful when printing
something that is always supposed to be a list.
@code{~@i{n}A} inserts spaces on the right, if necessary, to make the
column width at least @i{n}.  The @code{@@} modifier causes the spaces
to be inserted on the left rather than the right.
@code{~@i{mincol,colinc,minpad,padchar}A} is the full form of @code{~A},
which allows elaborate control of the padding.
The string is padded on the right with at least @i{minpad} copies
of @i{padchar}; padding characters are then inserted @i{colinc} characters
at a time until the total width is at least @i{mincol}.
The defaults are 0 for @i{mincol} and @i{minpad}, 1 for @i{colinc},
and space for @i{padchar}.

@item ~S
This is just like @code{~A}, but @i{arg} is printed @i{with} slashification
(like @code{prin1} rather than @code{princ}).

@item ~C
@code{(character @i{arg})} is printed as a keyboard character (see (%%kbd)).
Any control bits are printed first by representing them with Greek letters:
alpha (Control), beta (Meta), epsilon (Control and Meta),
lambda (Hyper), pi (Super).
If the character itself is alpha, beta, epsilon, lambda, pi, or equivalence-sign,
then it is preceded by an equivalence-sign to quote it.

With the colon flag (@code{~:C}), the name of the control bits are spelled out
(e.g. "@code{Control-Meta-F}"), and also non-printing characters (those in the 200 to 377 range)
are represented by their names (e.g. "@code{Return}").

With both colon and atsign (@code{~:@@C}), the colon-only format is printed, and then
if the character requires the Top, Front, or Greek key(s) to type it,
this fact is mentioned (e.g. "@code{ (Top-L)}").

For all three of these formats,
if the character is not a keyboard character but a mouse "character",
it is printed as "Mouse-", the name of the button, "-", and the number of clicks.

With just an atsign (@code{~@@C}), the character is printed in such a way that
the READ function can understand it, using "@code{#/}" or "@code{#\}".

Examples:

@lisp
(setq a `(44 1440 403 215 611 ,(dpb 1 %%kbd-mouse 11)))
(format nil "~@{<~C>~@}" a)  =>
  "<$>< ><><
><    ><Mouse-Middle-Twice>"
(format nil "~@{<~:C>~@}" a)  =>
  "<$><Control-Meta-Space><Control-><Return><Control-Tab><Mouse-Middle-Twice>"
(format nil "~@{<~:@@C>~@}" a)  =>
  "<$><Control-Meta-Space><Control- (Top-X)><Return><Control-Tab><Mouse-Middle-Twice>"
(format nil "~@{<~@@C>~@}" a)  =>
  "<#//$><#\SPACE><#//><#\RETURN><#\TAB><#\MOUSE-M-2>"
@end lisp

@item ~%
Outputs a newline.  @code{~@i{n}%} outputs @i{n} newlines.
No argument is used.

@item ~&
The @code{:fresh-line} operation is performed on the output stream.
Unless the stream knows that it is already at the front of a line,
this outputs a newline.  @code{~@i{n}&} does a @code{:fresh-line} operation
and then outputs @i{n-1} newlines.

@item ~|
Outputs a formfeed.  @code{~@i{n}|} outputs @i{n} formfeeds.  With a @code{:},
performs a @code{:clear-screen} operation on the output stream if the stream
supports that operation; otherwise it behaves as if no @code{:} were present
(outputs formfeed(s)).

@item ~X
Outputs a space.  @code{~@i{n}X} outputs @i{n} spaces.

@item ~~
Outputs a tilde.  @code{~@i{n}~} outputs @i{n} tildes.

@item ~ <CR>
Tilde immediately followed by a carriage return ignores the carriage return
and any whitespace at the beginning of the next line.  With a @code{:}, the whitespace
is left in place.  With an @code{@@}, the carriage return is left in place.

@item ~*
@i{arg} is ignored.  @code{~@i{n}*} ignores the next @i{n} arguments.
@code{~:*} "ignores backwards"; that is, it backs up in the list
of arguments so that the argument last processed will be processed
again.  @code{~:@i{n}*} backs up @i{n} arguments.
When within a @code{~@{} construct, the ignoring (in either direction)
is relative to the list of arguments being processed by the iteration.

@item ~P
If @i{arg} is not @code{1}, a lower-case s is printed.  ("P" for "plural".)
@code{~:P} does the same thing, after doing a @code{~:*}; that is, it prints
a lower-case s if the @i{last} argument was not 1.  @code{~@@P} prints "y"
if the argument is 1, or "ies" if it is not.  @code{~:@@P} does the same thing,
but backs up first.

@item ~T
Spaces over to a given column.  @code{~@i{n},@i{m}T} will output
sufficient spaces to move the cursor to column @i{n}.  If the cursor
is already past column @i{n}, it will output spaces to move it to
column @i{n}+@i{mk}, for the smallest integer value @i{k} possible.
@i{n} and @i{m} default to @code{1}.  Without the colon flag, @i{n} and
@i{m} are in units of characters; with it, they are in units of pixels.
@i{Note}: this operation @i{only} works properly on streams that support
the @code{:read-cursorpos} and @code{:set-cursorpos} stream operations
(see (read-cursorpos)).  On other streams (and when @code{format} is creating
a string), any @code{~T} operation will simply output two spaces.

@item ~R
If there is no parameter, then @i{arg} is printed as a cardinal English number, e.g. four.
With the colon modifier, @i{arg} is printed as an ordinal number, e.g. fourth.
With the atsign modifier, @i{arg} is printed as a Roman numeral, e.g. IV.
With both atsign and colon, @i{arg} is printed as an old Roman numeral, e.g. IIII.

If there is a parameter, then it is the radix in which to print the number.
The flags and any remaining parameters are used as for the @code{~D} directive.
Indeed, @code{~D} is the same as @code{~10R}.  The full form here is therefore
@code{~@i{radix},@i{mincol},@i{padchar},@i{commachar}R}.

@item ~@i{n}G
"Goes to" the @i{n}th argument.  @code{~0G} goes back to the
first argument in @i{args}.  Directives after a @code{~@i{n}G}
will take sequential arguments after the one gone to.
When within a @code{~@{} construct, the "goto"
is relative to the list of arguments being processed by the iteration.
This is an "absolute goto"; for a "relative goto", see @code{~*}.

@item ~[@i{str0}~;@i{str1}~;@i{...}~;@i{strn}~]
This is a set of alternative control strings.  The alternatives
(called @i{clauses})
are separated by @code{~;} and the construct is terminated by @code{~]}.
For example, "@code{~[Siamese ~;Manx ~;Persian ~;Tortoise-Shell ~;Tiger
~;Yu-Hsiang ~]kitty}".  The @i{arg}th
alternative is selected; @code{0} selects the first.
If a numeric parameter is given (i.e. @code{~@i{n}[}),
then the parameter is used instead of an argument
(this is useful only if the parameter is "@code{#}").
If @i{arg} is out of range no alternative is selected.
After the selected alternative has been processed, the control string
continues after the @code{~]}.

~[@i{str0}~;@i{str1}~;@i{...}~;@i{strn}~:;@i{default}~] has a default case.
If the @i{last} @code{~;} used to separate clauses
is instead @code{~:;}, then the last clause is an "else" clause,
which is performed if no other clause is selected.
For example, "@code{~[Siamese ~;Manx ~;Persian ~;Tortoise-Shell ~;Tiger
~;Yu-Hsiang ~:;Unknown ~] kitty}".

~[~@i{tag00},@i{tag01},@i{...};@i{str0}~@i{tag10},@i{...};@i{str1...}~]
allows the clauses to have explicit tags.  The parameters to each @code{~;}
are numeric tags for the clause which follows it.  That clause is processed
which has a tag matching the argument.  If @code{~:@i{a1},@i{a2},@i{b1},@i{b2},@i{...};}
is used, then the following clause is tagged not by single values but
by ranges of values @i{a1} through @i{a2} (inclusive), @i{b1} through @i{b2}, etc.
@code{~:;} with no parameters may be used at the end to denote a default clause.
For example, "@code{~[~'+,'-,'*,'//;operator ~'A,'Z,'a,'z;letter ~'0,'9;digit ~:;other ~]}".

@code{~:[@i{false}~;@i{true}~]} selects the @i{false} control string
if @i{arg} is @code{nil}, and selects the @i{true} control string otherwise.

@code{~@@[@i{true}~]} tests the argument.  If it is not @code{nil},
then the argument is not used up, but is the next one to be processed,
and the one clause is processed.
If it is @code{nil}, then the argument is used up, and the clause is not processed.

@lisp
(setq prinlevel nil prinlength 5)
(format nil "~@@[ PRINLEVEL=~D~]~@@[ PRINLENGTH=~D]" prinlevel prinlength)
   =>  " PRINLENGTH=5"
@end lisp

@item ~;
Separates clauses in @code{~[} and @code{~<} constructions.  It is undefined elsewhere.

@item ~]
Terminates a @code{~[}.  It is undefined elsewhere.

@item ~@{@i{str}~@}
This is an iteration construct.  The argument should be a list,
which is used as a set of arguments as if for a recursive call to @code{format}.
The string @i{str} is used repeatedly as the control string.
Each iteration can absorb as many elements of the list as it likes.
If before any iteration step the list is empty, then the iteration is terminated.
Also, if a numeric parameter @i{n} is given, then there will be at most @i{n}
repetitions of processing of @i{str}.

@code{~:@{@i{str}~@}} is similar, but the argument should be a list of sublists.
At each repetition step one sublist is used as the set of arguments for
processing @i{str}; on the next repetition a new sublist is used, whether
or not all of the last sublist had been processed.

@code{~@@@{@i{str}~@}} is similar to @code{~@{@i{str}~@}}, but instead of
using one argument which is a list, all the remaining arguments
are used as the list of arguments for the iteration.

@code{~:@@@{@i{str}~@}} combines the features of @code{~:@{@i{str}~@}} and @code{~@@@{@i{str}~@}}.
All the remaining arguments
are used, and each one must be a list.
On each iteration one argument is used as a list of arguments.

Terminating the repetition construct with @code{~:@}} instead of @code{~@}}
forces @i{str} to be processed at least once even if the initial
list of arguments is null (however, it will not override an explicit
numeric parameter of zero).

If @i{str} is null, then an argument is used as @i{str}.  It must be a string,
and precedes any arguments processed by the iteration.  As an example,
the following are equivalent:

@lisp
(apply (function format) (list* stream string args))
(format stream "~1@{~:@}" string args)
@end lisp

This will use @code{string} as a formatting string.  The @code{~1@{} says it will
be processed at most once, and the @code{~:@}} says it will be processed at least once.
Therefore it is processed exactly once, using @code{args} as the arguments.
As another example, the @code{format} function itself uses @code{format-error}
(a routine internal to the @code{format} package) to signal
error messages, which in turn uses @code{ferror}, which uses @code{format} recursively.
Now @code{format-error} takes a string and arguments, just like @code{format},
but also prints some addtitional information: if the control string in @code{ctl-string}
actually is a string (it might be a list -- see below), then it prints the string
and a little arrow showing where in the processing of the control string the
error occurred.  The variable @code{ctl-index} points one character after the place of
the error.

@c @lisp
@c (DEFUN FORMAT-ERROR (STRING &REST ARGS)
@c        (COND ((STRINGP CTL-STRING)
@c            (FERROR NIL "~1@{~:@}~%~VT~%~3X/"~A/"~%"
@c                    STRING ARGS (+ CTL-INDEX 3) CTL-STRING))
@c           (T (FERROR NIL "~1@{~:@}" STRING ARGS))))
@c @end lisp

This first processes the given string and arguments using @code{~1@{~:@}}, then
tabs a variable amount for printing the down-arrow, then prints the control
string between double-quotes.  The effect is something like this:

@c @lisp
@c (format t "The item is a ~[Foo~;Bar~;Loser~]." 'quux)
@c >>ERROR: The argument to the FORMAT "~[" command must be a number
@c                    
@c    "The item is a ~[Foo~;Bar~;Loser~]."
@c ...
@c @end lisp

@item ~@}
Terminates a @code{~@{}.  It is undefined elsewhere.

@item ~^
This is an escape construct.  If there are no more arguments remaining
to be processed, then the immediately enclosing @code{~@{} or @code{~<} construct
is terminated.  (In the latter case, the @code{~<} formatting @i{is} performed, but no
more clauses are processed before doing the justification.
The @code{~^} should appear only at the @i{beginning} of a @code{~<} clause,
because it aborts the entire clause.  It may appear anywhere in a @code{~@{} construct.)
If there is no such enclosing construct, then the entire formatting operation
is terminated.

If a numeric parameter is given, then termination occurs if the parameter
is zero.  (Hence @code{~^} is the same as @code{~#^}.)  If two parameters are
given, termination occurs if they are equal.  If three are given, termination
occurs if the second is between the other two in ascending order.

If @code{~^} is used within a @code{~:@{} construct, then it merely terminates
the current iteration step (because in the standard case it tests for
remaining arguments of the current step only); the next iteration step
commences immediately.  To terminate the entire iteration process,
use @code{~:^}.

@item ~<
@code{~@i{mincol},@i{colinc},@i{minpad},@i{padchar}<@i{text}~>}
justifies @i{text} within a field @i{mincol} wide.  @i{Text}
may be divided up into clauses with @code{~;}--the
spacing is evenly divided between the text segments.
With no modifiers, the leftmost text segment is left justified in the
field, and the rightmost text segment right justified;  if there is
only one, as a special case, it is right justified.
The colon modifier causes
spacing to be introduced before the first text segment;  the atsign
modifier causes spacing to be added after the last.
@i{Minpad}, default @code{0}, is the minimum number of @i{padchar}
(default space) padding characters to be output between each segment.
If the total width needed to satisfy these constraints is greater
than @i{mincol}, then @i{mincol} is adjusted upwards in
@i{colinc} increments.  @i{Colinc} defaults to @i{1}.

@lisp
(format nil "~10<foo~;bar~>")    =>  "foo    bar"
(format nil "~10:<foo~;bar~>")   =>  "  foo  bar"
(format nil "~10:@@<foo~;bar~>")  =>  "  foo bar "
(format nil "~10<foobar~>")      =>  "    foobar"
(format nil "$~10,,'*<~3f~>" 2.59023)  =>  "$******2.59"
@end lisp

If @code{~^} is used within a @code{~<} construct, then only the clauses
which were completely processed are used.  For example:

@lisp
(format nil "~15<~S~;~^~S~;~^~S~>" 'foo)            =>  "            FOO"
(format nil "~15<~S~;~^~S~;~^~S~>" 'foo 'bar)       =>  "BAR         FOO"
(format nil "~15<~S~;~^~S~;~^~S~>" 'foo 'bar 'baz)  =>  "FOO   BAR   BAZ"
@end lisp

If the first clause of a @code{~<} is terminated with @code{~:;} instead of @code{~;},
then it is used in a special way.  All of the clauses are processed
(subject to @code{~^}, of course), but the first one is omitted in
performing the spacing and padding.  When the padded result has been
determined, then if it will fit on the current line of output, it is output,
and the text for the first clause is discarded.  If, however, the padded text
will not fit on the current line, then a newline is output, then the
text for the first clause, then the padded text.  The first clause is
always processed, and so any arguments it refers to will be used;
the decision is whether to use the resulting piece of text, not whether to
process the first clause.  If the @code{~:;} has a numeric parameter @i{n}, then
the padded text must fit on the current line with @i{n} character positions to spare
to avoid outputting the newline.
For example, the control string @code{"~%;; ~@{~<;; ~:1; ~S~>~^,~@}.~%"} can be used to
print a list of items separated by commas, without breaking items over line boundaries,
and beginning each line with "@code{;; }".  The argument 1 in @code{~:1;} accounts
for the width of the comma which will follow the justified item if it is not the last
element in the list.  If @code{~:;} has a second numeric parameter @i{m},
then @i{m} is used as the width of the line, thus overriding the natural line
width of the output stream.  To make the preceding example use a line width of 50,
one would write @code{"~%;; ~@{~<;; ~:1,30; ~S~>~^,~@}.~%"}.

@item ~>
Terminates a @code{~<}.  It is undefined elsewhere.
@end table

In place of a numeric parameter to a directive, you can put the letter
V, which takes an argument from @i{args} as a parameter to the
directive.  Normally this should be a number but it doesn't really have
to be.  This feature allows variable column-widths and the like.  Also,
you can use the character # in place of a parameter; it represents the
number of arguments remaining to be processed.  This is useful, for
example, for dealing with English conventions for printing lists:

@lisp
(setq foo "Items:~#[ none~; ~S~; ~S and ~S~:;~@@@{~#[~1; and~] ~S~^,~@}~].")
(format nil foo)  =>  "Items: none."
(format nil foo 'foo)  =>  "Items: FOO."
(format nil foo 'foo 'bar)  =>  "Items: FOO and BAR."
(format nil foo 'foo 'bar 'baz)  =>  "Items: FOO, BAR, and BAZ."
(format nil foo 'foo 'bar 'baz 'quux)  =>  "Items: FOO, BAR, BAZ, and QUUX."
@end lisp

The user can define his own directives.  How to do this is not documented
here; read the code.  Names of user-defined directives longer than one character
may be used if they are enclosed in backslashes (e.g. @code{~4,3\GRAPH\}).

@lisp
@exdent Examples:
(format nil "foo") => "foo"
(setq x 5)
(format nil "The answer is ~D." x) => "The answer is 5."
(format nil "The answer is ~3D." x) => "The answer is   5."
(setq y "elephant")
(format nil "Look at the ~A!" y) => "Look at the elephant!"
(format nil "The character ~:@@C is strange." 1003)
      => "The character Meta- (Top-X) is strange."
(setq n 3)
(format nil "~D item~P found." n n) => "3 items found."
(format nil "~R dog~:[s are~; is~] here." n (= n 1))
      => "three dogs are here."
(format nil "~R dog~[~1; is~:;s are~] here." n)
      => "three dogs are here."
(format nil "Here ~[~1;is~:;are~] ~:*~R pupp~:P." n)
      => "Here are three puppies."
@end lisp

@code{format} also allows @i{control-string} to be a list of strings
and lists, which is processed from left to right.  Strings are interpreted
as in the simple case.  Lists are taken as extended directives; the first
element is the directive letter, and the remaining elements are the numeric
parameters to the directive.  If the
car of a list is not a recognized directive, the list is simply evaluated
as a form; anything it writes to the @code{standard-output} stream will
appear in the result of @code{format}.
@end defun

@defun format:print-list destination element-format list &optional separator start-line options
This function provides a simpler interface for the specific
purpose of printing comma-separated lists with no list element
split across two lines.  @i{destination} tells where to send the output;
it can be @code{t}, @code{nil}, or a stream, as with @code{format}.
@i{element-format} is a format-control-string which tells how
to print each element of @i{list}; it is used as the body of a @code{"~@{...~@}"} construct.
@i{separator}, which defaults to @code{", "} (comma, space) is a string which goes after
each element except the last.  Format-control commands are not recommended in @i{separator}.
@i{start-line}, which defaults to three spaces, is a format-control-string which
is used as a prefix at the beginning of each line of output, except the first.
Format-control commands are allowed in @i{separator}, but they should not swallow
arguments from @i{list}.  @i{options} is a string inserted before the opening @code{"@{"};
it defaults to the null string, but allows you to insert colon and/or atsign.
@end defun

For formatting Lisp code (as opposed to text and tables), there is
the Grind package.  See (grind).

@c DSK:LMMAN;FD.ARR 80
@c This file is part of the Lisp Machine Manual.  -*-Text-*-
@c Function Description: Array Functions

@chapter Arrays
@cindex array

@c Fill pointers have to be explained.
@c Some stuff here not really documented, because it should be flushed.

@section What Arrays Are

An @i{array} is a Lisp object that consists of a group of cells,
each of which may contain a Lisp object.  The individual cells are
selected by numerical @i{subscripts}.
@cindex subscript
@cindex types of arrays

There are many types of arrays.  Some types of arrays can hold
Lisp objects of any type; the other types of arrays can only hold
fixnums.  The array types are known by a set of symbols symbols whose names
begin with "@code{art-}" (for ARray Type).

@defvar array-types
The value of @code{array-types} is a list of all of the array type symbols
such as @code{art-q}, @code{art-4b}, @code{art-string} and so on.
@end defvar

@defun array-types array-type-code
An array of the array type symbols, indexed
by their internal numeric codes.
@end defun

@defvar array-elements-per-q
@code{array-elements-per-q} is an association list (see (alist)) which
associates each array type symbol with the number of array elements
stored in one word, for an array of that type.  If the value is negative,
it is instead the number of words per array element, for arrays whose
elements are more than one word long.
@end defvar

@defun array-elements-per-q array-type-code
This is an array, indexed by the internal codes of the array types,
containing the number of array elements stored in one word, for an
array of that type.  If the value is negative,
it is instead the number of words per array element, for arrays whose
elements are more than one word long.
@end defun

@defvar array-bits-per-element
The value of @code{array-bits-per-element} is an association list (see (alist))
which associates each array type symbol with the number of
bits of unsigned number it can hold, or @code{nil} if it can
hold Lisp objects.  This can be used to tell whether an array
can hold Lisp objects or not.
@end defvar

@defun array-bits-per-element array-type-code
This is an array, indexed by the internal codes of the array types, containing
the number of bits per cell for unsigned numeric arrays, and @code{nil} for
full-Lisp-object-containing array.
@end defun

@defun array-element-size array
Given an array, returns the number of bits that fit in an element of that
array.  For non-numeric arrays, the result is 24., assuming you will be
storing unsigned fixnums in the array.
@end defun

The most commonly used type is called @code{art-q}.  An @code{art-q} array simply
holds Lisp objects of any type.

Similar to the @code{art-q} type is the @code{art-q-list}.  Like the @code{art-q},
its elements
may be any Lisp object.  The difference is that the @code{art-q-list} array "doubles"
as a list; the function @code{g-l-p} will take an @code{art-q-list} array and return
a list object whose elements are those of the array, and whose actual substance
is that of the array.  If you @code{rplaca} elements of the list, the corresponding
element of the array will change, and if you store into the array, the corresponding
element of the list will change the same way.

There is a set of types called @code{art-1b, art-2b, art-4b, art-8b}
and @code{art-16b};
these names are short for "1 bit", "2 bits", and so on.  Each element
of an @code{art-1b} array is a fixnum, and only one bit (the least significant)
is remembered in the array; all of the others are discarded.  Similarly,
in an @code{art-2b} array, only the two least significant bits are remembered.
So if you store a 5 into an @code{art-2b} array, for example, and look at it
later, you will find a 1 rather than a 5.

These arrays are used when it is known beforehand that the
fixnums which will be stored are non-negative and limited in size to a
certain number of bits.  Their advantage over the @code{art-q} array is
that they occupy less storage, because more than one element of the
array is kept in a single machine word.  (For example, 32 elements
(decimal) of an @code{art-1b} array or 2 elements of an @code{art-16b} array
will fit into one word).

Character strings are implemented by the @code{art-string} array
type.  This type acts similarly to the @code{art-8b}; its elements must be
fixnums, of which only the least significant eight bits are stored.
However, many important system functions, including @code{read},
@code{print}, and @code{eval}, treat @code{art-string} arrays very differently from
the other kinds of arrays.  These arrays are usually called
@i{string}s, and an entire chapter of this manual deals with
functions which manipulate them.

There are three types of arrays which exist only for the
purposes of @i{stack groups}; these types are called
@code{art-stack-group-head, art-special-pdl} and @code{art-reg-pdl}.  Their elements
may be any Lisp object; their use is explained in the section on
stack groups (see (stack-group)).
@cindex stack group

The @code{art-float} array type is a special purpose type whose elements
are flonums.  When storing into such an array the value will be converted to
a flonum.  The advantage of storing flonums in an @code{art-float} array rather
than an @code{art-q} array is that the numbers in an @code{art-float} array are
not true Lisp objects.  Instead the array remembers the numerical value, and
when it is @code{aref}'ed creates a Lisp object (a flonum) to hold the value.
Because the system does special storage management for bignums and flonums
that are intermediate results the use of @code{art-float} arrays can save a lot
of work for the garbage-collector and hence greatly increase performance.
An intermediate result is a Lisp object passed as an argument, stored in a local variable,
or returned as the value of a function, but not stored into a global variable,
an array, or list structure.  @code{art-float} arrays also provide a locality
of reference advantage over @code{art-q} arrays containing flonums.

@section How Arrays Work

The @i{dimensionality} of an array (or, the number of dimensions
which the array has) is the number of subscripts used to
refer to one of the elements of the array.  The dimensionality
may be any integer from one to seven, inclusively.
@c How about zero?

The lowest value for any subscript is zero; the highest value
is a property of the array.  Each dimension has a size, which is
the lowest number which is too great to be used as a subscript.
For example, in a one dimensional array of five elements, the size
of the one and only dimension is five, and the acceptable
values of the subscript are zero, one, two, three, and four.

The most basic primitive functions for handling arrays are:
@code{make-array}, which is used for the creation of arrays, @code{aref},
which is used for examining the
contents of arrays, and @code{aset}, which
is used for storing into arrays.

An array is a regular Lisp object, and it is common for an
array to be the binding of a symbol, or the car or cdr of a cons,
or, in fact, an element of an array.  Another way of handling
arrays, inherited from Maclisp, is to treat them as functions.
In this case each array has a name, which is a symbol whose function
definition is the array.  The Lisp machine supports this style by
allowing an array to be @i{applied} to arguments, as if it were a function.  The
arguments are treated as subscripts and the array is referenced
appropriately.  The @code{store} special form (see (store-fun)) is also
supported.  This form of array referencing is considered to be obsolete,
and should not be used in new programs.

Here are some issues of Maclisp compatibility:

Fixnum arrays do not exist (however, see the Lisp machine's small-positive-number
arrays).  Flonum arrays exist but you do not use them in the same way; no
declarations are required or allowed.
"Un-garbage-collected" arrays do not exist.
'c yet??? --weak links
Readtables and obarrays are represented as arrays, but unlike Maclisp special
array types are not used.  See the descriptions
of @code{read} ((read-fun)) and @code{intern} ((intern-fun)) for
information about readtables and obarrays (packages).
There are no "dead" arrays, nor are Multics "external" arrays provided.

The @code{arraycall} function is not used (see @code{aref}, (aref-fun).)

Subscripts are always checked for validity, regardless of the value
of @code{*rset} and whether the code is compiled or not.
However, in a multi-dimensional array, an error is only caused
if the subscripts would have resulted in a reference to storage
outside of the array; so if you have a 2 by 7 array and refer
to an element with subscripts 3 and 1, no error will
be caused despite the fact that the reference is invalid;
but if you refer to element 1 by 100, an error will be caused.
In other words, any subscript error which is not detected
will only refer to somewhere else in your array, and not
to any other part of storage.

Currently multi-dimensional arrays are stored in column-major order
rather than row-major order as in Maclisp.  This has an effect on
paging performance when using large arrays.  Row-major order means
that successive memory locations differ in the last subscript,
while column-major order means that successive memory locations differ
in the first subscript.

@code{loadarrays} and @code{dumparrays} are not provided.  However,
arrays can be put into "QFASL" files; see the section on fasloading
((fasload-fun)).

@section Extra Features of Arrays
@cindex array leader

Any array may have an @i{array leader}.  An array leader is
like a one-dimensional @code{art-q} array which is attached to the main array.  So
an array which has a leader acts like two arrays joined together.  It
can be stored in and examined by a special set of functions which are
analogous to those used for the main array: @code{array-leader} and
@code{store-array-leader}.  The leader is always one-dimensional, and
always can hold any kind of Lisp object, regardless of the type or
dimensionality of the array.

By convention, the zeroth element of the array leader of
an array is used to hold the number of elements in the array
that are "active" in some sense.  When the zeroth element is used
this way, it is called a @i{fill pointer}.
@cindex fill pointer

Specifically, if a string (an array of type @code{art-string}) has
seven elements, but it has a fill pointer of five, then only elements
zero through four of the string are considered to be "active";  the string's
printed representation will be five characters long, string-searching
functions will stop after the fifth element, etc.

The second element is also used in conjunction with the "named
structure" feature; see (named-structure).

@cindex displaced array
The following explanation of @i{displaced arrays}
is probably not of interest to a beginner; the section may
be passed over without losing the continuity of the manual.

Normally, an array consists of a small amount of header information,
followed by the contents of the array.  However, sometimes it is desirable
to have the header information removed from the actual contents.  One
such occasion is when the contents of the array must be located in a
special part of the Lisp Machine's address space, such as the area used
for the control of input/output devices.  Displaced arrays are also
used to reference certain special system tables, which are at fixed
addresses so the microcode can access them easily.

If you give @code{make-array} a fixnum as its fourth argument,
it will create a displaced array refering to that location of virtual memory.
References to elements of the displaced array will access that part
of storage, and return the contents; the regular @code{aref} and
@code{aset} functions are used.  If the array is one whose elements
are Lisp objects, caution should be used: if the region of address
space does not contain typed Lisp objects, the integrity of the storage
system could be damaged by the garbage collector.  If the array is one
whose elements are bytes (such as an @code{art-4b} type), then there
is no problem.  It is important to know, in this case, that the elements
of such arrays are allocated from the right to the left within the 32-bit
words.  See the description of internal array formats on (array-format).

@cindex indirect array
@cindex indirect arrays
It is also possible to have an array whose contents, instead
of being located at a fixed place in virtual memory, are defined
to be those of another array.  Such an array is called an @i{indirect array},
and is created by giving @code{make-array} an array as its fourth argument.
The effects of this are simple if both arrays have the same type; the two
arrays share all elements.  An object stored in a certain element
of one can be retrieved from the corresponding element of the other.
This, by itself, is not very useful.  However, if the arrays have
different dimensionality, the manner of accessing the elements differs.
Thus, by creating a one-dimensional array of nine elements which was
indirected to a second, two-dimensional array of three elements by three,
then the elements could be accessed in either a one-dimensional or
a two-dimensional manner.  Even more complex effects can be produced if
the new array is of a different type than the old array; see the description
of internal array formats on (array-format).

@cindex index offset
It is also possible to create a one-dimensional indirect array
in such a way that when an attempt is made to reference it or store
into it, a constant number is added to the subscript given.  This
number is called the @i{index-offset}, and is specified at the time
the indirect array is created, by giving a fixnum to @code{make-array} as
its sixth argument.  The @code{nsubstring} function (see (nsubstring-fun)) creates such
arrays.
@findex nsubstring

@section Basic Array Functions

@defun make-array area type dims &optional displaced-p leader index-offset named-structure
This creates and returns an array, according to various specifications.

The @i{area} parameter specifies the area in which to allocate
the array's storage; if you are not concerned with areas, simply use @code{nil}
which as always means the default area.

@i{type} should be a symbolic name of an array type; the most
common of these is @code{art-q}.  The elements of the array are
initialized according to the type:  if the array is of a type whose
elements may only be fixnums or flonums, then every element of the array will
initially be @code{0}; otherwise, every element will initially be
@code{nil}.  See the description of array types on (array-type).
@cindex array initialization

@i{dims} should be a list of fixnums which are the dimensions of the array;
the length of the list will be the dimensionality of the array.  For convenience,
if the dimensionality should be one, the single dimension may be provided as
a fixnum rather than a list of one fixnum.

@lisp
@exdent Examples:
(setq a (make-array nil 'art-q 5))       @r{; Create a one-d array}
                                         @r{;of 5 elements.}

(setq b (make-array nil 'art-4b '(3 4))) @r{; Create a four-bit two-d}
                                         @r{;array, 3 by 4.}
@end lisp

If @i{displaced-p} is not @code{nil}, then the array will be a @i{displaced}
array.  @i{displaced-p} may either be a fixnum, to create a regular displaced array
which refers to a certain section of virtual address space, or an array, to create
an indirect array (see (indirect-array)).
@cindex displaced array
@cindex indirect array

If @i{leader} is not @code{nil}, then the array will be given a
leader.  If @i{leader} is a fixnum, the array's leader will be
@i{leader} elements long, and its elements will be initialized to
@code{nil}.  @i{Leader} may also be a list, in which case the length of
the leader is equal to that of the list, and the elements are
initialized to the elements of the list, in reverse order (i.e., the
car of the list is stored in the highest-subscripted location in the
leader).

If @i{index-offset} is present, @i{displaced-p} should be an
array, and @i{index-offset} should be a fixnum; it is made to be the
index-offset of the created indirect array. (See (index-offset).)
@cindex index offset

If @i{named-structure} is not @code{nil}, it is a symbol to
be stored in the named-structure cell element of the array.  The array
created will be a named structure (see (named-structure).)

@lisp
@exdent Examples:
(make-array nil 'art-q 5 nil 3)   @r{;;leader 3 elements long.}
(setq a (make-array nil 'art-1b 100 nil '(t nil)))
(array-leader a 0) => nil
(array-leader a 1) => t
@end lisp
@cindex array leader

@code{make-array} returns the newly-created array, and also returns, as
a second value, the number of words allocated from @i{area} in the process
of creating the array.
@end defun

@defun array-displaced-p array
@i{array} may be any kind of array.
This predicate returns @code{t} if @i{array} is any kind of displaced array
(including indirect arrays).  Otherwise it returns @code{nil}.
@end defun

@defun array-indirect-p array
@i{array} may be any kind of array.
This predicate returns @code{t} if @i{array} is an indirect array.
Otherwise it returns @code{nil}.
@end defun

@defun array-indexed-p array
@i{array} may be any kind of array.
This predicate returns @code{t} if @i{array} is an indirect array with an index-offset.
Otherwise it returns @code{nil}.
@end defun

@defun adjust-array-size array new-size
@i{array} should be a one-dimensional array.  Its size is
changed to be @i{new-size}.  If this results in making @i{array}
smaller, then the extra elements are lost; if @i{array} is made
bigger, the new elements are initialized in the same fashion as
@code{make-array} (see (make-array-fun)): either to @code{nil} or @code{0}.
[Currently there is a bug which causes initialization to zero not to work.]

@lisp
@exdent Example:
(setq a (make-array nil 'art-q 5))
(aset 'foo a 4)
(aref a 4) => foo
(adjust-array-size a 2)
(aref a 4) => ERROR
@end lisp

If the size of the array is being increased, @code{adjust-array-size}
must allocate a new array somewhere; it then alters @i{array} so that
references to it will be made to the new array instead, by means of
an "invisible pointer".  @code{adjust-array-size} will return this
new array if it creates one, and otherwise it will return @i{array}.
Be careful about using the returned result of @code{adjust-array-size},
because you may end up holding two arrays which are not the same
(i.e., not @code{eq}) which share the same contents.
@end defun

@defun return-array array
Return @i{array} to free storage.  If it is displaced,
this returns the pointer, not the data pointed to.  Currently
does nothing if the array is not at the end of its area.
This will eventually be renamed to @code{reclaim}, when
it works for other objects than arrays.
@end defun

@defun aref array &rest subscripts
Returns the element of @i{array} selected by the @i{subscripts}.
The @i{subscripts} must be fixnums and their number must match the
dimensionality of @i{array}.
@end defun

@defun ar-1 array i
@i{array} should be a one-dimensional array, and @i{i} should be a
fixnum.  This returns the @i{i}'th element of @i{array}.
@end defun

@defun ar-2 array i j
@i{array} should be a two-dimensional array, and @i{i} and @i{j} should be
fixnums.  This returns the @i{i} by @i{j}'th element of @i{array}.
@end defun

@defun ar-3 array i j k
@i{array} should be a three-dimensional array, and @i{i}, @i{j}, and
@i{k} should be  fixnums.  This returns the @i{i} by @i{j} by @i{k}'th
element of @i{array}.
@end defun

@defun aset x array &rest subscripts
Stores @i{x} into the element of @i{array} selected by the @i{subscripts}.
The @i{subscripts} must be fixnums and their number must match the
dimensionality of @i{array}.  The returned value is @i{x}.
@end defun

@defun as-1 x array i
@i{array} should be a one-dimensional array, and @i{i} should be a
fixnum.  @i{x} may be any object.  @i{x} is stored in the @i{i}'th element
of @i{array}.  @code{as-1} returns @i{x}.
@end defun

@defun as-2 x array i j
@i{array} should be a two-dimensional array, and @i{i} and @i{j} should be
fixnums.  @i{x} may be any object.  @i{x} is stored in the @i{i} by @i{j}'th
element of @i{array}.  @code{as-2} returns @i{x}.
@end defun

@defun as-3 x array i j k
@i{array} should be a three-dimensional array, and @i{i}, @i{j}, and
@i{k} should be fixnums.  @i{x} may be any object.  @i{x} is stored in
the @i{i} by @i{j} by @i{k}'th element of @i{array}.  @code{as-3} returns
@i{x}.
@end defun

@defun aloc array &rest subscripts
Returns a locative pointer to the element-cell of @i{array} selected by
the @i{subscripts}.  The @i{subscripts} must be fixnums and their
number must match the dimensionality of @i{array}.
@end defun

@defun ap-1 array i
@i{array} should be a one-dimensional array whose elements contain Lisp
objects, and @i{i} should be a
fixnum.  This returns a locative pointer to the @i{i}'th element of
@i{array}.  See the explanation of locatives, (locative).
@end defun

@defun ap-2 array i j
@i{array} should be a two-dimensional array whose elements contain Lisp
objects, and @i{i} and @i{j}
should be  fixnums.  This returns a locative pointer to the @i{i} by
@i{j}'th element of @i{array}.  See the explanation of locatives, (locative).
@end defun

@defun ap-3 array i j k
@i{array} should be a three-dimensional array whose elements contain Lisp
objects, and @i{i}, @i{j}, and
@i{k} should be  fixnums.  This returns a locative pointer to the
@i{i} by @i{j} by @i{k}'th element of @i{array}.
See the explanation of locatives, (locative).
@end defun

The compiler turns @code{aref} into @code{ar-1}, @code{ar-2}, etc. according
to the number of subscripts specified, turns @code{aset} into @code{as-1},
@code{as-2}, etc., and turns @code{aloc} into @code{ap-1}, @code{ap-2}, etc.
For arrays with more than 3 dimensions the compiler uses the slightly less
efficient form since the special routines only exist for 1, 2, and 3 dimensions.
There is no reason for any program to call @code{ar-1}, @code{as-1}, @code{ar-2}, etc.
explicitly; they are documented because there used to be such a reason, and
many existing programs use these functions.  New programs should use @code{aref},
@code{aset}, and @code{aloc}.

@defun arraycall ignored array &rest subscripts
@code{(arraycall nil @i{array} @i{sub1} @i{sub2}...)} is the same
as @code{(aref @i{array} @i{sub1} @i{sub2}...)}.  It exists for
Maclisp compatibility.
@end defun

@defun get-list-pointer-into-array array-ref
@c This will probably be renamed, if anyone can think of a better name
The argument @i{array-ref} is ignored, but should be a reference
to an @code{art-q-list} array by applying the array to subscripts (rather
than by @code{aref}).  This returns a list object which
is a portion of the "list" of the array, beginning with the last
element of the array which has been referenced.
@end defun

@defun g-l-p array
@c This will probably be renamed, if anyone can think of a better name
@i{array} should be an @code{art-q-list} array.  This returns
a list which shares the storage of @i{array}.  The @code{art-q-list}
type exists so that @code{g-l-p} can be used.

@lisp
@exdent Example:
(setq a (make-array nil 'art-q-list 4))
(aref a 0) => nil
(setq b (g-l-p a)) => (nil nil nil nil)
(rplaca b t)
b => (t nil nil nil)
(aref a 0) => t
(aset 30 a 2)
b => (t nil 30 nil)
@end lisp
@end defun

@defun get-locative-pointer-into-array array-ref
@c This will probably be flushed?
@code{get-locative-pointer-into-array} is
similar to @code{get-list-pointer-into-array}, except that it returns a
locative, and doesn't require the array to be @code{art-q-list}.
@end defun

@defun arraydims array
@i{array} may be any array; it also may be a symbol whose
function cell contains an array, for Maclisp compatibility
(see (maclisp-array)).
It returns a list whose first element is the symbolic name of
the type of @i{array}, and whose remaining elements are its dimensions.

@lisp
@exdent Example:
(setq a (make-array nil 'art-q '(3 5)))
(arraydims a) => (art-q 3 5)
@end lisp
@end defun

@defun array-dimensions array
@code{array-dimensions} returns a list whose elements are the dimensions
of @i{array}.

@lisp
@exdent Example:
(setq a (make-array nil 'art-q '(3 5)))
(array-dimensions a) => (3 5)
@end lisp

Note: the list returned by @code{(array-dimensions @i{x})} is
equal to the cdr of the list returned by @code{(arraydims @i{x})}.
@end defun

@defun array-in-bounds-p array &rest subscripts
This function checks whether the @i{subscripts} are all
legal subscripts for @i{array}, and returns @code{t} if they
are; otherwise it returns @code{nil}.
@end defun

@defun array-length array
@i{array} may be any array.  This returns the total number
of elements in @i{array}.  For a one-dimensional array,
this is one greater than the maximum allowable subscript.
(But if fill pointers are being used, you may want to use
@code{array-active-length} (see (array-active-length-fun))).

@lisp
@exdent Example:
(array-length (make-array nil 'art-q 3)) => 3
(array-length (make-array nil 'art-q '(3 5)))
                => 17  @r{;octal, which is 15. decimal}
@end lisp
@end defun

@defun array-/#-dims array
Returns the dimensionality of @i{array}.  Note that the name of the
function includes a "#", which must be slashified if you want to be
able to compile your program with the compiler running in Maclisp.

@lisp
@exdent Example:
(array-/#-dims (make-array nil 'art-q '(3 5))) => 2
@end lisp
@end defun

@defun array-dimension-n n array
@i{array} may be any kind of array, and @i{n} should be a fixnum.
If @i{n} is between 1 and the dimensionality of @i{array},
this returns the @i{n}'th dimension of @i{array}.  If @i{n} is @code{0},
it returns the length of the leader of @i{array}; if @i{array} has no
leader it returns @code{nil}.  If @i{n} is any other value, it
returns @code{nil}.

@lisp
@exdent Examples:
(setq a (make-array nil 'art-q '(3 5) nil 7))
(array-dimension-n 1 a) => 3
(array-dimension-n 2 a) => 5
(array-dimension-n 3 a) => nil
(array-dimension-n 0 a) => 7
@end lisp
@end defun

@defun array-type array
Returns the symbolic type of @i{array}.

@lisp
@exdent Example:
(setq a (make-array nil 'art-q '(3 5)))
(array-type a) => art-q
@end lisp
@end defun

@defun fillarray array x
Note: for the present, all arrays concerned must be one-dimensional.

@i{array} may be any type of array, or, for Maclisp
compatibility, a symbol whose function cell contains an array.  There
are two forms of this function, depending on the type of @i{x}.

If @i{x} is a list, then @code{fillarray} fills up @i{array} with
the elements of @i{list}.  If @i{x} is too short to fill up all of
@i{array}, then the last element of @i{x} is used to fill the
remaining elements of @i{array}.  If @i{x} is too long, the extra
elements are ignored.

If @i{x} is an array (or, for Maclisp compatibility, a symbol
whose function cell contains an array), then the elements of @i{array} are
filled up from the elements of @i{x}.  If @i{x} is too small, then
the extra elements of @i{array} are not affected.

@code{fillarray} returns @i{array}.
@end defun

@defun listarray array &optional limit
Note: for the present, all arrays concerned must be one-dimensional.

@i{array} may be any type of array, or, for Maclisp
compatibility, a symbol whose function cell contains an array.
@code{listarray} creates and returns a list whose elements are those of
@i{array}.  If @i{limit} is present, it should be a fixnum, and only
the first @i{limit} (if there are more than that many) elements of
@i{array} are used, and so the maximum length of the returned list is
@i{limit}.
@end defun

@defun copy-array-contents from to
@i{from} and @i{to} must be arrays.  The contents of @i{from}
is copied into the contents of @i{to}, element by element.
@i{Presently the first subscript varies fastest
in multi-dimensional arrays (opposite from Maclisp).}
If @i{to} is shorter than @i{from},
the excess is ignored.  If @i{from} is shorter than
@i{to}, the rest of @i{to} is filled with @code{nil} if it
is a q-type array or 0 if it is a numeric array or 200 if it is a string.
@code{t} is always returned.

Note that even if @i{from} or @i{to} has a leader, the whole array
is used; the convention with leader element 0 being the "active" length
of the array is not used by this function.
@end defun

@defun copy-array-portion from-array from-start from-end to-array to-start to-end
The portion of the array @i{from-array} with indices greater than or
equal to @i{from-start} and less than @i{from-end} is copied into
the portion of the array @i{to-array} with indices greater than or
equal to @i{to-start} and less than @i{to-end}, element by element.
If there are more elements in @i{to-array}, the extra elements are filled as
in @code{copy-array-contents}.
@code{t} is always returned.
@end defun

@section Array Leaders
@cindex array leader

Array leaders were introduced at the beginning of the chapter.
This section presents various functions which operate on array leaders.

@defun array-has-leader-p array
@i{array} may be any array.  This predicate returns @code{t} if @i{array}
has a leader; otherwise it returns @code{nil}.
@end defun

@defun array-leader-length array
@i{array} may be any array.  This returns the length of @i{array}'s leader
if it has one, or @code{nil} if it does not.
@end defun

@defun array-leader array i
@i{array} should be an array with a leader, and @i{i} should be a
fixnum.  This returns the @i{i}'th element of @i{array}'s leader.
This is analogous to @code{aref}.
@end defun

@defun store-array-leader x array i
@i{array} should be an array with a leader, and @i{i} should be a
fixnum.  @i{x} may be any object.  @i{x} is stored in the @i{i}'th element
of @i{array}'s leader.  @code{store-array-leader} returns @i{x}.
This is analogous to @code{aset}.
@end defun

@defun ap-leader array i
@i{array} should be an array with a leader, and @i{i} should be a
fixnum.  This returns a locative pointer to the @i{i}'th element of
@i{array}'s leader.  See the explanation of locatives, (locative).
This is analogous to @code{aloc}.
@end defun

@defun array-active-length array
If @i{array} does not have a fill pointer, then this returns whatever
@code{(array-length @i{array})} would have.  If @i{array} does have a
fill pointer, @code{array-active-length} returns it.  See the general
explanation of the use of fill pointers, which is at the beginning of
this section.
@end defun

@defun array-push array x
@i{array} must be a one-dimensional array which has a fill pointer, and @i{x} may
be any object.  @code{array-push} attempts to store @i{x} in the element
of the array designated by the fill pointer, and increase the fill pointer
by one.  If the fill pointer does not designate an element of the array (specifically,
when it gets too big), it is unaffected and @code{array-push} returns @code{nil};
otherwise, the two actions (storing and incrementing) happen uninterruptibly,
and @code{array-push} returns the @i{former} value of the fill pointer
(one less than the one it leaves in the array).  If the array is of type
@code{art-q-list}, an operation similar to @code{nconc} has taken place,
in that the element has been added to the list by changing the cdr of
the formerly last element.
@end defun

@defun array-push-extend array x
@code{array-push-extend} is just like @code{array-push} except
that if the fill pointer gets too large, the array is grown
to fit the new element; i.e. it never "fails" the way @code{array-push} does,
and so never returns @code{nil}.
@end defun

@defun array-pop array
@i{array} must be a one-dimensional array which has a fill pointer.
The fill pointer is decreased by one, and the array element
designated by the new value of the fill pointer is returned.
If the new value does not designate any element of the array
(specifically, if it has reached zero), an error is caused.
The two operations (decrementing and array referencing) happen
uninterruptibly.  If the array is of type @code{art-q-list}, an operation
similar to @code{nbutlast} has taken place.
@c ??? or will, anyway.
@end defun

@defun list-array-leader array &optional limit
@i{array} may be any type of array, or, for Maclisp
compatibility, a symbol whose function cell contains an array.
@code{list-array-leader} creates and returns a list whose elements are those of
@i{array}'s leader.  If @i{limit} is present, it should be a fixnum, and only
the first @i{limit} (if there are more than that many) elements of
@i{array}'s leader are used, and so the maximum length of the returned list is
@i{limit}. If @i{array} has no leader, @code{nil} is returned.
@end defun

@defun copy-array-contents-and-leader from to
This is just like @code{copy-array-contents} (see (copy-array-contents-fun)), but the leaders
of @i{from} and @i{to} are also copied.
@end defun

@section Maclisp Array Compatibility

Note: the functions in this section should not be used in new
programs.

In Maclisp, arrays are usually kept on the @code{array} property
of symbols, and the symbols are used instead of the arrays.  In order
to provide some degree of compatibility for this manner of using
arrays, the @code{array}, @code{*array}, and @code{store} functions are
provided, and when arrays are applied to arguments, the arguments are
treated as subscripts and @code{apply} returns the corresponding element
of the array.  However, the @code{*rearray}, @code{loadarrays}, and
@code{dumparrays} functions are not provided.  Also, @code{flonum},
@code{readtable}, and @code{obarray} type arrays are not supported.

@defun array &quote symbol type &eval &rest dims
This creates an @code{art-q} type array in @code{default-array-area}
with the given dimensions.  (That is, @i{dims} is given
to @code{make-array} as its third argument.)  @i{type} is ignored.
If @i{symbol} is @code{nil}, the array is returned; otherwise,
the array is put in the function cell of @i{symbol}, and @i{symbol}
is returned.
@end defun

@defun *array symbol type &rest dims
This is just like @code{array}, except that all of the arguments
are evaluated.
@end defun

@defun store &quote array-ref x
@i{x} may be any object; @i{array-ref} should be a form which
references an array by calling it as a function (@code{aref} forms are not
acceptable).  First @i{x} is evaluated, then @i{array-ref} is
evaluated, and then the value of @i{x} is stored into the array cell
which was referenced by the evaluation of @i{array-ref}.
@end defun

@defun xstore x array-ref
This is just like @code{store}, but it is not
a special form; this is because the arguments are in the other
order.  This function only exists for the compiler to compile the
@code{store} special form, and should never be used by programs.
@end defun

@c DSK:LMMAN;FD.CLO 12
@c This file is part of the Lisp Machine manual.		-*-Text-*-

@chapter Closures
@cindex closure

A @i{closure} is a type of Lisp functional object useful
for implementing certain advanced access and control structures.
Closures give the programmer more explicit control over the
environment, by allowing him to "save up" the environment created
by the entering of a dynamic contour (i.e. a @code{lambda}, @code{do},
@code{prog}, @code{progv}, @code{let}, or any of several other special
forms), and then use that environment
elsewhere, even after the contour has been exited.

@section What a Closure Is

There is a view of lambda-binding which we will use in this
section because it makes it easier to explain what closures do.  In
this view, when a variable is bound, a new value cell is created for it.
The old value cell is saved away somewhere and is inaccessible.  Any
references to the variable will get the contents of the new value cell,
and any @code{setq}'s will change the contents of the new value cell.
When the binding is undone, the new value cell goes away, and the old
value cell, along with its contents, is restored.

For example, consider the following sequence of Lisp forms:

@lisp
(setq a 3)

((lambda (a)
    (print (+ a 6)))
 10)

(print a)
@end lisp

Initially there is a value cell for @code{a}, and the @code{setq} form makes
the contents of that value cell be @code{3}.  Then the
@code{lambda}-combination is evaluated.  @code{a} is bound to @code{10}: the old
value cell, which still contains a @code{3}, is saved away, and a new
value cell is created with @code{10} as its contents.  The reference to
@code{a} inside the @code{lambda} expression evaluates to the current binding
of @code{a}, which is the contents of its current value cell, namely
@code{10}.  So @code{16} is printed.  Then the binding is undone, discarding
the new value cell, and restoring the old value cell which still
contains a @code{3}.  The final @code{print} prints out a @code{3}.

The form @code{(closure @i{var-list} @i{function})}, where
@i{var-list} is a list of variables and @i{function} is any function,
creates and returns a closure.  When this closure is applied to some
arguments, all of the value cells of the variables on @i{var-list} are
saved away, and the value cells that those variables had @i{at the time
@code{closure} was called} are made to be the value cells of
the symbols.  Then @i{function} is applied to the argument.  (This paragraph
is somewhat complex, but it completely describes the operation of closures;
if you don't understand it, come back and read it again.)

Here is another, lower level explanation.  The closure object
stores several things inside of it.  First, it saves the @i{function}.
Secondly, for each variable in @i{var-list}, it remembers what that
variable's value cell was when the closure was created.
Then when the closure is called as a function, it first temporarily restores
the value cells it has remembered, and then applies @i{function} to the
same arguments to which the closure itself was applied.

Now, if we evaluate the form

@lisp
(setq a
      ((lambda (x)
               (closure '(x) (function car)))
       3))
@end lisp

what happens is that a new value cell is created for @code{x}, and its
contents is a fixnum @code{3}.  Then a closure is created, which remembers
the function @code{car}, the symbol @code{x}, and that value cell.
Finally the old value cell of @code{x} is restored, and the closure is
returned.  Notice that the new value cell is still around, because
it is still known about by the closure.  When the closure is applied,
this value cell will be restored and the value of @code{x} will be @code{3}.

Because of the way closures are implemented, the variables
to be closed over must not get turned into "local variables" by the compiler.
Therefore, all such variables should be declared special.

In the Lisp Machine's implementation of closures, lambda-binding
never really allocates any storage to create new value cells.  Value
cells are only created (sometimes) by the @code{closure} function itself.
Thus, implementors of large systems need not worry about storage allocation
overhead from this mechanism if they are not using closures.  See the section
on internal formats.

Lisp Machine closures are not closures in the true sense,
as they do not save the whole variable-binding environment; however,
most of that environment is irrelevant, and the explicit
declaration of which variables are to be closed allows the
implementation to have high efficiency.
They also allow the programmer to explicitly choose for each variable
whether it is to be bound at the point of call or
bound at the point of definition (e.g., creation of the closure), a choice
which is not conveniently available in other languages.  In addition the
program is clearer because the intended effect of the closure is made
manifest by listing the variables to be affected.

@section Examples of the Use of Closures

This section gives some examples of things that can be done easily
and elegantly with closures, which would be difficult to do without them.

We will start with a simple example of a generator.  A @i{generator}
is a kind of function which is called successively to obtain successive elements
of a sequence.
We will implement a function @code{make-list-generator}, which takes a list,
and returns a generator which will return successive
elements of the list.  When it gets to the end it should return @code{nil}.

The problem is that in between calls to the generator, the generator
must somehow remember where it is up to in the list.  Since all of its
bindings are undone when it is exited, it cannot save this information in
a bound variable.  It could save it in a global variable, but the problem
is that if we want to have more than one list generator at a time, they
will all try to use the same global variable and get in each other's way.

Here is how we can use closures to solve the problem:

@lisp
(defun make-list-closure (l)
    (closure '(l)
             (function (lambda ()
                               (prog1 (car l)
                                      (setq l (cdr l)))))))
@end lisp

Now we can make as many list generators as we like; they won't get
in each other's way because each has its own value cell for @code{l}.
Each of these value cells was created when the @code{make-list-closure}
function was entered, and the value cells are remembered by the closures.

@c Need more exmaples.

@section Function Descriptions

@defun closure var-list function
This creates and returns a closure of @i{function} over the variables
in @i{var-list}.  Note that all variables on @i{var-list}
must be declared special if the function is to compile correctly.
@end defun

@defun symeval-in-closure closure symbol
This returns the binding of @i{symbol} in the environment of @i{closure};
that is, it returns what you would get if you restored the value cells
known about by @i{closure} and then evaluated @i{symbol}.
This allows you to "look around inside" a closure.
@end defun

@defun set-in-closure closure symbol x
This sets the binding of @i{symbol} in the environment of @i{closure}
to @i{x}; that is, it does what would happen if you restored the value cells
known about by @i{closure} and then set @i{symbol} to @i{x}.
This allows you to change the contents of the value cells known about
by a closure.
@end defun

@defmac let-closed
When using closures, it is very common to bind a set of variables with
initial values, and then make a closure over those variables.  Furthermore
the variables must be declared as "special" for the compiler.  @code{let-closed}
expands into a form which does all of this.  It is best described by example:

@lisp
(let-closed ((a 5) b (c 'x))
   (function (lambda () ...)))

@r{expands into}

(local-declare ((special a b c))
   (let ((a 5) b (c 'x))
      (closure '(a b c)
         (function (lambda () ...)))))
@end lisp
@end defmac

@c DSK:LMMAN;FD.SG 38
@c This file is part of the Lisp Machine manual.	-*-Text-*-

@c Still need explanation of states in general, and of RG-style error checking.
@c Need examples!

@chapter Stack Groups
@cindex stack group

A @i{stack group} (usually abbreviated "SG") is a type of Lisp
object useful for implementation of certain advanced control structures
such as coroutines and generators.  A stack group represents a
computation and its internal state, including the Lisp stack.
At any time, the computation being
performed by the Lisp Machine is associated with one stack group,
called the @i{current} or @i{running} stack group.  The operation of
making some stack group be the current stack group is called a
@i{resumption} or a @i{stack group switch}; the running stack group is
said to have @i{resumed} the new stack group.  The @i{resume} operation
has two parts: first, the state of the running computation is saved
away inside the current stack group, and secondly the state saved in
the new stack group is restored, and the new stack group is made
current.  Then the computation of the new stack group resumes its
course.

The stack group remembers all functions which
were active at the time of the resumption (that is, the running
function, its caller, its caller's caller, etc.), and where
in each function the computation was up to.  In other words,
the entire control stack (or regular pdl) is saved.  In addition,
the bindings that were present are saved also; that is, the environment
stack (or special pdl) is saved.  When the state of the current
stack group is saved away, all of its bindings are undone,
and when the state is restored, the bindings are put back.
Note that although bindings are temporarily undone, unwind-protect
handlers are @i{not} run (see @code{let-globally}).

There are several ways that a resumption can happen.  First of all,
there are several Lisp functions, described below, which resume some
other stack group.  When some stack group (call it @code{c}) calls such a
function, it is suspended in the state of being in the middle of a call
to that function.  When someone eventually resumes @code{c}, the function
will return.  The arguments to these functions and the returned values
can therefore be used to pass information back and forth between stack
groups.  Secondly, if an error is signalled, the current stack group
resumes an error handler stack group, which handles the error in some
way.  Thirdly, a @i{sequence break} can happen, which  transfers
control to a special stack group called the @i{scheduler} (see (scheduler)).

Note: the following discussion of resumers is incomplete, and the
way they work is being changed anyway.

@cindex resumer
Each stack group has a @i{resumer}.  @i{c}'s resumer is some other
stack group, which essentially is the last stack group to resume @i{c}.
This is not completely right, however, because some resume-forms set the
resumed stack group's resumer, and some don't.  So @i{c}'s resumer is actually
the last stack group to resume @i{c} by means of one of the types of
resume-form which does set the resumer.

@defvar si:%current-stack-group-previous-stack-group
The binding of this variable is the resumer of the current stack group.
@end defvar

There are currently four kinds of resume-forms:

@table @r
@item 1)
If @i{c} calls @i{s} as a function with an argument @i{x}, then @i{s} is resumed,
and the object transmitted is @i{x}.  @i{s}'s resumer is now @i{c}.
@item 2)
If @i{c} evaluates @code{(stack-group-return @i{x})}, then its resumer
is resumed, and the object transmitted is @i{x}.  The resumer's resumer
is not affected.
@item 3)
If @i{c} evaluates @code{(stack-group-resume @i{s} @i{x})}, then
@i{c} is resumed, and the object transmitted is @i{x}.  @i{c}'s resumer
is not affected.  (This is not currently implemented.)
@item 4)
If the initial function of @i{c} attempts to return a value @i{x},
the regular kind of Lisp function return cannot take place, since
the function did not have any caller (it got there when the stack group
was initialized).  So instead of returning, its resumer is resumed, and
the value transmitted is @i{x}.  The resumer's resumer is not affected.
@i{c} is left in a state from which it cannot be resumed again; any
attempt to resume it would signal an error.
@end table

There is one other way a stack group can be resumed.  If the
running stack group @i{c} gets a microcode trap, then the error handler
stack group is resumed.  The object transmitted is @code{nil}, and the
error handler's resumer is set to @i{c}.  This kind of resuming will
only happen to the error handler, so regular programs should not see
it.

@section What is Going On Inside

The stack group itself holds a great deal of state information.
First of all, it contains the control stack, or "regular PDL".  The
control stack is what you are shown by the backtracing commands of the
error handler (currently the Control-B and Meta-B commands); it
remembers the function which is running, its caller, its caller's
caller, and so on, and remembers the point of execution of each function
(i.e. the "return addresses" of each function).
Secondly, it contains the environment stack, or "special PDL".
This contains all of the values saved by @code{lambda}-binding.  Finally,
it contains various internal state information (contents of machine
registers and so on).

When one stack group resumes a second, the first thing that
happens is that (some of) the state of the processor is saved in the
first stack group.  Next, all of the bindings in effect are undone;
each stack group has its own environment, and the bindings done in one
stack group do not affect another stack group at all.  Then the second
stack group's bindings are restored, its machine state is restored, and
the second stack group proceeds from where it left off.  While these
things are happening, the transmitted object is passed into the second
stack group, and optionally the second stack group's resumer is made
to be the first stack group.

@c More narrative here.

@defvar si:%current-stack-group
The value of @code{si:%current-stack-group} is the stack group which is
currently running.  A program can use this variable to get its hands
on its own stack group.
@end defvar

@defun make-stack-group name &optional options
This creates and returns a new stack group.  @i{name} may be any symbol; it is used
to identify and print the stack group.  Each option is a keyword followed by
a value for that option; any number of options may be given, including zero.
The options are not too useful; most calls to
@code{make-stack-group} don't have any options at all.
The options are:

@table @code
@item :sg-area
The area in which to create the stack group structure itself.
Defaults to @code{default-array-area}.
@item :regular-pdl-area
The area in which to create the regular PDL.  Note that this
may not be any area; only certain areas may hold regular PDL,
because accessing a regular PDL as memory must go through special
microcode which checks an internal cache called the @i{pdl buffer}.
@c Just what needs to be true of the area?
Defaults to @code{error-linear-pdl-area}.
@item :special-pdl-area
The area in which to create the special PDL.
Defaults to @code{default-array-area}.
@item :regular-pdl-size
Length of the regular PDL to be created.  Defaults to 3000.
@item :special-pdl-size
Length of the special PDL to be created.  Defaults to 400.
@item :car-sym-mode
The "error mode" which determines the action taken when there
is an attempt to apply @code{car} to a symbol.  This, and the other
"error mode" options, are documented with the fucntions @code{car}
and @code{cdr}.  Defaults to @code{1}.
@item :car-num-mode
As above, for applying @code{car} to a number.  Defaults to 0.
@item :cdr-sym-mode
As above, for applying @code{cdr} to a symbol.  Defaults to 1.
@item :cdr-num-mode
As above, for applying @code{cdr} to a number.  Defaults to 0.
@item :swap-sv-on-call-out
@item :swap-sv-of-sg-that-calls-me
@item :trap-enable
This determines what to do if a microcode error occurs.
If it is @code{1} the system tries to handle the error;
if it is @code{0} the machine halts.  Defaults to 1.
@item :safe
If @code{1} (the default), a strict call-return discipline among
stack-groups is enforced.  If @code{0}, no restriction on stack-group
switching is imposed.
@c I could explain this a lot better if I understood it.
@end table

@end defun

@defun stack-group-preset stack-group function &rest arguments
This sets up @i{stack-group} so that when it is resumed,
@i{function} will be applied to @i{arguments} within the stack group.
Both stacks are made empty.
@code{stack-group-preset} is used to initialize a stack group just after it is made,
but it may be done to any stack group at any time.
@end defun

@defun stack-group-return x
Let @i{s} be the current stack group's resumer;
@code{stack-group-return} will resume @i{s}, transmitting
the value @i{x}.  @i{s}'s resumer is not affected.
@end defun

@defun stack-group-resume s x
@code{stack-group-resume}
will resume @i{s}, transmitting the object @i{x}.  @i{s}'s
resumer is not affected.  This function is not currently implemented.
@end defun

@c Add some discussion of the screws Gosper encountered.  Discuss how
@c stack-groups relate to variables, environments, conditions, throws, etc.

@c DSK:LMMAN;FD.LOC 13
@c This file is part of the Lisp Machine Manual.	-*-Text-*-

@chapter Locatives
@cindex locative

@section Cells and Locatives
@cindex cell

A @i{locative} is a type of Lisp object used as a @i{pointer}
to a @i{cell}.  Locatives are inherently a more "low level" construct
than most Lisp objects; they require some knowledge of the nature of
the Lisp implementation.  Most programmers will never need them.

A cell is a machine word which contains a (pointer to a) Lisp object.
A symbol has five cells: the print name cell, the value cell, the
function cell, the property list cell, and the package cell.  The value
cell holds (a pointer to) the binding of the symbol, and so on.
Also, an array leader of length @i{n} has @i{n} cells, and
an array of @i{n} elements has @i{n} cells provided the array is
not a numeric array.  However, a numeric array contains a different
kind of cell, which cannot be pointed to by a locative.

There are a set of functions which create locatives to
cells; the functions are documented with the kind of object to
which they create a pointer.  See @code{ap-1}, @code{ap-leader},
@code{car-location}, @code{value-cell-location}, etc.  The macro @code{locf}
(see (locf-fun))
can be used to convert a form which accesses a cell to one which
creates a locative pointer to that cell: for example,

@lisp
(locf (fsymeval x)) ==> (function-cell-location x)
@end lisp

@section Functions Which Operate on Locatives

Either of the functions @code{car} and @code{cdr}
(see (car-fun))
may be given a locative, and will return the contents of the cell at
which the locative points.

@lisp
@r{For example,}
(car (value-cell-location x))
@r{is the same as}
(symeval x)
@end lisp

Similarly, either of the functions @code{rplaca} and @code{rplacd} may
be used to store an object into the cell at which a locative
points.

@lisp
@r{For example,}
(rplaca (value-cell-location x) y)
@r{is the same as}
(set x y)
@end lisp

If you mix locatives and lists, then it matters whether you use @code{car}
and @code{rplaca} or @code{cdr} and @code{rplacd},
and care is required.  For example, this function takes
advantage of @code{value-cell-location} to cons up a list in forward
order without special-case code.  The first time through the loop,
the @code{rplacd} is equivalent to @code{(setq res ...)}; on later times
through the loop the @code{rplacd} tacks an additional cons onto the end of the list.

@lisp
(defun sort-of-mapcar (fcn lst)
  (do ((lst lst (cdr lst))
       (res nil)
       (loc (value-cell-location 'res)))
      ((null lst) res)
    (rplacd loc
            (setq loc (ncons (funcall fcn (car lst)))))))
@end lisp

You might expect this not to work if it was compiled and @code{res}
was not declared special, since non-special compiled variables are
not represented as symbols.  However, the compiler arranges for
it to work anyway.

@c DSK:LMMAN;FD.SUB 30
@c This file is part of the Lisp Machine Manual 		-*-Text-*-

@chapter Subprimitives
@cindex subprimitives

Subprimitives are functions which are not intended to be used by
the average program, only by "system programs".  They allow one to
manipulate the environment at a level lower than normal Lisp.
Subprimitives usually have names which start with a @code{%} character.
The "primitives" described in other sections of the manual typically
use subprimitives to accomplish their work.  The subprimitives take
the place of machine language in other systems, to some extent.
Subprimitives are normally hand-coded in microcode.

Subprimitives by their very nature cannot do full checking.
Improper use of subprimitives can destroy the environment.

@section Data Types

@defun data-type arg
@code{data-type} returns a symbol which is the name
for the internal data-type of the "pointer" which represents @i{arg}.
Note that some types as seen by the user are not distinguished from each other
at this level, and some user types may be represented by more than one
internal type.

@table @code
@item si:dtp-symbol
The object is a symbol.
@item si:dtp-fix
The object is a fixnum; the numeric value is contained immediately in the pointer field.
@item si:dtp-small-flonum
The object is an immediate small floating-point number.
@item si:dtp-extended-number
The object is a flonum or a bignum.  This value will be used for future numeric
types.
@item si:dtp-list
The object is a cons.
@item si:dtp-locative
The object is a locative pointer.
@item si:dtp-array-pointer
The object is an array.
@item si:dtp-fef-pointer
The object is a fef.
@item si:dtp-u-entry
The object is a microcode entry.
@item si:dtp-closure
The object is a closure.
@item si:dtp-stack-group
The object is a stack-group.
@item si:dtp-instance
The object is an "active object".  These are not documented yet.
@item si:dtp-entity
The same as @code{dtp-closure} except it is a kind of "active object".
These are not documented yet.
@item si:dtp-select-method
Another type associated with "active objects" and not documented yet.
@item si:dtp-header
An internal type used to mark the first word of a multi-word structure.
@item si:dtp-array-header
An internal type used in arrays.
@item si:dtp-symbol-header
An internal type used to mark the first word of a symbol.
@item si:dtp-instance-header
An internal type used to mark the first word of an instance.
@item si:dtp-null
Nothing to do with @code{nil}.  This is used in unbound value and function cells.
@item si:dtp-trap
The zero data-type, which is not used.  This hopes to detect microcode errors.
@item si:dtp-free
This type is used to fill free storage, to catch wild references.
@item si:dtp-external-value-cell-pointer
An "invisible pointer" used for external value cells,
which are part of the closure mechanism (see (closure)).
and used by compiled code to address value and function cells.
@item si:dtp-header-forward
An "invisible pointer" used to indicate that the structure containing
it has been moved elsewhere.  The "header word" of the structure is
replaced by one of these invisible pointers.  See the function @code{structure-forward}
((structure-forward-fun)).
@item si:dtp-body-forward
An "invisible pointer" used to indicate that the structure containing
it has been moved elsewhere.  This points to the word containing
the header-forward, which points to the new copy of the structure.
@item si:dtp-one-q-forward
An "invisible pointer" used to indicate that the single cell containing
it has been moved elsewhere.
@item si:dtp-gc-forward
This is used by the copying garbage collector to flag old objects that
have already been copied.
@end table

@end defun

@defvar q-data-types
The value of @code{q-data-types} is a list of all of the symbolic
names for data types described above under @code{data-type}.
(the symbols whose print names begin
with "@code{dtp-}")
@end defvar

@defun q-data-types type-code
An array, indexed by the internal numeric data-type code,
which contains the corresponding symbolic names.
@end defun

@section Creating Objects

@defun make-list area size
This function makes a cdr-coded list of @code{nil}s of a
specified length in a specified area.
@i{area} is which area to create it in, which may be either a fixnum
or a symbol whose value will be used.  @i{size} is the number
of words to be allocated.  Each word has cdr code @i{cdr-next},
except for the last which has @i{cdr-nil}.

This function is to be used only for making lists.  If
making a "structure" (any data type that has a header), use one
of the two functions below.  This is because the two classes of object
must be created in different storage regions, for the sake of
system storage conventions and the garbage collector.
@end defun

@defun %allocate-and-initialize data-type header-type header second-word area size
This is the subprimitive for creating most structured-type objects.
@i{area} is the area in which it is to be created, as a fixnum or a symbol.
@i{size} is the number of words to be allocated.  The value returned
points to the first word allocated, and has data-type @i{data-type}.
Uninterruptibly, the words allocated are initialized so that storage
conventions are preserved at all times.  The first word, the header,
is initialized to have @i{header-type} in its data-type field
and @i{header} in its pointer field.  The second word is initialized
to @i{second-word}.  The remaining words are initialized to @code{nil}.
The cdr codes are initialized as in @code{make-list}, currently.
@end defun

@defun %allocate-and-initialize-array header data-length leader-length area size
This is the subprimitive for creating arrays, called only by @code{make-array}.
It is different from @code{%allocate-and-initialize} because arrays have
a more complicated header structure.
@end defun

@defun structure-forward old-object new-object
This causes references to @i{old-object} to actually reference
@i{new-object}, by storing invisible pointers in @i{old-object}.
It returns @i{old-object}.
@end defun

@defun forward-value-cell from-symbol to-symbol
This alters @i{from-symbol} so that it always has the same value
as @i{to-symbol}, by sharing its value cell.  A @i{one-q-forward}
invisible pointer is stored into @i{from-symbol}'s value cell.
Do not do this when @i{from-symbol} is @code{lambda}-bound, as
the microcode does not bother to check for that case (doing so would
make binding slower).
@end defun

@section Pointer Manipulation

It should again be emphasized that improper use of these functions
can destroy the Lisp environment, primarily because of interactions
between the garbage collector and  the illegal pointers that
can be created by these sub-primitives.

@c Narrative description of Q format, and data types, or pointer thereto.

@defun %data-type x
Returns the data-type field of @i{x}, as a fixnum.
@end defun

@defun %pointer x
Returns the pointer field of @i{x}, as a fixnum.  For most
types, this is dangerous since the garbage collector can copy the object
and change its address.
@end defun

@defun %make-pointer data-type pointer
This makes up a pointer, with @i{data-type} in the data-type
field and @i{pointer} in the pointer field, and returns it.  This is
most commonly used for changing the type of a pointer.  Do not use this
to make pointers which are not allowed to be in the machine, such as
@code{dtp-null}, invisible pointers, etc.
@end defun

@defun %make-pointer-offset data-type pointer offset
This returns a pointer with @i{data-type} in the data-type
field, and @i{pointer} plus @i{offset} in the pointer field.  The
types of the arguments are not checked, their pointer fields are simply
added together.  This is useful for constructing locative pointers
into the middle of an object.  However, note that it is illegal to
have a pointer to untyped data, such as the inside of a FEF or
a numeric array.
@end defun

@defun %pointer-difference pointer-1 pointer-2
Returns a fixnum which is @i{pointer-1} minus @i{pointer-2}.
No type checks are made.  For the result to be meaningful, the two pointers
must point into the same object, so that their difference cannot change
as a result of garbage collection.
@end defun

@defun %find-structure-header pointer
This subprimitive finds the structure into which
@i{pointer} points, by searching backward for a header.
It is a basic low-level function used by such things as the
garbage collector.
@i{pointer} is normally a locative, but its data-type is ignored.
Note that it is illegal to point into an "unboxed" portion of
a structure, for instance the middle of a numeric array.

In structure space, the "containing structure" of a pointer
is well-defined by system storage conventions.  In list space,
it is considered to be the contiguous, cdr-coded segment of
list surrounding the location pointed to.  If a cons of the list
has been copied out by @code{rplacd}, the contiguous list includes
that pair and ends at that point.
@end defun

@defun %find-structure-leader pointer
This is identical to @code{%find-structure-header}, except that if the
structure is an array with a leader, this returns a locative pointer
to the leader-header, rather than returning the array-pointer itself.
Thus the result of @code{%find-structure-leader} is always the lowest
address in the structure.  This is the one used internally by the garbage collector.
@end defun

@defun %structure-boxed-size object
Returns the number of "boxed Q's" in @i{object}.  This is the number
of words at the front of the structure which contain normal Lisp objects.
Some structures, for example FEFs and numeric arrays, containing additional
"unboxed Q's" following their "boxed Q's".
Note that the boxed size of a PDL (either regular or special) does not
include Q's above the current top of the PDL.  These locations are boxed
but their contents is considered garbage, and is not protected by the
garbage collector.
@end defun

@defun %structure-total-size object
Returns the total number of words occupied by the representation
of @i{object}.
@end defun

@section Special Memory Referencing

@defun %store-conditional pointer old new
This is the basic locking primitive.  @i{pointer} points to
a cell which is uninterruptibly read and written.  If the contents of
the cell is @code{eq} to @i{old}, then it is replaced by @i{new} and
@code{t} is returned.  Otherwise, @code{nil} is returned and the contents
of the cell is not changed.
@end defun

The following four functions are for I/O programming.

@defun %unibus-read address
Returns the contents of the register at the specified Unibus
address, as a fixnum.  You must specify a full 18-bit address.  This
is guaranteed to read the location only once.  Since the Lisp
Machine Unibus does not support byte operations, this always references
a 16-bit word, and so @i{address} will normally be an even number.
@end defun

@defun %unibus-write address data
Writes the 16-bit number @i{data} at the specified Unibus
address, exactly once.
@end defun

@defun %xbus-read io-offset
Returns a fixnum which is the low 24 bits of the contents
of the register at the specified Xbus address.  @i{io-offset} is
an offset into the I/O portion of Xbus physical address space.
This is guaranteed to read the location exactly once.
@end defun

@defun %xbus-write io-offset data
Writes the pointer field of @i{data}, which should be a fixnum,
into the register at the specified Xbus address.
The high eight bits of the word written are always zero.
@i{io-offset} is
an offset into the I/O portion of Xbus physical address space.
This is guaranteed to write the location exactly once.
@end defun

@defun %p-contents-offset base-pointer offset
This checks the cell pointed to by @i{base-pointer} for
a forwarding pointer.  Having followed forwarding pointers to the
real structure pointed to, it adds @i{offset} to the resulting
forwarded @i{base-pointer} and returns the contents of that location.
@end defun

@defun %p-contents-as-locative pointer
Given a pointer to a memory location containing a pointer which isn't
allowed to be "in the machine" (typically an invisible pointer)
this function returns the contents of the location as a @code{dtp-locative}.  I.e.
it changes the disallowed data type to locative so that you can safely
look at it and see what it points to.
@end defun

@defun %p-contents-as-locative-offset base-pointer offset
This checks the cell pointed to by @i{base-pointer} for
a forwarding pointer.  Having followed forwarding pointers to the
real structure pointed to, it adds @i{offset} to the resulting
forwarded @i{base-pointer}, fetches the contents of that location,
and returns it with the data type changed to @code{dtp-locative} in case
it was a type which isn't allowed to be "in the machine" (typically
an invisible pointer).  This is used, for example, to analyze the
@code{dtp-external-value-cell-pointer} pointers in a FEF, which are
used by the compiled code to reference value cells and function cells
of symbols.
@end defun

@defun %p-store-contents pointer value
@i{value} is stored into the data-type and pointer
fields of the location addressed by @i{pointer}.  The cdr-code
and flag-bit fields remain unchanged.  @i{value} is returned.
@end defun

@defun %p-store-contents-offset value base-pointer offset
This checks the cell pointed to by @i{base-pointer} for
a forwarding pointer.  Having followed forwarding pointers to the
real structure pointed to, it adds @i{offset} to the resulting
forwarded @i{base-pointer}, and stores @i{value} into the data-type and pointer
fields of that location.  The cdr-code
and flag-bit fields remain unchanged.  @i{value} is returned.
@end defun

@defun %p-store-tag-and-pointer pointer miscfields pntrfield
Creates a @i{Q} by taking 8 bits from @i{miscfields}
and 24 bits from @i{pntrfield}, and stores that into the
location addressed by @i{pointer}.  The low 5 bits of @i{miscfields}
become the data-type, the next bit becomes the flag-bit, and the
top two bits become the cdr-code.  This is a good
way to store a forwarding pointer from one structure
to another (for example).
@end defun

@defun %p-ldb ppss pointer
This is like @code{ldb} but gets a byte from the location
addressed by @i{pointer}.  Note that
you can load bytes out of the data type etc. bits, not just
the pointer field, and that the word loaded out of need not
be a fixnum.  The result returned is always a fixnum, unlike
@code{%p-contents} and friends.
@end defun

@defun %p-ldb-offset ppss base-pointer offset
This checks the cell pointed to by @i{base-pointer} for
a forwarding pointer.  Having followed forwarding pointers to the
real structure pointed to, the byte specified by @i{ppss} is
loaded from the contents of the location addressed by the forwarded
@i{base-pointer} plus @i{offset}, and returned as a fixnum.
This is the way to reference byte fields within a structure
without violating system storage conventions.
@end defun

@defun %p-dpb value ppss pointer
The @i{value}, a fixnum, is stored into the byte selected
by @i{ppss} in the word addressed by @i{pointer}.  @code{nil} is returned.
You can use this to alter data types, cdr codes, etc.
@end defun

@defun %p-dpb-offset value ppss base-pointer offset
This checks the cell pointed to by @i{base-pointer} for
a forwarding pointer.  Having followed forwarding pointers to the
real structure pointed to, the @i{value} is stored into the byte specified by @i{ppss} in
the location addressed by the forwarded
@i{base-pointer} plus @i{offset}.  @code{nil} is returned.
This is the way to alter unboxed data within a structure
without violating system storage conventions.
@end defun

@defun %p-mask-field ppss pointer
This is similar to @code{%p-ldb}, except that the selected
byte is returned in its original position within the word instead
of right-aligned.
@end defun

@defun %p-mask-field-offset ppss base-pointer offset
This is similar to @code{%p-ldb-offset}, except that the selected
byte is returned in its original position within the word instead
of right-aligned.
@end defun

@defun %p-deposit-field value ppss pointer
This is similar to @code{%p-dpb}, except that the selected
byte is stored from the corresponding bits of @i{value} rather than
the right-aligned bits.
@end defun

@defun %p-deposit-field-offset value ppss base-pointer offset
This is similar to @code{%p-dpb-offset}, except that the selected
byte is stored from the corresponding bits of @i{value} rather than
the right-aligned bits.
@end defun

@defun %p-pointer pointer
Extracts the pointer field of the contents of the
location addressed by @i{pointer} and returns
it as a fixnum.
@end defun

@defun %p-data-type pointer
Extracts the data-type field of the contents of the
location addressed by @i{pointer} and returns
it as a fixnum.
@end defun

@defun %p-cdr-code pointer
Extracts the cdr-code field of the contents of the
location addressed by @i{pointer} and returns
it as a fixnum.
@end defun

@defun %p-flag-bit pointer
Extracts the flag-bit field of the contents of the
location addressed by @i{pointer} and returns
it as a fixnum.
@end defun

@defun %p-store-pointer pointer value
Clobbers the pointer field of the location
addressed by @i{pointer} to @i{value}, and returns @i{value}.
@end defun

@defun %p-store-data-type pointer value
Clobbers the data-type field of the location
addressed by @i{pointer} to @i{value}, and returns @i{value}.
@end defun

@defun %p-store-cdr-code pointer value
Clobbers the cdr-code field of the location
addressed by @i{pointer} to @i{value}, and returns @i{value}.
@end defun

@defun %p-store-flag-bit pointer value
Clobbers the flag-bit field of the location
addressed by @i{pointer} to @i{value}, and returns @i{value}.
@end defun

@defun %stack-frame-pointer
Returns a locative pointer to its caller's stack frame.  This
function is not defined in the interpreted Lisp environment; it only works
from compiled code.  Since it turns into a "misc" instruction,
the "caller's stack frame" really means "the frame for the FEF
that executed the @code{%stack-frame-pointer} instruction".
@end defun

@defun bind locative value
[This will be renamed to @code{%bind} in the future.]
Binds the cell pointed to by @i{locative} to @i{x}, in
the caller's environment. This
function is not defined in the interpreted Lisp environment; it only works
from compiled code.  Since it turns into an instruction,
the "caller's environment" really means "the binding block for the FEF
that executed the @code{bind} instruction".
@end defun

@defun %halt
Stops the machine.
@end defun

@section The Paging System

@c Insert narrative description of the page hash table, etc.

[Someday this will discuss how it works.]

@defun si:wire-page address &optional (wire-p @code{t})
If @i{wire-p} is @code{t}, the page containing @i{address} is @i{wired-down}; that is,
it cannot be paged-out.  If @i{wire-p} is @code{nil}, the page ceases to be wired-down.
@end defun

@defun si:unwire-page address
@code{(si:unwire-page @i{address})} is the same as @code{(si:wire-page @i{address})}.
@end defun

@defun si:%change-page-status virtual-address swap-status access-status-and-meta-bits
The page hash table entry for the page containing @i{virtual-address}
is found and altered as specified.  @code{t} is returned if it was found,
@code{nil} if it was not (presumably the page is swapped out.)  @i{swap-status}
and @i{access-status-and-meta-bits} can be @code{nil} if those fields are not
to be changed.  This doesn't make any error checks; you can really
screw things up if you call it with the wrong arguments.
@end defun

@defun si:%compute-page-hash virtual-address
This makes the hashing function for the page hash table
available to the user.
@end defun

@defun si:%create-physical-page physical-address
This is used when adjusting the size of real memory available
to the machine.  It adds an entry for the page frame at @i{physical-address}
to the page hash table, with virtual address -1, swap status flushable,
and map status 120 (read only).  This doesn't make error checks; you
can really screw things up if you call it with the wrong arguments.
@end defun

@defun si:%delete-physical-page physical-address
If there is a page in the page frame at @i{physical-address},
it is swapped out and its entry is deleted from the page hash table,
making that page frame unavailable for swapping in of pages in the
future.  This doesn't make error checks; you
can really screw things up if you call it with the wrong arguments.
@end defun

@defun si:%disk-restore high-16-bits low-16-bits
Loads virtual memory from the partition named by the catenation of
the two 16-bit arguments, and starts executing it.  The name @code{0}
refers to the default load (the one the machine loads when it is
started up).
@end defun

@defun si:%disk-save physical-mem-size high-16-bits low-16-bits
Copies virtual memory into the partition named by the catenation
of the two 16-bit arguments (@code{0} means the default), then restarts
the world, as if it had just been restored.  The @i{physical-mem-size}
argument should come from @code{%sys-com-memory-size} in @code{system-communication-area}.
@end defun

@section Microcode Variables

The following variables' values actually reside in the scratchpad memory
of the processor.  They are put there by @code{dtp-one-q-forward} invisible
pointers.  The values of these variables are used by the microcode.

@defvar %microcode-version-number
This is the version number of the currently-loaded microcode, obtained
from the version number of the microcode source file.
@end defvar

@defvar sys:%number-of-micro-entries
Size of @code{micro-code-entry-area} and related areas.  Currently the
data-type is missing from this number.
@end defvar

@defvar default-cons-area
The area number of the default area in which new data are to be consed.
This is normally @code{working-storage-area}.
@end defvar

@defvar si:%initial-fef
The function which is called when the machine starts up.
Normally @code{si:lisp-top-level}.
@end defvar

@defvar %error-handler-stack-group
The stack group which receives control when a microcode-detected error
occurs.  This stack group cleans up, signals the appropriate condition,
or enters the debugger.
@end defvar

@defvar si:%current-stack-group
The stack group which is currently running.
@end defvar

@defvar %initial-stack-group
The stack group in which the machine starts up.
@end defvar

@defvar si:%current-stack-group-state
The @code{sg-state} of the currently-running stack group.
@end defvar

@defvar si:%current-stack-group-previous-stack-group
The resumer of the currently-running stack group.
@end defvar

@defvar si:%current-stack-group-calling-args-pointer
The argument list of the currently-running stack group.
@end defvar

@defvar si:%current-stack-group-calling-args-number
The number of arguments to the currently-running stack group.
@end defvar

@defvar si:%trap-micro-pc
The microcode address of the most recent error trap.
@end defvar

@defvar si:%count-first-level-map-reloads
The number of times the first-level virtual-memory map was invalid
and had to be reloaded from the page hash table.
@end defvar

@defvar si:%count-second-level-map-reloads
The number of times the second-level virtual-memory map was invalid
and had to be reloaded from the page hash table.
@end defvar

@defvar si:%count-pdl-buffer-read-faults
The number of read references to the pdl buffer which happened
as virtual memory references which trapped.
@end defvar

@defvar si:%count-pdl-buffer-write-faults
The number of read references to the pdl buffer which happened
as virtual memory references which trapped.
@end defvar

@defvar si:%count-pdl-buffer-memory-faults
The number of virtual memory references which trapped in case
they should have gone to the pdl buffer, but turned out to be
real memory references after all (and therefore were needlessly
slowed down.)
@end defvar

@defvar si:%count-disk-page-reads
The number of pages read from the disk.
@end defvar

@defvar si:%count-disk-page-writes
The number of pages written to the disk.
@end defvar

@defvar si:%count-disk-errors
The number of recoverable disk errors.
@end defvar

@defvar si:%count-fresh-pages
The number of fresh (newly-consed) pages created in core,
which would have otherwise been read from the disk.
@end defvar

@defvar si:%aging-rate
The number of age steps per disk read or write.  This parameter
controls how long a page must remain unreferenced before it is
evicted from main memory.
@end defvar

@defvar si:%count-aged-pages
The number of times the page ager set an age trap on a page, to determine
whether it was being referenced.
@end defvar

@defvar si:%count-age-flushed-pages
The number of times the page ager saw that a page still had an age trap
and hence made it "flushable", a candidate for eviction from main memory.
@end defvar

@defvar %mar-low
A fixnum which is the inclusive lower bound of the region of virtual
memory subject to the MAR feature.
@end defvar

@defvar %mar-high
A fixnum which is the inclusive upper bound of the region of virtual
memory subject to the MAR feature.
@end defvar

@defvar %self
The instance which has just been called.  (See (instance).)
@end defvar

@defvar %method-class
The class in which the current method was found.  (See (method).)
@end defvar

@defvar inhibit-scheduling-flag
If non-@code{nil}, no process other than the current process can
run.
@end defvar

@defvar inhibit-scavenging-flag
If non-@code{nil}, the scavenger is turned off.  The scavenger is
the quasi-asynchronous portion of the garbage collector,
which normally runs during consing operations.
@end defvar

@c DSK:LMMAN;AREAS 19
@c This file is part of the Lisp Machine manual.-*-Text-*-

@chapter Areas
@cindex area

@c What is in all value cells and function cells of the area names?

[Note: this chapter will be completely rewritten in the next edition
of this manual, to reflect the existence of the garbage collector.
The present chapter is very incomplete.]

Storage in the Lisp machine is divided into @i{areas}.
Each area contains related objects, of any type.  Areas are intended to give the
user control over the paging behavior of his program, among other
things.  By putting related data together, locality can be greatly
increased.  Whenever a new object is created, for instance with @code{cons},
the area to be used can optionally be specified.  There is a default
Working Storage area which collects those objects which the user has
not chosen to control explicitly.

Areas also give the user a handle to control the garbage
collector.  Some areas can be declared to be "static", which means that
they change slowly and the garbage collector should not attempt to
reclaim any space in them.  This can eliminate a lot of useless
copying.  All pointers out of a static area can be collected into an
"exit vector", eliminating any need for the garbage collector to look
at that area.  As an important example, an English-language dictionary
can be kept inside the Lisp without adversely affecting the speed of
garbage collection.  A "static" area can be explicitly
garbage-collected at infrequent intervals when it is believed that that
might be worthwhile.

Each area can potentially have a different storage discipline,
a different paging algorithm, and even a different data representation.
The microcode will dispatch on an attribute of the area at the
appropriate times.  The structure of the machine makes the performance
cost of these features negligible; information about areas is stored
in extra bits in the memory mapping hardware where it can be quickly
dispatched on by the microcode.  These dispatches usually have to be
done anyway to make the garbage collector work, and to implement
invisible pointers.

Since the garbage collector is not yet implemented, the features
mentioned in the previous two paragraphs are not either.  Also, with
the implementation of the garbage collector will come a new, more sophisticated
area scheme.  The two most visible effects of the new scheme will be
that garbage will be collected, and that areas will be able to shrink
and grow.  When this happens, it will be documented; stay tuned.  Most of this
chapter will become inoperative at this time, so don't depend on it.

Each area has a name and a number.  The name is a symbol whose value
is the number.  The number is an index into various internal tables.  Normally
the name is treated as a special variable, so the number is what is given
as an argument to a function that takes an area as an argument.
Thus, areas are not Lisp objects.

The following variables hold the areas most often used:

@defvar default-cons-area
The value of this variable is the number of the area to which all of the creators
of conses (@code{cons, xcons, list, append}, etc.) use by default.
It is initially the number of @code{working-storage-area}.
Note that you can either bind this variable or use functions such as
@code{cons-in-area} (see (cons-in-area-fun)) which take an area as an explicit argument.
@end defvar

@defvar default-array-area
The value of this variable is the number of the area which
@code{make-array} uses by default.  It is initially the number of
@code{working-storage-area}.
@end defvar

@defun make-area &rest keywords
Creates a new area, whose name and attributes are specified by the keywords.
You must specify a symbol as a name; the symbol will be @code{setq}'ed to
the area-number of the new area, and that number will also be returned.
The arguments are taken in pairs, the first being a keyword and the second
a "value" for that keyword.  The following keywords exist:

@table @code
@item :name
A symbol which will be the name of the area.  This item is required.
@item :size
The maximum allowed size of the area, in words.  Defaults to infinite.
@item :region-size
The approximate size, in words, for regions within this area.  The default
is the area size if a @code{:size} argument was given, otherwise a suitable
medium size.  Note that if you specify @code{:size} and not @code{:region-size},
the area will have exactly one region.
@item :representation
The type of object to be contained in the area's initial region.
The argument to this keyword can be @code{:list}, @code{:structure}, or a numeric code.
@code{:structure} is the default.
@item :gc
The type of garbage-collection to be employed.  The choices are @code{:dynamic}
(which is the default) and @code{:static}.  @code{:static} means that the area will
not be copied by the garbage collector, and nothing in the area or pointed to by
the area will ever be reclaimed.
@item :read-only
With an argument of @code{t}, causes the area to be made @i{read-only}.
@item :pdl
With an argument of @code{t}, makes the area suitable for storing
regular-pdls of stack-groups.  This is a special attribute due to the
pdl-buffer hardware.
@item :compact-cons
With an argument of @code{t}, enables the @i{at present unimplemented}
feature that @code{cons} will create cdr-coded list-structure when possible.
@item sys:%%region-map-bits
Lets you specify the @i{map bits} explicitly, overriding the specification
from the other keywords.  This is for special hacks only.
@item sys:%%region-space-type
Lets you specify the @i{space type} explicitly, overriding the specification
from the other keywords.  This is for special hacks only.
@item sys:%%region-scavenge-enable
Lets you override the scavenge-enable bit explicitly.  Don't mess with this!
@end table

@lisp
@exdent Example:
(make-area ':name 'foo-area
           ':gc ':dynamic
           ':representation ':list)
@end lisp
@end defun

@defvar area-list
The value of @code{area-list} is a list of the names of all existing areas.
This list shares storage with the internal area name table, so you should
not change it.
@end defvar

@defun %area-number pointer
Returns the number of the area to which @i{pointer} points, or @code{nil} if
it does not point within any known area.  The data-type of @i{pointer}
is ignored.
@end defun

@defun %region-number pointer
Returns the number of the region to which @i{pointer} points, or @code{nil} if
it does not point within any known region.  The data-type of @i{pointer}
is ignored.  Regions will be explained later.
@end defun

We will now list those areas with which the user may need to be concerned.
This section will be expanded later.

@defvar area-name
Indexed by area number.  Contains the area's name (a symbol).
@end defvar

@defun area-name
The function definition of @code{area-name} is an array of area names,
indexed by area numbers.
@end defun

@defvar working-storage-area
This is the normal value of @code{default-cons-area} and @code{default-array-area}.
Most working data are consed in this area.
@end defvar

@defvar permanent-storage-area
This is to be used for "permanent" data, which will (almost) never become
garbage.  Unlike @code{woring-storage-area}, the contents of this area
are not continually copied by the garbage collector.
@end defvar

@defvar sys:p-n-string
Print names are stored here.
@end defvar

@defvar sys:nr-sym
This contains most of the symbols in the Lisp world, except @code{t} and @code{nil}.
@end defvar

@defvar macro-compiled-program
FEFs are put here by the compiler and by @code{fasload}.
@end defvar

@c DSK:LMMAN;COMPIL 44
@c This file is part of the Lisp Machine manual.	-*-Text-*-

@chapter The Compiler
@cindex compiler

@section The Basic Operations of the Compiler

The purpose of the Lisp compiler is to convert Lisp functions
into programs in the Lisp Machine's instruction set, so that they
will run more quickly and take up less storage.  Compiled functions
are represented in Lisp by FEFs (Function
Entry Frames), which contain machine code as well as various other information.
The format of FEFs and the instruction set are explained in (section-fef-format).

There are three ways to invoke the compiler from the Lisp
Machine.  First, you may have an interpreted function in the Lisp
environment which you would like to compile.  The function @code{compile}
is used to do this.  Second, you may have code in an editor buffer
which you would like to compile.  The EINE editor has commands
to read code into Lisp and compile it.
Third, you may have a program (a group of function definitions and other forms) written in a
file on the file system.  The compiler can translate this file into a
QFASL file.  Loading in the QFASL file is like reading in the source
file, except that the functions in the source file will be compiled.
The @code{qc-file} function is used for translating source files into QFASL files.

@c Explain why the compiler expands macros.
@c Explain specialness versus localness, etc.

@section How to Invoke the Compiler

@defun compile symbol
@i{symbol} should be defined as an interpreted function (its definition
should be a lambda-expression).  The compiler converts the lambda-expression
into a FEF, saves the lambda-expression as the @code{:previous-expr-definition}
and @code{:previous-definition} properties of @i{symbol}, and changes @i{symbol}'s
definition to be the FEF.  (See @code{fset-carefully}, (fset-carefully-fun).
(Actually, if @i{symbol} is not defined as a lambda-expression,
@code{compile} will try to find a lambda-expression in the @code{:previous-expr-definition}
property of @i{symbol} and use that instead.)
@end defun

@defun uncompile symbol
If @i{symbol} is not defined as an interpreted function and it
has a @code{:previous-expr-definition} property, then @code{uncompile}
will restore the function cell from the value of the property.
This "undoes" the effect of @code{compile}.
@end defun

@defun qc-file filename &optional output-file load-flag in-core-flag package
The file @i{filename} is given to the compiler, and the output of the
compiler is written to a file whose name is @i{filename} except with an
FN2 of "QFASL".  The input format for files to the compiler is
described on (compiler-input-section).
Macro definitions and @code{special} declarations created during
the compilation will be undone when the compilation is
finished.

The optional arguments allow certain modifications to this procedure.
@i{output-file} lets you change where the output is written.
@i{package} lets you specify in what package the source file is to
be read.  Normally the system knows, or asks interactively,
and you need not supply this argument.
@i{load-flag} and @i{in-core-flag} are incomprehensible; you don't
want to use them.
@end defun

@defun qc-file-load filename
@code{qc-file-load} compiles a file and then loads it in.
@end defun

See also the @code{disassemble} function ((disassemble-fun)), which lists the instructions
of a compiled function in symbolic form.

The compiler can also be run in Maclisp on ITS.  On the MIT-AI
machine, type :LISPM1;QCMP.  It will type out "READY" and leave you
at a Maclisp top level.  Then type @code{(qc-file @i{filename})},
expressing @i{filename} in Maclisp form.

@lisp
@exdent Example:
(qc-file '((lispm) foo >))
@end lisp

@section Input to the Compiler
@cindex input to the compiler

The purpose of @code{qc-file} is to take a file and produce
a translated version which does the same thing as the original except
that the functions are compiled.  @code{qc-file} reads through the input
file, processing the forms in it one by one.  For each form, suitable
binary output is sent to the QFASL file so that when the QFASL file is
loaded the effect of that source form will be reproduced.  The differences
between source files and QFASL files are that QFASL files are in a compressed
binary form which reads much faster (but cannot be edited), and that
function definitions in QFASL files have been translated from S-expressions
to FEFs.

So, if the source contains a @code{(defun ...)} form at top
level, then when the QFASL file is loaded, the function will be defined
as a compiled function.  If the source file contains a form which is
not of a type known specially to the compiler, then that form will be
output "directly" into the QFASL file, so that when the QFASL file is
loaded that form will be evaluated.  Thus, if the source file contains
@code{(setq x 3)}, then the compiler will put in the QFASL file
instructions to set @code{x} to @code{3} at load time.

However, sometimes we want to put things in the file
that are not merely meant to be translated into QFASL form.
One such occasion is top level macro definitions; the macros
must actually get defined within the compiler in order that the
compiler be able to expand them at compile time.  So when a macro
form is seen, it should (sometimes) be evaluated at compile time,
and should (sometimes) be put into the QFASL file.

Another thing we sometimes want to put in a file is
compiler declarations.  These are forms which should be evaluated
at compile time to tell the compiler something.  They should
not be put into the QFASL file.

Therefore, a facility exists to allow the user to tell
the compiler just what to do with a form.  One might want a form
to be:

@table @r
@item Put into the QFASL file (translated), or not.
@item Evaluated within the compiler, or not.
@item Evaluated if the file is read directly into Lisp, or not.
@end table

Two forms are recognized by the compiler to allow this.  The less
general but Maclisp compatible one is @code{declare}; the completely
general one is @code{eval-when}.

An @code{eval-when} form looks like

@lisp
(eval-when @i{times-list}
           @i{form1}
           @i{form2}
           ...)
@end lisp

The @i{times-list} may contain any of the symbols @code{load}, @code{compile},
or @code{eval}.
If @code{load} is present, the @i{form}s are written into the QFASL file
to be evaluated when the QFASL file is loaded (except that @code{defun} forms
will put the compiled definition into the QFASL file instead).
If @code{compile} is present, the @i{form}s are evaluated in the compiler.
If @code{eval} is present, the @i{form}s are evaluated when read into Lisp;
this is because @code{eval-when} is defined as a special form in Lisp.  (The
compiler ignores @code{eval} in the @i{times-list}.)
For example, @code{(eval-when (compile eval) (macro foo (x) (cadr x)))}
would define @code{foo} as a macro in the compiler and when the file
is read in interpreted, but not when the QFASL file is fasloaded.

For the rest of this section, we will use lists such as are
given to @code{eval-when}, e.g. @code{(load eval)}, @code{(load compile)}, etc.
to describe when forms are evaluated.

A @code{declare} form looks like @code{(declare @i{form1 form2} ...)}.
@code{declare} is defined in Lisp as a special form which does nothing;
so the forms within a @code{declare} are not evaluated at @code{eval} time.
The compiler does the following upon finding @i{form} within
a @code{declare}:  if @i{form} is a call to either @code{special}
or @code{unspecial}, @i{form} is treated as @code{(load compile)};
otherwise it is treated as @code{(compile)}.

If a form is not enclosed in an @code{eval-when} nor a @code{declare},
then the times at which it will be evaluated depend on the form.
The following table summarizes at what times evaluation will take
place for any given form seen at top level by the compiler.

@table @code
@item (eval-when @i{times-list} @i{form1} ...)
@i{times-list}
@item (declare (special ...)) @r{or} (declare (unspecial ...))
@code{(load compile)}
@item (declare @i{anything-else})
@code{(compile)}
@item (special ...) @r{or} (unspecial ...)
@code{(load compile eval)}
@item (macro ...) @r{or} (defstruct ...)
@code{(load compile eval)}
@item (comment ...)
Ignored
@item (begf ...) @r{or} (endf ...)
Ignored but may one day put something in the QFASL file.
@item (compiler-let ((@i{var val}) ...) @i{body}...)
At @code{(compile eval)} time, processes the body with the indicated
variable bindings in effect.  Does nothing at @code{load} time.
@item (local-declare (@i{decl decl ...}) @i{body}...)
Processes the @i{body} in its normal fashion, with the indicated
declarations added to the front of the list which is the value
of @code{local-declarations}.
@item @i{anything-else}
@code{(load eval)}
@end table

Sometimes a macro wants to return more than one form
for the compiler top level to see (and to be evaluated).  The following
facility is provided for such macros.  If a form

@lisp
(progn (quote compile) @i{form1} @i{form2} ...)
@end lisp

is seen at the compiler top level, all of the @i{form}s are processed as if they had been at
compiler top level.  (Of course, in the interpreter they
will all be evaluated, and the @code{(quote compile)} will harmlessly
evaluate to the symbol @code{compile} and be ignored.)

@defspec eval-when
An @code{eval-when} form looks like

@lisp
(eval-when @i{times-list} @i{form1} @i{form2} ...)
@end lisp

If one of the element of @i{times-list} is the symbol @code{eval}, then
the @i{form}s are evaluated; otherwise @code{eval-when} does nothing.

But when seen by the compiler, this special form does the special things described above.
@end defspec

@defspec declare
@code{declare} does nothing, and returns the symbol @code{declare}.

But when seen by the compiler, this special form does the special things described above.
@end defspec

@section Compiler Declarations

This section describes functions meant to be called during
compilation, and variables meant to be set or bound during compilation,
by using @code{declare} or @code{local-declare}.

@defspec local-declare
A @code{local-declare} form looks like

@lisp
(local-declare (@i{decl1} @i{decl2} ...)
   @i{form1}
   @i{form2}
   ...)
@end lisp

Each @i{decl} is consed onto the list @code{local-declarations} while
the @i{form}s are being evaluated (in the interpreter) or compiled
(in the compiler).  There are two uses for this.  First, it can be
used to pass information from outer macros to inner macros.  Secondly,
the compiler will specially interpret certain @i{decl}s as local
declarations, which only apply to the compilations of the @i{form}s.
It understands the following forms:

@table @code
@item (special @i{var1 var2 ...})
The variables @i{var1}, @i{var2}, etc. will be treated as special
variables during the compilation of the @i{form}s.
@item (unspecial @i{var1 var2 ...})
The variables @i{var1}, @i{var2}, etc. will be treated as local
variables during the compilation of the @i{form}s.
@item (macro @i{name} lambda (x) @i{body})
@i{name} will be defined as a macro during the compilation
of the @i{form}s.  Note that the @code{cddr} of this item
is a function.
@end table

@end defspec

@defspec special
@code{(special @i{var1} @i{var2} ...)} causes the variables to
be declared to be "special" for the compiler.
@end defspec

@defspec unspecial
@code{(unspecial @i{var1} @i{var2} ...)} removes any "special" declarations
of the variables for the compiler.
@end defspec

The next three declarations are primarily for Maclisp compatibility.

@defspec *expr
@code{(*expr @i{sym1} @i{sym2} ...)} declares @i{sym1}, @i{sym2}, etc.
to be names of functions.  In addition it prevents these functions from appearing
in the list of functions referenced but not defined printed at the end of the compilation.
@end defspec

@defspec *lexpr
@code{(*lexpr @i{sym1} @i{sym2} ...)} declares @i{sym1}, @i{sym2}, etc.
to be names of functions.  In addition it prevents these functions from appearing
in the list of functions referenced but not defined printed at the end of the compilation.
@end defspec

@defspec *fexpr
@code{(*fexpr @i{sym1} @i{sym2} ...)} declares @i{sym1}, @i{sym2}, etc.
to be names of special forms.  In addition it prevents these names from appearing
in the list of functions referenced but not defined printed at the end of the compilation.
@end defspec

There are some advertised variables whose compile-time values affect
the operation of the compiler.  The user may set these variables by
including in his file forms such as

@lisp
(declare (setq open-code-map-switch t))
@end lisp

@defvar run-in-maclisp-switch
If this variable is non-@code{nil}, the compiler will try to warn the
user about any constructs which will not work in Maclisp.  By no means
will all Lisp machine system functions not built in to Maclisp be
cause for warnings;  only those which could not be written by the user
in Maclisp (for example, @code{*catch}, @code{make-array},
@code{value-cell-location}, etc.).  Also, lambda-list keywords such as
@code{&optional} and initialized @code{prog} variables will be
mentioned.  This switch also inhibits the warnings for obsolete Maclisp functions.
The default value of this variable is @code{nil}.
@end defvar

@defvar obsolete-function-warning-switch
If this variable is non-@code{nil}, the compiler will try to warn
the user whenever an "obsolete" Maclisp-compatibility function such as
@code{maknam} or @code{samepnamep} is used.  The default value is @code{t}.
@end defvar

@defvar allow-variables-in-function-position-switch
If this variable is non-@code{nil}, the compiler allows the use of
the name of a variable in function position to mean that the
variable's value should be @code{funcall}'d.  This is for compatibility
with old Maclisp programs.  The default value of this variable is
@code{nil}.
@end defvar

@defvar open-code-map-switch
If this variable is non-@code{nil}, the compiler will attempt
to produce inline code for the mapping functions (@code{mapc}, @code{mapcar}, etc.,
but not @code{mapatoms}) if the function being mapped is an anonymous
lambda-expression.  This allows that function to reference
the local variables of the enclosing function without the need for special
declarations.
The generated code is also more efficient.  The default value is T.
@end defvar

@defvar all-special-switch
If this variable is non-@code{nil}, the compiler regards all variables
as special, regardless of how they were declared.  This provides full
compatibility with the interpreter at the cost of efficiency.
The default is @code{nil}.
@end defvar

@defvar inhibit-style-warnings-switch
If this variable is non-@code{nil}, all compiler style-checking is
turned off.  Style checking is used to issue obsolete function
warnings and won't-run-in-Maclisp warnings, and other sorts of
warnings.  The default value is @code{nil}.  See also the
@code{inhibit-style-warnings} macro, which acts on one level only of an
expression.
@end defvar

@defvar retain-variable-names-switch
This controls whether the generated FEFs remember the names of the variables
in the function; such information is useful for debugging
(the @code{arglist} function uses it, see (arglist-fun)), but it increases
the size of the QFASL file and the FEFs created.  The variable
may be any of

@table @code
@item nil
No names are saved.
@item args
Names of arguments are saved.
@item all
Names of arguments and @code{&aux} variables are saved.
@end table

The default value of this symbol is @code{args}, and it should usually be
left that way.
@end defvar

@defmac compiler-let
@code{(compiler-let ((@i{variable value})...) @i{body}...)},
syntactically identical to @code{let}, allows
compiler switches to be bound locally at compile time, during the
processing of the @i{body} forms.

@lisp
@exdent Example:
(compiler-let ((open-code-map-switch nil))
          (map (function (lambda (x) ...)) foo))
@end lisp

will prevent the compiler from open-coding the @code{map}.
When interpreted, @code{compiler-let} is equivalent to @code{let}.  This
is so that global switches which affect the behavior of macro
expanders can be bound locally.
@end defmac

@defmac inhibit-style-warnings
@code{(inhibit-style-warnings @i{form})}
prevents the compiler from performing style-checking on the top level
of @i{form}.  Style-checking will still be done on the arguments of @i{form}.
Both obsolete function warnings and won't-run-in-Maclisp warnings are
done by means of the style-checking mechanism, so, for example,

@lisp
(setq bar (inhibit-style-warnings (value-cell-location foo)))
@end lisp

will not warn that @code{value-cell-location} will not work in Maclisp,
but

@lisp
(inhibit-style-warnings (setq bar (value-cell-location foo)))
@end lisp

will warn, since @code{inhibit-style-warnings} applies only to the top
level of the form inside it (in this case, to the @code{setq}).
@end defmac

@section Compiler Source-Level Optimizers

The compiler stores optimizers for source code on property lists so as
to make it easy for the user to add them.  An optimizer can be used to
transform code into an equivalent but more efficient form (for
example, @code{(eq @i{obj} nil)} is transformed into @code{(null @i{obj})},
which can be compiled better).  An optimizer can also be used to
tell the compiler how to compile a special form.  For example,
in the interpreter @code{do} is a special form, implemented by a function
which takes quoted arguments and calls @code{eval}.  In the compiler,
@code{do} is expanded in a macro-like way by an optimizer, into
equivalent Lisp code using @code{prog}, @code{cond}, and @code{go}, which
the compiler understands.

The compiler finds the optimizers to apply to a form by looking for
the @code{compiler:optimizers} property of the symbol which is the
@code{car} of the form.  The value of this property should be a list of
optimizers, each of which must be a function of one argument.  The
compiler tries each optimizer in turn, passing the form to be
optimized as the argument.  An optimizer which returns the original
form unchanged (and @code{eq} to the argument) has "done nothing", and
the next optimizer is tried.  If the optimizer returns anything else,
it has "done something", and the whole process starts over again.
This is somewhat like a Markov algorithm.  Only after all the optimizers
have been tried and have done nothing is an ordinary macro definition
processed.  This is so that the macro definitions, which will be seen
by the interpreter, can be overridden for the compiler by an optimizer.

@section Files that Maclisp Must Compile

Certain programs are intended to be run both in Maclisp and in Lisp
Machine Lisp.  These files need some special conventions.  For example,
such Lisp Machine constructs as @code{&aux} and @code{&optional} must not be
used.  In addition, @code{eval-when} must not be used, since only the Lisp
Machine compiler knows about it.  All @code{special} declarations must be
enclosed in @code{declare}s, so that the Maclisp compiler will see them.
It is suggested that you turn on @code{run-in-maclisp-switch}
in such files, which will warn you about a lot of bugs.

The macro-character combination "#Q" causes the object that
follows it to be visible only when compiling for the Lisp Machine.
The combination "#M" causes the  following object to be visible
only when compiling for Maclisp.  These work only on subexpressions
of the objects in the file, however.  To conditionalize top-level objects,
put the macros @code{if-for-lispm} and
@code{if-for-maclisp} around them.  (You can only put these around
a single object.)  The @code{if-for-lispm} macro turns off @code{run-in-maclisp-switch}
within its object, preventing spurious warnings from the compiler.
The @code{#Q} macro-character does not do this, since it can be used
to conditionalize any S-expression, not just a top-level form.

There are actually three possible cases of compiling: you may
be compiling on the Lisp Machine for the Lisp Machine; you may
be compiling in Maclisp for the Lisp Machine (with :LISPM1;QCMP);
or you may be compiling in Maclisp for Maclisp (with COMPLR).
(You can't compile for Maclisp on the Lisp Machine because there isn't a Lisp
Machine Lisp version of COMPLR.)  To allow a file to detect any
of these conditions it needs to, the following macros are provided:

@defmac if-for-lispm
If @code{(if-for-lispm @i{form})} is seen at the top level of
the compiler, @i{form} is passed to the compiler top level if
the output of the compiler is a QFASL file intended for the Lisp Machine.
If the Lisp Machine interpreter sees this it will evaluate @i{form}
(the macro expands into @i{form}).
@end defmac

@defmac if-for-maclisp
If @code{(if-for-maclisp @i{form})} is seen at the top level of
the compiler, @i{form} is passed to the compiler top level if
the output of the compiler is a FASL file intended for Maclisp
(e.g. if the compiler is COMPLR).
If the Lisp Machine interpreter sees this it will ignore it
(the macro expands into @code{nil}).
@end defmac

@defmac if-for-maclisp-else-lispm
If @code{(if-for-maclisp-else-lispm @i{form1} @i{form2})} is seen at the top level of
the compiler, @i{form1} is passed to the compiler top level if
the output of the compiler is a FASL file intended for Maclisp;
otherwise @i{form2} is passed to the compiler top level.
@end defmac

@defmac if-in-lispm
On the Lisp Machine, @code{(if-in-lispm @i{form})} causes @i{form}
to be evaluated; in Maclisp, @i{form} is ignored.
@end defmac

@defmac if-in-maclisp
In Maclisp, @code{(if-in-maclisp @i{form})} causes @i{form}
to be evaluated; on the Lisp Machine, @i{form} is ignored.
@end defmac

When you have two definitions of one function, one conditionalized
for one machine and one for the other, indent the first "@code{(defun}"
by one space, and the editor will put both function definitions together
in the same file-section.

In order to make sure that those macros and macro-characters are
defined when reading the file into the Maclisp compiler, you must
make the file start with a prelude, which will have no effect
when you compile on the real machine.  The prelude can
be found in "AI: LMDOC; .COMPL PRELUD"; this will also define
most of the standard Lisp Machine macros and reader macros in Maclisp, including
@code{defmacro} and the backquote facility.

Another useful facility is the form @code{(status feature lispm)},
which evaluates to @code{t} when evaluated on the Lisp machine and to @code{nil}
when evaluated in Maclisp.

@c DSK:LMMAN;MACROS 39
@c This file is part of the Lisp Machine manual.	-*-Text-*-
@c Macros: introduction, examples, DEFMACRO, backquote.

@c Note: there are still some sections to be written; see end of the file.

@chapter Macros
@cindex macros
@c Macros!!!!!!!

@section Introduction to Macros

If @code{eval} is handed a list whose @i{car} is a symbol, then @code{eval}
inspects the definition of the symbol to find out what to do.  If the
definition is a @i{cons}, and the @i{car} of the @i{cons} is the symbol
@code{macro}, then the definition (i.e. that cons) is called a @i{macro}.
The @i{cdr} of the @i{cons} should be a function of one argument.
@code{eval} applies the function to the form it was originally given.
Then it takes whatever is returned, and evaluates that in lieu of the
original form.

Here is a simple example.  Suppose the definition of the symbol @code{first} is

@lisp
(macro lambda (x)
         (list 'car (cadr x)))
@end lisp

This thing is a macro: it is a @i{cons} whose @i{car} is the symbol @code{macro}.
What happens if we try to evaluate a form @code{(first '(a b c))}?  Well,
@code{eval} sees that it has a list whose @i{car} is a symbol (namely,
@code{first}), so it looks at the definition of the symbol and sees that
it is a @i{cons} whose @i{car} is @code{macro}; the definition is a macro.
@code{eval} takes the @i{cdr} of the cons,
which is a lambda expression, and @i{applies} it to the
original form that @code{eval} was handed.
So it applies @code{(lambda (x) (list 'car (cadr x)))}
to @code{(first '(a b c))}.  @code{x} is bound to @code{(first '(a b c))},
@code{(cadr x)} evaluates to @code{'(a b c)}, and @code{(list 'car (cadr x))}
evaluates to @code{(car '(a b c))}, which is what the function returns.
@code{eval} now evaluates this new form in place of the original form.
@code{(car '(a b c))} returns @code{a}, and so the result is that
@code{(first '(a b c))} returns @code{a}.

What have we done?  We have defined a macro called @code{first}.  What
the macro does is to @i{translate} the form to some other form.  Our
translation is very simple--it just translates forms that look like
@code{(first @i{x})} into @code{(car @i{x})}, for any form @i{x}.
We can do much more
interesting things with macros, but first we will show how
to define a macro.

Macros are normally defined using the @code{macro} special form.
A macro definition looks like this:

@lisp
(macro @i{name} (@i{arg})
    @i{body})
@end lisp

To define our @code{first} macro, we would say

@lisp
(macro first (x)
    (list 'car (cadr x)))
@end lisp

Here are some more simple examples of macros.  Suppose we want
any form that looks like @code{(addone @i{x})} to be translated into
@code{(plus 1 @i{x})}.  To define a macro to do this we would say

@lisp
(macro addone (x)
   (list 'plus '1 (cadr x)))
@end lisp

Now say we wanted a macro which would translate @code{(increment @i{x})}
into @code{(setq @i{x} (1+ @i{x})}.  This would be:

@lisp
(macro increment (x)
    (list 'setq (cadr x) (list '1+ (cadr x))))
@end lisp

Of course, this macro is of limited usefulness.  The reason is that the
form in the @i{cadr} of the @code{increment} form had better be a symbol.
If you tried @code{(increment (car x))}, it would be translated into
@code{(setq (car x) (1+ (car x)))}, and @code{setq} would complain.

You can see from this discussion that macros are very different
from functions.  A function would not be able to tell what kind of subforms
are around in a call to itself; they get evaluated before the functions
ever sees them.  However, a macro gets to look at the whole form and see
just what is going on there.  Macros are @i{not} functions; if @code{first}
is defined as a macro, it is not meaningful to apply @code{first} to arguments.
A macro does not take arguments at all; it takes a @i{Lisp form} and turns
it into another @i{Lisp form}.

The purpose of functions is to @i{compute}; the purpose of
macros is to @i{translate}.  Macros are used for a variety of purposes, the
most common being extensions to the Lisp language.  For example, Lisp
is powerful enough to express many different control structures, but it
does not provide every control structure anyone might ever possibly
want.  Instead, if a user wants some kind of control structure with a
syntax that is not provided, he can  translate it into some form that
Lisp @i{does} know about.

For example, someone might want a limited iteration construct
which increments a symbol by one until it exceeds a limit (like the
FOR statement of the BASIC language).  He might want it to look like

@lisp
(for a 1 100 (print a) (print (* a a)))
@end lisp

To get this, he could write a macro to translate it into

@lisp
(do a 1 (1+ a) (> a 100) (print a) (print (* a a)))
@end lisp

A macro to do this could be defined with

@lisp
(macro for (x)
  (cons 'do
        (cons (cadr x)
              (cons (caddr x)
                    (cons (list '1+ (cadr x))
                          (cons (list '> (cadr x) (cadddr x))
                                (cddddr x)))))))
@end lisp

Now he has defined his own new control structure primitive, and it
will act just as if it were a special form provided by Lisp itself.

@section Aids for Defining Macros

The main problem with the definition for the @code{for} macro is
that it is verbose and clumsy.  If it is that hard to write a macro
to do a simple specialized iteration construct, one would wonder how
anyone would write macros of any real sophistication.

There are two things that make the definition so inelegant.
One is that the programmer must write things like "@code{(cadr x)}"
and "@code{(cddddr x)}" to refer to the parts of the form he wants
to do things with.  The other problem is that the long chains of calls
to the @code{list} and @code{cons} functions are very hard to read.

Two features are provided to solve these two problems.
The @code{defmacro} macro solves the former, and the "backquote" ("@code{`}")
reader macro solves the latter.

@subsection Defmacro
@cindex macro-defining macros

Instead of referring to the parts of our form by "@code{(cadr x)}"
and such, we would like to give names to the various pieces of the form,
and somehow have the @code{(cadr x)} automatically generated.  This is done
by a macro called @code{defmacro}.  It is easiest to explain what @code{defmacro} does
by showing an example. Here is how you would write the @code{for} macro
using @code{defmacro}:

@lisp
(defmacro for (var lower upper . body)
  (cons 'do
        (cons var
              (cons lower
                    (cons (list '1+ var)
                          (cons (list '> var upper)
                                body))))))
@end lisp

The @code{(var lower upper . body)} is a @i{pattern} to match against
the body of the macro (to be more precise, to match against the @i{cdr}
of the argument to the macro).  @code{defmacro} tries to match the two
lists

@lisp
(var lower upper . body)
@r{and}
(a 1 100 (print a) (print (* a a)))
@end lisp

@code{var} will get bound to the symbol @code{a}, @code{lower} to the fixnum @code{1},
@code{upper} to the fixnum @code{100}, and @code{body} to the list
@code{((print a) (print (* a a)))}.  Then inside the body of the @code{defmacro},
@code{var, lower, upper,} and @code{body} are variables, bound to the matching
parts of the macro form.

@defmac defmacro
@code{defmacro} is a general purpose macro-defining macro.  A @code{defmacro}
form looks like

@lisp
(defmacro @i{name} @i{pattern} . @i{body})
@end lisp

The @i{pattern} may be anything made up out of symbols and conses.
It is matched against the body of the macro form; both @i{pattern}
and the form are @i{car}'ed and @i{cdr}'ed identically, and whenever
a symbol is hit in @i{pattern}, the symbol is bound to the corresponding
part of the form.  All of the symbols in @i{pattern} can be used
as variables within @i{body}.  @i{name} is the name of the macro
to be defined.  @i{body} is evaluated with these bindings in effect,
and is returned to the evaluator.
@end defmac

Note that the pattern need not be a list the way a lambda-list must.
In the above example, the pattern was a "dotted list", since the symbol
@code{body} was supposed to match the @i{cddddr} of the macro form.
If we wanted a new iteration form, like @code{for} except that it
our example would look like

@lisp
(for a (1 100) (print a) (print (* a a)))
@end lisp

(just because we thought that was a nicer syntax), then we could
do it merely by modifying the pattern of the @code{defmacro} above;
the new pattern would be @code{(var (lower upper) . body)}.

Here is how we would write our other examples using @code{defmacro}:

@lisp
(defmacro first (the-list)
    (list 'car the-list))

(defmacro addone (form)
   (list 'plus '1 form))

(defmacro increment (symbol)
   (list 'setq symbol (list '1+ symbol)))
@end lisp

All of these were very simple macros and have very simple patterns,
but these examples show that we can replace the @code{(cadr x)} with a
readable mnemonic name such as @code{the-list} or @code{symbol}, which
makes the program clearer.

There is another version of @code{defmacro} which defines
displacing macros (see (displacing-macro)).
@code{defmacro} has other, more complex features; see (defmacro-hair).

@subsection Backquote

Now we deal with the other problem: the long strings of calls
to @code{cons} and @code{list}.  For this we must introduce some @i{reader
macros}.  Reader macros are not the same as normal macros, and they
are not described in this chapter; see (reader).

The backquote facility is used by giving a backquote character ("@code{`}",
ASCII code 140 octal), followed by a form.  If the form does not contain
any use of the comma macro-character, the form will simply be quoted.  For example,

@lisp
 '(a b c) ==> (a b c)
 `(a b c) ==> (a b c)
@end lisp

So in the simple cases, backquote is just like the regular single-quote
macro.  The way to get it to do interesting things is to include a use
of the comma somewhere inside of the form following the backquote.
The comma is followed by a form, and that form gets evaluated even
though it is inside the backquote.  For example,

@lisp
(setq b 1)
`(a b c)  ==> (a b c)
`(a ,b c) ==> (a 1 c)
@end lisp

In other words, backquote quotes everything @i{except} things preceeded by
a comma; those things get evaluated.

When the reader sees the @code{`(a ,b c)} it is actually generating
a form such as @code{(list 'a b 'c)}.  The actual form generated may use @code{list},
@code{cons}, @code{append}, or whatever might be a good idea; you should
never have to concern yourself with what it actually turns into.  All you
need to care about is what it evaluates to.

This is generally found to be pretty confusing by most people; the best way
to explain further seems to be with examples.  Here is how we would write our
three simple macros using both the @code{defmacro} and backquote facilities.

@lisp
(defmacro first (the-list)
    `(car ,the-list))

(defmacro addone (form)
   `(plus 1 ,form))

(defmacro increment (symbol)
   `(setq ,symbol (1+ ,symbol)))
@end lisp

To finally demonstrate how easy it is to define macros with these two facilities,
here is the final form of the @code{for} macro.

@lisp
(defmacro for (var lower upper . body)
  `(do ,var ,lower (1+ ,var) (> ,var ,upper) . ,body))
@end lisp

Look at how much simpler that is than the original definition.  Also,
look how closely it resembles the code it is producing.  The functionality
of the @code{for} really stands right out when written this way.

@c New part starts here.

If a comma inside a backquote form is followed by an "atsign"
character ("@code{@@}"), it has a special meaning.  The "@code{,@@}" should
be followed by a form whose value is a @i{list}; then each of the elements
of the list are put into the list being created by the backquote.  In other
words, instead of generating a call to the @code{cons} function, backquote
generates a call to @code{append}.  For example, if @code{a} is bound to
@code{(x y z)}, then @code{`(1 ,a 2)} would evaluate to @code{(1 (x y z) 2)},
but @code{`(1 ,@@a 2)} would evaluate to @code{`(1 x y z 2)}.

Here is an example of a macro definition that uses the "@code{,@@}"
construction.  Suppose you wanted to extend Lisp by adding a kind of
special form called @code{repeat-forever}, which evaluates all of its
subforms repeatedly.  One way to implement this would be to expand

@lisp
(repeat-forever @i{form1} @i{form2} @i{form3})
@end lisp

into

@lisp
(prog ()
    a @i{form1}
      @i{form2}
      @i{form3}
      (go a))
@end lisp

You could define the macro by

@lisp
(macro repeat-forever body
       `(prog ()
            a ,@@body
              (go a)))
@end lisp

Advanced macro writers sometimes write "macro-defining macros":
forms which expand into forms which, when evaluated, define macros.  In
such macros it is often useful to use nested backquote constructs.  The
following example illustrates the use of nested backquotes in the
writing of macro-defining macros.

This example is a very simple version of @code{defstruct} (see (defstruct-fun)).
You should first understand the basic description of @code{defstruct} before
proceeding with this example.  The @code{defstruct} below does not accept
any options, and only allows the simplest kind of items; that is, it only
allows forms like

@lisp
(defstruct (@i{name})
     @i{item1}
     @i{item2}
     @i{item3}
     @i{item4}
     ...)
@end lisp

We would like this form to expand into

@lisp
(progn
 (defmacro @i{item1} (x)
      `(aref ,x 1))
 (defmacro @i{item2} (x)
      `(aref ,x 2))
 (defmacro @i{item3} (x)
      `(aref ,x 3))
 (defmacro @i{item4} (x)
      `(aref ,x 4))
 ...)
@end lisp

Here is the macro to perform the expansion:

@lisp
(defmacro defstruct ((name) . items)
     (do ((item-list items (cdr item-list))
          (ans nil)
          (i 0 (1+ i)))
         ((null item-list)
          (cons 'progn (nreverse ans)))
       (setq ans
             (cons `(defmacro ,(car item-list) (x)
                           `(aref ,x ,',i))
                   ans))))
@end lisp

The interesting part of this definition is the body of
the (inner) @code{defmacro} form: @code{`(aref ,x ,',i)}.
Instead of using this backquote construction, we could have
written @code{(list 'aref x ,i)}; that is, the "@code{,',}"
acts like a comma which matches the outer backquote, while
the "@code{,}" preceeding the "@code{x}" matches with the inner
backquote.  Thus, the symbol @code{i} is evaluated when the
@code{defstruct} form is expanded, whereas the symbol @code{x} is
evaluated when the accessor macros are expanded.

Backquote can be useful in situations other than the writing
of macros.  Whenever there is a piece of list structure to be consed
up, most of which is constant, the use of backquote can make the
program considerably clearer.

@section Aids for Debugging Macros

@defun mexp
@code{mexp} goes into a loop in which it reads forms and sequentially
expands them, printing out the result of each expansion.  It terminates
when it reads an atom (anything that is not a cons).  If you type
in a form which is not a macro form, there will be no expansions
and so it will not type anything out, but just prompt you for
another form.  This allows you to see what your macros are
expanding into, without actually evaluating the result of the expansion.
@end defun

@section Displacing Macros
@cindex displacing macros

Every time the the evaluator sees a macro form, it must
call the macro to expand the form.  If this expansion always
happens the same way, then it is wasteful to expand the whole
form every time it is reached; why not just expand it once?
A macro is passed the macro form itself, and so it can change
the car and cdr of the form to something else by using @code{rplaca}
and @code{rplacd}!  This way the first time the macro is expanded,
the expansion will be put where the macro form used to be, and the
next time that form is seen, it will already be expanded.  A macro that
does this is called a @i{displacing macro}, since it displaces
the macro form with its expansion.

The major problem with this is that the Lisp form
gets changed by its evaluation.  If you were to write a program
which used such a macro, call @code{grindef} to look at it,
then run the program and call @code{grindef} again, you would
see the expanded macro the second time.  Presumably the reason
the macro is there at all is that it makes the program look nicer;
we would like to prevent the unnecessary expansions, but still let
@code{grindef} display the program in its more attractive form.
This is done with the function @code{displace}.

@defun displace form expansion
@i{form} must be a list.
@code{displace} replaces the car and cdr of @i{form} so
that it looks like:

@lisp
(si:displaced @i{original-form} @i{expansion})
@end lisp

@i{original-form} is equal to @i{form} but has a different
top-level cons so that the replacing mentioned above doesn't
affect it.  @code{si:displaced} is a macro, which returns
the caddr of its own macro form.  So when the @code{si:displaced}
form is given to the evaluator, it "expands" to @i{expansion}.
@code{displace} returns @i{expansion}.
@end defun

The grinder knows specially about @code{si:displaced} forms,
and will grind such a form as if it had seen the original-form
instead of the @code{si:displaced} form.

So if we wanted to rewrite our @code{addone} macro as a displacing
macro, instead of writing

@lisp
(macro addone (x)
   (list 'plus '1 (cadr x)))
@end lisp

we would write

@lisp
(macro addone (x)
   (displace x (list 'plus '1 (cadr x))))
@end lisp

Of course, we really want to use @code{defmacro} to define
most macros.  Since there is no way to get at the original macro form itself
from inside the body of a @code{defmacro}, another version of it is
provided:

@defmac defmacro-displace
@code{defmacro-displace} is just like @code{defmacro} except that
it defines a displacing macro, using the @code{displace} function.
@end defmac

Now we can write the displacing version of @code{addone} as

@lisp
(defmacro-displace addone (form)
   (list 'plus '1 form))
@end lisp

All we have changed in this example is the @code{defmacro} into
@code{defmacro-displace}.  @code{addone} is now a displacing macro.

@section Advanced Features of Defmacro

(To be supplied.)

(The basic matter is that you can use @code{&optional} and @code{&rest}
with @code{defmacro}.  The interactions between @code{&optional}'s initialization,
and the fact that the "lambda-list" in @code{defmacro} can be arbitrary
list structure are not clear.  If you need to use this feature, try it out.)

@section Functions to Expand Macros

The following two functions are provided to allow
the user to control expansion of macros; they are often
useful for the writer of advanced macro systems.

@defun macroexpand-1 form &optional compilerp
If @i{form} is a macro form, this expands it (once)
and returns the expanded form.  Otherwise it just
returns @i{form}.  If @code{compilerp} is @code{t}, @code{macroexpand-1}
will search the compiler's list of intenally defined macros
(@code{sys:macrolist}) for a definition, as well as the function cell
of the @i{car} of @i{form}.  @i{compilerp} defaults to @code{nil}.
@end defun

@defun macroexpand form &optional compilerp
If @i{form} is a macro form, this expands it repeatedly
until it is not a macro form, and returns the final expansion.
Otherwise, it just returns @i{form}.  @i{compilerp} has the
same meaning as in @code{macroexpand-1}.
@end defun

@c DSK:LMMAN;DEFSTR 28
@c This file is part of the Lisp Machine manual.	-*-Fundamental-*-
@c Defstruct.

@c This needs more work.  More examples are needed.

@chapter Defstruct
@cindex structures
@cindex defstruct
@c Macro-defining macros!!!!!
@cindex macro defining macros

@section Introduction to Structure Macros

@code{defstruct} provides a facility in Lisp for creating and
using aggregate datatypes with named elements.  These are like
"structures" in PL/I, or "records" in PASCAL.  In the last chapter we
saw how to use macros to extend the control structures of Lisp; here we
see how they can be used to extend Lisp's data structures as well.

To explain the basic idea, assume you were writing a Lisp
program that dealt with space ships.  In your program, you want to
represent a space ship by a Lisp object of some kind.  The interesting
things about a space ship, as far as your program is concerned, are
its position (X and Y), velocity (X and Y), and mass.  How do you
represent a space ship?

Well, the representation could be a 5-list of the x-position,
y-position, and so on.  Equally well it could be an array of five
elements, the zeroth being the x-position, the first being the
y-position, and so on.  The  problem with both of these representations
is that the "elements" (such as x-position) occupy places in the object
which are quite arbitrary, and hard to remember (Hmm, was the mass the
third or the fourth element of the array?).  This would make programs
harder to write and read.  What we would like to see are names, easy to
remember and to understand.  If the symbol @code{foo} were bound to a
representation of a space ship, then

@lisp
(ship-x-position foo)
@end lisp

could return its x-position, and

@lisp
(ship-y-position foo)
@end lisp

its y-position, and so forth.  @code{defstruct} does just this.

@code{defstruct} itself is a macro which defines a structure.  For the
space ship example above, we might define the structure by saying:

@lisp
(defstruct (ship)
     ship-x-position
     ship-y-position
     ship-x-velocity
     ship-y-velocity
     ship-mass)
@end lisp

(This is a very simple case of @code{defstruct}; we will see the general form
later.)  The evaluation of this form does several things.  First, it
defines @code{ship-x-position} to be a macro which expands into an @code{aref}
form; that is, @code{(ship-x-position foo)} would turn into @code{(aref foo 0)}.  All of
the "elements" are defined to refer to sequentially increasing
elements of the array, e.g., @code{(ship-mass foo)} would turn into @code{(aref foo
4)}.  So a ship is really implemented as an array, although that fact
is kept hidden.  These macros are called the @i{accessor macros}, as they
are used to access elements of the structure.

@code{defstruct} will also define @code{make-ship} to be a macro which
expands into a call to @code{make-array} which will create an array of the
right size (namely, 5 elements).  So @code{(setq x (make-ship))} will make a
new ship, and @r{x} will be bound to it.  This macro is called the
@i{constructor macro}, because it constructs a new structure.

We also want to be able to change the contents of a structure.
To do this, we use the @code{setf} macro
(see (setf-fun)), as follows (for example):

@lisp
(setf (ship-x-position x) 100)
@end lisp

Here @r{x} is bound to a ship, and after the evaluation of the @code{setf}
form, the @code{ship-x-position} of that ship will be 100.  The way this
works is that the @code{setf} form expands into @code{(aset 100 x 0)}; again, this
is invisible to the programmer.

By itself, this simple example provides a powerful structure
definition tool.  But, in fact, @code{defstruct} has many other features.  First
of all, we might want to specify what kind of Lisp object to use for the
"implementation" of the structure.  The example above implemented a "ship"
as an array, but @code{defstruct} can also implement structures as array-leaders
and as lists.  (For array-leaders, the accessor macros expand into calls
to @code{array-leader}, and for lists, to @code{car, cadr, caddr,} and so on.)

Most structures are implemented as arrays.  Lists take slightly less
storage, but elements near the end of a long list are slower to access.
Array leaders allow you to have a homogeneous aggregate (the array)
and a heterogeneous aggregate with named elements (the leader) tied
together into one object.

@code{defstruct} allows you to specify to the constructor
macro what the various elements of the structure should be initialized
to.  It also lets you give, in the @code{defstruct} form, default values
for the initialization of each element.

@section Setf and Locf

In Lisp, for each function to @i{access} (read) any piece of
information, there is almost always a corresponding function to
@i{update} (write) it as well.  For example, @code{symeval} accesses a
symbol's value cell, and @code{set} updates it.  @code{array-leader} accesses
the contents of an array leader element, and @code{store-array-leader}
updates it.  The knowledge of how these functions correspond is accessible through
a macro called @code{setf}.

@code{setf} is particularly useful in combination with structure-accessing
macros, such as those created with @code{defstruct}, because the knowledge of the
representation of the structure is embedded inside the macro, and the programmer
shouldn't have to know what it is in order to alter an element of the structure.

@defmac setf
@code{setf} takes a form which @i{accesses} something, and "inverts"
it to produce a corresponding form to @i{update} the thing.  The
form for @code{setf} is

@lisp
(setf @i{access-form} @i{value})
@end lisp

It expands into an update form, which stores the result of evaluating
the form @i{value} into the place referenced by the @i{access-form}.

@lisp
@exdent Examples:
(setf (array-leader foo 3) 'bar)
                ===> (store-array-leader 'bar foo 3)
(setf a 3) ===> (setq a 3)
(setf (plist 'a) '(foo bar)) ===> (setplist 'a '(foo bar))
(setf (aref q 2) 56) ===> (aset 56 q 2)
(setf (cadr w) x) ===> (rplaca (cdr w) x)
@end lisp
@end defmac

@defmac locf
@code{locf} takes a form which @i{accesses} some cell, and produces
a corresponding form to create a locative pointer to that cell.
The form for @code{locf} is

@lisp
(locf @i{access-form})
@end lisp

@lisp
@exdent Examples:
(locf (array-leader foo 3)) ===> (ap-leader foo 3)
(locf a) ===> (value-cell-location 'a)
(locf (plist 'a)) ===> (property-cell-location 'a)
(locf (aref q 2)) ===> (aloc q 2)
@end lisp
@end defmac

Both @code{setf} and @code{locf} work by means of property lists.
When the form @code{(setf (aref q 2) 56)} is expanded, @code{setf} looks
for the @code{setf} property of the symbol @code{aref}.  The value of the
@code{setf} property of a symbol should be a @i{cons} whose @i{car}
is a pattern to be matched with the @i{access-form}, and whose @code{cdr}
is the corresponding @i{update-form}, with the symbol @code{si:val} in
the place of the value to be stored.  The @code{setf} property of @code{aref}
is a @i{cons} whose @i{car} is @code{(aref array . subscripts)} and whose
@i{cdr} is @code{(aset si:val array . subscripts)}.  If the transformation which
@code{setf} is to do cannot be expressed as a simple pattern, an arbitrary
function may be used.  When the form @code{(setf (foo bar) baz)}
is being expanded, if the @code{setf} property of @code{foo} is a symbol,
the function definition of that symbol will be applied to two arguments,
@code{(foo bar)} and @code{baz}, and the result will be taken to be the
expansion of the @code{setf}.

Similarly, the @code{locf} function
uses the @code{locf} property, whose value is analogous.  For example, the @code{locf} property
of @code{aref} is a @i{cons} whose @i{car} is @code{(aref array . subscripts)}
and whose @i{cdr} is @code{(aloc array . subscripts)}.  There is no @code{si:val}
in the case of @code{locf}.

As a special case, @code{setf} and @code{locf} allow a variable as the reference.
In this case they turn into @code{setq} and @code{value-cell-location}, respectively.

For the sake of efficiency, the code produced by @code{setf} and @code{locf}
does not preserve order of evaluation of the argument forms.  This is only a problem
is the argument forms have interacting side-effects.  In addition, the value produced
by @code{setf} is dependant on the structure type and is not guaranteed; @code{setf}
should be used for side effect only.

@section How to Use Defstruct

@defmac defstruct
A call to @code{defstruct} looks like:

@lisp
(defstruct (@i{name} @i{option-1} @i{option-2} ...)
           @i{item-1}
           @i{item-2}
           ...)
@end lisp

@i{name} must be a symbol; it is the name of the structure.
It is used for many different things, explained below.

@i{option-n} may be either a symbol (which should be one of the recognized
option names, listed below) or a list (whose @i{car} should be one of the
option names and the rest of which should be "arguments" to the option).

@i{item-n} may be in any of three forms:

@lisp
@r{(1)} @i{item-name}
@r{(2)} @code{(@i{item-name} @i{default-init})}
@r{(3)} ((@i{item-name-1} @i{byte-spec-1} @i{default-init-1})
        (@i{item-name-2} @i{byte-spec-2} @i{default-init-2})
                ...)
@end lisp

@i{item-name} must always be a symbol, and each @i{item-name} is
defined as an access macro.  Each @i{item} allocates one entry of
the physical structure, even though in form (3) several access macros
are defined.

In form (1), @i{item-name} is simply defined as a macro to
return the corresponding element of the structure.  The constructor macro will
initialize that entry to @code{nil} (or @code{0} in a numeric array)
by default.  In form (2), the access macro
is defined the same way, but the default initialization is provided by
the user of @code{defstruct}.

In form (3), several access macros are defined, and each one
refers to the single structure element allocated for this @i{item}.
However, if @i{byte-spec} is a fixnum, the access macros will @code{ldb} that
byte from the entry (see the function @code{ldb}, (ldb-fun)).
@i{byte-spec} may also be @code{nil}, in which case the usual form of
access macro is defined, returning the entire entry in the structure.
Note that it is possible to define two or more different overlapping
byte fields.  (If more than one of these has a @i{default-init} the
results of initializing the entry are undefined and unpredictable.)  For
example, if the third @i{item} of a call to @code{defstruct} were

@lisp
        ((foo-high-byte 1010)
         (foo-low-byte 0010)
         (foo-whole-thing nil))
@end lisp

then @code{(foo-high-byte foo)} would expand to @code{(ldb 1010 (aref foo
2))}, and @code{(foo-whole-thing foo)} would expand to @code{(aref foo 2)}.

Form (3) can also be used if you want to have an element with more
than one access macro.  By putting @code{((foo nil) (bar nil))}, both @code{foo}
and @code{bar} will be defined identically.
@end defmac

@section Options to Defstruct

Note that options which take no arguments may be given as just a symbol,
instead of a list.

@table @code
@item :array
The structure should be implemented as an array.  This is the default.
(No arguments.)
@item :array-leader
The structure should implemented as be an array-leader. (No arguments.)
@item :list
The structure should be implemented as a list. (No arguments.)
@item :grouped-array
See (grouped-array).
@item :times
Used by grouped arrays.  See (grouped-array).
@item :size
Takes one argument, a symbol.  The symbol gets @i{set} to the size of the
structure, at load-time (not compile-time).
@item :size-macro
One argument, a symbol.  The symbol gets defined as a macro,
which expands into the size of the structure.
@item :constructor
One argument, a symbol which will be the name of the constructor macro.
If the option is not present, the name of the constructor will be
made by concatenating @code{"make-"} with the @i{name} of the structure.
If the argument is @code{nil}, do not define any constructor macro.
@item :named
No argument.  This causes the constructor to
create named structure arrays (and thus may not be used with the @code{:list} option)
and automatically allocate the appropriate slot in the structure and
put the name of the structure there as the named-structure symbol.
@item :default-pointer
One argument.  The access macros will be defined in such
a way that if they are called on no "arguments", the argument
to the @code{:default-pointer} option will be used instead.  (Normally, access macros
will signal an error if their "argument" is missing.)
@item :make-array
One argument, arguments to the @code{make-array} function.  See below.
@item :include
One argument, the name of a structure.  The structure being defined will
start out the same as that structure, with some additional elements
added at the end.
@end table

@section Using the Constructor Macro

If the argument to the @code{:constructor} option is @code{nil}, no
constructor macro is defined.  But otherwise, @code{defstruct} creates a
constructor macro, which will create an instance of the
structure.  This section explains how the constructor macro interprets
its "arguments".

A call to a constructor macro, in general, has the form

@lisp
(@i{name-of-constructor-macro}
        @i{symbol-1} @i{form-1}
        @i{symbol-2} @i{form-2}
        ...)
@end lisp

Each @i{symbol} may be either a name of an @i{item} of the structure,
or a specially recognized keyword.  All @i{form}s are evaluated.

If @i{symbol} is the name of an @i{item}, then that element
of the created structure will be initialized to the value of @i{form}.
If no @i{symbol} is present for a given item, then the item will be
initialized in accordance with the default initialization specified
in the call to @code{defstruct}.  If the @code{defstruct} itself also
did not specify any initialization, the element will be initialized
to @code{nil}, unless the structure is implemented by a @i{numeric array},
in which case it will be initialized to @code{0}.
(In other words, the initialization specified to the constructor
overrides the initialization specified to @code{defstruct}.)

There are two symbols which are specially recognized by the
constructor.  One is @code{:make-array}, which should only be used for @i{array}
and @i{array-leader} type structures.  The value of @i{form} is used as the
argument list to the @code{make-array} function call created by the constructor.
This way, you can specify the area in which you wish the structure to
be created, the type of the array to be created, and so on.  Of
course, if you provided @i{all} of the arguments to @code{make-array}, the
constructor would not be able to do its job; so the constructor overrides
your specifications of certain elements.  If the structure is @i{array}
type, your specification of the array's dimensions (the third argument to
@code{make-array}) is ignored; if it is of @i{array-leader} type, the array-leader
argument (the fifth argument to @code{make-array}) is ignored.  Also, in both
cases the named-structure argument (the seventh argument to
@code{make-array}) is ignored.  They are ignored because it is the constructor
macro's job to fill them in.  If the list you provide is shorter than the number
of arguments to @code{make-array}, it will be as if you had given the missing
elements as @code{nil}.  Similarly, if your list is too long, the extra elements
will be ignored.  If you do not provide the @code{:make-array} keyword
at all, the arguments default from the value of the @code{:make-array}
option to @code{defstruct}.  If you did not even provide that, the
default argument lists are:

@table @r
@item For @i{array}s:
@code{(default-array-area 'art-q @i{whatever} nil nil nil @i{whatever})}
@item For @i{array-leader}s:
@code{(default-array-area 'art-q  0 nil @i{whatever} nil @i{whatever})}
@end table

The second keyword recognized by the constructor is @code{:times},
which should only be used for @code{grouped-arrays}.  Its value is the number
of repetitions of the structure in the grouped-array.  If @code{:times} is not
provided, it defaults from the @code{:times} option of @code{defstruct}.  If you did
not even provide that, the default is 1.

@section Grouped Arrays

The grouped array feature allows you to store several
instances of a structure side-by-side within an array.  This feature
is somewhat limited, and requires that the structure be implemented as an array,
that it not have any @code{:include} option, and that it not be a
named structure.

The accessor macros are defined to take a "first argument" which
should be a fixnum, and is the index into the array of where this
instance of the structure starts.  It should be a multiple of the size
of the structure, for things to make sense.

Note that the "size" of the structure (as given in the @code{:size} symbol
and the @code{:size-macro}) is the number of elements in @i{one} instance of the structure;
the actual length of the array is the product of the size of the structure and the
number of instances.  The number of instances to be created by the creator
macro is given as the argument to the @code{:times} or @code{:grouped-array} option, or
the @code{:times} keyword of the constructor macro (see below).

@section Named Structures
@cindex named-structure

The @i{named structure} feature provides a very simple form of
user-defined data type.  Any array may be made a named structure, although
usually the @code{:named} option of @code{defstruct} is used to create named
structures.  The principle advantages to a named structure are that it has
a more informative printed representation than a normal array and that
the @code{describe} function knows how to give a detailed description of it.
Because of these improved user-interface features it is recommended that
"system" data structures be implemented with named structures.

Another kind of user-defined data type, more advanced but less
efficient, is provided by the @i{actor} feature (see (actor)).

A named structure has an associated symbol, called its "named
structure symbol", which represents what user-defined type it is an
instance of; the @code{typep} function, applied to the named structure,
will return this symbol.  If the array has a leader, then the symbol is
found in element 1 of the leader; otherwise it is found in element 0 of
the array.  (Note: if a numeric-type array is to be a named structure,
it must have a leader, since a symbol cannot be stored in any element
of a numeric array.)

The named structure symbol should be defined as a function.  The functions
which know about named structures will apply this function to
several arguments. The first is a "keyword" symbol to
identify the calling function, and the second is the named structure
itself.  The rest of the arguments passed depend on the caller; any
named structure function should have a "@code{&rest}" parameter to
absorb any extra arguments that might be passed.  Just what
the function is expected to do depends on the keyword it is passed
as its first argument.  The following are the keywords defined at present:

@table @code
@item :which-operations
Should return a list of the names of the operations the function handles.
@item :print
The arguments are @code{:print}, the named structure, the stream to output to,
the current depth in
list-structure, and @code{t} if slashification is enabled (@code{prin1}
versus @code{princ}).  The printed representation of the named structure
should be output to the stream.  If the named structure symbol
is not defined as a function, or @code{:print} is not in its
@code{:which-operations} list, the printer will default to a reasonable
printed representation.
@item :describe
The arguments are @code{:describe} and the named structure.  It should
output a description of itself to @code{standard-output}.  If the named
structure symbol is not defined as a function, or @code{:describe} is not
in its @code{:which-operations} list, the describe system will
check whether the named structure was created by using the @code{:named}
option of @code{defstruct}; if so, the names and values of the structure's
fields will be enumerated.
@end table

The following functions operate on named structures.

@defun named-structure-p x
This predicate returns @code{t} if @i{x} is a named structure; otherwise
it returns @code{nil}.
@end defun

@defun named-structure-symbol x
@i{x} should be a named structure.  This returns @i{x}'s named structure
symbol: if @i{x} has an array leader, element 1 of the leader is returned,
otherwise element 0 of the array is returned.
@end defun

@defun make-array-into-named-structure array
@i{array} is made to be a named structure, and is returned.
@end defun

@defun named-structure-invoke str op &rest args
@i{str} should be a named structure, and @i{op} should be a keyword
symbol.  The function definition of the named structure symbol is called
with appropriate arguments.
@end defun

@c DSK:LMMAN;IOS 116
@c This file is part of the Lisp Machine manual.	-*-Text-*-
@c The I/O System Chapter.

@c Need to add examples in the section on read, maybe print too.
@c Need to explain the readtable?  Which reader?
@c Guide to writing your own stream.
@c There is an issue regarding what the output functions return.
@c   Now they mostly return the object, but Maclisp returns T.

@chapter The I/O System
@cindex input and output

The Lisp Machine provides a powerful and flexible system for
performing input and output to peripheral devices.  To allow device
independent I/O (that is, to allow programs to be written in a general
way so that the program's input and output may be connected with any
device), the Lisp Machine I/O system provides the concept of an "I/O
stream".  What streams are, the way they work, and the functions to create and
manipulate streams, are described in this chapter.  This chapter also
describes the Lisp "I/O" operations @code{read} and @code{print}, and the
printed representation they use for Lisp objects.

@section The Character Set
@cindex character set

The Lisp Machine normally represents characters as fixnums.
The mapping between these numbers and the characters is listed here.
The mapping is similar to ASCII, but somewhat modified to allow the use
of the so-called SAIL extended graphics, while avoiding certain
ambiguities present in ITS.  For a long time ITS treated the Backspace,
Control-H, and Lambda keys on the keyboard identically as
character code 10 octal; this problem is avoided from the start in the
Lisp Machine's mapping.

Fundamental characters are eight bits wide.  Those less than
200 octal (with the 200 bit off) and only those are printing graphics;
when output to a device they are assumed to print a character and move
the "cursor" one character position to the right.  (All software provides
for variable-width fonts, so the term "character position" shouldn't
be taken too literally.)

Characters in the range of 200 to 237 inclusive are used for
special characters.  Character 200 is a "null character", and is not
used for anything much.  Characters 201 to 215 correspond
to the special keys on the keyboard such as Form and Call.
The rest of this group is reserved for future expansion.

The remaining characters are used for control operations.
The characters 240 to 247 inclusively mean "Switch to font 0", "Switch
to font 1", etc.  The rest of this group is reserved for future
expansion.

In some contexts, a fixnum can hold both a character code
and a font number for that character.  The following byte
specifiers are defined:

@defvar %%ch-char
The value of @code{%%ch-char} is a byte specifier for the field
of a fixnum character which holds the character code.
@end defvar

@defvar %%ch-font
The value of @code{%%ch-font} is a byte specifier for the field
of a fixnum character which holds the font number.
@end defvar

@cindex keyboard characters
Characters read in from the keyboard include a character
code and the Control and Meta bits.  The following byte specifiers
are provided:

@cindex %%kbd fields
@defvar %%kbd-char
The value of @code{%%kbd-char} is a byte specifier for the field
of a keyboard character which holds the normal eight-bit character code.
@end defvar

@defvar %%kbd-control
The value of @code{%%kbd-char} is a byte specifier for the bit
of a keyboard character which is 1 if either Control key was held down.
@end defvar

@defvar %%kbd-meta
The value of @code{%%kbd-char} is a byte specifier for the field
of a keyboard character which is 1 if either Meta key was held down.
@end defvar

@defvar %%kbd-control-meta
The value of @code{%%kbd-char} is a byte specifier for the two-bit field
of a keyboard character
whose low bit is the Control bit, and whose high bit is the Meta bit.
@end defvar

@defvar %%kbd-mouse
The value of @code{%%kbd-mouse} is a byte specifier for the bit in a keyboard character
which indicates that the character is not really a character,
but a signal from the mouse.
@end defvar

@defvar %%kbd-mouse-button
The value of @code{%%kbd-mouse-button} is a byte specifier for the field in a mouse signal
which says which button was clicked.  The value is @code{0}, @code{1}, or @code{2} for
the left, middle, and right buttons, respectively.
@end defvar

@defvar %%kbd-mouse-n-clicks
The value of @code{%%kbd-mouse-n-clicks}
is a byte specifier for the field in a mouse signal
which says how many times the button was clicked.
The value is one less than the number of times the button was clicked.
@end defvar

Since the Control and Meta bits are not part of the fundamental 8-bit character
codes, there is no way to express keyboard input in terms of simple
character codes.  However, there is a convention which many programs
accept for encoding keyboard input into character codes:  if a
character has its Control bit on, prefix it with an Alpha; if a
character has its Meta bit on, prefix it with a Beta; if a character
has both its Control and Meta bits on, prefix it with an Epsilon.
To get an Alpha, Beta, Epsilon, or Equivalence into the string,
quote it by prefixing it with an Equivalence.

@verbatim
@c 000 center-dot ( )             040 space       100 @@           140 `
@c 001 down arrow ()             041 !           101 A           141 a
@c 002 alpha ()                  042 "           102 B           142 b
@c 003 beta ()                   043 #           103 C           143 c
@c 004 and-sign ()               044 $           104 D           144 d
@c 005 not-sign ()               045 %           105 E           145 e
@c 006 epsilon ()                046 &           106 F           146 f
@c 007 pi ()                     047 '           107 G           147 g
@c 010 lambda ()                 050 (           110 H           150 h
@c 011 gamma ()                  051 )           111 I           151 i
@c 012 delta ()                  052 *           112 J           152 j
@c 013 uparrow ()                053 +           113 K           153 k
@c 014 plus-minus ()             054 ,           114 L           154 l
@c 015 circle-plus ()            055 -           115 M           155 m
@c 016 infinity ()               056 .           116 N           156 n
@c 017 partial delta ()          057 /           117 O           157 o
@c 020 left horseshoe ()         060 0           120 P           160 p
@c 021 right horseshoe ()        061 1           121 Q           161 q
@c 022 up horseshoe ()           062 2           122 R           162 r
@c 023 down horseshoe ()         063 3           123 S           163 s
@c 024 universal quantifier ()   064 4           124 T           164 t
@c 025 existential quantifier () 065 5           125 U           165 u
@c 026 circle-X ()               066 6           126 V           166 v
@c 027 double-arrow ()           067 7           127 W           167 w
@c 030 left arrow ()             070 8           130 X           170 x
@c 031 right arrow ()            071 9           131 Y           171 y
@c 032 not-equals ()             072 :           132 Z           172 z
@c 033 diamond (altmode) ()      073 ;           133 [           173 @{
@c 034 less-or-equal ()          074 <           134 \           174 |
@c 035 greater-or-equal ()       075 =           135 ]           175 @}
@c 036 equivalence ()            076 >           136 ^           176 ~
@c 037 or ()                     077 ?           137 _           177 
@c 200 null character             210 bs          240 switch to font 0
@c 201 break                      211 tab         241 switch to font 1
@c 202 clear                      212 line        242 switch to font 2
@c 203 call                       213 vt          243 switch to font 3
@c 204 escape (NOT altmode!)      214 form        244 switch to font 4
@c 205 backnext                   215 return      245 switch to font 5
@c 206 help                                       246 switch to font 6
@c 207 rubout                                     247 switch to font 7
@c 216-237 reserved for future special keys
@c 250-377 reserved for future control operations
@end verbatim
@center The Lisp Machine Character Set

@section Printed Representation

People cannot deal directly with Lisp objects, because the
objects live inside the machine.  In order to let us get at and talk
about Lisp objects, Lisp provides a representation of objects in the
form of printed text; this is called the @i{printed representation}.
This is what you have been seeing in the examples throughout this manual.
Functions such as @code{print}, @code{prin1},  and @code{princ} take a Lisp
object, and send the characters of its printed representation to a
stream.  These functions (and the internal functions they call) are
known as the @i{printer}.  The @code{read} function takes characters from a stream,
interprets them as a printed representation of a Lisp object, builds a
corresponding object and returns it; it and its subfunctions are known as the @i{reader}.

This section describes in detail what the printed
representation is for any Lisp object, and just what @code{read} does.
For the rest of the chapter, the phrase "printed representation" will
be abbreviated as "p.r.".

@subsection What the Printer Produces
@cindex printer

The printed representation of an object depends on its
type.  In this section, we will consider each type of object
and explain how it is printed.

@cindex slashification
Printing is done either with or without @i{slashification}.
The non-slashified version is nicer looking in general, but
if you give it to @code{read} it won't do the right thing.
The slashified version is carefully set up so that @code{read}
will be able to read it in.  The primary effects of slashification
are that special characters used with other than their
normal meanings (e.g., a parenthesis appearing in the name
of a symbol) are preceeded by slashes or cause the name of the
symbol to be enclosed in vertical bars, and that symbols which
are not from the current package get printed out with their
package prefixes (a package prefix looks like a string followed
by a colon).

For a fixnum: if the fixnum is negative, the printed representation
begins with a minus sign ("@code{-}").  Then, the value of the variable @code{base}
is examined.  If @code{base} is a positive fixnum, the number is printed
out in that base (@code{base} defaults to 8); if it is a symbol with
a @code{:princ-function} property, the value of the property will be
funcalled on two arguments: @code{minus} of the fixnum to be printed,
and the stream to which to print it; otherwise the value of @code{base} is invalid.
This is a hook to allow output in Roman numerals and the like.
Finally, if @code{base} equals 10. and the variable @code{*nopoint} is
@code{nil}, a decimal point is printed out.  Slashification does
not affect the printing of fixnums.

@defvar base
The value of @code{base} is a number which is the radix in which fixnums
are printed, or a symbol with a @code{:princ-function} property.
The initial value of @code{base} is 8.
@end defvar

@defvar *nopoint
If the value of @code{*nopoint} is @code{nil}, a trailing decimal point
is printed when a fixnum is printed out in base 10.  This allows
the numbers to be read back in correctly even if @code{ibase}
is not 10. at the time of reading.  If @code{*nopoint} is non-@code{nil},
the trailing decimal points are suppressed.  The initial value of
@code{*nopoint} is @code{nil}.
@end defvar

For a symbol: if slashification is off, the p.r. is simply the successive
characters of the print-name of the symbol. If slashification is on,
two changes must be made.  First, the symbol might require a package prefix
in order that @code{read} work correctly, assuming that the package into which
@code{read} will read the symbol is the one in which it is being printed.
See the section on packages ((package)) for an explanation
of the package name prefix.
Secondly, if the p.r. would not read in as a symbol at all (that is, if
the print-name looks like a number, or contains special characters),
then the p.r. must have some quoting for those characters, either
by the use of slashes ("/") before each special character,
or by the use of vertical bars ("|") around the whole name.
The decision whether quoting is required is done using the readtable,
so it is always accurate provided that @code{readtable} has the same value when
the output is read back in as when it was printed.

For a string: if slashification is off, the p.r. is simply the
successive characters of the string.  If slashification is on, the
string is printed between double quotes, and any characters inside the
string which need to be preceeded by slashes will be.   Normally these
are just double-quote and slash.  Incompatibly with Maclisp, carriage
return is @i{not} ignored inside strings and vertical bars.

@cindex named-structure
For an array which is a named structure: if the array has a
named structure symbol which is defined as a function, then that
function is called on five arguments: the symbol @code{:print}, the
object itself, the stream to print to, the current @i{depth} of list
structure (see below), and whether slashification is enabled.  A
suitable printed representation should be sent to the stream.  This
allows a user to define his own p.r. for his named structures;
examples can be found in the named structure section (see
(named-structure)).  If the named structure symbol does not have a
function definition, the printed-representation is like that for
random data-types: a number sign and a less than sign, the named
structure symbol, the numerical address of the array, and a greater
than sign.

Other arrays: the p.r. starts with a number sign and
a less-than sign.  Then the "@code{art-}" symbol for the array
type is printed.  Next the dimensions of the array are printed, separated
by hyphens.  This is followed by a space, the machine address of the
array, and a greater-than sign.

Conses:  The p.r. for conses tends to favor @i{lists}.  It
starts with an open-parenthesis.  Then, the @i{car} of the cons is
printed, and the @i{cdr} of the cons is examined.  If it is @code{nil}, a
close parenthesis is printed.  If it is anything else but a cons, space
dot space followed by that object is printed.  If it is a cons, we
print a space and start all over (from the point @i{after} we printed
the open-parenthesis) using this new cons.  Thus, a list is printed as
an open-parenthesis, the p.r.'s of its elements separated by spaces, and a
close-parenthesis.

Thus, the usual printed representations such as @code{(a b (foo bar) c)}
are printed.

The following additional feature is provided for the p.r. of conses:
as a list is printed, @code{print} maintains the length of the list so far,
and the depth of recursion of printing lists.  If the length exceeds the
value of the variable @code{prinlength}, @code{print} will terminate the printed
representation of the list with an ellipsis (three periods) and a close-parenthesis.
If the depth of recursion exceeds the value of the variable @code{prinlevel},
then the list will be printed as "**".  These two features allow a kind of abbreviated
printing which is more concise and suppresses detail.  Of course, neither
the ellipsis nor the "**" can be interpreted by @code{read}, since the relevant information
is lost.

@defvar prinlevel
@code{prinlevel} can be set to the maximum number of nested
lists that can be printed before the printer will give up and just print a
"**".  If it is @code{nil}, which it is initially, any number of nested
lists can be printed.  Otherwise, the value of @code{prinlevel} must be a fixnum.
@end defvar

@defvar prinlength
@code{prinlength} can be set to the maximum number of elements of a list
that will be printed before the printer will give up and print a "@code{...}".
If it is @code{nil}, which it is initially, any length list may be
printed.  Otherwise, the value of @code{prinlength} must be a fixnum.
@end defvar

For any other data type: the p.r. starts with a number sign and
a less-than sign ("@code{<}"), the "@code{dtp-}" symbol for this datatype, a space, and
the machine address of the object.  Then, if the object is a microcoded
function, compiled function, or stack group, its name
is printed.  Finally a greater-than sign ("@code{>}") is printed.

None of the p.r.'s beginning with a number sign can be read back in,
nor, in general, can anything produced by named structure functions.
Just what @code{read} accepts is the topic of the next section.

@subsection What The Reader Accepts
@cindex reader

The purpose of the reader is to accept characters,
interpret them as the p.r. of a Lisp object, and return
a corresponding Lisp object.  The reader cannot accept
everything that the printer produces; for example, the
p.r.'s of arrays (other than strings), compiled code
objects, closures, stack groups etc. cannot be read in.
However, it has many features which are not seen in the
printer at all, such as more flexibility, comments, and
convenient abbreviations for frequently-used unwieldy constructs.

This section shows what kind of p.r.'s the reader understands,
and explains the readtable, reader macros, and various features
provided by @code{read}.

The reader understands the p.r's of fixnums in a way
more general than is employed by the printer.  Here is a complete
description of the format for fixnums.

Let a @i{simple fixnum} be a string of digits, optionally
preceeded by a plus sign or a minus sign, and optionally followed by a
trailing decimal point.  A simple fixnum will be interpreted by
@code{read} as a fixnum.  If the trailing decimal point is present, the
digits will be interpreted in decimal radix; otherwise, they will be
considered as a number whose radix is the value of the variable
@code{ibase}.

@defvar ibase
The value of @code{ibase} is a number which is the radix in which
fixnums are read.  The initial value of @code{ibase} is 8.
@end defvar

@code{read} will also understand a simple fixnum,
followed by an underscore ("_") or a circumflex ("^"),
followed by another simple fixnum.  The two simple fixnums
will be interpreted in the usual way,
then the character in between indicates an operation to be
performed on the two fixnums.  The underscore indicates a binary
"left shift"; that is, the fixnum to its left is doubled the
number of times indicated by the fixnum to its right.  The circumflex
multiplies the fixnum to its left by @code{ibase} the number of
times indicated by the fixnum to its right. Examples:  @code{645_6}
means @code{64500} (in octal) and @code{645^3} means @code{645000}.

Here are some examples of valid representations
of fixnums to be given to @code{read}:

@lisp
4
23456.
-546
+45^+6
2_11
@end lisp

A string of letters, numbers, and "extended alphabetic"
characters is recognized by the reader as a symbol, provided
it cannot be interpreted as a number.
When the reader sees one, it @i{interns} it on a @i{package}
(see (package) for an explanation of interning and the package system).
Symbols may start with digits; you could even
have one named "-345T"; @code{read} will accept this as a symbol
without complaint.  If you want to put strange characters (such as
lower-case letters, parentheses, or reader macro characters) inside the name of a symbol,
put a slash before the strange characters. If you want to have a symbol
whose print-name looks like a number, put a slash before some character
in the name.  You can also enclose the name of a symbol in vertical bars,
which quotes all characters inside, except vertical bars and slashes, which
must be quoted with slash.

@lisp
@exdent Examples of symbols:
foo
bar/(baz/)
34w23
|Frob Sale|
@end lisp

The reader will also recognize strings, which should be
surrounded by double-quotes.  If you want to put a double-quote or
a slash inside a string, preceed it by a slash.

@lisp
@exdent Examples of strings:
"This is a typical string."
"That is known as a /"cons cell/" in Lisp."
@end lisp

When @code{read} sees an open parenthesis, it knows that
the p.r. of a cons is coming, and calls itself recursively to
get the elements of the cons or the list that follows.  Any of
the following are valid:

@lisp
(foo . bar)
(foo bar baz)
(foo . (bar . (baz . nil)))
(foo bar . quux)
@end lisp

The first is a cons, whose car and cdr are both symbols.  The second
is a list, and the third is exactly the same as the second (although
@code{print} would never produce it).  The fourth is a "dotted list";
the cdr of the last cons cell (the second one) is not @code{nil}, but
@code{quux}.
@cindex dotted list

Whenever the reader sees any of the above, it creates new cons
cells; it never returns existing list structure.  This contrasts
with the case for symbols, as very often @code{read} returns symbols
that it found on the package rather than creating new symbols
itself.  Symbols are the only thing that work this way.

The dot that separates the 2 elements of a dotted-pair
p.r. for a cons is only recognized if it is surrounded by delimiters.
Thus dot may be freely used within print-names of symbols and within numbers.

@subsection Sharp-sign Abbreviations

The reader's syntax includes several abbreviations introduced by sharp sign (@code{#}).
These take the general form of a sharp sign, a second character which identifies
the syntax, and following arguments.  Here are the currently-defined sharp-sign
constructs; more are likely to be added in the future.

@table @code
@item #/
@code{#/@i{x}} reads in as the number which is the character code for the
character @i{x}.  For example, @code{#/a} is equivalent to @code{141} but clearer
in its intent.  This is the recommended way to include character constants
in your code.  Note that the slash causes this construct to be parsed correctly
by the editors, Emacs and Eine.

The character can be modified with control and meta bits by inserting one or more special
characters between the @code{#} and the @code{/}.  @code{#/@i{x}} generates control-@i{x}.
@code{#/@i{x}} generates meta-@i{x}.  @code{#/@i{x}} generates super-@i{x}.
@code{#/@i{x}} generates hyper-@i{x}.  These can be combined, for instance
@code{#/&} generates super-meta-ampersand.  Also, @code{#/@i{x}} is an abbreviation
for @code{#/@i{x}}.
@item #\
@code{#\@i{name}} reads in as the number which is the character code
for the non-printing character symbolized by @i{name}.  (In the Lisp-machine
compatible Maclisp environment, Lisp-machine character code is used if the
file is being compiled for the Lisp machine, or ascii character code if the
result is intended to be used in Maclisp.)

The following character names are recognized: @code{break, clear, esc, tab, alt,
form, vt, rubout, bs, call, return, line, back-next, help, space}.  These are the same as
are written on the keys.  The abbreviations @code{cr} for @code{return} and @code{sp}
for @code{space} are accepted and generally used.
[There are a lot more characters as well as these; I'll refrain from documenting
them until things settle down.  Here is the list:
@code{clear-input, escape, clear-screen, quote, hold-output, stop-output,
abort, resume, status, delete, end, i, ii, iii, iv, hand-up, hand-down,
hand-left, hand-right, system, network, lambda, gamma, delta, uparrow,
plus-minus, circle-plus, integral, null, backspace}.]

The character can be modified with control and meta bits by inserting special
characters as with @code{#/}.

The names @code{mouse-1-1, mouse-2-1, mouse-3-1, mouse-1-2, mouse-2-2, @r{and} mouse-3-2}
represent the special characters sometimes used to represent clicking on the
mouse buttons.
@item #^
@code{#^@i{x}} is exactily like @code{#/@i{x}} if the input is being
read by the Lisp machine or being compiled to run on the Lisp machine;
it generates control-@i{x}.
In Maclisp @i{x} is converted to upper case and the xored with 100 (octal).
Thus @code{#^@i{x}} always generates the fixnum returned by @code{tyi} if
the user holds down the control key and types @i{x}.
(In Maclisp @code{#/@i{x}} sets the bit set by the control key when the TTY is
open in FIXNUM mode.)
@item #'
@code{#'@i{foo}} is an abbreviation for @code{(function @i{foo})}.
@i{foo} is the p.r. of any object.
@item #,
@code{#,@i{foo}} evaluates @i{foo} (the p.r. of a Lisp form) at read
time, unless the compiler is doing the reading, in which case it is arranged
that @i{foo} will be evaluated when the QFASL file is loaded.  This is a way,
for example, to include in your code complex list-structure constants which cannot
be written with @code{quote}.  Note that the reader does not put @code{quote}
in front of the result of the evaluation.  You must do this yourself if you
want it, typically by using the @code{'} macro-character.
@item #.
@code{#.@i{foo}} evaluates @i{foo} (the p.r. of a lisp form) at read
time, regardless of who is doing the reading.
@item #O
@code{#O @i{number}} reads @i{number} in octal regardless of the
setting of @code{ibase}.  Actually, any S-expression can be prefixed
by @code{#O}; it will be read with @code{ibase} bound to 8.
@item #R
@code{#@i{radix}R @i{number}} reads @i{number} in radix @i{radix} regardless
of the setting of @code{ibase}.  As with @code{#O}, any S-expression
can be prefixed by @code{#@i{radix}R}; it will be read with @code{ibase}
bound to @i{radix}.  @i{radix} must consist of only digits, and
it is read in decimal.

For example, @code{#3R102} is another way of writing @code{11.}
and @code{#11R32} is another way of writing @code{35.}
@item #X
@code{#X @i{number}} reads @i{number} in radix 16. (hexadecimal)
regardless of the setting if @i{ibase}.  As with @code{#O} and @code{#R},
any S-expression can be prefixed by @code{#X}.
@item #Q
@code{#Q @i{foo}} reads as @i{foo} if the input is being read by the
Lisp machine or being compiled to run on the Lisp machine, otherwise it
reads as nothing (white space).
@item #M
@code{#M @i{foo}} reads as @i{foo} if the input is being read into Maclisp
or compiled to run in Maclisp, otherwise it reads as nothing (white space).
@item #N
@code{#N @i{foo}} reads as @i{foo} if the input is being read into NIL
or compiled to run in NIL, otherwise it reads as nothing (white space).
Also, during the reading of @i{foo},
the reader temporarily defines various NIL-compatible sharp-sign
abbreviations (such as @code{#!} and @code{#"}) in order to parse
the form correctly, even though its not going to be evaluated.

For details on NIL syntax see the NIL manual.
@item #+
This abbreviation provides a read-time conditionalization facility similar
to, but more general than, that provided by @code{#M}, @code{#N} and @code{#Q}.  It is used
as @code{#+@i{feature} @i{form}}.  If @i{feature} is a symbol, then this is
read as @i{form} if @code{(status feature @i{feature})} is @code{t}.
If @code{(status feature @i{feature})} is @code{nil}, then this is read as whitespace.
Alternately, @i{feature} may be a boolean expression composed of @code{and}, @code{or}, and
@code{not} operators and symbols representing items which may appear on the
@code{(status features)} list.
@code{(or lispm amber)} represents evaluation of the predicate
@code{(or (status feature lispm) (status feature amber))}
in the read-time environment.

For example, @code{#+lispm @i{form}} makes @i{form} exist if being read by the Lisp machine,
and is thus equivalent to @code{#Q @i{form}}.  Similarly, @code{#+maclisp @i{form}} is equivalent
to @code{#M @i{form}}.  @code{#+(or lispm nil) @i{form}} will make @i{form} exist on either
the Lisp machine or in NIL.  Note that items may be added to the @code{(status features)}
list by means of @code{(sstatus feature @i{feature})}, thus allowing the user to selectively
interpret or compile pieces of code by parameterizing this list.
@item #-
@code{#-@i{feature} @i{form}} is equivalent to @code{#+(not @i{feature}) @i{form}}.
@item ##
This is an obsolete form of @code{#/}.  You write @code{##} followed by a space,
followed by the character whose character code you want.
@end table

@c Should define how users create these and discuss SI:XR-SHARP-ARGUMENT
@c Which is a real kludge, can anything be done about it?

@subsection The Readtable

(To be supplied.)
@c I think this can be put off for a while.

@subsection Reader Macros

(To be supplied.)
@c Needs to be written.  The explanation of how to install your own WRT the
@c readtable is pretty bad.

@section Input Functions

@defun read &optional stream eof-option
@code{read} reads in the printed representation of a Lisp object
from @i{stream}, builds a corresponding Lisp object, and returns
the object.  If the end-of-file is reached before a valid object starts,
it returns @i{eof-option} instead.  If the end-of-file is reached
in the middle of an object, e.g. inside parentheses, an error is signalled.
@i{stream} defaults to the value of @code{standard-input},
and @i{eof-option} defaults to @code{nil}.

In order to allow compatibility with Maclisp, the arguments are
interpreted in a slightly more complicated way.  If the @i{stream} is
@code{nil}, then the value of @code{standard-input} is used.  If @i{stream}
is @code{t}, the value of @code{terminal-io} is used.

Maclisp allows the two arguments to be interchanged, but the
Lisp machine does not.
@c It does, actually, but that is soon to be flushed.
@end defun

@defvar read-preserve-delimiters
Certain printed-representations given to @code{read}, notably those of symbols
and numbers, require a delimiting character after them.  (Lists do not, because
the matching close parenthesis serves to mark the end of the list.)
Normally @code{read} will throw away the delimiting character if it is "whitespace",
but will preserve it (with a @code{:untyi} stream operation) if the character is
syntactically meaningful, since it may be the start of the next S-expression.

If @code{read-preserve-delimiters} is bound to @code{t} around a call to @code{read},
no delimiting characters will be thrown away, even if they are whitespace.
This may be useful for certain reader macros or special syntaxes.
@end defvar

There is an array called the readtable (see (readtable)) which
is used to control the reader.  It contains information about the syntax
of each character.  Initially it is set up to give the standard Lisp
meanings to all the characters, but the user can change them to make
the reader usable as a lexical analyzer for a wide variety of input
formats or languages.  It is also possible to have several readtables
describing different syntax and to switch from one to another by
binding the symbol @code{readtable}.

The format of the readtable is not yet documented herein.

@defvar readtable
The value of @code{readtable} is the current readtable.
@end defvar

@defun tyi &optional stream eof-option
@code{tyi} inputs one character from @i{stream} and returns it.
The arguments are the same as for @code{read}, except that @i{eof-option}
may not be @code{nil}; it instead defaults to @code{-1} for "Maclisp compatibility".
@end defun

@defun readline &optional stream eof-option
@code{readline} reads in a line of text, terminated by a newline.
It returns the line as a character string, @i{without} the newline character.
This function is usually used to get a line of input from the user.
The arguments are the same as for @code{read}.
@end defun

@defun readch &optional stream eof-option
@code{readch} is just like @code{tyi}, except that instead of returning
a fixnum character, it returns a symbol whose print name is the character
read in.

@cindex character object
This is just like a Maclisp "character object".  The symbol
is interned, on the @code{user} package.
The arguments are the same as for @code{read}.
@end defun

@defun tyipeek &optional peek-type stream eof-option
What @code{tyipeek} does depends on the @i{peek-type}, which
defaults to @code{nil}.  With a @i{peek-type} of @code{nil},
@code{tyipeek} returns the next character to be read from
@i{stream}, without actually removing it from the input stream.
The next time input is done from @i{stream} the character will still
be there; in general, @code{(= (tyipeek) (tyi))} is @code{t}.

If @i{peek-type} is a fixnum less than 1000 octal, then @code{tyipeek}
reads characters from @i{stream} until it gets one equal to @i{peek-type}.
That character is not removed from the input stream.

If @i{peek-type} is @code{t}, then @code{tyipeek} skips over input characters
until the start of the printed representation of a Lisp object is reached.
As above, the last character (the one that starts an object)
is not removed from the input stream.

The form of @code{tyipeek} supported by Maclisp in which @i{peek-type}
is a fixnum not less than 1000 octal is not supported, since the readtable
formats of the Maclisp reader and the Lisp Machine reader are quite different.

The @i{stream} and @i{eof-option} arguments are the same as for @code{read}.
@end defun

Note that all of these functions will echo their input if used on an
interactive stream (one which supports the @code{:rubout-handler}
operation; see below.)  The functions that input more than one
character at a time (@code{read}, @code{readline}) allow the input to be
edited using rubout.  @code{tyipeek} echoes all of the characters that
were skipped over if @code{tyi} would have echoed them; the character not
removed from the stream is not echoed either.

@defun readlist char-list
@i{char-list} is a list of characters.  The characters may
be represented by anything that the function @code{character} accepts:
fixnums, strings, or symbols.  The characters are given successively
to the reader, and the Lisp object built by the reader is returned.
Macro characters and so on will all take effect.
@end defun

@defun read-from-string string &optional eof-option (idx 0)
The characters of @i{string} are given successively
to the reader, and the Lisp object built by the reader is returned.
Macro characters and so on will all take effect.

@i{eof-option} is what to return if the end of the string is reached,
as with other reading functions.  @i{idx} is the index in the string
of the first character to be read.

@lisp
@exdent Example:
(read-from-string "(a b c)") => (a b c)
@end lisp
@end defun

@section Output Functions

@defun prin1 x &optional stream
@code{prin1} outputs the printed representation of @i{x} to
@i{stream}, with slashification (see (slashification)).
@i{stream} defaults to the value of @code{standard-output}.
If @i{stream} is @code{nil}, the value of @code{standard-output}
is used.  If it is @code{t}, the value of @code{terminal-io} is used.
If it is a list of streams, then the output is performed to all
of the streams (this is not implemented yet).
@end defun

@defun prin1-then-space x &optional stream
@code{prin1-then-space} is like @code{prin1} except that output
is followed by a space.
@end defun

@defun print x &optional stream
@code{print} is just like @code{prin1} except that output
is preceeded by a newline and followed by a space.
@end defun

@defun princ x &optional stream
@code{princ} is just like @code{prin1} except that the
output is not slashified.
@end defun

@defun tyo char &optional stream
@code{tyo} outputs the character @i{char} to @i{stream}.
The @i{stream} argument is the same as for @code{prin1}.
@end defun

@defun terpri &optional stream
@code{terpri} outputs a newline character to @code{stream}.
The @i{stream} argument is the same as for @code{prin1}.
@end defun

The @code{format} function (see (format-fun)) is very useful for producing
nicely formatted text.  It can do anything any of the above functions
can do, and it makes it easy to produce good looking messages and such.

The @code{grindef} function is useful for formatting Lisp programs.
See (grindef-fun).

@defun cursorpos &optional arg1 arg2
This function exists primarily for Maclisp compatibility.  Usually
it is preferable to call the TV routines directly.  @code{cursorpos}
only operates on @code{console-io-pc-ppr} and does not work if
a different font than the default is being used.  The Maclisp Newio
feature where one of the arguments to @code{cursorpos} can be a file
is not supported.

@code{(cursorpos)} => @code{(@i{line . column})}, the current
cursor position.

@code{(cursorpos @i{line column})} moves the cursor to that position.
It returns @code{t} if it succeeds and @code{nil} if it doesn't.

@code{(cursorpos @i{op})} performs a special operation coded by @i{op},
and returns @code{t} if it succeeds and @code{nil} if it doesn't.
@i{op} is tested by string comparison, it is not a keyword.

@table @code
@item F
Moves one space to the right.
@item B
Moves one space to the left.
@item D
Moves one line down.
@item U
Moves one line up.
@item C
Clears the piece of paper.
@item T
Homes up (moves to the top left corner).
@item E
Clear from the cursor to the end of the piece of paper.
@item L
Clear from the cursor to the end of the line.
@item K
Clear the character position at the cursor.
@item X
B then K.
@item Z
Home down (moves to the bottom left corner).
@end table

@end defun

@defun exploden x
@code{exploden} returns a list of characters (as fixnums) which
are the characters that would be typed out by @code{(princ @i{x})}
(i.e. the unslashified printed representation of @i{x}).

@lisp
@exdent Example:
(exploden '(+ /12 3)) => (50 53 40 61 62 40 63 51)
@end lisp
@end defun

@defun explodec x
@code{explodec} returns a list of characters represented by character
objects which are the characters that would be typed out by
@code{(princ @i{x})} (i.e. the unslashified printed representation of @i{x}).

@lisp
@exdent Example:
(explodec '(+ /12 3)) => ( /( + /  /1 /2 /  /3 /) )
@end lisp

(Note that there are slashified spaces in the above list.)
@end defun

@defun explode x
@code{explode} returns a list of characters represented by character
objects which are the characters that would be typed out by
@code{(prin1 @i{x})} (i.e. the slashified printed representation of @i{x}).

@lisp
@exdent Example:
(explode '(+ /12 3)) => ( /( + /  // /1 /2 /  /3 /) )
@end lisp

(Note that there are slashified spaces in the above list.)
@end defun

@defun flatsize x
@code{flatsize} returns the number of characters in the slashified printed representation
of @i{x}.
@end defun

@defun flatc x
@code{flatc} returns the number of characters in the unslashified printed representation
of @i{x}.
@end defun

@defun stream-copy-until-eof from-stream to-stream &optional leader-size
@code{stream-copy-until-eof} inputs characters from @i{from-stream}
and outputs them to @i{to-stream}, until it reaches the end-of-file
on the @i{from-stream}.  For example, if @code{x} is bound to a stream
for a file opened for input, then @code{(stream-copy-until-eof x terminal-io)}
will print the file on the console.

If @i{from-stream} supports the @code{:line-in} operation and @i{to-stream}
supports the @code{:line-out} operation, then @code{stream-copy-until-eof} will
use those operations instead of @code{:tyi} and @code{:tyo}, for greater
efficiency.  @i{leader-size}  will be passed as the argument to the
@code{:line-out} operation.
@end defun

@section I/O Streams

@subsection What Streams Are

Many programs accept input characters and produce output characters.
The method for performing input and output to one device is very different
from the method for some other device.  We would like our programs to be able
to use any device available, but without each program having to know about
each device.

In order to solve this problem, we introduce the concept of
a @i{stream}.  A stream is a source and/or sink of characters.
A set of @i{operations} is available with every stream; operations include
things like "output a character" and "input a character".  The way to perform
an operation to a stream is the same for all streams, although what happens
inside the stream is very different depending on what kind of a stream it is.
So all a program has to know is how to deal with streams.

A stream is a functional object; that is, it is something that
you can apply to arguments.  The first argument given to a stream is a
symbol which is the name of the operation you wish to perform.  The
rest of the arguments depend on what operation you are doing.

Some streams can only do input, some can only do output, and some can
do both.  Some operations are only supported by some streams.  Also,
there are some operations which the stream may not support by itself,
but will work anyway, albeit slowly, because the "stream default handler" can handle
them.  If you have a stream, there is an operation called
@code{:which-operations} that will return a list of the names of all of
the operations that are supported "natively" by the stream.  @i{All}
streams support @code{:which-operations}, and so it isn't in the list
itself.

@subsection General Purpose Stream Operations

Here are some simple operations.  Listed are the name of the
operation, what arguments it takes, and what it does.

@table @code
@item :tyo
Takes one argument, which is a character.  The stream will output
that character.  For example, if @code{s} is bound to a stream, then the form

@lisp
(funcall s ':tyo 102)
@end lisp

will output a "B" to the stream.
@item :tyi
Takes one optional argument, described later.  The stream will
input one character and return it.  For example, if the next character
to be read in by the stream is a "C", then the form

@lisp
(funcall s ':tyi)
@end lisp

will return 103.  Note that the @code{:tyi} operation will not
"echo" the character in any fashion; it just does the input.  The
@code{tyi} function (see (tyi-fun)) will do echoing
when reading from the terminal.  The argument to the @code{:tyi}
operation tells the stream what to do if it gets to the end of the
file.  If the argument is not provided or is @code{nil}, the stream will
return @code{nil} at the end of file.  Otherwise it will signal an error,
and print out the argument as the error message.
@item :untyi
Takes one argument, which is a character.  The stream will
remember that character, and the next time a character is input, it
will return the saved character.  In other words, @code{:untyi} means
"stuff this character back into the input source".  For example,

@lisp
(funcall s ':untyi 120)
(funcall s ':tyi) ==> 120
@end lisp

This operation is used by @code{read}, and any stream which supports @code{:tyi}
must support @code{:untyi} as well.  Note that you are only allowed to @code{:untyi}
one character before doing a @code{:tyi}, and you aren't allowed to @code{:untyi} a different
character than the last character you read from the stream.  Some streams implement
@code{:untyi} by saving the character, while others implement it by backing up
the pointer to a buffer.
@item :which-operations
Takes no arguments.  It returns a list of the operations
supported "natively" by the stream.

@lisp
@exdent Example:
(funcall s ':which-operations)
   ==> (:tyi :tyo :untyi :line-out :listen)
@end lisp
@end table

Any stream must either support @code{:tyo}, or support both
@code{:tyi} and @code{:untyi}.  There are several other, more advanced input
and output operations which will work on any stream that can do input
or output (respectively).  Some streams support these operations
themselves; you can tell by looking at the list returned by the
@code{:which-operations} operation.  Others will be handled by the "stream
default handler" even if the stream does not know about the operation
itself.  However, in order for the default handler to do one of the
more advanced output operations, the stream must support @code{:tyo}, and
for the input operations the stream must support @code{:tyi} (and
@code{:untyi}).

Here is the list of such operations:

@table @code
@item :listen
On an interactive device, the @code{:listen} operation returns non-@code{nil}
if there are any input characters immediately available, or @code{nil} if there
is no immediately available input.  On a non-interactive device, the
operation always returns @code{nil}, by virtue of the default handler.
The main purpose of
@code{:listen} is to test whether the user has hit a key, perhaps
trying to stop a program in progress.
@item :fresh-line
An output operation which takes no arguments.  It tells
the stream that it should position itself at the beginning of a new line;
if the stream is already at the beginning of a fresh line it will do nothing,
otherwise it will output a newline.  For streams which don't support this,
the default handler will always output a newline.
@item :string-out
An output operation which takes one required argument, a string to output.
The characters of the string are successively output to the stream.  This operation
is provided for two reasons; first, it saves the writing of a loop which is used
very often, and second, some streams can perform this operation much more
efficiently than the equivalent @code{:tyo} operations.  The @code{:string-out}
operation also takes two optional arguments, which are a range of characters
withing the string to output; the second argument is the index of the
first character to output
(defaulting to @code{0}),
and the third is one greater than the index of the last character to output
(defaulting to the length of the string).
Callers need not pass these arguments, but all streams that handle
@code{:string-out} must check for them and interpret them appropriately.
If the stream
doesn't support @code{:string-out} itself, the default hander will turn it
into a bunch of @code{:tyo}s.
@item :line-out
An output operation which takes one argument, a string.
The characters of the string, followed by a newline character, are output
to the stream.  If the stream
doesn't support @code{:line-out} itself, the default hander will turn it
into a bunch of @code{:tyo}s.
@item :line-in
An input operation which takes one argument.  The stream
should input one line from the input source, and return it as a string
with the newline character stripped off.  Many streams will have a string which
is used as a buffer for lines.  If this string itself is returned, there
would be problems caused if the caller of the stream attempted
to save the string away somewhere, because the contents of the string
would change when the next line was read in.  In order to solve this
problem, the string must be copied. On the other hand, some streams
don't reuse the string, and it would be wasteful to copy it on every
@code{:line-in} operation.  This problem is solved by using the argument
to @code{:line-in}.  If the argument is @code{nil}, the stream will not
bother to copy the string, and the caller should not rely on the contents
of that string after the next operation on the stream.  If the argument
is @code{t}, the stream will make a copy.  If the argument is a fixnum, @i{n},
then the stream will make a copy with an array leader @i{n} elements
long.  (This is used by the editor, which represents lines of buffers
as strings with additional information in their array-leaders, to
eliminate an extra copy operation.)
If the stream reaches the end-of-file while reading in characters,
it will return the characters it has read in as a string, and return
a second value of @code{t}.  The caller of the stream should therefore
arrange to receive the second value, and check it to see whether the string
returned was a whole line or just the trailing characters after the last newline
in the input source.
@item :clear-input
Takes no arguments.  The stream will clear any buffered
input.  If the stream does not handle this, the default handler
will ignore it.
@item :clear-output
Takes no arguments.  The stream will clear any buffered
output.  If the stream does not handle this, the default handler
will ignore it.
@item :finish
Takes no arguments.  It returns when the currently pending
I/O operation is completed.  It does not do anything itself; it is just used
to await completion of an operation.  If the stream does not handle this,
the default handler will ignore it.
@item :force-output
Takes no arguments.  It causes any buffered output
to be sent to the device.  If the stream does not handle this,
the default handler will ignore it.
@item :close
This takes an optional argument, which you usually don't supply.
The stream is "closed", and no
further operations should be performed on it.  However, it is all right
to @code{:close} a closed stream.  If the stream does not handle @code{:close}, the
default handler will ignore it.

With an argument of @code{:abort}, we are abnormally exiting from the use of this stream.
If the stream is outputting to a file, and has not been closed already, the
stream's newly-created file will be deleted; it will be as if it was never
opened in the first place.

@item :tyi-no-hang
Just like @code{:tyi} except that if it would be neccesary to wait in order to get
the character, returns @code{nil} instead.  This lets the caller efficiently
check for input being available and get the input if there is any.
@end table

@subsection Special Purpose Stream Operations

There are several other defined operations which the default
handler cannot deal with; if the stream does not support the operation itself,
then an attempt to use it will signal an error.  These are:

@table @code
@item :read-pointer
This is supported by the file stream (see (file-stream)).
It takes no arguments, and returns the position that the stream is up to in the file,
as a number of characters.
@item :name
This is supported by the file stream.  It returns the name of the file
open on the stream, as a string.
@item :rubout-handler
This is supported by interactive streams such as the @code{tv-terminal-stream}, and is described
in its own section below (see (rubout-handler)).
@item :untyo-mark
This is used by @code{grind} if the output stream supports it.
It takes no arguments.  The stream
should return some object which indicates where output has gotten up to in
the stream.
@item :untyo
This is used by @code{grind} in conjunction with @code{:untyo-mark}.
It takes one argument, which is something returned by the @code{:untyo-mark}
operation of the stream.  The stream should back up output to the point
at which the object was returned.
@item :read-cursorpos
This operation is supported by piece-of-paper streams (see @code{tv-make-stream},
(tv-make-stream-fun)).  It returns two values: the current @i{x} and @i{y} positions
of the cursor.  It takes one argument, which is a symbol indicating
in what units @i{x} and @i{y} should be; the symbols @code{:pixel}
and @code{:character} are understood.  This operation, and @code{:set-cursorpos},
are used by the @code{format} @code{"~T"} request (see (format-t-operation)),
which is why @code{"~T"}
doesn't work on all streams.  Any stream that supports this operation must
support @code{:set-cursorpos} as well.
@item :set-cursorpos
This operation is supported by the same streams that support
@code{:read-cursorpos}.  It sets the position of the cursor.  It takes
three arguments: a symbol indicating the units (just like
@code{:read-cursorpos}), the new @i{x} position, and the new @i{y}
position.
@item :pc-ppr
Takes no arguments.  Returns the @i{piece of paper} on which the stream
displays.  Non-TV streams don't support this operation.
@item :clear-screen
Takes no arguments.  Erases the screen area on which this stream displays.
Non-TV streams don't support this operation.
@end table

@subsection Standard Streams

There are several variables whose values are streams used by many
functions in the Lisp system.  These variables and their uses are listed here.
By convention, variables which are expected to hold a stream capable of input
have names ending with @code{-input}, and similarly for output.  Those expected
to hold a bidirectional stream have names ending with @code{-io}.

@defvar standard-input
In the normal Lisp top-level loop, input is read from
@code{standard-input} (that is, whatever stream is the value of
@code{standard-input}).  Many input functions, including @code{tyi} and
@code{read}, take a stream argument which defaults to @code{standard-input}.
@end defvar

@defvar standard-output
In the normal Lisp top-level loop, output is sent to
@code{standard-output} (that is, whatever stream is the value of
@code{standard-output}).  Many output functions, including @code{tyo} and
@code{print}, take a stream argument which defaults to @code{standard-output}.
@end defvar

@defvar error-output
The value of @code{error-output} is a stream to which error messages
should be sent.  Normally this is the same as @code{standard-output},
but @code{standard-output} might be bound to a file and @code{error-output}
left going to the terminal.
[This seems not be used by things which ought to use it.]
@end defvar

@defvar query-io
The value of @code{query-io} is a stream which should be used when
asking questions of the user.  The question should be output to this
stream, and the answer read from it.  The reason for this is that when
the normal input to a program may be coming from a file, questions such
as "Do you really want to delete all of the files in your directory??" should
be sent elsewhere (usually directly to the user).
[This seems not be used by things which ought to use it.]
@end defvar

@defvar terminal-io
The value of @code{terminal-io} is always the stream which connects to the user's
console.  For someone using the Lisp Machine from its keyboard and TV, the value
will be @code{tv-terminal-stream}.  The default values of the above four variables
are streams which simply take whatever operations they are given and pass them
on to whatever stream is the value of @code{terminal-io}.  No user program
should ever change the value of @code{terminal-io}.  A program which wants
(for example) to divert output to a file should do so by binding the value
of @code{standard-output}; that way error messages sent to @code{error-output}
can still get to the user by going through @code{terminal-io}, which is usually
what is desired.
@end defvar

@defun make-syn-stream symbol
@code{make-syn-stream} creates and returns a "synonym stream".  Any operations
sent to this stream will be redirected to the stream
which is the value of @i{symbol}.

@code{standard-input}, @code{standard-output}, @code{error-output}, and
@code{query-io} are initially bound to synonym streams which
use the value of @code{terminal-io}.
@end defun

@subsection Making Your Own Stream

@c How I wrote a stream in my spare time, and so can you, by A. J. Specktowski

Here is a sample output stream, which accepts characters and conses
them onto a list.

@lisp
(defun list-output-stream (op &optional arg1 &rest rest)
    (selectq op
        (:tyo
         (setq the-list (cons arg1 the-list)))
        (:which-operations '(:tyo))
        (otherwise
         (multiple-value-call
          (stream-default-handler (function list-output-stream)
                                  op arg1 rest)))))
@end lisp

The lambda-list for a stream must always have one required parameter (@code{op}),
one optional parameter (@code{arg1}), and a rest parameter (@code{rest}).
This allows an arbitrary number of arguments to be passed to the
default handler.
This is an output stream, and so it supports the @code{:tyo} operation.
Note that all streams must support @code{:which-operations}.
If the operation is not one that the stream understands (e.g. @code{:string-out}),
it calls the @code{stream-default-handler}.  The calling of the default handler
is @i{required}, since the willingness to accept @code{:tyo} indicates to the caller
that @code{:string-out} will work.  The @code{multiple-value-call}
(see (multiple-value-call-fun)) is used so that if the default
handler returns multiple values, the stream will return all of them.

Here is a typical input stream, which generates successive characters
of a list.

@lisp
(defun list-input-stream (op &optional arg1 &rest rest)
  (selectq op
    (:tyi
     (cond ((not (null untyied-char))
            (prog1 untyied-char (setq untyied-char nil)))
           ((null the-list)
            (or arg1
                (ferror nil "You got to the end of the stream.")))
           (t (prog1 (car the-list)
                     (setq the-list (cdr the-list))))))
    (:untyi
     (setq untyied-char arg1))
    (:which-operations '(:tyi :untyi))
    (otherwise
     (multiple-value-call
      (stream-default-handler (function list-input-stream)
                              op arg1 rest)))))
@end lisp

The important things to note are that @code{:untyi} must be supported,
and that the stream must check for having reached the end of the information,
and do the right thing with the argument to the @code{:tyi} operation.

The above stream uses a free variable (@code{the-list}) to hold
the list of characters, and another one (@code{untyied-char}) to hold
the @code{:untyi}ed character (if any).
You might want to have several instances of this type of
stream, without their interfering with one another.  This is a typical
example of the usefulness of closures in defining streams.  The following
function will take a list, and return a stream which generates successive
characters of that list.

@lisp
(defun make-a-list-input-stream (list)
   (let-closed ((list list) (untyied-char nil))
       (function list-input-stream)))
@end lisp

@defun stream-default-handler stream op arg1 rest
@code{stream-default-handler} tries to handle
the @i{op} operation on @i{stream}, given arguments
of @i{arg1} and the elements of @i{rest}.  The exact action
taken for each of the defined operations is explained with
the documentation on that operation, above.:
@end defun

@section Accessing Files

As of this writing, the Lisp Machine uses the A.I. PDP-10's
file system to read and write files.  The A.I. machine is accessed
through the Chaos network.  When the Lisp Machine is started, it will
tell you whether it has successfully connected to the file system.  The
function @code{si:file-use-chaos} (not documented in this manual) allows
you to initiate a connection to the file system server, and to control
which machine is used as a file system.

At present, there may be no more than one file open for reading
and one file open for writing at a time.

All of the functions herein are subject to change, and in general
you shouldn't belive too much of this.  However, it does describe the existing
software.

@defspec with-open-file
@code{(with-open-file (@i{s} @i{fn} @i{options}) @i{body1} @i{body2}...)}
[needs to be documented.  Discourage direct use of @code{open}.]

.complain_to_user
@end defspec

@defun open filename options
This is the function for accessing files.  It returns a stream which is
connected to the specified file.  Unlike Maclisp, the @code{open} function
only creates streams for @i{files}; other streams are created by other functions.

@i{filename} is the name of the file to be opened; it must be a string.
Currently, files are stored on ITS and @i{filename} must be an ITS file name.
If an ITS error (such as file not found) occurs when opening the file,
a Lisp error is signalled.

@i{options} is either a single symbol or a (possibly-null) list of symbols.
The following option symbols are recognized:

@table @code
@item :in, :read
Select opening for input (the default).
@item :out, :write, :print
Select opening for output; a new file is to be created.
@item :fixnum
Select binary mode, otherwise character mode is
used.  Note that fixnum mode uses 16-bit binary words
and is not compatible with Maclisp fixnum mode which uses 36-bit words.
@item :ascii
The opposite of :fixnum.  This is the default.
@item :single, :block
Ignored for compatibility with Maclisp.
@end table

For example, evaluating any of the forms

@lisp
(open "info;dir >" ':in)
(open "INFO;DIR >" '(:read))
(open "DIR > INFO;" ':read)
@end lisp

will open the file "AI: INFO; DIR >", and return an input stream which will
return successive characters of the file, and support the following operations:
@code{:tyi, :untyi, :clear,
:close, :name,} and @code{:line-in}.
When the caller is finished with the
stream, it should close the file by using the @code{:close} operation or
the @code{close} function.

Opening a file output stream creates a new file with specified name
(calling it "_LSPM_ OUTPUT" until it has been successfully closed)
and returns a stream which supports the following operations:
@code{:tyo, :close, :finish, :read-pointer, :name, :line-out, @r{and} :string-out}.
@end defun

@defun close stream
The @code{close} function simply performs the @code{:close} operation on @i{stream}.
@end defun

@subsection Other File Operations

@defun file-command &rest strings
This concatenates all of the @i{strings} and sends the result
as a command to the PDP-10 FILE job.  It returns the string
which is the FILE program's response, except that if the response
was empty, it returns @code{nil}.  The returned string is special
and will be clobbered by the next file operation,
so you should copy it (with @code{string-append}, see (string-append-fun))
if you want to save it.
@end defun

@defun file-command-careful &rest strings
This is the same as @code{file-command}, but if the string returned
from the FILE program is not empty, it signals an error, using
that string as the error-message.
@end defun

@defvar file-error
When an error such as "File Not Found" or "No Such Directory" occurs,
(i.e. errors due to the current state of the file system), then
instead of directly calling @code{error}, the file-access functions
apply the value of @code{file-error} to the arguments upon which @code{error} would
have been called.  In fact, the default binding of @code{file-error}
is to the symbol @code{error}.  However, this convention allows flexibility
in such programs as EINE, which may want to handle such errors
specially.

This little feature is recognized as an inelegant kludge, which
will be repaired when the error system is more fully developed.
@end defvar

@defun file-error-status filename
This tries to open the file @i{filename}.  If it gets an
error, it returns the ITS error code, which will always
be a small positive fixnum; otherwise it returns @code{nil}.
In any case it leaves the file closed.
@end defun

@defun file-mapped-open filename &optional (write-p @code{nil})
Tells the pdp10 FILE program to map the specified file
into its address space for random access, searching, etc.
This is used in the present implementation of multi-sectioned files.
@code{file-mapped-open} returns a stream to read from the file
if @i{write-p} is @code{nil}, or write to it if @i{write-p} is @code{t}.
The stream will apply only to the subrange of the file set by
the latest @code{mapset} or @code{finddef} command given to the FILE job.
On reading, when you get to the end of the range, it is considered
the end-of-file.  Giving another @code{mapset} or @code{finddef} command will
make it start reading from a different range.  To skip
the rest of a range, do another @code{mapset} or @code{finddef}
and do a @code{:clear} operation on the stream.
To set the range with @code{mapset}, do @code{(file-command "mapset @i{start} @i{size}")}
where @i{start} and @i{size} are numbers converted to decimal.
To set the range to @code{foo}'s definition, do @code{(file-command "finddef " "foo")}.
@end defun

@defun file-qfasl-p filename
If the file is a QFASL file, return @code{t}; otherwise return @code{nil}.
This works by checking the file itself, not the name; if opening
the file gives an ITS error, an error is signalled.
@end defun

@defun file-exists-p pathname
Returns @code{nil} if the file @i{pathname} does not exist.  If it
does exist, returns @code{:qfasl} if it is a QFASL file, and otherwise @code{t}.
@end defun

@subsection File Name Manipulation

@defun file-expand-pathname filename
This defaults the FN2 to ">", and any other unspecified components
from the current default filename. It then sets up the current default
filename to be the resulting filename, and returns it.  This will
always return the filename in a canonical form.

@lisp
@exdent Example:
(file-expand-pathname "lispm;foo") => "AI: LISPM; FOO >"
@end lisp
@end defun

@defun file-default-fn2 filename fn2
If @i{filename} does not specify its FN2 component, this returns
a filename whose FN2 is @i{fn2}, and whose other components are from
@i{filename}.

@lisp
@exdent Example:
(file-default-fn2 "lispm;foo" "bar") => "AI: LISPM; FOO BAR"
@end lisp
@end defun

@defun file-set-fn2 filename fn2
Returns a filename whose FN2 is @i{fn2}, and whose other components
are from @i{filename}.

@lisp
@exdent Example:
(file-set-fn2 "lispm;foo >" "qfasl") => "AI: LISPM; FOO QFASL"
@end lisp
@end defun

@section Rubout Handling

The rubout handler is a feature of all interactive streams, that is, streams
which connect to terminals.  Its purpose is to allow the user to edit
minor mistakes in typein.  At the same time, it is not supposed to
get in the way; input is to be seen by Lisp as soon as a syntactically complete
form has been typed.  The rubout handler also provides a few
commands to do things like clear the screen.

The rubout handler will eventually provide the same editing commands
as the editor, but at this writing they have not yet been conjoined.

The basic way that the rubout handler works is as follows.  When
an input function that reads an "object", such as @code{read} or @code{readline}
but not @code{tyi}, is called to read from a stream which has @code{:rubout-handler}
in its @code{:which-operations} list, that function "enters" the rubout handler.
It then goes ahead @code{:tyi}'ing characters from the stream.  Because control
is inside the rubout handler, the stream will echo these characters so the user
can see what he is typing.  (Normally echoing is considered to be a higher-level
function outside of the province of streams, but when the higher-level function
tells the stream to enter the rubout handler it is also handing it the responsibility
for echoing).  The rubout handler is also saving all these characters in a buffer,
for reasons disclosed in the following paragraph.
When the function, @code{read} or whatever, decides it has enough
input, it returns and control "leaves" the rubout handler.  That was the easy case.

If the user types a rubout, a @code{*throw} is done, out of all recursive levels
of @code{read}, reader macros, and so forth, back to the point where the rubout
handler was entered.  Also the rubout is echoed by erasing from the screen
the character which was rubbed out.  Now the @code{read} is tried over again,
re-reading all the characters which had been typed and not rubbed out, not echoing
them this time.  When the saved characters have been exhausted, additional input is read
from the user in the usual fashion.

The effect of this is a complete separation of the functions of rubout
handling and parsing, while at the same time mingling the execution of
these two functions in such a way that input is always "activated" at
just the right time.  It does mean that the parsing function (in the
usual case, @code{read} and all macro-character definitions) must be
prepared to be thrown through at any time and should not have
non-trivial side-effects.

If an error occurs while inside the rubout handler, the error message is printed
and the buffered input is redisplayed.  The user can then type as he wishes;
the input will be reparsed from the beginning in the usual fashion
after he rubs out the characters which caused the error.

The rubout handler also recognizes the special characters Clear, Form, and VT.
Form clears the screen and echoes back the buffered input.  Clear is like
hitting enough rubouts to flush all the buffered input.  VT is like Form
in that it echoes back the input, but it does not clear the screen.

If a Control or Meta character is typed to the rubout handler, the rubout
handler beeps and ignores the character.  In the future control and meta
characters will be usable for editing the input.  Control-Z, however, is
usually intercepted by the @code{kbd-tyi-hook} and causes control to be thrown
to top-level.  Note that when not inside the rubout handler, Control and
Meta characters are passed through as input like ordinary characters.

The way that the rubout handler is entered is complicated, since a
@code{*catch} must be established.  The variable @code{si:rubout-handler} is
non-@code{nil} if the current process is inside the rubout handler.  This is
used to handle recursive calls to @code{read} from inside reader macros and the
like.  If @code{si:rubout-handler} is @code{nil}, and the stream being read from
has @code{:rubout-handler} in its @code{:which-operations}, functions such as
@code{read} send the @code{:rubout-handler} operation to the stream with arguments
of a list of options, the function, and its arguments.  The rubout handler
initializes itself and establishes its @code{*catch}, then calls back to the
specified function.  If you look at the code in @code{read}, you will see some
magic hair which is used to make sure that multiple values pass back through
all this correctly.  This will eventually become unnecessary.
@defvar si:rubout-handler
@code{t} if control is inside the rubout handler in this process.
@end defvar

Each option in the list of options given as the first argument to the @code{:rubout-handler}
stream operation consists of a list whose first element is one of the following
keywords and whose remaining elements are "arguments" to that keyword.

@table @code
@item (:full-rubout @i{val})
If the user rubs out all the characters he typed, then control will be returned
from the rubout handler immediately.  In the absence of this option, the rubout
handler would simply wait for more characters to be typed in.  Two values
are returned; the first is @code{nil} and the second is @i{val}.
@item (:pass-through @i{char1} @i{char2}...)
The characters @i{char1}, @i{char2}, etc. are not to be treated as special
by the rubout handler.  You can use this to override the default processing
of characters such as Clear.
@item (:prompt @i{function})
@item (:reprompt @i{function})
When it is time for the user to be prompted, @i{function} is called with
two arguments.  The first is a stream it may print on; the second is the
character which caused the need for prompting, e.g. @code{#\clear} or @code{#\form}, or @code{nil}
if the rubout handler was just entered.

The difference between @code{:prompt} and @code{:reprompt} is that the latter does
not call the prompt function when the rubout handler is first entered.
@end table

@section Special I/O Devices

@c Moby I/O
-> pointers to separate chapter on TV, keyboard, and mouse.

-> pointer to separate chapter on Chaos net

-> how to use whatever else ought to go in here

@c DSK:LMMAN;PACKD 66
@c This file is part of the Lisp Machine manual.	-*-Text-*-
@c Documentation on PACK4.

@chapter Packages
@cindex package

@section The Need for Multiple Contexts

A Lisp program is a collection of function definitions.
The functions are known by their names, and so each must have its
own name to identify it.  Clearly a programmer must not use the same
name for two different functions.

The Lisp machine consists of a huge Lisp environment, in which many
programs must coexist. All of the "operating system", the compiler, the
EINE editor, and a wide variety of programs are provided in the initial
environment.  Furthermore, every program which the user uses during
his session must be loaded into the same environment.  Each of these
programs is composed of a group of functions; apparently each function
must have its own distinct name to avoid conflicts.  For example, if
the compiler had a function named @code{pull}, and the user loaded a program
which had its own function named @code{pull}, the compiler's @code{pull} would be
redefined, probably breaking the compiler.

It would not really be possible to prevent these conflicts,
since the programs are written by many different people who could
never get together to hash out who gets the privilege of using
a specific name such as @code{pull}.

Now, if we are to enable two programs to coexist in the Lisp
world, each with its own function @code{pull}, then each program must have
its own symbol named "@code{pull}", because there can't be two function
definitions on the same symbol.  This means that separate "name
spaces"--mappings between names and symbols--must be provided for
them.  The package system is designed to do just that.

Under the package system,  the author of a program or a group
of closely related programs identifies them together as a "package".
The package system associates a distinct name space with each package.

Here is an example: suppose there are two programs named @code{chaos}
and @code{arpa}, for handling the Chaos net and Arpanet respectively.  The
author of each program wants to have a function called @code{get-packet},
which reads in a packet from the network (or something).  Also, each
wants to have a function called @code{allocate-pbuf}, which allocates the
packet buffer.  Each "get" routine first allocates a packer buffer,
and then reads bits into the buffer; therefore, each version of
@code{get-packet} should call the respective version of @code{allocate-pbuf}.

Without the package system, the two programs could not coexist
in the same Lisp environment.  But the package feature can be used to
provide a separate name space for each program.  What is required is
to declare a package named @code{chaos} to contain the Chaos net program, and
another package @code{arpa} to hold the Arpanet program.  When the Chaos net
program is read into the machine, its symbols would be entered in the
@code{chaos} package's name space.  So when the Chaos net program's
@code{get-packet} referred to @code{allocate-pbuf}, the @code{allocate-pbuf} in the @code{chaos}
name space would be found, which would be the @code{allocate-pbuf} of the
Chaos net program--the right one.  Similarly, the Arpanet program's
@code{get-packet} would be read in using the @code{arpa} package's name space and
would refer to the Arpanet program's @code{allocate-pbuf}.

An additional function of packages is to remember the names of
the files which constitute each program, making it easy to ask to load
or recompile all of them at once.

To understand what is going on here, you should keep in mind
how Lisp reading and loading works.  When a file is gotten into the
Lisp machine, either by being read or by being fasloaded, the file itself
obviously cannot contain Lisp objects; it contains printed representations
of those objects.  When the reader encounters a printed representation of a symbol,
it calls @code{intern} to look up that string in some name space and find
a corresponding symbol to return.  The package system arranges that the correct
name space is used whenever a file is loaded.

@section The Organization of Name Spaces

We could simply let every name space be implemented as one
obarray, e.g. one big table of symbols.  The problem with this is
that just about every name space wants to include the whole
Lisp language: @code{car}, @code{cdr}, and so on should be available to every
program.  We would like to share the main Lisp system between
several name spaces without making many copies.

Instead of making each name space be one big array,
we arrange packages in a tree.  Each package has a
"superpackage" or "parent", from which it "inherits" symbols.  Also,
each package has a table, or "obarray", of its own additional
symbols.  The symbols belonging to a package are simply those in the
package's own obarray, followed by those belonging to the
superpackage.  The root of the tree of packages is the package called
@code{global}, which has no superpackage.  @code{global} contains @code{car} and @code{cdr} and
all the rest of the standard Lisp system.  In our example, we might
have two other obarrays called @code{chaos} and @code{arpa}, each of which would
have @code{global} as its parent.  Here is a picture of the resulting tree
structure:

@lisp
                    global
                       |
          /----------------------------\
          |                            |
        chaos                         arpa
@end lisp

In order to make the sharing of the @code{global} package work, the
@code{intern} function is made more complicated than in basic Lisp.  In
addition to the string or symbol to intern, it must be told which
package to do it in.  First it searches for a symbol with the
specified name in the obarray of the specified package.  If nothing is
found there, @code{intern} looks at its superpackage, and then at the
superpackage's superpackage, and so on, until the name is found or a
root package such as @code{global} is reached.
When @code{intern} reaches the root package, and doesn't find the symbol there either,
it decides that there is no symbol known with that name, and adds a
symbol to the originally specified package.

Since you don't normally want to worry about specifying
packages, @code{intern} normally uses the "current" package, which is the
value of the symbol @code{package}.  This symbol serves the purpose of the
symbol @code{obarray} in Maclisp.

Here's how that works in the above example.  When the Chaos
net program is read into the Lisp world, the current package would be
the @code{chaos} package.  Thus all of the symbols in the Chaos net program
would be interned on the @code{chaos} package.  If there is a reference to
some well known global symbol such as @code{append}, @code{intern} would look for
"@code{append}" on the @code{chaos} package, not find it, look for "@code{append}" on
@code{global}, and find the regular Lisp @code{append} symbol, and return that.  If,
however, there is a reference to a symbol which the user made up
himself (say it is called @code{get-packet}), the first time he uses it,
@code{intern} won't find it on either @code{chaos} nor @code{global}.  So @code{intern} will make
a new symbol named @code{get-packet}, and install it on the @code{chaos} package.
When @code{get-packet} is refered to later in the Chaos net program, @code{intern}
will find @code{get-packet} on the @code{chaos} package.

When the Arpanet program is read in, the current package would
be @code{arpa} instead of @code{chaos}.  When the ArpaNet program refers
to @code{append}, it gets the @code{global} one; that is, it shares the same one
that the Chaos net program got.  However, if it refers to @code{get-packet},
it will @i{not} get the same one the Chaos net program got, because
the @code{chaos} package is not being searched.  Rather, the @code{arpa} and @code{global}
packages are getting searched.  So @code{intern} will create a new @code{get-packet}
and install it on the @code{arpa} package.

So what has happened is that there are two @code{get-packet}s: one for
@code{chaos} and one for @code{arpa}.  The two programs are loaded together without name
conflicts.

@section Shared Programs

Now, a very important feature of the Lisp machine is that of
"shared programs"; if one person writes a function to, say, print
numbers in Roman numerals, any other function can call it to print
Roman numerals.  This contrasts sharply with PDP-10 system programs,
in which Roman numerals have been independently reimplemented several
times (and the ITS filename parser several dozen times).

For example, the routines to manipulate a robot arm might be a
separate program, residing in a package named @code{arm}.  If we
have a second program called @code{blocks} (the blocks world, of course)
which wanted to manipulate the arm, it would want to call functions
which are defined on the @code{arm} obarray, and therefore not in @code{blocks}'s
own name space.  Without special provision, there would be no way for
any symbols not in the @code{blocks} name space to be part of any @code{blocks}
functions.

The colon character ("@code{:}") has a special meaning to the Lisp
reader.  When the reader sees a colon preceeded by the name of a package,
it will read in the next Lisp object with @code{package} bound to that package.
The way @code{blocks} would
call a function named @code{go-up} defined in @code{arm} would be by asking to call
@code{arm:go-up}, because @code{"go-up} would be interned on the @code{arm} package.
What @code{arm:go-up} means precisely is "The symbol named @code{go-up} in
the name space of the package @code{arm}."

Similarly, if the @code{chaos} program wanted to refer to the @code{arpa}
program's @code{allocate-pbuf} function (for some reason), it would simply
call @code{arpa:allocate-pbuf}.

An important question which should occur at this point is how
the names of packages are associated with their obarrays and other
data.  This is done by means of the "refname-alist" which each package
has.  This alist associates strings called @i{reference names} or @i{refnames}
with the packages they
name.  Normally, a package's refname-alist contains an entry for each
subpackage, associating the subpackage with its name.  In addition,
every package has its own name defined as a refname, referring to
itself.  However, the user can add any other refnames, associating
them with any packages he likes.  This is useful when multiple versions
of a program are loaded into different packages.  Of course, each
package inherits its superpackage's refnames just as it does symbols.

In our example, since @code{arm} is a subpackage of @code{global}, the name
@code{arm} is on @code{global}'s refname-alist, associated with the @code{arm} package.
Since @code{blocks} is also a subpackage of @code{global}, when @code{arm:go-up} is seen
the string "@code{arm}" is found on @code{global}'s refname alist.

When you want to refer to a symbol in a package which you and
your superpackages have no refnames for--say, a subpackage named @code{foo}
of a package named @code{bar} which is under @code{global}--you can use multiple
colons.  For example, the symbol @code{finish} in that package @code{foo} could be
referred to as @code{foo:bar:finish}.  What happens here is that the second
name, @code{bar}, is interpreted as a refname in the context of the package
@code{foo}.

@section Declaring Packages
@cindex declaring packages
@cindex package declarations

Before any package can be referred to or loaded, it must be declared.
This is done with the special form @code{package-declare}, which tells the package system
all sorts of things, including the name of the package, the place in the
package hierarchy for the new package to go, its estimated size, the
files which belong in it, and some of the symbols which belong in it.

  Here is a sample declaration:

@lisp
(package-declare foo global 1000
       (("lispm;foo qfasl")
        ("lispm;bar qfasl")
        ("lispm;barmac >" defs))
       (shadow array-push adjust-array-size)
       (extern foo-entry))
@end lisp

What this declaration says is that a package named @code{foo} should be
created as an inferior of @code{global}, the package which contains advertised
global symbols.  Its obarray should initially be large enough to hold 1000
symbols, though it will grow automatically if that isn't enough.
Unless there is a specific reason to do otherwise, you should make all
of your packages direct inferiors of @code{global}.  The size you give is
increased slightly to be a good value for the hashing algorithm used.

After the size comes the "file-alist".  The files in the @code{foo} package
are "lispm;foo" and "lispm;bar", both of which should be compiled, and
"lispm;barmac", which should be read in as a text file.  In addition,
"barmac" is marked as a DEFS file, which means that the latest version of
"barmac" must always be loaded before attempting to compile or load any of
the other files.
Typically a DEFS file contains macro definitions, compiler declarations,
structure definitions, and the like.
All the source files should start with

@lisp
(pkg-contained-in "foo")
@end lisp

to help detect processing them in the wrong package.  Soon it will
automatically cause them to be processed in the right package, even if
copied under strange names.  (NOTE: @code{pkg-contained-in} IS NOT IMPLEMENTED YET!
DON'T USE IT!)

Finally, the @code{foo} package "shadows" @code{array-push} and @code{adjust-array-size},
and "externs" @code{foo-entry}.  What shadowing means is that the @code{foo} package
should have its own versions of those symbols, rather than inheriting
its superpackage's versions.  Symbols by these names will be added to the @code{foo}
package even though there are symbols on @code{global} already with those names.
This allows the @code{foo} package to redefine
those functions for itself without redefining them in the @code{global}
package for everyone else.  What externing means is that the @code{foo}
package is allowed to redefine @code{foo-entry} as inherited from the @code{global}
package, so that it @i{is} redefined for everybody.  If @code{foo} attempts to
redefine a function such as @code{car} which is present in the @code{global} package
but neither shadowed nor externed, confirmation from the user will be
requested.

Note that externing doesn't actually put any symbols into the @code{global}
package.  It just asserts permission to redefine symbols already there.
This is deliberate; the intent is to enable the maintainers of the
@code{global} package to keep control over what symbols are present in it.
Because inserting a new symbol into the @code{global} package can cause trouble
to unsuspecting programs which expect that symbol to be private, this is
not supposed to be done in a decentralized manner by programs written by
one user and used by another unsuspecting user.
Here is an example of the trouble that could be caused:
if there were two user programs, each with a function named @code{move-square},
and @code{move-square} were put on the @code{global} package, all of a sudden
the two functions would share the same symbol, resulting in a name conflict.
While all the definitions of the functions in @code{global} are actually
supplied by subpackages which extern them (@code{global} contains no files of
its own), the list of symbol names is centralized in one place, the file
"ai: lispm2; global >", and this file is not changed without notifying everyone,
and updating the @code{global} documentation.

Certain other things may be found in the declarations of various internal system
packages.  They are arcane and needed only to compensate for the fact
that parts of those packages are actually loaded before the package
system is.  They should not be needed by any user package.

Your package declarations should go into separate files containing
only package declarations.  Group them however you like, one to a file
or all in one file.  Such files can be read with @code{load}.  It doesn't
matter what package you load them into, so use @code{user}, since that has to
be safe.

If the declaration for a package is read in twice, no harm is done.
If you edit the size to replace it with a larger one, the package will
be expanded.  If you change the file-alist, the new one will replace the
old.  At the moment, however, there is no way to change the list of
shadowings or externals;  such changes will be ignored.  Also, you can't
change the superpackage.  If you edit the superpackage name and read the
declaration in again, you will create a new, distinct package without
changing the old one.

@defmac package-declare
The @code{package-declare} macro is used to declare a package to the package
system.  Its form is:

@lisp
(package-declare @i{name} @i{superpackage} @i{size} @i{file-alist} @i{option-1} @i{option-2} ...)
@end lisp

The interpretation of the declaration is complicated; see (declaring-packages).
@end defmac

@section Packages and Writing Code

The unsophisticated user need never be aware of the existence of
packages when writing his programs.  He should just load all of his
programs into the package @code{user}, which is also what console type-in is
interned in.  Since all the functions which users are likely to need are
provided in the @code{global} package, which is @code{user}'s superpackage, they are
all available.  In this manual, functions which are not on the @code{global}
package are documented with colons in their names, so typing the name
the way it is documented will work.

However, if you are writing a generally useful tool, you should
put it in some package other than @code{user},
so that its internal functions will not conflict with
names other users use.  Whether for this reason or for any other, if you
are loading your programs into packages other than @code{user} there are
special constructs that you will need to know about.

One time when you as the programmer must be aware of the existence of
packages is when you want to use a function or variable in another
package.  To do this, write the name of the package, a colon, and then
the name of the symbol, as in @code{eine:ed-get-defaulted-file-name}.  You will
notice that symbols in other packages print out that way, too.
Sometimes you may need to refer to a symbol in a package whose superior
is not @code{global}.  When this happens, use multiple colons, as in
@code{foo:bar:ugh}, to refer to the symbol @code{ugh} in the package named @code{bar} which
is under the package named @code{foo}.

Another time that packages intrude is when you use a "keyword": when
you check for @code{eq}ness against a constant symbol, or pass a constant
symbol to someone else who will check for it using @code{eq}.  This includes
using the symbol as either argument to @code{get}.  In such cases, the usual
convention is that the symbol should reside in the @code{user} package,
rather than in the package with which its meaning is associated.  To
make it easy to specify @code{user}, a colon before a symbol, as in @code{:select},
is equivalent to specifying @code{user} by name, as in @code{user:select}.
Since the @code{user} package has no subpackages, putting symbols into it will not cause
name conflicts.

Why is this convention used?  Well, consider the function
@code{tv-define-pc-ppr}, which takes any number of keyword arguments.
For example,

@lisp
(tv-define-pc-ppr "foo" (list tvfont) 'vsp 6 'sideways-p t)
@end lisp

specifies, after the two peculiar mandatory arguments, two options with
names @code{vsp} and @code{sideways-p} and values @code{6} and @code{t}.  The file containing this
function's definition is in the @code{system-internals} package, but the
function is available to everyone without the use of a colon prefix
because the symbol @code{tv-define-pc-ppr} is itself inherited from @code{global}.
But all the keyword names, such as @code{vsp}, are short and should not have
to exist in @code{global}.  However, it would be a shame if all callers of
@code{tv-define-pc-ppr} had to specify @code{system-internals}: before the name of
each keyword.  After all, those callers can include programs loaded into
@code{user}, which should by rights not have to know about packages at all.
Putting those keywords in the @code{user} package solves this problem.
The correct way to type the above form would be

@lisp
(tv-define-pc-ppr "foo" (list tvfont) ':vsp 6 ':sideways-p t)
@end lisp

Exactly when should a symbol go in @code{user}?  At least, all symbols
which the user needs to be able to pass as an argument to any function
in @code{global} must be in @code{user} if they aren't themselves in @code{global}.
Symbols used as keywords for arguments by any function should usually
be in @code{user}, to keep things consistent.  However, when a program uses a
specific property name to associate its own internal memoranda with
symbols passed in from outside, the property name should belong to the
program's package, so that two programs using the same property name
in that way don't conflict.

@section Shadowing

Suppose the user doesn't like the system @code{nth} function;  he
might be a former @code{interlisp} user, and expecting a completely
different meaning from it.  Were he to say @code{(defun nth ---)} in his
program (call it @code{interloss}) he would clobber the @code{global} symbol
named "@code{nth}", and so affect the "@code{nth}" in everyone else's name
space. (Actually, if he had not "externed" the symbol "@code{nth}", the
redefinition would be caught and the user would be warned.)

In order to allow the @code{interloss} package to have its own @code{(defun nth
---)} without interfering with the rest of the Lisp environment, it
must "shadow" out the global symbol "@code{nth}" by putting a new symbol
named "@code{nth}" on its own obarray.  Normally, this is done by writing
@code{(shadow nth)} in the declaration of the @code{interloss} package.  Since
@code{intern} looks on the subpackage's obarray before @code{global}, it will find
the programmer's own @code{nth}, and never the global one.  Since the global
one is now impossible to see, we say it has been "shadowed."

Having shadowed @code{nth}, if it is sometimes necessary to refer to the
global definition, this can be done by writing @code{global:nth}.  This works
because the refname @code{global} is defined in the @code{global} package as a name
for the @code{global} package.  Since @code{global} is the superpackage of the
@code{interloss} package, all refnames defined by @code{global}, including @code{"global"},
are available in @code{interloss}.

@section Packages and Interning

The function @code{intern} allows you to specify a package as the second
argument.  It can be specified either by giving the package object
itself, or by giving a string or symbol which is the name of the
package.  @code{intern} returns three values.  The first is the interned symbol.  The
second is @code{t} if the symbol is old (was already present, not just added to
the obarray).  The third is the package in which the symbol was actually
found.  This can be either the specified package or one of its
superiors.

When you don't specify the second argument to @code{intern}, the current
package, which is the value of the symbol @code{package}, is used.  This
happens, in particular, when you call @code{read}.  Bind the symbol @code{package}
temporarily to the desired package, before calling things which call
@code{intern}, when you want to specify the package.  When you do this, the
function @code{pkg-find-package}, which converts a string into the package it
names, may be useful.  While most functions that use packages will do
this themselves, it is better to do it only once when @code{package} is bound.
The function @code{pkg-goto} sets @code{package} to a package specified by a string.
You shouldn't usually need to do this, but it can be useful to "put
the keyboard inside" a package when you are debugging.

@defvar package
The value of @code{package} is the current package; many functions which
take packages as optional arguments default to the value of @code{package},
including @code{intern} and related functions.
@end defvar

@defun pkg-goto &optional pkg
@i{pkg} may be a package or the name of a package.
@i{pkg} is made the current package.  It defaults to the @code{user} package.
@end defun

@defmac pkg-bind
The form of the @code{pkg-bind} macro is @code{(pkg-bind @i{pkg} . @i{body})}.
@i{pkg} may be a package or a package name.  The forms of the @i{body}
are evaluated sequentially with the variable @code{package} bound to @i{pkg}.

@lisp
@exdent Example:
(pkg-bind "eine"
          (read-from-string function-name))
@end lisp
@end defmac

There are actually four forms of the @code{intern} function:  regular @code{intern},
@code{intern-soft}, @code{intern-local}, and @code{intern-local-soft}.  @code{-soft} means that the
symbol should not be added to the package if there isn't already one;
in that case, all three values are @code{nil}.  @code{-local} means that the
superpackages should not be searched.  Thus, @code{intern-local} can be used to
cause shadowing.  @code{intern-local-soft} is a good low-level primitive for
when you want complete control of what to search and when to add symbols.
All four forms of @code{intern} return the same three values, except that
the @code{soft} forms return @code{nil nil nil} when
the symbol isn't found.

@defun intern string &optional (pkg @code{package})
@code{intern} searches @i{pkg} and its superpackages sequentially, looking
for a symbol whose print-name is equal to @i{string}.  If it finds
such a symbol, it returns three values: the symbol, @code{t}, and the package
on which the symbol is interned.  If it does not find one, it
creates a new symbol with a print name of @i{string}, and
returns the new symbol, @code{nil}, and @i{pkg}.
@end defun

@defun intern-local string &optional (pkg @code{package})
@code{intern} searches @i{pkg} (but @i{not} its superpackages), looking
for a symbol whose print-name is equal to @i{string}.  If it finds
such a symbol, it returns three values: the symbol, @code{t}, and @i{pkg}
If it does not find one, it
creates a new symbol with a print name of @i{string}, and
returns the new symbol, @code{nil}, and @i{pkg}.
@end defun

@defun intern-soft string &optional (pkg @code{package})
@code{intern} searches @i{pkg} and its superpackages sequentially, looking
for a symbol whose print-name is equal to @i{string}.  If it finds
such a symbol, it returns three values: the symbol, @code{t}, and the package
on which the symbol is interned.  If it does not find one, it returns
@code{nil}, @code{nil}, and @code{nil}.
@end defun

@defun intern-local-soft string &optional (pkg @code{package})
@code{intern} searches @i{pkg} (but @i{not} its superpackages), looking
for a symbol whose print-name is equal to @i{string}.  If it finds
such a symbol, it returns three values: the symbol, @code{t}, and @i{pkg}
If it does not find one, it returns @code{nil}, @code{nil}, and @code{nil}.
@end defun

Each symbol remembers which package it belongs to.  While you can
intern a symbol in any number of packages, the symbol will only remmeber
one:  normally, the first one it was interned in, unless you clobber it.
This package is available as @code{(cdr (package-cell-location @i{symbol}))}.
If the value is @code{nil}, the symbol believes that it is uninterned.

The printer also implicitly uses the value of @code{package} when
printing symbols.  If slashification is on, the printer tries to print
something such that if it were given back to the reader, the same object would be produced.
If a symbol which is not in the current name space were just printed as
its print name and read back in, the reader would intern it on the wrong
package, and return the wrong symbol.  So the printer figures out the right
colon prefix so that if the symbol's printed representation were read back
in to the same package, it would be interned correctly.  The prefixes
only printed if slashification is on, i.e. @code{prin1} prints them
and @code{princ} does not.

@defun remob symbol &optional package
@code{remob} removes @i{symbol} from @i{package} (the names means "REMove from OBarray").
@i{symbol} itself is unaffected, but @code{intern} will no longer find
it on @i{package}.  @code{remob} is always "local", in that it removes only from the specified
package and not from any superpackages.  It returns @code{t} if the symbol was
found to be removed. @i{package} defaults to the contents of the symbol's
package cell, the package it is actually in.  (Sometimes a symbol
can be in other packages also, but this is unusual.)
@end defun

@defun mapatoms function &optional (package @code{package}) (superiors-p @code{t})
@i{function} should be a function of one argument.  @code{mapatoms} applies
@i{function} to all of the symbols in @i{package}.  If @i{superiors-p} is
@code{t}, then the function is also applies to all symbols in @i{package}'s
superpackages.  Note that the function will be applied to shadowed symbols
in the superpackages, even though they are not in @i{package}'s name space.
If that is a problem, @i{function} can try applying @code{intern}
in @i{package} on each symbol it gets, and ignore it if it is not @code{eq}
to the result of @code{intern}; this measure is rarely needed.
@end defun

@defun mapatoms-all function &optional (package "@code{global}")
@i{function} should be a function of one argument.
@code{mapatoms-all} applies @i{function} to all of the symbols
in @i{package} and all of @i{package}'s subpackages.  Since
@i{package} defaults to the @code{global} package, this
normally gets at all of the symbols in all packages.
It is used by such functions as @code{apropos} and @code{who-calls} (see (apropos-fun))

@lisp
@exdent Example:
(mapatoms-all
  (function
    (lambda (x)
      (and (alphalessp 'z x)
           (print x)))))
@end lisp
@end defun

@defun pkg-create-package name &optional (super @code{package}) (size @code{200})
@code{pkg-create-package} creates and returns a new package.  Usually packages are created
by @code{package-declare}, but sometimes it is useful to create
a package just to use as a hash table for symbols, or for some other
reason.

If @i{name} is a list, its first element is taken as the package name
and the second as the program name; otherwise, @i{name} is taken as both.
In either case, the package name and program name are coerced to strings.
@i{super} is the superpackage for this package; it may be @code{nil},
which is useful if you only want the package as a hash table, and don't
want it to interact with the rest of the package system.  @i{size} is
the size of the package; as in @code{package-declare} it is rounded up
to a "good" size for the hashing algorithm used.
@end defun

@defun pkg-kill pkg
@i{pkg} may be either a package or the name of a package.  The package
should have a superpackage and no subpackages.  @code{pkg-kill} takes
the package off its superior's subpackage list and refname alist.
@end defun

@defun pkg-find-package x &optional (create-p @code{nil}) (under "@code{global}")
@code{pkg-find-package} tries to interpret @i{x} as a package.
Most of the functions whose descriptions say "... may be either
a package or the name of a package" call @code{pkg-find-package} to interpret
their package argument.

If @i{x} is a package, @code{pkg-find-package} returns it.
Otherwise it should be a symbol or string, which is taken to be
the name of a package.  The name is looked up on the refname
alists of @code{package} and its superpackages, the same as if it had
been typed as part of a colon prefix.  If this finds the package, it
is returned.  Otherwise, @i{create-p} controls what happens.
If @i{create-p} is @code{nil}, an error is signalled.  Otherwise,
a new package is created, and installed as an inferior of @i{under}.
@end defun

A package is implemented as a structure, created by @code{defstruct}.
The following accessor macros are available on the @code{global} package:

@table @code
@item pkg-name
The name of the package, as a string.
@item pkg-refname-alist
The refname alist of the package, associating strings with packages.
@item pkg-super-package
The superpackage of the package.
@end table

@section Status Information

The current package--where your type-in is being interned--is
always the value of the symbol @code{package}.  A package is a named
structure which prints out nicely, so examining the value of
@code{package} is the best way to find out what the current package is.
Normally, it should be @code{user}, except when inside
compilation or loading of a file belonging to some other package.

  To get more information on the current package or any other, use the
function @code{pkg-describe}.  Specify either a package object or a string
which is a refname for the desired package as the argument.  This will
print out everything except a list of all the symbols in the package.
If you want @i{that}, use @code{(mapatoms 'print @i{package} nil)}.
@code{describe} of a package will call @code{pkg-describe}.

@section Packages, Loading, and Compilation

It's obvious that every file has to be loaded into the right package
to serve its purpose.  It may not be so obvious that every file must be
compiled in the right package, but it's just as true.  Luckily, this
usually happens automatically.

When you have mentioned a file in a package's file-alist, requesting
to compile that file with @code{qc-file} or loading it with @code{load} automatically
selects that package to perform the operation.  This is done by
inverting the package-to-file correspondence described by the
file-alists and remembering the inversion in the form of @code{:package}
properties on symbols in the @code{files} package (the symbol representing the
file is @code{(intern (file-expand-pathname @i{filename}) "files"))}.

The system can get the package of a source file from its "editor
property list".  For instance, you can put at the front of your file
a line such as "; -*- Mode:Lisp; Package:System-Internals -*-".  The
compiler puts the package into the QFASL file.
If a file is not mentioned in a package's file-alist and doesn't
have such a package specification in it, the system loads it into
the current package, and tells you what it did.

To compile or load all of the files of a package, you can use the
@code{pkg-load} function (see (pkg-load-fun)), which uses the file-alist from the package
declaration.

@section Subpackages

Usually, each independent program occupies one package, which is
directly under @code{global} in the hierarchy.  But large programs, such as
Macsyma, are usually made up of a number of sub-programs, which are
maintained by a small number of people.  We would like each
sub-program to have its own name space, since the program as a whole
has too many names for anyone to remember.  So, we can make each
sub-program into its own package.  However, this practice requires
special care.

It is likely that there will be a fair number of functions and
symbols which should shared by all of the sub-programs of Macsyma.
These symbols should reside in a package named @code{macsyma}, which would be
directly under @code{global}.
Then, each part of @code{macsyma} (which might be called @code{sin},
@code{risch}, @code{input}, and so on) would have its own package, with the @code{macsyma}
package as its superpackage.  To do this, first declare the @code{macsyma}
package, and then declare the @code{risch}, @code{sin}, etc. packages, specifying
@code{macsyma} as the superpackage for each of them.  This way, each
sub-program gets its own name space.  All of these declarations would probably
be in a together in a file called something like "macpkg".

However, to avoid a subtle pitfall (described in detail in the
appendix), it is necessary that the @code{macsyma} package itself contain no
files;  only a set of symbols specified at declaration time.  This
list of symbols is specified using @code{shadow} in the declaration of the
@code{macsyma} package.  At the same time, the file-alist specified in the
declaration must be @code{nil} (otherwise, you will not be allowed to create
the subpackages).  The symbols residing in the @code{macsyma} package can
have values and definitions, but these must all be supplied by files
in @code{macsyma}'s subpackages (which must "@code{extern}" those symbols as
necessary).  Note that this is exactly the same treatment that @code{global}
receives:  all its functions are actually defined in files which are
loaded into @code{system-internals (si), compiler}, etc.

To demonstrate the full power and convenience of
this scheme, suppose there were a second huge program called @code{owl} which
also had a subprogram called @code{input} (which, presumably, does all of the
@code{input}ting for @code{owl}), and one called @code{database}.  Then a picture of the
hierarchy of packages would look like this:

@lisp
                        global
                           |
                /--------------------------------\
                |                                |
             macsyma                            owl
                |                                |
 -----------------------------           -------------------------
  | | |      |       |       |           |         |         | | |
(others)   risch    sin    input       input   database      (others)
@end lisp

Now, the @code{risch} program and the @code{sin} program both do integration, and
so it would be natural for each to have a function called @code{integrate}.
From inside @code{sin}, @code{sin's} @code{integrate} would be referred to as "@code{integrate}"
(no prefix needed), while @code{risch's} would be referred to as
"@code{risch:integrate}".  Similarly, from inside @code{risch}, @code{risch's} own
@code{integrate} would be called "@code{integrate}", whereas @code{sin's} would be referred
to as "@code{sin:integrate}".

If @code{sin}'s @code{integrate} were a recursive function, the implementor would
be referring to it from within @code{sin} itself, and would be happy that he
need not type out "@code{sin:integrate}" every time; he can just say
"@code{integrate}".

From inside the @code{macsyma} package or any of its other sub-packages,
the two functions would be referred to as "@code{sin:integrate}" and as
"@code{risch:integrate}".  From
anywere else in the hierarchy, they would have to be called
"@code{macsyma:sin:integrate}" and "@code{macsyma:risch:integrate}".

Similarly, assume that each of the @code{input} packages has a function
called @code{get-line}.  From inside @code{macsyma} or any of @code{macsyma's} subprograms
(other than @code{input}), the relevant function would be called
@code{input:get-line}, and the irrelevant one @code{owl:input:get-line}.  The
converse is true for @code{owl} and its sub-programs.  Note that there is no
problem arising from the fact that both @code{owl} and @code{macsyma} have
subprograms of the same name (@code{input}).

You might also want to put Macsyma's @code{get-line} function on
the @code{macsyma} package.  Then, from anywehere inside Macsyma, the function
would be called @code{get-line}; from the @code{owl} package and subpackages
it could be referred to as @code{macsyma:get-line}.

@section Initialization of the Package System

This section describes how the package system is initialized
when generating a new software release of the Lisp Machine system;
none of this should affect users.

When the world begins to be loaded, there is no package system.
There is one "obarray", whose format is different from that used by
the package system.  After sufficiently much of the Lisp environment
is present for it to be possible to initialize the package system,
that is done.  At that time, it is necessary to split the symbols of
the old-style obarray up among the various initial packages.

  The first packages created by initialization are the most important
ones:  @code{global}, @code{system}, @code{user}, and @code{system-internals}.
All of the symbols already
present are placed in one of those packages.  By default, a symbol
goes into @code{system-internals}.  Only those placed on special lists go
into one of the others.  These lists are the file "AI: LISPM2; GLOBAL >" of
symbols which belong in @code{global}, the file "AI: LISPM2; SYSTEM >" which
go in @code{system}, and the file "AI: LISPM2; KWDPKG >" of symbols
which belong in @code{user} (at the moment, these are actually loaded into
@code{global}, because not everything has been converted to use colons where
necessary).

After the four basic packages exist, the package system's
definition of @code{intern} is installed, and packages exist.  Then, the
other initial packages @code{format}, @code{compiler}, @code{eine}, etc. are declared and
loaded using @code{package-declare} and @code{pkg-load}, in almost the normal
manner.  The exception is that a few of the symbols present before
packages exist really belong in one of these packages.  Their package
declarations contain calls to @code{forward} and @code{borrow}, which exist only for
this purpose and are meaningful only in package declarations, and are used
to move the symbols as appropriate.  These declarations are kept in
the file "AI: LISPM; PKGDCL >".

@defun globalize &rest symbols
Sometimes it will be discovered that a symbol which ought to be in
@code{global} is not there, and the file defining it has already been loaded,
thus mistakenly creating a symbol with that name in a package which
ought just to inherit the one from @code{global}.  When this happens, you can
correct the situation by doing @code{(globalize "@i{symbol-name}")}.  This
function creates a symbol with the desired name in @code{global}, merges
whatever value, function definition, and properties can be found on
symbols of that name together into the new symbol (complaining if
there are conflicts), and forwards those slots of the existing symbols
to the slots of the new one using one-q-forward pointers, so that they
will appear to be one and the same symbol as far as value, function
definition, and property list are concerned.  They cannot all be made
@code{eq} to each other, but @code{globalize} does the next-best thing:  it takes
an existing symbol from @code{user}, if there is one, to put it in @code{global}.
Since people who check for @code{eq} are normally supposed to specify @code{user}
anyway, they will not perceive any effect from moving the symbol from
@code{user} into @code{global}.

If @code{globalize} is given a symbol instead of a string as argument,
the exact symbol specified is put into @code{global}.  You can use this when
a symbol in another package, which should have been inherited from
@code{global}, is being checked for with @code{eq}--as long as there are not @i{two}
different packages doing so.  But, if the symbol is supposed to be in
@code{global}, there usually should not be.
@end defun

@section Initial Packages

The initially present packages include:

@table @code
@item global
Contains advertised global functions.
@item user
Used for interning the user's type-in.  Contains all keyword symbols.
@item sys @r{or} system
Contains various internal global symbols
used by various system programs.
@item si @r{or} system-internals
Contains subroutines of many advertised
system functions.  @code{si} is a subpackage of @code{sys}.
@item compiler
Contains the compiler and fasload.  @code{compiler} is a subpackage
of @code{sys}.
@item eine
Contains the Eine editor.
@item chaos
Contains the Chaos net controller.
@item supdup
Contains the Supdup program.
@item peek
Contains the Peek program.
@item format
Contains the function @code{format} and its associated subfunctions.
@end table

Packages which are used for special sorts of data:

@table @code
@item fonts
Contains the names of all fonts.
@item files
Contains the file-symbols of all files.
Many properties are kept on these symbols to remember information
about files which are in use.
@item format
Contains the keywords for @code{format}, as well as the code.
@end table

Here is a picture depicting the inital package hierarchy:

@lisp
                           global
                             |
  /-----------------------------------------------------------\
  |     |     |         |        |       |       |      |     |
user  eine  chaos    system    supdup  format  fonts  files  peek
                        |
                /--------------\
                |              |
         system-internals    compiler
@end lisp

@section Multiple Instantiations of a Program

This isn't finished yet, which is why we don't say how to do
any of this.

Suppose a maintainer of EINE (the Lisp Machine editor) has
made some changes to EINE, and would like to debug them.  He has a
problem: if he reads in the new version, which presumably may be full
of bugs, then he will not be able to do any editing!  This would be
annoying, since the editor is very useful.

We would like both the regular and the experimental versions
of the editor to @i{both} be loaded into the Lisp world.  In order for two
definitions of each editor function to coexist, we need to load the
new version into a separate package, which must have a different name
(not named "@code{eine}", like the package the original editor is in).  If
the test version's package is called "@code{test-eine}", then the user can
try it by calling @code{(test-eine:ed)}, and edit it using @code{(ed)}.

However, there is a problem to be faced.  The editor redefines
a few entry-point functions (@code{ed}, @code{edprop}, etc) which reside in @code{global}.
If the test editor redefined them, the whole point of the separate
package would be lost.  So, the @code{test-eine} package must @code{shadow} all the
symbols which the regular @code{eine} package @code{extern}s.

Further complications are needed to make it possible to test
one program using another instead of by hand.  Suppose that there is a
program named @code{random} residing in its own package, and containing a
function named @code{number}.  Suppose that we have a debugged program @code{dp}
(Dissociated Press) which uses @code{random:number}.  And now, we have
written a new version of @code{random} and want to test it using @code{dp}, without
installing it and breaking system tools which use @code{random}.  What we
want to do is to load in a test version of @code{random}, @code{test-random}, and
also a @code{test-dp} which will refer to it, to test it with.

This can be done if we can make the @code{test-dp} package
take references to @code{random} as references to the @code{test-random}
package.  All this takes is
an entry on @code{test-dp}'s refname-alist, associating the name "@code{random}"
with the @code{test-random} package.  Then, when @code{random:number} is seen in the
course of reading in the old @code{dp} program into @code{test-dp},
@code{test-random:number} will actually be used.  Note that normally @code{test-dp}
wouldn't have an entry on its own refname-alist for "@code{random}";  it
would inherit the association from @code{global}.  We are actually
"shadowing" in @code{test-dp} the definition of "@code{random}" as a package refname
which is present in @code{global}.  Here is what we will get.

@lisp
                            global  [random -> random]
                               |
      /-----------------------------------------------\
      |        |                      |               |
     dp  =>  random                test-dp  =>      test-random
                           [random -> test-random]
@end lisp

("=>" indicates who calls whom;  "->" indicates a refname).

So far, every package has had its own name as a refname for
itself.  A test package, however, shouldn't have its actual name as a
refname for itself, but the name its program expects:  "@code{random}", not
"@code{test-random}".  This is necessary to handle test packages with
subpackages right, together with shadowing.  In fact every package has
a "program name" as well as a "name".  For ordinary packages, they are
the same, but for a test package, the program name is identical to
that of the original package.

Suppose we have the Macsyma program with all of its sub-packages as
described above. Further assume that the @code{input} sub-program's author
has his own symbol named @code{simp}, and he calls @code{macsyma:simp}
in various places to get the
one in the @code{macsyma} package.  Now, say someone wants to load an
experimental @code{macsyma} into the machine: he would name the new obarray
@code{test-macsyma} or something.  In order to assure that the reference to
@code{macsyma:simp} is properly resolved, the refname-alist of @code{test-macsyma}
must contain @code{test-macsyma} under the name @code{macsyma}.  This, finally,
is the reason why each package has a reference to itself on its refname-alist.

@c DSK:LMMAN;FILES 16
@c This file is part of the Lisp Machine manual.	-*-Text-*-

@c New section on FILES for the manual to explain:
@c Mention packages and how they relate to files.
@c BEGF/ENDF sectioning.
@c File computer file system.
@c FILE job?
@c Pointer to file philosophy of EINE.
@c FILES package.

@chapter Files
@cindex file

This chapter explains how the Lisp Machine system interacts
with files and the file system.  It explains how to keep your
programs in files and how to get them into the Lisp environment,
how they relate to packages, how they are divided into sections,
and how they are seen by EINE (the editor).

Eventually, Lisp Machines will be able to support
their own file sytems, or use a special purpose "File Computer"
over the Chaosnet.  At the moment, the prototype Lisp Machine
uses the A.I. PDP-10 file system.  To allow it
to access the PDP-10 (which is not yet attached to the Chaosnet),
a special program must be run on the PDP-10, which is invoked
by typing @code{:lmio;file} to DDT.

A @i{pathname} or @i{filename} is a string of characters
which identifies a file in the file system.  On the existing file
system, a pathname looks like

"@i{device}: @i{directory}; @i{fn1} @i{fn2}"

It is assumed that the reader of this document is familiar with the
meanings of these pathnames, and the use of ">" as the @i{fn2} in a
pathname.  Unlike Maclisp, Lisp Machine functions usually take
filenames as a character string, rather then as a list.  Most functions understand pathnames
in which some components are not specified.  For example, in the
string @code{"lispm;qmod"}, the @i{device} and @i{fn2} are not specified.

@section Functions for Loading Programs

@subsection Functions for Loading Single Files

@defun load pathname &optional pkg
This function loads the file @i{pathname} into the Lisp environment.
If the file is a QFASL file, it calls @code{fasload}; otherwise
it calls @code{readfile}.  @i{pkg} should be a package or the name of a package, and if
it is given it is used as the current package when the file
is read in.  Usually it is not given; when it is not supplied
explicitly, @code{load} tries to figure out what package to use
by calling @code{pkg-find-file-package}.  If the FN2 is not
specified in @i{pathname}, @code{load} first tries appending
the @i{fn2} @code{"qfasl"}, and then tries the @i{fn2} @code{">"}
if the @code{"qfasl"} file is not found.
@end defun

@defun readfile pathname
@code{readfile} sequentially reads and evaluates forms
from the file @i{pathname}, in the current package.
@end defun

@defun fasload pathname
@code{fasload} reads in and processes a QFASL file,
in the current package.  That is, it defines functions
and performs other actions as directed by the specifications
inserted in the file by the compiler.
@end defun

@subsection Loading and Compiling Whole Packages

Because each package has a file-alist, it is possible to request that
the files of a package be compiled or loaded, as needed.  This is done
with the @code{pkg-load} function, which takes as arguments a package and a
list of keywords (or one keyword) specifying the precise nature of the
operation.  For example, @code{(pkg-load "eine" ':compile)} would recompile and
reload the files of the @code{eine} package, such as require it.

@defun pkg-load package &optional keywords
This function loads and/or compiles the files of a package.  @i{package}
may be a package or a package name; @i{keywords} should be one of the
keyword symbols below or a list of keywords.  The keywords control
what @code{pkg-load} does.

The keywords defined include:

@table @code
@item :confirm
Ask for confirmation before doing it (this is the default);
@item :noconfirm
Don't ask for confirmation
@item :compile
Compile files before loading;
@item :nocompile
Do not compile (this is the default);
@item :load
Load files (the default);
@item :noload
Don't load (but compile, if that was specified);
@item :selective
Ask about each file;
@item :complete
Don't ask about each file (the default);
@item :reload
Compile or load even files which appear not to need it;
@item :noreload
Only process files which have newer versions on disk (the default);
@item :recursive
Also process packages this one refers to;
@item :defs
Process only DEFS files.
@end table

See also @code{recompile-world} ((recompile-world-fun)).
@end defun

@c DSK:LMMAN;PROCES 3
@c This file is part of the Lisp Machine manual.  -*-Text-*-

@chapter Processes
@cindex process
@cindex multiprocessing
@cindex wait

@i{Processes} are used to implement multi-processing.
Several computations can be executed "concurrently" by placing
each in a separate process.  A computation in a process may
also @i{wait} for something to happen, during which time it
does not execute at all.

A @i{process} is a Lisp structure with the following components:

@table @code
@item process-name
The name of the process, as a string.  This string is only used
for the process's printed representation, and for programs
to print out; it can be anything reasonably mnemonic.
@item process-stack-group
The stack group currently associated with this process.  When the process
is run, this stack group will be resumed.  See below.
@item process-wait-function
A function, applied to the argument list in the process's @code{process-wait-argument-list}
to determine whether the process is runnable.  The function should return @code{nil}
if the process is not ready to run.
@item process-wait-argument-list
The arguments to which the @code{process-wait-function} is applied.
@item process-whostate
The reason this process is waiting, as a string.  This is only
used for display by the who-line or various programs; it can
be anything reasonably mnemonic.
@item process-job
The job associated with this process, or @code{nil} if the process
is not associated with any job.  See the chapter on jobs ((job)).
@item process-initial-stack-group
The function @code{process-preset} (see (process-preset-fun))
will make the @code{process-stack-group} be this stack group.
@end table

@cindex scheduler
At any time there is a set of @i{active processes}.  Each active
process is either trying to run, or waiting for some condition to become true.
The active
processes are managed by a special stack group called the @i{scheduler},
which repeatedly cycles through the active processes, determining
for each process whether it is ready to be run, or whether it is
waiting.  The scheduler determines whether a process is ready to run by applying the process's
@i{wait-function} to its @i{wait-argument-list}.  If the
wait-function returns a non-@code{nil} value, then the process is ready to run;
otherwise, it is waiting.  If the process is ready to run,
the scheduler resumes the @code{process-stack-group} of the process.
For example, if a process were waiting for input from the keyboard,
its wait-function might be @code{kbd-char-available}, which returns
non-@code{nil} if there is a character available from the keyboard.
Since @code{kbd-char-available} takes no arguments, the wait-argument-list
of the process would be @code{nil}.

When a process's wait-function returns non-@code{nil}, the scheduler
will resume its stack group and let it proceed.  The process is now the
@i{current process}, that is, the one process that is running
on the machine.  The scheduler sets the variable @code{current-process}
to it.  It will remain the current process and continue to
run until either it decides to wait, or a @i{sequence break} occurs.
A process can wait for some condition to become true by calling
@code{process-wait} (see (process-wait-fun)),
which will set up its wait-function and wait-argument-list accordingly,
and resume the scheduler stack group.  A sequence break is a kind of interrupt
that is generated by the Lisp system for any of a variety of reasons;
when it occurs, the scheduler is resumed.  In either case, the scheduler
will continue cycling through the active processes.
This way, each process that is ready to run will get its share of
time in which to execute.

Note: Sequence breaks are not yet implemented, and so the scheduler
only regains control when the running process calls @code{process-wait}.
Any process that simply computes for a long time without waiting will
keep all of the other processes from running.  In the future, seqence
breaks will happen periodically and at interesting times when some process's
wait condition may have become true.

@section Functions for Manipulating Processes

@defun process-create name job &rest options
@code{process-create} creates and returns a new process.  @i{name} may be any
string, @i{job} is usually @code{t}, and there are usually no options.
The options are used in creating the stack group which executes on behalf of this process.

The fields of the new process are set up as follows:

@table @code
@item process-name
@i{name}, which should be a string.
@item process-job
@i{job}.  If @i{job} is @code{t}, the current job is used instead.
Otherwise @i{job} should be @code{nil} (meaning that the process
is not associated with any job), or a job.
@item process-stack-group
A newly created stack group.  The @i{options} argument to @code{process-create}
are the options passed to @code{make-stack-group} (see (make-stack-group-fun))
used when creating this stack group.
@item process-initial-stack-group
The same as the @code{process-stack-group}.
@end table

The rest of the fields are set to @code{nil}; the process should not be enabled
until @code{process-preset} (see below) is called.
@end defun

@defun process-preset process initial-function &rest options
@code{process-preset} initializes the state of a process.
First, it restores the @code{process-stack-group} from the
@code{process-initial-stack-group}.  Then it presets
the stack group, passing the @code{initial-function} and @code{options}
arguments to @code{stack-group-preset} (see (stack-group-preset-fun)).
Finally it sets
the @code{process-wait-function} and @code{process-argument-list}
to return @code{t}, so that the process will be ready to run.
The process is now ready to be enabled (see @code{process-enable}
below).
@end defun

@defun process-kill process
This deactivates @i{process} if it is active, and dissociates it from
its associated job (if any).
@end defun

@defun process-enable process
Enable @code{process}.  If @i{process} has no associated job, or if its
job if process-enabled, @i{process} is activated.
@end defun

@defun process-disable process
Disable @i{process}.  If it was active, deactivate it.
@end defun

@defun process-wait whostate function &rest arguments
@code{process-wait} sets the current-process's @code{process-whostate},
@code{process-wait-function}, and @code{process-wait-argument-list} from
its three arguments, which makes the current process wait until the
application of @i{function} to @i{arguments} returns non-@code{nil}
(at which time @code{process-wait} returns).  Note that @i{function} is applied
in the environment of the scheduler, not the environment of the @code{process-wait},
so bindings in effect when @code{process-wait} was called will @i{not} be
in effect when @i{function} is applied.  Be careful when using any free
references in @i{function}.

@lisp
@exdent Example:
;; This won't work.
((lambda (until)
    (process-wait "sleep" '(lambda () (> (time) until))))
 500)

;; This is the right way to do it.
(process-wait "sleep" '(lambda (until) (> (time) until)) 500)
@end lisp

When running the @code{process-wait-function}, the scheduler sets the
variables @code{current-process} and @code{current-job}
to the process being considered and its job, so the @code{process-wait-function}
can use them; for example:

@lisp
;; Wait until I get the keyboard.
(process-wait "kbd" '(lambda () (eq kbd-job current-job)))
@end lisp
@end defun

@defun process-sleep interval
This simply waits for @i{interval} sixtieths of a second, and then returns.
It uses @code{process-wait}.
@end defun

@defun process-allow-schedule
This function simply waits for a condition which is always true;
all other processes will get a chance to run before the current process runs again.
@end defun

@defspec without-interrupts
The @code{without-interrupts} special form allows you to perform @i{atomic operations}.
Within the body of this form, control is guaranteed to remain in the current process.

@lisp
@exdent Examples:
(without-interrupts
  (push item list))

(without-interrupts
  (cond ((memq item list)
         (setq list (delq item list))
         t)
        (t nil)))
@end lisp
@end defspec

@section Locks
@cindex lock

A @i{lock} is a software construct used for synchronization
of two processes.  A lock is either held by some process, or is free.
When a process tries to seize a lock, it waits until the lock is free,
and then it becomes the process holding the lock.  When it is finished,
it should unlock the lock.

In the Lisp Machine, a lock is a locative pointer to a cell.
If the lock is free, the cell contains @code{nil}; otherwise it contains
the process that holds the lock.  The @code{process-lock} and @code{process-unlock}
functions are written in such a way as to guarantee that two processes
can never both think that they hold a certain lock; only one process
can ever hold a lock at a time.

@defun process-lock locative
This is used to seize the lock which @i{locative} points to.
If necessary, @code{process-lock} will wait until the lock becomes free.
When @code{process-lock} returns, the lock has been seized.
@end defun

@defun process-unlock locative
This is used to unlock the lock which @i{locative} points to.
If the lock is free or was locked by some other process, an
error is signaled.  Otherwise the lock is unlocked.
@end defun

It is a good idea to use @code{unwind-protect} to make sure that
you unlock any lock that you seize.  For example, if you write

@lisp
(unwind-protect
   (progn (process-lock lock-3)
          (function-1)
          (function-2))
   (process-unlock lock-3))
@end lisp

then even if @code{function-1} or @code{function-2} does a @code{*throw},
@code{lock-3} will get unlocked correctly.

@code{process-lock} and @code{process-unlock} are written by
use of a sub-primitive function called @code{%store-conditional}
(see (%store-conditional-fun)), which
is sometimes useful in its own right.

@c DSK:LMMAN;JOBSYS 85
@c This file is part of the Lisp Machine manual.  -*-Text-*-

@c Mention the term job system early on in this chapter.
@c Description of stuff in JOBSYS.

@chapter TVOBs and Jobs

[The subject of this chapter is currently being redesigned.  The contents
of this chapter will be completely changed in the next edition of this manual.]

@section Introduction to the Concepts of This Chapter
@cindex tvob

@i{TVOBs} (TV OBjects) represent permission to use
the TV screen.  The TVOB mechanism is provided to allow the
TV to be shared between all of the activities the user
may be conducting, without those activities getting in each other's
way.

@cindex job
A @i{job} is a collection of processes and TVOBs, grouped
together for the user's convenience.  The processes can be started
and stopped together, and the TVOBs can be put on or taken off the
TV together.

@section TVOBs

A @i{TVOB} (TV OBject) is a Lisp structure with the following
components:

@table @code
@item tvob-name
This is the name of the TVOB, as a string.  It is only used for
the TVOB's printed representation, and can be anything reasonably
mnemonic.
@item tvob-x1
The first (leftmost) column of the TVOB's area of the screen.
@item tvob-y1
The first (highest) line of the TVOB's area of the screen.
The @code{tvob-x1} and @code{tvob-y1} are the co-ordinates of the
upper-left-hand corner of the TVOB's rectangular area.
@item tvob-x2
The first (leftmost) column to the right of the TVOB's area of the screen.
@item tvob-y2
The first (highest) line below the TVOB's area of the screen.
The @code{tvob-x2} and @code{tvob-y2} are the co-ordinates of the
lower-right-hand corner of the TVOB's rectangular area, with 1 added to each.
Thus the height of the tvob is the difference between its @code{tvob-y2} and @code{tvob-y1},
and the width is the difference between the @code{tvob-x2} and @code{tvob-x1}.
@item tvob-handler
A function, described below.
@item tvob-info
This field may contain anything at all; it is meant to be used by the
@code{tvob-handler} function.
@item tvob-job
The job associated with this TVOB, or @code{nil} if there is no associated
job.
@item tvob-priority
Either @code{t} or @code{nil}.  If it is @code{t}, the functions which
allocate area on the screen (@code{tvob-create} and @code{tvob-create-expandable},
see (tvob-create-fun))
will be reluctant to allocate over this TVOB's area of the screen.
@item tvob-screen
The screen on which this TVOB is displayed.  See (screen).
@item tvob-status
This field is provided for the convenience of @code{tvob-handler} functions.
It contains one of the following symbols:
@table @code
@item :selected
The TVOB is the selected TVOB.  Only one TVOB will have this @code{tvob-status}.
@item :exposed
The TVOB is not selected, but is on @code{exposed-tvobs}.  This means that this
TVOB is not covered by any other TVOB; its screen area is fully exposed.
@item nil
The TVOB is not on @code{exposed-tvobs}.
@end table

@item tvob-clobbered-p
This field is provided for the convenience of @code{tvob-handler} functions.
It is @code{t} if the TVOB has been sent a @code{:clobber} or @code{:set-edges}
command more recently
than an @code{:update} command; otherwise it is @code{nil}.
@item tvob-mouse-handler
A function to call when the mouse enters this TVOB's screen region.  This allows
the TVOB to take over control of the mouse.  This field is @code{nil} if this TVOB
does not do anything special with the mouse.
@item tvob-mouse-action
See @code{mouse-default-handler} ((mouse-default-handler-fun)).
@item tvob-plist
A disembodied property list.  Use, for example, @code{(get (locf (tvob-plist tvob)) 'mumble)}.
@end table

It is often useful to divide the TV screen up into several parts,
and do different things in each part.  Sometimes one program wants
to split up the screen, as Eine does; sometimes the user wants to run several
programs at once, and each program wants some space on the screen.
At any time, there is a set of @i{active TVOBs} (TV objects) which are sharing
the screen.  Each TVOB has a rectangular piece of the screen on which
it does its displaying; it is not allowed to go outside its area.

It is possible for two active TVOB's regions of the screen
to overlap.  When this happens, only one of them is @i{exposed} (fully
visible); the other is partially or fully buried.  There is a subset of
the active TVOBs called the @i{exposed} TVOBs; no two exposed TVOBs
overlap.  The TVOBs act as if they were a bunch of rectangular sheets
of paper on a desktop; some are up at the top, and others are partially
buried.  Various programs can "pull" a non-exposed TVOB up to the top,
making it exposed and making some other TVOB(s) non-exposed.  Several functions
of the job system, explained below, keep track of and change which TVOBs
are active, and which are exposed.

The job system also keeps track of one TVOB called the
@i{selected TVOB}.  Conceptually, the selected TVOB is the one in which
the user is interested at the moment, and it is usually the one that is
responding to the keyboard.  For example, when Eine is being used, the
TVOB of the window in which the user is editing is the selected TVOB.
The selected TVOB is always exposed.
A TVOB's being selected, exposed but not selected, or not exposed at
all is called the TVOB's @i{status}.

Usually a program will want certain actions to be taken when
the status of a TVOB changes.  When the TVOB associated with an Eine window
becomes exposed, Eine generally wants
to redisplay the window, and when the TVOB is selected, Eine starts
blinking the window's blinkers and makes its buffer be the current
buffer.  In order to let a user program know that the status of a
TVOB has changed, so that it can do these things, there is a function
called the @i{handler} associated with every TVOB.  When the status of
the TVOB changes, its handler is applied to three arguments:  the TVOB
itself, a keyword symbol indicating what kind of change of status
is occurring, and a list of other information whose meaning is dependant
on the value of the second argument.  The applications of this function
can be thought of as a "command" being sent to the TVOB.  For example, when
a TVOB becomes selected, it is "sent a command" telling it so; that is,
the handler is applied to the TVOB, the keyword @code{:select}, and @code{nil}.

Here is a list of all of the keyword symbols (i.e. all of the kinds
of commands) that are used.  In addition to status changes, requests
for the TVOB to update and relocate itself cause the handler to be
invoked.

@table @code
@item :expose
The TVOB is being made exposed.  This command is only sent
when the TVOB is active and not exposed.
@item :deexpose
The TVOB is no longer exposed.  This command is only sent when
the TVOB is active and exposed.
@item :select
The TVOB is now selected.  This command is only sent when the TVOB
is exposed and not selected.
@item :deselect
The TVOB is no longer selected.  This command is only sent when the TVOB
is selected.
@item :clobber
This command means that for some reason, the TVOB's area of the screen has
been altered; future @code{:update} and @code{:clean} commands should not
assume that the screen is as it was left.  Most TVOBs will ignore this
message, since the information is saved in the @code{tvob-clobbered-p}
element of the TVOB (see below).  This command is only sent when the TVOB
is exposed.
@item :update
This command is only sent when the TVOB is exposed.
The TVOB should assure that its area of the screen contains whatever
it is supposed to contain.  Just what @code{:update} means depends on the
program.  Some programs can remember the contents of what is on the TVOB
and can refresh it at will; others do not remember the contents, and cannot
reconstruct them.

The former kind, upon receiving the @code{:update} command,
should update the TVOB.  If the TVOB has not been clobbered, the handler
can assume that whatever it last put there is still there, and it may
be able to avoid redisplaying.  The @code{tvob-clobbered-p} field
of the TVOB is set to @code{t} by the job system after a @code{:clobber}
or @code{:set-edges}
command is sent, and to @code{nil} after an @code{:update} or @code{:clean}
command is sent. The handler can determine whether or not its area
of the screen has been clobbered by simply looking at the @code{tvob-clobbered-p}.

The latter kind of TVOB cannot update,
and should ignore the @code{:update} command entirely.
@item :clean
@code{:clean} is like @code{:update} except that TVOBs of the kind that
cannot refresh themselves should clear their areas instead of doing nothing.
Like @code{:update}, this command is only sent when the TVOB is exposed.
@code{:clean} is sent to all exposed TVOBs when the user requests that the screen be
cleaned up; for instance when the FORM key is pressed in most programs.
@item :set-edges
The TVOB should change its area of the screen.  This command takes four
arguments: the new left edge, top edge, bottom edge, and right edge, in raster
units.  The first two are inclusive, and the other two are exclusive.
The elements of the TVOB structure that hold the screen area (@code{tvob-x1} etc.)
will be updated automatically; the handler need not change them itself.
The handler should update any other associated information; for example,
if the TVOB has an associated "piece of paper", it should call @code{tv-redefine-pc-ppr}
(see (tv-redefine-pc-ppr-fun)).
@end table

The @code{tvob-info} component of the TVOB is provided to give
the handler somewhere to put its internal state.  It is usually
some kind of structure, depending on what program created the TVOB.
For example, it might be a piece of paper (see (pc-ppr)).

@section Jobs

A @i{job} is a Lisp structure with the following components:

@table @code
@item job-name
The name of the job, as a string.  This is only used for the printed
representation of the job or for display by programs, and may be anything
reasonably mnemonic.
@item job-tvobs
A list of all TVOBs associated with this job.
@item job-processes
A list of all processes associated with this job.
@item job-enabled-tvobs
A list of this job's enabled tvobs.  Each TVOB on this list is also
on the @code{job-tvobs} list.  The order of the enabled tvobs list is
"highest" first; this list is sometimes passed to @code{tvob-setup}.
@item job-enabled-processes
A list of this job's enabled processes.  This list is a subset of
the @code{job-processes} list.
@item job-tvob-enabled-p
If this is non-@code{nil}, this job is @i{tvob-enabled}; its enabled
TVOBs are active.
@item job-process-enabled-p
If this is non-@code{nil}, this job is @i{process-enabled}; its enabled
processes are active.
@item job-who-line-process
Whenever this job becomes the @code{kbd-job}, the process in this component
becomes the @code{tv-who-line-process} (The process whose @code{process-whostate}
is displayed in the who-line) (see (tv-who-line-process-var)).
@item job-tvob-selector
@code{nil}, or a function which is called by @code{tvob-setup} (see (tvob-setup-fun))
when this job is current and a new @code{selected-tvob} is needed.
The function takes no arguments and doesn't return anything in particular.
It isn't required to do anything, but it normally should call @code{tvob-select}
with an appropriate TVOB.
@item job-forced-input
If non-@code{nil}, a character or a string which is forced input for this job.
This is a character or characters which are pretending to come from the keyboard
but really originated from another process or the mouse.  See the function
@code{force-kbd-input} ((force-kbd-input-fun)).
@item job-forced-input-index
Index into @code{job-forced-input} when it is a string.
@end table

At any time, the user of the Lisp Machine may be conducting several
different activities.  For example, he may want to temporarily stop editing
in order to send some mail; he might want to start up a file transfer, and
while waiting for it to finish, continue editing.

Each such activity, in general, will want some processes to do
computation, and some pieces of the screen (TVOBs) on which to do output.
When the user is not concerned with some activity, he may want its
processes to stop, and/or its TVOBs to stop displaying.  In order to
make it easy to deactivate a set of processes and TVOBs, such a set
may be grouped together as a @i{job}.

Every job has a set of processes and TVOBs; these sets are
represented by the lists in the @code{job-processes} and @code{job-tvobs}
of the job.  Of each set, there is a subset that is @i{enabled};
these are the @code{job-enabled-processes} and @code{job-enabled-tvobs}
of the job.  A process's being @i{enabled} means that whenever
the job is told that it may run, that process
will be made @i{active}.  The same is true for TVOBs.
When the job is told that it may run its enabled processes, it is
said to be @i{process-enabled}; when it is told that it may
display its enabled TVOBs, it is said to be @i{tvob-enabled}.
A job can control which of its processes and TVOBs are enabled
by means of the functions @code{process-enable}, @code{process-disable},
@code{tvob-enable}, and @code{tvob-disable}, which are described below.

At any time there is one job which is said to "own the keyboard";
this job is the value of the variable @code{kbd-job}.  When a function calls
any of the keyboard input functions (such as @code{kbd-tyi}), the function
will wait until the current job is the @code{kbd-job} before returning.
The reason for this is that while the TV can be split up into areas
so that several programs can type on it at once, there is no similar
way to split up the keyboard; if several jobs want keyboard input,
one of them will get what the user types, and the rest will wait
until they become the @code{kbd-job}.

When Lisp is initialized, one job is created and given the keyboard.
The job is given a single, active TVOB, the size of the screen, and
a single, active process.  It is both process-enabled and TVOB-enabled,
so the process and TVOB are both active.

@section Controlling Jobs

It should be made easy for the user to control which jobs
are process-enabled and which are TVOB-enabled.
Unfortunately, the commands to allow easy control
of these parameters have not yet been fully developed.  This section
describes what has been implemented so far, but this will probably change.

The following two simple functions control whether
a job is process-enabled or TVOB-enabled.

@defun job-set-process-state job state
If @i{state} is non-@code{nil}, @i{job} is made process-enabled;
otherwise, it is made process-disabled.
@end defun

@defun job-set-tvob-state job state
If @i{state} is non-@code{nil}, @i{job} is made TVOB-enabled;
otherwise, it is made TVOB-disabled.  Since this function can change
the set of active TVOBs, the caller should follow with a call to
@code{tvob-setup} (see (tvob-setup-fun)).
@end defun

There is one job designated as the top-level job, from
which other jobs are selected.  This job is the value of the variable
@code{si:top-job}.  When Lisp is initialized, @code{si:top-job} is set
to the initial job, and usually it is never set again.  If this job
wants to let some other job run, it uses the function @code{job-select},
which may be called directly by the user, or by a program's "command interface"
function.  (The functions @code{ed}, @code{edval}, and @code{edprop} serve
this purpose for Eine, and the function @code{supdup} for the Supdup program.)

@defun job-select job
@code{job-select} should be called from the top-level job to give the
keyboard to @i{job}.  The top-level job is made process-disabled
and TVOB-disabled, and @i{job} is made process-enabled and TVOB-enabled,
and is given the keyboard (made to be the @code{kbd-job}).
@end defun

When the keyboard belongs to some job other than the top-level job,
'setq call-key page
the "CALL" key is interpreted specially to mean "Return the keyboard to the
top-level job."  If the user types a "CALL", the current @code{kbd-job} will
be made process-disabled and TVOB-disabled, the top-level job will be made
process-enabled and TVOB-enabled, and the top-level job will be given the
keyboard. The Control and Meta keys can be used with CALL:
Control prevents the current @code{kbd-job} from being made TVOB-disabled,
and Meta stops it from being process-disabled.

@section Functions for Manipulating TVOBs.

The following four functions are all used to create TVOBs; they
differ primarily in the way the caller specifies the TVOB's area of the screen.
To fully specify the area, use @code{tvob-create-absolute}.
If you just want an area of a certain size, but don't care where the area
is, use @code{tvob-create}.
If you need at least a certain size but would accept a larger size
if the space is available, use @code{tvob-create-expandable}.
If you have a pc ppr (piece of paper) and want to make a TVOB
for it, use @code{tvob-create-for-pc-ppr}.

@defun tvob-create-absolute x1 y1 x2 y2 &rest options
@code{tvob-create-absolute} creates and returns a new TVOB.
Its fields are set up as follows:

@table @code
@item tvob-handler
The value of the @code{:handler} option.
@item tvob-info
The value of the @code{:info} option.
@item tvob-job
The value of the @code{:job} option.  If it is @code{t}, the current job is used instead;
this is the default.
Otherwise it should be @code{nil} (meaning that the TVOB
is not associated with any job), or a job.
@item tvob-priority
The value of the @code{:priority} option.
@item tvob-x1
@i{x1}.
@item tvob-y1
@i{y1}.
@item tvob-x2
@i{x2}.
@item tvob-y2
@i{y2}.
@item tvob-screen
The value of the @code{:screen} option, which should be a screen.  It defaults
to the value of @code{tv-default-screen}.
@item tvob-status
The value of the @code{:status} option.
@item tvob-clobbered-p
@code{nil}.
@item tvob-mouse-handler
The value of the @code{:mouse-handler} option.  If the value is @code{t},
use the default mouse handler.
@end table

The options to @code{tvob-create-absolute} are:

@table @code
@item :handler
The @code{tvob-handler} function.
@item :info
The value to go in the @code{tvob-info} field.
@item :job
The job with which the TVOB will be associated.  @code{t} means the current
job and @code{nil} means no job.  The default is the current job.
@item :mouse-handler
The @code{tvob-mouse-handler} function.  @code{nil} means this TVOB doesn't
do anything special with the mouse, and @code{t} means the @code{mouse-default-handler}
should be used.
@item :name
The print-name of the TVOB.
@item :priority
@code{t} to make this TVOB more tenacious of its place on the screen.
@item :screen
The screen on which the TVOB will appear.  The default is @code{tv-default-screen}.
@end table

@end defun

@defun tvob-create x y &rest options
This allocates an area of the screen of width @i{x} and height @i{y}, and
creates and returns a TVOB with that area.
The options are the same as for @code{tvob-create-absolute}.
The screen area of the TVOB will be within the rectangular boundaries described
by the @code{screen-x1}, @code{screen-y1}, @code{screen-x2}, and @code{screen-y2}
of the screen on which the TVOB is created.
@code{tvob-create} tries to choose an area that will overlap
the fewest interesting TVOBs.  Specifically, it tries to stay out of the area used by
the exposed TVOB of the highest priority, then that of the exposed TVOB of the second-highest
priority, etc.  The way priority works is that the exposed tvobs are divided into
two groups: those with @code{tvob-priority} of @code{t}, and those with @code{tvob-priority}
of @code{nil}; the former all have higher priority than the latter.  Within
these two groups, the TVOBs are ordered by their ordering in the list @code{active-tvobs}.
The priority is remembered by the ordering of the list @code{exposed-tvobs}, of which
the first element is the TVOB of @i{lowest} priority, and the last is the TVOB
of @i{highest} priority.
@end defun

@defun tvob-create-expandable min-x min-y &optional max-x max-y &rest options
This first finds a @i{min-x} by @i{min-y} area of the screen, the same way
@code{tvob-create} does.  Then it tries to make that area larger,
up to @i{max-x} by @i{max-y}, without overlapping any other exposed TVOBs.
Otherwise it is like @code{tvob-create}.  @i{max-x} defaults to the size
of the area in which automatic allocation takes place: the difference between
the @code{screen-x2} and @code{screen-x1} of the screen.  @i{max-y} defaults similarly.
@end defun

@defun tvob-create-for-pc-ppr pc-ppr &rest options
If you want to use a pc ppr, you need an associated TVOB in order
to get permission for your pc ppr to use the screen.
This function takes a pc ppr and creates a TVOB, whose area of the
screen is that of the pc ppr.  The @code{tvob-info} will be the pc ppr,
the @code{tvob-handler} a function called @code{si:pc-ppr-tvob-handler}
(which does the right thing for pieces of paper which don't remember what they are
displaying and hence cannot @code{:update}),
and the screen used will be the @code{pc-ppr-screen} of the pc ppr.
If you give the @code{:handler} option, though, it will override
the @code{si:pc-ppr-tvob-handler}.  The rest of the options are the same
as in @code{tvob-create-absolute}.
@end defun

@defun tvob-kill tvob
This deactivates @i{tvob} if it is active, and dissociates it from
its associated job (if any).
@end defun

@defun tvob-enable tvob
Enable @i{tvob}.  If @i{tvob} has no associated job, or if its
job is tvob-enabled, activate @i{tvob}.  After making some calls
to @code{tvob-enable} and @code{tvob-disable}, the caller should call
@code{tvob-setup} (see (tvob-setup-fun)).
@end defun

@defun tvob-disable tvob
Disable @i{tvob}.  If it was active, deactivate it.  After making some calls
to @code{tvob-enable} and @code{tvob-disable}, the caller should call
@code{tvob-setup} (see (tvob-setup-fun)).
@end defun

@defun tvob-setup no-reselection &rest tvobs
This is the function in charge of keeping the state of the screen and
the internal database consistent when tvobs are activated, deactivated,
moved, etc.  After a program makes some calls to @code{tvob-enable} and
@code{tvob-disable}, it may have changed the set of @i{active} TVOBs, and
it should call @code{tvob-setup} to make sure that the set of @i{exposed}
TVOBs is recomputed, and that the right messages are sent to all TVOBs.
(If @code{tvob-enable} etc. did that themselves, then unneccesary
redisplay and computation would be unavoidable.) The
@code{job-set-tvob-state} function can also change the set of active
TVOBs, and it too should be followed by a call to @code{tvob-setup}.

@code{tvob-setup} looks at its argument, @i{tvobs}, and at the list of
active TVOBs and figures out which TVOBs should be exposed.

First, @code{tvob-setup} examines the elements of @i{tvobs}, all of which
should be active, and rearranges the order of @code{active-tvobs}.  The
TVOBs in @i{tvobs} are moved to the front of @code{active-tvobs}, and
placed in the order they were given to @code{tvob-setup}.  The first TVOB
in @i{tvobs} is guaranteed to be first in @code{active-tvobs}.  The
remaining active TVOBs are moved to the end of @code{active-tvobs}.  Their
relative order is not changed.  The @code{job-enabled-tvobs} lists of the
TVOB's jobs are similarly reordered.

Next, @code{tvob-setup} figures out the new subset of the active TVOBs
that should be exposed, by walking down the @code{active-tvobs} list and
taking every TVOB that doesn't overlap with some TVOB already on the
new @code{exposed-tvobs} list.  Since the new list starts out as @code{nil},
the first element of @code{active-tvobs}, which was the second argument to
@code{tvob-setup}, will always be exposed.  The exposed list is kept in
reverse priority order, as explained under @code{tvob-create} (see
(tvob-create-fun)).

Having determined the new set of exposed tvobs, @code{tvob-setup} sends
out @code{:deselect}, @code{:deexpose}, and @code{:expose} commands as needed.
It only sends @code{:deselect} if the selected tvob would no longer be exposed;
when it does this, it also sets @code{selected-tvob} to @code{nil}. At this point,
@code{exposed-tvobs} is set to its new value.  @code{tvob-select} then sends
@code{:clobber} and @code{:update} commands to all of the new exposed TVOBs.

Finally, if there is no @code{selected-tvob}, and @i{no-reselection}
is @code{nil}, @code{tvob-setup} tries to choose a new @code{selected-tvob} by calling
the @code{job-tvob-selector} function of the @code{kbd-job} (if there is a @code{kbd-job}
and it has a @code{job-tvob-selector}).
@end defun

@defun tvob-select tvob
This makes @i{tvob} be the @code{selected-tvob}.  It makes sure
that @i{tvob}'s job is TVOB-enabled, and that @i{tvob} is exposed.
Then it deselects the current @code{selected-tvob} (if any) and selects
@i{tvob}.
@end defun

@defun tvob-update
If the variable @code{tvob-complete-redisplay} is non-@code{nil}, set it to
@code{nil} and call @code{tvob-complete-redisplay}.  Otherwise send
an @code{:update} message to all exposed TVOBs.
@end defun

@defvar tvob-complete-redisplay
Used as a flag by @code{tvob-update} (see above): if non-@code{nil}, @code{tvob-update}
should do a @code{tvob-complete-redisplay}.
@end defvar

@defun tvob-complete-redisplay
Clears the screen, outlines the screen area of partially-exposed enabled TVOBs,
and sends @code{:clobber} and @code{:update} to all exposed TVOBs.
@end defun

@defun tvob-clean
This "cleans up" the screen.  It sends a @code{:clean} message to all exposed TVOBs,
and clears portions of the screen not occupied by exposed TVOBs.
@end defun

@defun tvob-command command tvob &rest arguments
Sends @i{command} to @i{tvob}, with the given @i{arguments}.
@i{command} should be one of the symbols mentioned above
(@code{:set-edges}, @code{:clobber}, etc.).  After sending the command,
@code{tvob-command} updates the @i{tvob}'s @code{tvob-status},
@code{tvob-clobbered-p}, or the screen area (@code{tvob-x1} et. al.) as
appropriate.

In order to preserve consistency, only the @code{tvob-setup} and @code{tvob-select} functions
should send any of the commands @code{:select}, @code{:deselect}, @code{:expose},
and @code{:deexpose}; you should never send these yourself.
@end defun

@defun tvob-under-point x y &optional screen
Returns the TVOB under the point (@i{x},@i{y}) on @i{screen}, or
@code{nil} if there is none.  If there are several TVOBs at that point,
the "top-most" one, i.e. the one which is actually visible, is
returned.  @i{screen} defaults to @code{tv-default-screen}.
@end defun

@section Functions for Manipulating Jobs.

@defun job-create name
Creates and returns a job, whose name is @i{name}.
The job is created with no processes and no TVOBs,
and its initial @code{job-process-enabled-p} and @code{job-tvob-enabled-p}
are both @code{nil}.  @code{job-create} also puts the job on @code{job-list}.
@end defun

@defun job-kill job
Deactivates and kills all of @i{job}'s processes and TVOBs,
and removes @i{job} from the @code{job-list}.
@end defun

@defvar job-list
A list of all jobs.  See @code{job-create} and @code{job-kill}.
@end defvar

@defun job-reset-processes job
Disables all of @i{job}'s enabled processes, and unwinds those
processes's stack groups.
@end defun

@defun job-select job
This is meant to be called from the top-level job, which should have
the keyboard at the time.
It disables the @code{kbd-job}'s processes and TVOBs,
enables those of @i{job}, and gives @i{job} the keyboard.
@end defun

@defun job-return
This is meant to be called from jobs other than the top-level job.
It disables the current job's processes and TVOBs,
enables those of the top-level job, and gives the top-level job
the keyboard.
[The job calling it had better have the keyboard.]
@end defun

@c DSK:LMMAN;TV 76
@c This file is part of the Lisp Machine manual.	-*-Text-*-
@c This file documents the TV routines (LMIO;TV >)

@c It's unclear if these comments mean anything.
@c It is being modified from LMDOC; TVDOC into LMMAN format.
@c NOTE: This file is not really up to the standards of the rest of the
@c       manual, in that it is somewhat "internal" in style.  I don't really
@c       want to rewrite it at this time, but eventually we probably should.
@c [NEW: TV-ALL-PLANES-MASK, NEW MARGIN STUFF, 2 NEW CLEAR FCNS]
@c Make sure we document reverse video mode.
@c [Also, must insert TVDEFS and TV2 (when that gets renamed and installed).]
@c Document the ESCAPE commands from the kbd.

@chapter The TV Display
@cindex tv

The principal output device of the Lisp Machine is the TV display
system.  It is used in conjunction with the keyboard as an interactive
terminal, and it can output printed text or graphics.  This chapter
describes the Lisp functions used to manipulate the TV.

@section The Hardware

The Lisp machine display system is a raster-scan, bit-map
system.  This means that the screen is divided up rectangularly into
points.  The video signal that enters the TV comes from
a memory which has one bit for every point on the screen.
This memory is directly accessible to the program, allowing extremely
flexible graphics.

The coordinate system normally used has the origin (0,0) at the
top left corner of the screen.  @i{X} increases to the right, and @i{Y}
increases downward.

There are currently two TV controllers in use.  The 16-bit controller,
which is going away, generates industry-standard composite video, allowing
a screen size of 454. lines from top to bottom with 576. points on each
line.  The newer, 32-bit controller, provides various options.  With the
CPT monitor it generates a black-and-white display of 896. lines with
768. points on each line.  Other monitors can also be supported.

One thing to be aware of is that the same fonts cannot be used
with both controllers, because the 16-bit controller has its bits reversed.

It is possible to have a display in which there is more than
one bit per visible point, allowing gray-scale or color.  The set of all
bits which contribute to a single point on the screen is called a
@i{pixel}.  (The point on the screen itself is also sometimes called a
pixel.)  Some of the software operates in terms of pixels.  Pixels are
implemented in an entirely different way in the two controllers.  This
document doesn't really discuss them yet.

Because of all these options, the Lisp machine system
includes @i{screen objects}.  A screen object contains all the
attributes of a particular TV controller and display monitor.

@section Screens
@cindex screen

There is a type of Lisp object called a @i{screen}, which is the internal
representation for a physical display with someone looking at it.  Both
microcode and Lisp functions look at screen objects.
A screen is a structure which contains the following fields:

@table @code
@item screen-name
An arbitrary character string which appears in the printed representation
of the screen-object.
@item screen-height
The total height of the screen in bits (raster lines, pixels).
@item screen-width
The total width of the screen in bits (pixels).
@item screen-x1, screen-x2, screen-y1, screen-y2
The coordinates of a rectangle which is the portion of the
screen in which allocation of tvobs may occur.  Usually this
is the whole screen, but if there is a who-line it is excluded.
There could be other reserved areas of the screen.
@item screen-plane-mask
0 if this screen is on a 32-bit controller.  If it is on a 16-bit
controller, one of the bits in this mask is on corresponding to
the memory "plane" which contains this screen.  (For instance,
for plane 0 the value of this field would be 1.)  Having more than
one bit on in this mask is not really supported.
@item screen-bits-per-pixel
The number of bits in a pixel.
@item screen-property-list
This is a property list for special features of this screen.
Access this via forms such as @code{(get (locf (screen-property-list s)) ':video)}
The following property names are standard.
@table @code
@item :video
The kind of video this screen uses.
One of @code{:black-and-white}, @code{:gray}, @code{:color}.
@item :controller
The only controller that exists currently is @code{:simple}.
@item :monitor
The brand-name of the attached monitor, e.g. @code{:cpt}, @code{:barco}, etc.
@item :sideways
If the value of this property is non-@code{nil},
the monitor is standing on its left side.  The TV routines know how
to draw characters on such a screen, given a rotated font, so that
the text comes out in the normal orientation.
@end table

@item screen-font-alist
An a-list that associates from font names to font objects.
This is not really used yet.
@item screen-default-font
The font to be used by default on this screen.
@item screen-buffer
The address in virtual memory of the video buffer for this screen.
@item screen-locations-per-line
The number of locations (containing 16 or 32 bits depending on the controller)
of the video buffer for a scan line.
@item screen-buffer-pixel-array
A two-dimensional array of positive integers, which are pixel values.
The first subscript is the X coordinate and the second subscript is the Y coordinate.
@item screen-buffer-halfword-array
A one-dimensional array of 16-bit words of video buffer.  This is provided to allow
direct manipulation of the video buffer, bypassing the usual microcode primitives.
Note that on a 16-bit controller, the bits in these words are reversed.
@item screen-control-address
The address, suitable for use with @code{%xbus-read}, of the hardware control registers
for this screen.
@end table

@defvar tv-default-screen
The value of @code{tv-default-screen} is the "normal" screen where
text display happens.  Various functions that take a screen as an
optional argument default to this.
@end defvar

@defun tv-define-screen name &rest options
Creates and returns a screen whose name is @i{name} (a string)
and whose attributes are controlled by the options.  These attributes
has better correspond to an existing hardware screen.
@i{options} is alternating keywords and arguments to those keywords.  The following
keywords are accepted:

@table @code
@c *** Are these defaults still true? ***
@item :plane-mask
The value of the @code{screen-plane-mask} field.  Defaults to 0,
for screens on the 32-bit TV controller.
(This is obsolete.)
@item :height
The value of the @code{screen-height} field.  Required argument.
@item :width
The value of the @code{screen-width} field.  Required argument.
@item :x1
The value of the @code{screen-x1} field.  Defaults to 0.
@item :y1
The value of the @code{screen-y1} field.  Defaults to 0.
@item :x2
The value of the @code{screen-x2} field.  Defaults to the width.
@item :y2
The value of the @code{screen-y2} field.  Defaults to the height,
unless the @code{:who-line-p} option is specified, in which case
one line of space is left at the bottom of the screen for the who-line.
@item :who-line-p
@code{t} to leave space for a who-line, @code{nil} to make the entire
screen available for TVOB allocation.  Defaults to @code{t}.
@item :buffer
A fixnum which is the address of the video buffer containing
the bits for this screen.  Required argument.
@item :control-address
A fixnum which goes into the @code{screen-control-address} field.
@item :locations-per-line
The value of the @code{screen-locations-per-line} field.  Defaults from
the width, the bits per pixel, and the controller type.
@item :bits-per-pixel
The value of the @code{screen-bits-per-pixel} field.  Defaults to 1.
@item :properties
The value of the @code{screen-attributes} field.  Defaults to @code{nil}.
@item :font-alist
The value of the @code{screen-font-alist} field.  Defaults to @code{nil}.
@item :default-font
The value of the @code{screen-default-font} field.  Defaults
according to the type of controller used.
@end table

@end defun

@section Simple Bit Manipulation

Some arrays of numbers exist which allow access to the TV memory.  These
are regular Lisp arrays and all array operations work on them, but they
are set up so that their data storage is actually in the TV memory.
These arrays are normally found in fields of a screen object.

@code{screen-buffer-pixel-array} is a two-dimensional array.  Array element
(@i{x},@i{y}) corresponds to the point whose coordinates are @i{x} and
@i{y}: if the array element is 0, the point is illuminated, and if the
element is 1, the point is dark.  (The opposite is true when the TV is
in reverse-video mode; see below).

The elements of this array are single bits in the usual case, but they can
be small positive numbers in the case of gray-scale or color screens.

In the case of a 16-bit TV, this array accesses whichever
plane is currently selected.

@code{screen-buffer-halfword-array} is a one-dimensional array of 16-bit
elements, whose exact interpretation depends on the type of TV screen.
Certain programs use this to access the TV buffer memory.

It is possible to do anything to a TV screen, albeit slowly, using the
above two arrays.  However, for efficiency several microcode primitives
are provided which perform certain common operations at much higher speed,
typically close to the maximum speed of the memory.  Most programs use
these microcode primitives or the higher-level functions built on them
rather than accessing the TV buffer memory directly.  The remainder of
this chapter describes these facilities.

@section Fonts
@cindex font

A font is a set of related characters.  It is represented by an array
(of type @code{art-1b}) which contains the bit patterns used to actually draw the
characters.  The leader of that array contains other required information
such as character widths, height, bookkeeping information, etc.

There is a microcode entry for drawing characters, which understands the
structure of fonts.  It exists so as to make character drawing as fast
as possible.  User functions do not call the microcode entry directly,
as it is rather kludgey, and handles only the easy cases.  Instead the
TV routines do all the necessary calls.

A font usually contains 128 characters.  The widths may be
variable, but the height is always fixed (characters need not actually have
ink all the way from the top to the bottom of the height, but the distance
between lines is fixed for each font).  There are special provisions
for fixed-width fonts to save space and time.  There is a thing called
the baseline, which is a certain vertical position in each character.
For example, the baseline touches the bottom of the legs of a capital A,
and passes through the stem of a lower-case p.
When several fonts are used together, all the baselines are made to line up.

The way characters are drawn is a little strange (it is done this way for
speed).  There is a thing called a @i{raster element}, which is a row of
1-bits and 0-bits.  A character is drawn by taking a column of raster elements,
(making a rectangle) and OR'ing this into the bit-map memory.  A raster
element can be at most 16 bits wide for hardware reasons, so for large characters
it may take several side-by-side columns to draw the character.  The font
is stored with several raster elements packed into each 32-bit word.  The width
of a raster element is chosen to give maximum packing, and depends on the font.
The reason for the existence of raster elements is to decrease the number
of memory cycles by processing several bits at a time.

The structure of the array leader of a font is defined by @code{defstruct}
macros.  Here we list the element names and what they are for.  This structure
is not guaranteed not to be changed in the future, however the macros
are automatically made available to user programs.

@table @code
@item font-name
A symbol, in the @code{fonts} package, whose value is this font.
This symbol also appears in the printed representation.
@item font-char-height
Height of the characters in this font (with a VSP
of 0, this is how far apart the lines would be.)
@item font-char-width
Width of the characters if this is a fixed-width font,
i.e. how far apart successive characters are drawn.
Otherwise contains the width of "space".
@item font-raster-height
Number of raster lines of "ink" in a character (often
the same as @code{font-char-height}).
@item font-raster-width
Width of a raster element.
@item font-rasters-per-word
Number of elements packed per word (used when accessing the font.)
@item font-words-per-char
Number of words needed to hold one column of elements.
@item font-baseline
Number of raster lines down from the top of the
character cell of the position to align.
@item font-char-width-table
@code{nil} for fixed width fonts.  Otherwise, contains the
128-long array of character widths.
@item font-left-kern-table
@code{nil} for non-kerned fonts.  Otherwise, contains the
128-long array of left-kerns.  This is the amount (positive
or negative) to back up the X position before drawing
the character.
@item font-indexing-table
@code{nil} for narrow fonts which only take one column of
raster elements to draw.  Otherwise, contains a
129-long array which determines what columns of the
font to draw for that character as follows: for
character @i{i}, draw columns @i{indexingtable}(@i{i}) through
@i{indexingtable}(@i{i}+1)-1
inclusive.
Note that 2 of the above 3 arrays only contain small
positive numbers, so they are usually of type @code{art-16b} or
@code{art-8b} to save space.
@item font-next-plane
@code{nil} usually.  For multi-plane fonts, contains the
font for the next higher plane.  This field is obsolete and no
longer supported.
@item font-blinker-width
Default width for blinkers.
@item font-blinker-height
Default height for blinkers.
@end table

The data part of a font array contains an integral number of words per
character (per column in the case of wide characters that need an
indexing table).  Each word contains an integral number of raster
elements, left adjusted and processed from left to right.  All 32 bits
of each element in this array are used.  For easiest processing by Lisp
programs, it should be of @code{art-1b} array type.

The exact format of the data part of a font array depends on whether
the font is intended to be used with a 16-bit TV controller or a 32-bit controller.
In the 32-bit case, the bits are displayed from right to left.  The maximum
width of a raster element is 32. bits; use of the @code{font-indexing-table}
is required if characters are wider than this.  If there is more than one
raster element per word, the elements are displayed from right to left.
In the 16-bit case, the bits and raster elements are displayed from
left to right, and the maximum width of a raster element is 16. bits.

@section TVOBs

[Here explain what TVOBs are, how they differ from pieces of paper, what
you use them for, and point to JOBSYS chapter.]  Until this is written,
see (tvob).

@section Pieces of Paper
@cindex pc ppr
@cindex piece of paper

A @i{piece of paper} is something on which you draw
characters.  It is displayed on a certain rectangular portion of a
screen.  It remembers what fonts to use, where to display the next
character, how to arrange margins and spacing, and what to do when
certain special conditions arise.  It optionally displays a blinking cursor
(or several of them).

All character-drawing in the Lisp
Machine system is accomplished with pieces of paper.  One thing to note
is that pieces of paper do not remember the characters you draw on
them, except by making dots on the TV screen.  This means that if one
piece of paper overlays another, or if the screen is cleared, the
contents of the first is lost.  A higher-level facility (e.g. editor
buffers) must be used if the characters are to be remembered.  The
abbreviation "pc ppr" is often used for "piece of paper".

A piece of paper is represented as an ordinary array whose elements are
named by the following accessor macros.  These are automatically available
to the user, but should not normally be used as they are not guaranteed to remain unchanged,
and often contain internal values which are made into more palatable
form by the interface functions.  All screen coordinates in this structure
are absolute screen coordinates; the user interface functions convert these
into coordinates which are relative to the margins of the piece of paper.

@table @code
@item pc-ppr-name
An arbitrary string which appears in the printed representation.
@item pc-ppr-screen
The screen-object representing the screen on which this pc ppr displays.
@item pc-ppr-top
The raster line number of the topmost screen line in this pc ppr.
@item pc-ppr-top-margin
The raster line number of the topmost screen line used to draw characters.
The difference between @code{pc-ppr-top-margin} and @code{pc-ppr-top} is the size
of the top margin.
@item pc-ppr-bottom
The raster line number of the screen line just below this pc ppr.
@item pc-ppr-bottom-margin
The raster line number of the screen line just below the bottommost point
on which a character can be drawn.  The difference between @code{pc-ppr-bottom}
and @code{pc-ppr-bottom-margin} is the size of the bottom margin.
@item pc-ppr-bottom-limit
The lowest raster line to which the cursor may be positioned.  This is a suitable
value to prevent excursion below the bottom margin.
@item pc-ppr-left
The bit number of the leftmost bit in the pc ppr's screen area.
@item pc-ppr-left-margin
The bit number of the leftmost bit used to draw characters.
The difference between @code{pc-ppr-left-margin} and @code{pc-ppr-left} is the left margin.
@item pc-ppr-right
The bit number of the bit just to the right of the pc ppr's screen area.
@item pc-ppr-right-margin
The bit number of the bit just to the right of the portion of the pc ppr
in which characters may be drawn.  The difference between @code{pc-ppr-right}
and @code{pc-ppr-right-margin} is the right margin.
@item pc-ppr-right-limit
The rightmost bit position to which the cursor may be positioned.  This is
set to a suitable value to prevent excursion past the right margin.
@item pc-ppr-current-x
The X position of the left edge of the next character to be drawn,
i.e. the X coordinate of the cursor position.
@item pc-ppr-current-y
The Y position of the top edge of the next character to be drawn,
i.e. the Y coordinate of the cursor position.
@item pc-ppr-flags
A fixnum containing various bit flags, as follows:
@table @code
@item pc-ppr-sideways-p
0 normally.  1 if the pc ppr is on a sideways screen, so the X and Y
coordinates should be interchanged before calling the microcode.
@item pc-ppr-exceptions
Non-zero if any special conditions which prevent typeout
are active.  The conditions are:
@table @code
@item pc-ppr-end-line-flag
1 if @code{pc-ppr-current-x} is
greater than @code{pc-ppr-right-limit}.
The default response to this is to advance to the next line.
@item pc-ppr-end-page-flag
1 if @code{pc-ppr-current-y} is greater than @code{pc-ppr-bottom-limit}.
The default response to this is to return to the top of the pc ppr.
@item pc-ppr-more-flag
1 if "more-processing" must happen before the next character can
be output.  The default response to this is to display "**MORE**"
and await keyboard input.
@item pc-ppr-output-hold-flag
1 if some higher-level function has decided that output is not to be
allowed on this pc ppr.  For example, its region of the screen might
be in use for something else.  When this is seen a function specified
when the pc ppr was created is called.
@end table @c (exceptions)
@end table @c (flags)
@item pc-ppr-more-vpos
Y passing here triggers "more processing" by setting @code{pc-ppr-more-flag}.
Add 100000 to this field to delay until after screen wraparound.
Store @code{nil} here to inhibit more processing.
@item pc-ppr-baseline
The number of raster lines from the top of the character cell (@code{pc-ppr-current-y})
to the baseline.
@item pc-ppr-font-map
An array of fonts.  Normally a font-change command
specifies a code number, which is looked up in this
array to find what font to actually use.  Font 0
is the "principal" font.  The array is usually 26. long.
@item pc-ppr-current-font
The font which is currently selected.
@item pc-ppr-baseline-adj
Y offset for current font to align baseline.  This is the difference between
the @code{pc-ppr-baseline} and the font's baseline.
@item pc-ppr-line-height
The number of raster lines per character line.
@item pc-ppr-char-width
A character width which is just used for old-style
space/backspace/tab operations and for blinkers.
@item pc-ppr-char-aluf
ALU function for drawing characters.  The default is the value of @code{tv-alu-ior}.
@item pc-ppr-erase-aluf
ALU function for erasing characters/lines/whole pc ppr.  The default is
the value of @code{tv-alu-andca}.
@item pc-ppr-blinker-list
(Possibly null) list of blinkers on this pc ppr.
@item pc-ppr-end-line-fcn
Function called when typeout is attempted with @code{pc-ppr-end-line-flag} set.
The default is to wrap around to the next line.
@item pc-ppr-end-screen-fcn
Function called when typeout is attempted with @code{pc-ppr-end-page-flag} set.
The default is to wrap around to the top margin.
@item pc-ppr-output-hold-fcn
Function called when typeout is attempted with @code{pc-ppr-output-hold-flag} set.
The default is to wait for the flag to be cleared by some other process.
@item pc-ppr-more-fcn
Function called when typeout is attempted with @code{pc-ppr-more-flag} set.
The default is to type **MORE** and await typein.
@end table @c (pc ppr)

@subsection Simple Typeout

@defun tv-tyo pc-ppr char
Draws a printing character, or executes a special format character.
The character is drawn at the current cursor position, in the current font,
and the cursor position is shifted to the right by the width of the character.
The following format effectors are recognized:

@table @code
@item 200
Null.  Nothing happens.
@item 210
Backspace.  The cursor is moved left the width of a space.  At the beginning
of a line it sticks.
@item 211
Tab.  The cursor is moved right to the next multiple of 8 times the width
of a space.
@item 215
Carriage return.  The cursor is advanced to the beginning of the next line,
and that line is erased.  More-processing and screen wrap-around may be
triggered.
@item 240-247
Font change.  The low 3 bits are the font number.
@end table

Other non-printing characters are displayed as their name enclosed in a box.
These displays are quite wide and currently don't bother to respect the right margin.
@end defun

@defun tv-beep
This function is used to attract the user's attention.
It flashes the screen and beeps the beeper.  Doesn't really have
that much to do with TVs.
@end defun

@defvar tv-beep
If the value of @code{tv-beep} is non-@code{nil}, the @code{tv-beep}
function doesn't flash the screen, it only sounds a beep.
The initial value is @code{nil}.
@end defvar

@defun si:tv-move-bitpos pc-ppr delta-x delta-y
Move current X, current Y on piece of paper, keeping inside boundaries.
This function is called from many others.  It is the central place
to keep track of edges, automatic wrap-around, **MORE** processing, etc.
It will set the @code{pc-ppr-exceptions} flags as necessary.
@end defun

@defun si:tv-exception pc-ppr
This function is called by various TV functions when they encounter
a @code{pc-ppr-exceptions} flag which they care about (for example, @code{tv-crlf}
does not care about @code{pc-ppr-end-line-flag}).
The appropriate function (stored in the pc ppr) is called.  It is up to
that function to correct the condition and clear the exception flag.
@end defun

If you want to supply your own exception-handling function for
a piece of paper, you would be well-advised to read the corresponding
system default function first.  They need to do non-obvious things
in some cases.

@defun si:tv-end-line-default pc-ppr
This is the default end-of-line function, called if an attempt is made
to display a character when the cursor is off the end of a line.
It essentially just does a crlf.
@end defun

@defun si:tv-end-screen-default pc-ppr
This is the default end-of-screen function, called when an attempt is
made to display a character when the cursor is off the bottom of the pc ppr.
It wraps around to the top of the pc ppr.
Note that more-processing is separate from and unrelated to end-of-screen processing.
@end defun

@defun si:tv-more-default pc-ppr
This is the default more processor.  It types out **MORE**,
waits for input, and decides where the next "more" should happen.
@end defun

@defun tv-note-input
The purpose of @code{tv-note-input} is to prevent "more"s from happening
during normal interactive usage, since typeout is frequently pausing
for user input anyway, and presumably the user is keeping up in his reading.
This function is called by the keyboard handler when a process hangs
waiting for input.  @code{tv-note-input} arranges (on each active pc ppr)
for a more not to happen until the current
line is reached again; except, if this line is far from the bottom, we prefer
to more at the bottom before wrapping around.  This makes moreing usually happen at the bottom.
@end defun

@subsection Cursor Motion

Note that the "cursor" is the x,y position where the top-left corner of the next
character printed will be placed.  (This is not strictly true because there is
base-line adjustment and kerning.)
The cursor doesn't necessarily have a corresponding
blinker; this is under the control of the user program.

Many of these functions are not used by real Lisp Machine code,
but are present for completeness
and to aid compatibility with ITS I/O.  On the other hand, some are heavily used.

@defun tv-home pc-ppr
Home up to the top-left corner.
Usually you then want to do a @code{tv-clear-eol}.
@end defun

@defun tv-home-down pc-ppr
Home down the cursor to the bottom-left corner (the beginning of the
last line in the pc ppr).
@end defun

@defun tv-crlf pc-ppr
Advance to the beginning of the next line, and erase its
previous contents.
@end defun

@defun tv-space pc-ppr
Space forward.
@end defun

@defun tv-backspace pc-ppr
Space backward.  Not too useful with variable-width fonts.
@end defun

@defun tv-tab pc-ppr
Tab.  Spaces forward to the next multiple of 8 times the width of space.
@end defun

@defun tv-set-font pc-ppr font
This is the common internal routine for changing what font a piece
of paper is to print with.  It does some bookkeeping,
such as adjusting the baseline.  It is OK to set the font to one
which is not in the font map, however this won't change the line-spacing,
which is initially set up according to the tallest font in the font map.
@end defun

@defun tv-set-cursorpos pc-ppr x y
Sets the "cursor" position of the piece of paper
in raster units (@i{not} character units).  @i{x} and @i{y}
are relative to the margins of the pc ppr.
@end defun

@defun tv-read-cursorpos pc-ppr
Returns two values, the X and Y coordinates of the cursor.
These are relative to the margins of the pc ppr.
@end defun

@subsection Erasing, etc.

@defun tv-clear-char pc-ppr
Clear the current character position.  In a variable-width font,
the width of space is used, which isn't likely to be the right thing.
@end defun

@defun tv-clear-eol pc-ppr
Clear from current position to end of line.
@end defun

@defun tv-clear-eof pc-ppr
Clear from current position to end of piece of paper.
@end defun

@defun tv-clear-pc-ppr pc-ppr
Clear whole piece of paper.
@end defun

@defun tv-clear-pc-ppr-except-margins pc-ppr
Clear all of @i{pc-ppr} except the margins, which are unaffected.
This is useful if the margins contain decorative graphics
'c What Fredkin calls "decorative computer art"
such as outlines.
@end defun

@defun tv-clear-screen &optional screen
Clears the entire screen, and tells the who-line it has been clobbered.
@i{screen} defaults to @code{tv-default-screen}.
@end defun

@defun tv-delete-char pc-ppr &optional (char-count 1)
Deletes the specified number of character positions immediately to
the right of the cursor, on the current line.  The remainder of
the line slides to the left, and blank space slides in from the
right margin.
@end defun

@defun tv-insert-char pc-ppr &optional (char-count 1)
Inserts the specified number of blank character positions immediately
to the right of the cursor, on the current line.  The remainder of
the line slides to the right, and anything that goes off the right
margin is lost.
@end defun

@defun tv-delete-line pc-ppr &optional (line-count 1)
Deletes the specified number of lines immediately at and below the cursor.
The remaining lines of the piece of paper slide up, and blank spaces
slides in from the bottom margin.
@end defun

@defun tv-insert-line pc-ppr &optional (line-count 1)
Inserts the specified number of blank lines at the cursor.
The remaining lines of the piece of paper slide down, and anything
that goes off the bottom margin is lost.
@end defun

@defun tv-black-on-white &optional screen
Makes the hardware present the screen as black characters on a white background.
(Presently, the @i{screen} argument can also be a plane-mask.)
@end defun

@defun tv-white-on-black &optional screen
Makes the hardware present the screen as white characters on a black background.
(Presently, the @i{screen} argument can also be a plane-mask.)
@end defun

@defun tv-complement-bow-mode &optional screen
Makes the hardware present the screen in the reverse of its current mode.
(Presently, the @i{screen} argument can also be a plane-mask.)
@end defun

@defun tv-white-on-black-state &optional screen
Returns @code{:white} if the screen is currently presented as white-on-black,
or @code{:black} if it is currently presented as black-on-white.  The @i{screen}
argument can also be a plane-mask.  If more than one bit is on in the plane-mask,
and not all the planes are in the same state, @code{:both} is returned.
@end defun

@subsection String Typeout

@defun tv-string-out pc-ppr string &optional (start 0) end
Print a string onto a piece of paper.
Optional starting and ending indices may be supplied; if unsupplied,
the whole string is printed.  This is basically just iterated @code{tv-tyo},
except in the case of simple fonts it runs much faster by removing
a lot of overhead from the inner loop.
@end defun

@defun tv-line-out pc-ppr string &optional (start 0) end
This variant of @code{tv-string-out}
is used by the editor's display routines to output one line.
The argument is a string of either 8-bit or 16-bit characters (usually
this is an EINE "line", but the leader is not touched except for the fill pointer.)
The high 8 bits (@code{%%ch-font}) of each character are the index into the font map
for the font in which that character is to be displayed.  8-bit chars use font 0.
There are optional starting and ending indices; if these are omitted the
whole string is specified.
If during printing the cursor runs off the end of the line, typeout stops
and the index of the next character to be output is returned.  At this point,
the @code{pc-ppr-end-line-flag} is 1 and the cursor is off the end of the line.
If the whole string is successfully output, @code{nil} is returned,
and the pc ppr is pointing somewhere in the middle of the line.
@end defun

@defun tv-string-length pc-ppr string &optional (start 0) end stop-x
Compute the display-length of a string, which is the sum of the widths
of the printing characters in it.  Newline characters are ignored.  Tab
characters act as if the string starts at the left margin.  @i{pc-ppr}
is used mainly for its font map.  @i{start} and @i{end} allow you to
process a substring.  @i{stop-x}, if non-@code{nil}, is a tv-length
at which to stop.  The index in the string of the character after the one
which exceeded the @i{stop-x} is returned as the second value.

The first returned value is the @i{x}-position reached, i.e. the tv-length
of the string.  The second returned value is the next index in the string,
which is @i{end} if @i{stop-x} was not supplied.

Contrast @code{tv-compute-motion}, which does a
two-dimensional computation taking line-length into account.
@end defun

@defun tv-compute-motion pc-ppr x y string &optional (start 0) end (cr-at-end-p nil) (stop-x 0) stop-y
Compute the motion that would be caused by outputting a string.
This is used by the editor to aid in planning its display,
to compute indentations with variable width fonts, to
position the cursor on the current character, etc.
Note that this does not use the "case shift" flavor of font hacking.
Instead, it uses the 16-bit-character flavor that the editor uses.
This means that if you give it an ordinary 8-bit string it will
be assumed to be all in font 0.

The arguments are: the piece of paper, the X and Y position to
start at (@code{nil}s here use the current position of the pc ppr),
the string, and optionally the starting and ending indices,
a flag saying to fake a crlf at the end of the string, and
two additional arguments which are the
X and Y to stop at; if not given these default to the end of the screen.
Returns 3 values: final-X, final-Y, and an indication of how far down the
string it got.  This is @code{nil} if the whole string (including the fake
carriage return, if any) was processed without
reaching the stopping point, or the index of the next character to be
processed when the stopping point was reached, or @code{t} if the stopping point
was reached after the fake carriage return.
@end defun

@defun tv-char-width pc-ppr char
Returns the width of the character, if displayed in the font
current in the pc-ppr.  The width of backspace is negative,
the width of tab depends on the pc ppr's cursor position, and the width
of carriage return is zero.
@end defun

@subsection More Processing

More processing is a flow control mechanism for
output to the user.  Lisp machine more processing is similar to more
processing in ITS.  The problem that more processing solves is that
displayed output tends to appear faster than the user can read it.  The
solution is to stop just before output which has not been read yet is
wiped out, and display "**MORE**".  The user then reads the whole
screen and hits space to allow the machine to continue output.  More
processing normally occurs one line above where the cursor was when the
machine last waited for user input; however, it tries to do an extra
**MORE** at the bottom of the pc ppr, so as to get into a phase where
the **MORE** always appears at the bottom, which is more aesthetic.

@subsection ALU Functions

Some TV operations take an argument called an @i{ALU Function},
which specifies how data being stored into the TV memory is to be combined with
data already present.  The ALU function is OR'ed directly into a microinstruction,
so specifying a value other than one of those listed below may produce
unexpected disasters.
The following special variables have numeric values
which are useful ALU functions.

@defvar tv-alu-ior
Inclusive-OR.  Storing a 1 turns on the corresponding bit, otherwise
the bit in TV memory is left unchanged.
@end defvar

@defvar tv-alu-xor
Exclusive-OR.  Storing a 1 complements the corresponding bit, otherwise
the bit in TV memory is left unchanged.
@end defvar

@defvar tv-alu-andca
AND-with-complement.  Storing a 1 turns off the corresponding bit, otherwise
the bit in TV memory is left unchanged.
@end defvar

@defvar tv-alu-seta
Bits are simply stored, replacing the previous contents.
With most functions, this is not useful since it clobbers unrelated
bits in the same word as the bits being operated on.  However,
it is useful for bitblt.
@end defvar

@subsection Blinkers

A @i{blinker} is an attention-getting mark on the screen.
Often, but not always, it will blink.  The most common type is a
character-sized rectangle which blinks twice a second, but several
other types exist, and it is easy for the user to define new ones.
Often a piece of paper will have an associated blinker which shows
where the next character will be drawn.  A blinker can be on top of a
character, and the character will still be visible.  This done by
XORing the blinker into the TV memory.  Synchronization between pieces
of paper and blinkers is provided so that when characters are being
drawn on the screen, blinkers are turned off to prevent the picture
from being messed up.  (This is called "opening" a piece of paper, and
should be invisible to the user.)

A blinker is an array, described as follows:

@table @code
@item tv-blinker-x-pos
X position of the left edge of the blinker. @code{nil} if the blinker
should follow the @code{tv-blinker-pc-ppr}'s current X and Y.
@item tv-blinker-y-pos
Y position of the top edge of the blinker.
@item tv-blinker-pc-ppr
Pc ppr the blinker is associated with.  @code{nil} for a @i{roving blinker},
which can go anywhere.
@item tv-blinker-screen
The screen on which the blinker is displayed.
@item tv-blinker-visibility
@code{nil} invisible, @code{t} visible, @code{blink} blinking.
@item tv-blinker-half-period
Time interval in 60ths of a second between changes of the blinker.
@item tv-blinker-phase
@code{nil} means not visible, anything else means visible in some form.
A complementing blinker has only two phases,
@code{nil} and @code{t}, but provision is made for blinkers which go
through an elaborate sequence of states.
@item tv-blinker-time-until-blink
Time interval in 60ths of a second until the next change.  The scheduler
decrements this 60 times a second if the @code{tv-blinker-visibility} is @code{blink}.
If it reaches zero, the blinker is blinked.
If this field is @code{nil}, the blinker is not to be looked at by the scheduler.
@item tv-blinker-function
The function to call to blink the blinker.  The next two fields are for its use.
The arguments to the function are the blinker, an operation code, the
@code{tv-blinker-x-pos}, and the @code{tv-blinker-y-pos}.  The operation codes
are @code{nil} to make the blinker invisible, @code{t} to make it visible, and
@code{blink} to blink it.
When this function is called, interrupts have been disallowed and the proper
screen has been selected.
For additional conventions, read the function @code{tv-blink}.
@item tv-blinker-width
Width in bits of area to complement if
@code{tv-rectangular-blinker}.
For other blinker types, miscellaneous data.
@item tv-blinker-height
Height in raster lines of area to complement if @code{tv-rectangular-blinker}.
For other blinker types, miscellaneous data.
@item tv-blinker-sideways-p
@code{t} => interchange X and Y before calling microcode.
@end table

@defun tv-set-blinker-cursorpos blinker x y
Set the cursor position of a blinker.  If @i{blinker} is a roving
blinker, @i{x} and @i{y} are absolute coordinates.  Otherwise,
they are relative to the margins of @i{blinker}'s piece of paper.
If this blinker was following the pc ppr's cursor, it won't any more.
@end defun

@defun tv-read-blinker-cursorpos blinker
Read the cursor position of a blinker, returning two values, X and Y.
If the blinker is not roving, these are relative to the margins of its
piece of paper.
@end defun

@defun tv-set-blinker-visibility blinker type
Carefully alters the visibility of a blinker.
@i{type} may be @code{nil} (off), @code{t} (on), or @code{blink}.
@end defun

@defun tv-set-blinker-function blinker function &optional arg1 arg2
Carefully alters the function which implements a blinker.
@i{arg1} and @i{arg2}, if supplied, change @code{tv-blinker-height}
and @code{tv-blinker-width}, which are really just general arguments to the function.
@end defun

@defun tv-set-blinker-size blinker width height
Carefully changes the size of a blinker, consulting the function which
implements it if that function has a @code{tv-set-blinker-size-function} property.
@end defun

@section Graphics

@defun tv-draw-line x1 y1 x2 y2 alu screen
Draws a straight line between the points (@i{x1},@i{y1}) and (@i{x2},@i{y2}),
merging the line into the existing contents of the screen with the specified
alu function.  This is a fast micro-coded function.
@end defun

@defun bitblt alu width height from-array from-x from-y to-array to-x to-y
This function moves a portion of one two-dimensional numeric array into
a portion of another, merging them under the control of a specified alu function.
It has several applications, including shifting portions of the TV screen
around (use the @code{screen-buffer-pixel-array}), saving and restoring
portions of the TV screen, writing half-tone and stipple patterns into the
TV screen, and general array-moving.

@code{bitblt} operates on a rectangular region of @i{to-array} which starts at the coordinates
(@i{to-x},@i{to-y}) and has extent @code{(abs @i{width})} in the @i{X}
direction and @code{(abs @i{height})} in the @i{Y} direction.  An error occurs
if this region does not fit within the bounds of @i{to-array}.  Note that the
coordinates and the @i{height} and @i{width} are in terms of array elements,
not bits, although the actual operation is done bitwise.  @i{from-array} needn't
be as big as the specified region; conceptually, @code{bitblt} replicates
@i{from-array} a sufficiently-large number of times in both @i{X} and @i{Y},
then picks out a rectangular region containing the same number of bits
as the destination region, starting at the coordinates (@i{from-x},@i{from-y}).
@code{bitblt} combines these two regions
under control of @i{alu}.  The "A" operand is the @i{from-array}, thus
an alu function of @code{tv-alu-seta} copies the @i{from-array}, ignoring the
previous contents of the selected region of the @i{to-array}.

The specified @i{X} and @i{Y} coordinates are always the upper-left corner
(minimum coordinate values) of the selected region.

@code{bitblt} normally works in a left-to-right and top-to-bottom order, that
is with increasing coordinate values.  When using overlapping @i{from} and
@i{to} arrays, for instance when shifting a portion of the TV screen slightly,
it may be necessary to work in one of the other three possible orders.
This is done using the sign of the @i{width} and @i{height} arguments.
If @i{width} is negative, decreasing @i{X} coordinates are used, and
if @i{height} is negative, decreasing @i{Y} coordinates are used.

For the sake of efficiency, @code{bitblt} requires that the @i{from-array}
and @i{to-array} have word-aligned rows.  This means that the
first dimension of these arrays must be a multiple of 32. divided by the
number of bits per array-element.  All TV screen arrays are forced by
hardware to satisfy this criterion anyway.
@end defun

@section The Who Line

The @i{who line} is a line at the bottom of the screen which
contains information on what the program is currently doing.  The who
line has its own pc ppr and is updated whenever the software goes into
an I/O wait.  In addition, there are two short line segments (called @i{run lights}) at
the bottom of the screen which are controlled by the microcode and by the scheduler.  The
one on the right lights up when the machine is running (not waiting and
not paging), and the one on the left lights up when the disk is running
(paging).

@defun tv-who-line-update &optional state
This function updates all fields of the who-line which have changed.  It is called
from various functions which change the "state of the machine" as perceived by
the user.  The optional argument, @i{state}, is a string to be displayed
in the state field.
If @i{state} is not specified, the value of @code{tv-who-line-run-state} is used, which is
usually @code{"RUN"}.
@end defun

@defvar tv-who-line-list
The value of @code{tv-who-line-list} is a list of who-line fields.  Each field
is a list; the first four elements of the list constitute a structure
containing the following components:

@table @code
@item tv-who-line-item-function
A function to call, given the field as its argument.  The function is supposed
to update the field of the who-line if it has changed.  The list elements of the field
after the first four are for the use of this function.
@item tv-who-line-item-state
If @code{nil}, the who-line has been clobbered (e.g. by clearing of the screen)
and the field must be updated.  Otherwise, this is used by the function in
an unspecified way to remember its previous state.
@item tv-who-line-item-left
The bit position of the left edge of the portion of the who-line containing this field.
@item tv-who-line-item-right
The bit position (+1) of the right edge of the portion of the who-line containing this field.
@end table

The initial @code{tv-who-line-list} is set up to display the time, the name
of the person logged-on to the machine, the current package, the "state"
of a certain selected process, and name and position of the current input file.
@end defvar

@defun tv-who-line-prepare-field field
This is called by @code{tv-who-line-item-function}s in preparation for redisplay
of a who-line field.  The portion of the screen on which the field displays
is erased and the @code{tv-who-line-pc-ppr}'s cursor is set to the beginning of
the field.
@end defun

@defun tv-who-line-string field
This is a useful function to put into a who-line field.  It displays the
string which is the value of the symbol which is the fifth element of the field,
if it is not @code{eq} to the string previously displayed.
@end defun

@defvar tv-who-line-pc-ppr
The value of @code{tv-who-line-pc-ppr} is a piece of paper which
is used to display the characters in the who-line.
@end defvar

@defvar tv-who-line-stream
The value of @code{tv-who-line-stream} is a stream whose output
displays on the @code{tv-who-line-pc-ppr}.
@end defvar

@defvar tv-who-line-process
The value of @code{tv-who-line-process} is the process whose state is to
be displayed in the who-line.  @code{process-wait} calls @code{tv-who-line-update}
if this is the current process.
@code{tv-who-line-process} is normally the main process of the job
which owns the keyboard.
@end defvar

@defvar tv-who-line-run-state
Normally the string "RUN".  This is what appears in the wholine
when the machine isn't waiting for anything.
@end defvar

@defvar tv-who-line-run-light-loc
Unibus address of the TV memory location used for the run-light.
@end defvar

@defvar tv-who-line-state
This is a special variable which exists inside of @code{tv-who-line-update}.
@end defvar

@section Microcode Routines

@defun tv-select-screen screen
This microcode primitive selects a screen for use by the @code{tv-draw-char}
and @code{tv-erase} functions.  It sets up microcode variables and hardware
registers.  Note that this state is not preserved through process switching,
so this primitive should only be called with @code{inhibit-scheduling-flag}
bound to @code{t}, which is normally desired for other reasons anyway.

@code{tv-select-screen} should also be used before referencing the TV arrays,
such as the @code{screen-buffer-pixel-array}, if a 16-bit TV controller is being used.
@end defun

@defun tv-draw-char font-array char-code x-bit-pos y-bit-pos alu-func
The @i{x-bit-pos} and @i{y-bit-pos} are of the top left corner of the character.
(0,0) is the top left corner of the screen.
@code{tv-draw-char} extracts the raster elements for one character
(or one column of a wide character) and displays them at the indicated
address in the currently-selected plane,
using the indicated ALU function to combine them with the bits
already there.  Note that this function does not know anything about
pieces of paper; no pc ppr handling is in microcode.
@c [More to be said about conventions.]
@end defun

@defun tv-erase width height x-bit-pos y-bit-pos alu-func
This function is in microcode.
@i{width} and @i{height} are in bits, and should be fixnums.
A rectangle of the indicated
size, of all 1s, is created and merged into the rectangle of TV memory
in the currently-selected plane
whose top left corner is at (@i{x-bit-pos},@i{y-bit-pos}),
using the specified @i{alu-func}.  Usually
the ANDCA function is used for erasing, but XOR is used
for the blinking cursor etc.  Note that @i{width} and @i{height}
must be greater than zero.
@end defun

@defun tv-draw-line x0 y0 x1 y1 alu-func screen
This function is in microcode.
A straight line is drawn from the point (@i{x0,y0})
to the point (@i{x1,y1}).  These points had better not
lie outside the screen.  The bits that form the line are
merged into the screen with the specified alu function.
@code{tv-select-screen} is applied to @i{screen} before
the line is drawn.
@end defun

@section Opening a Piece of Paper

Before a piece of paper can be manipulated, any blinkers
which may intercept it must be turned off (i.e. their @code{tv-blinker-phase}
must be @code{nil}).  The operation of assuring this is called @i{opening}
the piece of paper.  Similarly, before a blinker's location, size, shape,
visibility, or other attributes can be changed, it must be opened, that
is made to have no visible effect on the screen.

Once a blinker has been opened, we must make sure that the clock
function, which implements the blinking, does not come in and turn the
blinker back on.  This is done in the simplest possible fashion, by
binding the @code{inhibit-scheduling-flag} non-@code{nil}, which causes
the microcode not to switch to another process.  [In the present system
processes are never interrupted, not even by the clock, and this variable is ignored.]
This also prevents any other process from coming in and messing up the
piece of paper by trying to type on it at the same time.

Once we are done with a blinker or piece of paper, and don't
need to have it opened any more, we want the blinkers to reappear.
It looks best if a blinker reappears right away, rather than at the next
time it would have blinked.  However, for efficiency we don't want to
disappear and reappear the blinker every time a TV operation is performed.
Rather, if a program is doing several TV operations right in a row,
the first one will turn off the blinkers, the succeeding ones will
notice that the blinkers are already off, and then soon after the sequence
is completed the blinker will come back on.  This is implemented by having
the next clock interrupt after we get out of the TV code turn the blinker on.

@defmac tv-prepare-pc-ppr
The form @code{(tv-prepare-pc-ppr (@i{pc-ppr}) @i{form1 form2 ...})}
opens the piece of paper which is the value of the variable @i{pc-ppr}
and evaluates the forms with it open.  This macro contains all the knowledge
of how to open a pc ppr, including disabling interrupts, finding and
opening the blinkers, and selecting the proper screen.
@end defmac

@defun tv-open-blinker blinker
The specified blinker is temporarily turned off; the next clock interrupt
when @code{inhibit-scheduling-flag} is @code{nil} will turn it back on.
@end defun

@defun tv-open-screen
Opens all the visible blinkers, preparatory to arbitrary
munging of the screen, for instance picture drawing.
@end defun

@defun tv-blink blinker type
The function to blink a blinker.
@i{type} is one of the symbols @code{nil} (off), @code{t} (on), or @code{blink}.
@code{tv-blink} checks @i{type}, selects the proper screen, digs up the
blinker position out of the pc ppr if necessary, and calls the blinker's function
to do the actual display.
@end defun

@defun tv-rectangular-blinker blinker type x y
A @code{tv-blinker-function} function for rectangular blinkers (the default).
Ignores @i{type}, just complements.
@end defun

@defun tv-hollow-rectangular-blinker blinker type x y
Function for hollow rectangles.
@end defun

@defun tv-character-blinker blinker type x y
Function for blinkers defined by a character.  Arg1 ("height")
is the font, and arg2 ("width") is the character in the font.
The character is XORed in and out as the blinker blinks.
@end defun

@section Creating Pieces of Paper and Blinkers

@defun tv-define-pc-ppr name font-map &rest options
This function creates a returns a piece of paper.  Keyword arguments
allow the user to specify some of the many attributes of the piece of
paper and leave the remainder to default.
@i{name} is just a string which is remembered in the pc-ppr and appears
in its printed representation.  @i{font-map} may be either a list or an array of fonts;
or it may be @code{nil}, which causes the font map to be taken from the screen's default.
The remaining arguments are alternating keywords (which should
be quoted) and values for those keywords.  For example,

@lisp
(setq foo (tv-define-pc-ppr "foo" (list fonts:tvfont)
                            ':top 300
                            ':bottom 400))
@end lisp

Valid option keywords are:

@table @code
@item :screen
The screen on which the piece of paper is to display.
The default is @code{tv-default-screen}.
@item :top
Raster line number of highest line in the pc ppr.
Defaults to @code{screen-y1} of the specified screen, the top.
@item :bottom
Raster line number + 1 of lowest line in the pc ppr.
Defaults to @code{screen-y2} of the specified screen,
just above the who line (if there is one) at the bottom
of the screen.
@item :left
Raster point number of left edge of pc ppr.
Defaults to @code{screen-x1} of the specified screen, the left edge.
@item :right
Raster point number + 1 of right edge of the pc ppr.
Defaults to @code{screen-x2} of the specified screen, the right edge.
@item :blinker-p
@code{t} if this pc ppr should have a blinker on its cursor,
@code{nil} if the cursor should be invisible.
Default is @code{t}.
@item :activate-p
@code{t} if this pc ppr should be initially active.
Active means that its blinkers can blink.
The default is @code{t}.
@item :reverse-video-p
@code{t} if this pc ppr should be in the inverse of the
normal black-on-white mode.  This works by changing @code{pc-ppr-char-aluf}
and @code{pc-ppr-erase-aluf}.
Default is @code{nil}.
@item :more-p
@code{t} if this pc ppr should have more processing.
Default is @code{t}.
@item :vsp
Number of raster lines between character lines.
This is added to the maximum height of the fonts in
the font map to get the height of a line in this
pc ppr.  The default is 2.
@item :left-margin
Amount of unused space at the left edge of the pc ppr.
The default is 0.
@item :top-margin
Amount of unused space at the top.  The default is 0.
@item :right-margin
Amount of unused space at the right.  The default is 0.
@item :bottom-margin
Amount of unused space at the bottom.  The default is 0.
@item :end-line-fcn
A function which is invoked when typeout reaches the
end of a line.  The default is one which wraps around
to the next line.
@item :end-screen-fcn
A function which is invoked when typeout reaches
the bottom of the pc ppr.  The default is one which
wraps around to the top.
@item :output-hold-fcn
A function which is invoked when typeout encounters
the output-hold flag.  The default is one which waits
for some other process to clear the flag.
@item :more-fcn
A function which is invoked when more processing
is necessary.  The default is one which types
**MORE** and waits for the user to hit a character,
then ignores that character and continues typing.
@item :blink-fcn
The function to implement the blinker if @code{:blinker-p}
is not turned off.  The default is @code{tv-rectangular-blinker}.
@item :sideways-p
@code{t} means the monitor is standing on its left side
instead of its bottom; change things around
appropriately.  The default comes from the specified screen.
@item :integral-p
@code{t} means that the piece of paper should be forced
to be an integral number of lines high; it will be
made slightly smaller than the specified size if
necessary.  The default is @code{nil}.
@item :font-map
Set the font-map.  This is intended to replace the passing
in of the font-map as the second argument.
@end table

@end defun

@defun tv-define-blinker pc-ppr &rest options
Define a blinker on a piece of paper.  The options are similar
in syntax to those in @code{tv-define-pc-ppr}.  Valid options are:

@table @code
@item :height
Number of raster lines high.  The default comes
from the first font in the pc ppr's font map.
@item :width
Number of raster points wide.  The default comes
from the first font in the pc ppr's font map.
@item :function
The function to implement the blinker.  The default
is @code{tv-rectangular-blinker}.
@item :arg1
Another name for @code{:width}.  Use this with @code{:function}s
which don't interpret their first "argument" as a width.
@item :arg2
Another name for @code{:height}.  Use this with @code{:function}s
which don't interpret their second "argument" as a height.
@item :visibility
Initial visibility, @code{t}, @code{nil}, or @code{blink}.
Default is @code{blink}.
@item :follow-p
@code{t} if this blinker should follow that pc ppr's cursor.
Default is @code{nil}.
@item :roving-p
@code{t} if this blinker is not confined to a single piece
of paper.  In this case the pc ppr argument is ignored and should be @code{nil}.
Default is @code{nil}.
@item :activate-p
@code{t} if this blinker should be initially active.
The default is @code{nil}.
@item :half-period
Number of 60ths of a second between changes in the blinker.
Default is 15.
@item :screen
The screen on which the blinker should appear.  The default
is to take it from the pc ppr, or from @code{tv-default-screen}
in the case of a roving blinker.
@item :sideways-p
@code{t} to make the blinker be rotated 90 degrees.  Default
is to take it from the pc ppr.
@end table

You may give @code{nil} as a pc-ppr, in which case you must specify
@code{:width} and @code{:height} (or @code{:arg1} and @code{:arg2}) since they will
default to @code{nil}.
You should give @code{nil} as pc-ppr if and only if you specify @code{:roving-p},
probably, since @code{:roving-p} means this blinker is not on a pc ppr.
@end defun

@defun tv-redefine-pc-ppr pc-ppr &rest &eval options
Redefine some of the parameters of a pc ppr.
The allowed options are @code{:top}, @code{:bottom}, @code{:left}, @code{:right},
@code{:top-margin},
@code{:bottom-margin}, @code{:left-margin}, @code{:right-margin}, @code{:vsp}, @code{:integral-p},
@code{:more-p}, @code{:screen},
and @code{:fonts}.  @code{:fonts} allows you to change the font map,
which can change the line height.  The size of the blinker
will not be changed, but perhaps it should be.
@end defun

@defun tv-deactivate-pc-ppr pc-ppr
Cause a piece of paper's blinkers to stop blinking.
It is illegal to type out on a pc ppr which is deactivated.
@end defun

@defun tv-activate-pc-ppr pc-ppr
Cause blinkers to blink again.
@end defun

@defun tv-deactivate-pc-ppr-but-show-blinkers pc-ppr
Cause all blinkers on this piece of paper to be stuck in the blunk (@code{t}) state.
I.e. mark place but don't flash.  Deactivates so that they won't flash.
Typing out on this piece of paper will cause blinkers to start blinking again.
@end defun

@defun tv-return-pc-ppr pc-ppr
@code{return-array} all of a piece of paper.
@end defun

@defun tv-make-stream pc-ppr
Returns a stream which accepts output and displays it on @i{pc-ppr},
and reads input from the keyboard, echoing it on @i{pc-ppr}.
@end defun

@section The Keyboard

Keyboard input can be done either by reading from the @code{standard-input}
stream, which is preferred, or by calling these keyboard routines directly.

The characters read by the functions below are in the Lisp Machine
character set, with extra bits to incicate the Control and Meta
keys.  Also, the characters may come from the @i{forced-input}
mechanism (see (force-kbd-input-fun)), and may be from the mouse.
The byte fields which make up the fixnums returned by these functions
have names beginning with "@code{%%kbd-}", and are explained on (%%kbd).

The special characters Break, Call, and Escape are normally intercepted
by the keyboard routines.  Break causes the process which reads it to
enter a @code{break} loop (see (break-fun)).
Call returns control to the top-level job, or enters a @code{break} loop
if control is already in the top-level job.  Control and Meta modifiers
cause additional effects.  See (call-key) for details.
Escape is a prefix for various commands, as in ITS.  Commands consist of
Escape, an optional numeric argument (in octal), and a letter, and do not echo.
The commands that currently exist are:

@table @r
@item <esc>C
Complement TV black-on-white mode.
@item <esc>@i{n}C
Complement black-on-white mode of plane @i{n}.
@item <esc>@i{n}S
Select video-switch input @i{n}.
@item <esc>M
Complement more-processing enable.
@item <esc>0M
Turn off more-processing.
@item <esc>1M
Turn on more-processing.
@end table

@defun kbd-tyi &optional (whostate @code{"TYI"})
This is the main routine for reading from the keyboard.
The optional argument is what to display as the program state in the
who line (usually just "TYI") while awaiting typein.  The value returned
is a number which consists of a Lisp machine character code,
augmented with bits for the control and meta keys.
The character is not echoed.
@end defun

@defun kbd-tyi-no-hang
Returns @code{nil} if no character has been typed, or the character
code as @code{kbd-tyi} would return it.
@end defun

@defun kbd-char-available
Returns non-@code{nil} if there is a character waiting to be read; otherwise
returns @code{nil}.  It does not read the character out.  This function can
be used with @code{process-wait}.
@end defun

@defvar kbd-super-image-p
If the value of @code{kbd-super-image-p} is non-@code{nil}, checking for
the special characters Break, Call, and Escape is disabled.  Note that
you cannot lambda-bind this variable, because it is looked at in different
stack-groups.
@end defvar

@defvar kbd-simulated-clock-fcn-list
List of functions to be called every 60th of a second (while the
machine is waiting for typein.)  This is used to implement blinkers.
[This variable should be renamed and moved to the scheduler section.]
@end defvar

@defun force-kbd-input job input
This is used to make a job think it has keyboard input that was not
actually typed by the user.  The menu system, for example, uses this.
@i{job} is the job to receive the input.  @i{input} is either a fixnum,
representing a single character, or an array of characters (which may or
may not be a string).  @code{force-kbd-input} waits until previous
forced input has been read, then gives the new forced input to the job.
@end defun

@section Internal Special Variables

@defvar tv-blinker-list
This is a list of all blinkers which are visible (blinking or
solidly on).  It is used by the @code{tv-blinker-clock} routine
and by @code{tv-open-screen}.
@end defvar

@defvar tv-roving-blinker-list
This is a list of peculiar blinkers which don't stay on any single
piece of paper.  Whenever any piece of paper is opened, in addition
to that piece of paper's own blinkers, all of the roving blinkers
will be temporarily turned off.  Only the visible ones are on this list.
This is primarily for the mouse's blinker.
@end defvar

@defvar tv-pc-ppr-list
This is a list of all the pieces of paper.
Currently for no particular reason.
@end defvar

@defvar tv-white-on-black-state
[??]
@end defvar

@defvar tv-beep-duration
Controls beeping.
@end defvar

@defvar tv-beep-wavelength
Controls beeping.
@end defvar

@defvar tv-more-processing-global-enable
This flag controls whether "**MORE**"'s can happen.  Complemented
by <esc>M.  The initial value is @code{t}.
@end defvar

@section Font Utility Routines

[Are these the latest word?  I suspect not.]

@defun tv-get-font-pixel font char row col
Returns a number which is the pixel value of the specified
point in the specified character in the specified font.  This is
0 or 1 for normal fonts, or a gray-level value for multi-plane
fonts.  The value returned is zero if you address outside
of the character raster.
@end defun

@defun tv-store-font-pixel pixel font char row col
This is similar to the above, but stores.  It is an error to store
outside of the character raster.
@end defun

@defun tv-make-sideways-font font
Returns a new font which is the same, except turned on its side
in such a way that it works on pieces of paper created with
the @code{sideways-p} @code{t} option.
@end defun

@defun tv-make-dbl-hor-font font
Returns a new font with alternating bits split into two planes
in such a way that it will work with doubled horizontal resolution
(producing squished characters if the original font had a normal
aspect ratio.)
@end defun

@defun tv-make-gray-font font1 &optional (x-ratio 2) (y-ratio 2) (n-planes 2)
Returns a new font which is the original font with areas
@i{x-ratio} wide and @i{y-ratio} high converted into single points
with an appropriate gray level value.  @i{n-planes} determines
the number of gray levels available.
@end defun

@section The Font Compiler
@cindex font compiler

The Font Compiler is a lisp program which runs on the pdp10.
It converts fonts represented as AST files into QFASL files
which can be loaded into the Lisp machine.  When a font is loaded,
a symbol in the @code{fonts} package is @code{setq}'ed to
the representation of that font.

To run the font compiler, incant

@lisp
:lispm1;qcmp
(fasload (lmio)fcmp)
(crunit dsk lmfont)  ;Or whatever directory you keep fonts on
(fcmp-1 '@i{input} '@i{output} '@i{fontname} @i{screen-type})
@end lisp

@i{input} is the first-name of the AST file containing the font
to be processed.  @i{output} is the first-name of the QFASL file
to be produced.  @i{fontname} is the name of the symbol in the
@code{fonts} package whose value will be the font.  This symbol will
also appear in the @code{font-name} field of the font and in the printed
representation of the font.
@i{screen-type} is @code{t} if the font is to be used with the 32-bit
TV controller, or @code{nil} if the font is to be used with the 16-bit controller.

[Here insert a catalog of fonts when things settle down a little more.]

@c DSK:LMMAN;ERRORS 45
@c This file is part of the Lisp Machine Manual.  -*-Text-*-
@c Error system.

@chapter Errors and Debugging
@cindex error system
@cindex handling errors

The first section of this chapter explains how programs
can handle errors, by means of condition handlers.  It also explains how
a program can signal an error if it detects something it doesn't like.

The second explains how users can handle errors, by means of an interactive debugger;
that is, it explains how to recover if you do something wrong.
For a new user of the Lisp Machine, the second section is probably
much more useful; you may want to skip the first.

The remaining sections describe some other debugging facilities.
Anyone who is going to be writing programs for the Lisp machine should
familiarize himself with these.

The @i{trace} facility provides the ability to perform certain
actions at the time a function is called or at the time it returns.  The
actions may be simple typeout, or more sophisticated debugging functions.

The @i{step} facility allows the evaluation of a form to be
intercepted at every step so that the user may examine just what is happening
throughout the execution of the form.

The @i{MAR} facility provides the ability to cause a trap
on any memory reference to a word (or a set of words) in memory.  If
something is getting clobbered by agents unknown, this can help track
down the source of the clobberage.

@section The Error System

@subsection Conditions
@cindex conditions

Programmers often want to control what action is taken by their
programs when errors or other exceptional situations occur.  Usually
different situations are handled in different ways, and in order to express
what kind of handling each situation should have, each situation
must have an associated name.  In Lisp Machine Lisp there is the
concept of a @i{condition}.  Every condition has a name, which is a
symbol.  When an unusual situation occurs, some condition is @i{signalled}, and a
@i{handler} for that condition is invoked.

When a condition is signalled, the system (essentially) searches
up the stack of nested function invocations looking for a handler established
to handle that condition.
The handler is a function which gets called to deal with the condition.
The condition mechanism itself is
just a convenient way for finding an appropriate handler function given
the name of an exceptional situation.  On top of this is built the
error-condition system, which defines what arguments are passed to a handler
function and what is done with the values returned by a handler function.
Almost all current use of the condition mechanism is for errors, but the user
may find other uses for the underlying mechanism.

@cindex signaller
@cindex signalling conditions
The search for an appropriate handler is done by the function @code{signal}:

@defun signal condition-name &rest args
@code{signal} searches through all currently-established condition handlers,
starting with the most recent.  If it finds one that will handle
the condition @i{condition-name}, then it calls that handler with a first argument
of @i{condition-name}, and with @i{args} as the rest of the arguments.
If the first value returned by the handler is @code{nil}, @code{signal}
will continue searching for another handler; otherwise,
it will return the first two values returned by the handler.
If @code{signal} doesn't find any handler that returns a non-@code{nil}
value, it will return @code{nil}.
@end defun

@cindex condition handler
@cindex handling conditions
Condition handlers are established through the @code{condition-bind} special form:

@defspec condition-bind
The @code{condition-bind} special form is used for establishing handlers for conditions.
It looks like:

@lisp
(condition-bind ((@i{cond-1} @i{hand-1})
                 (@i{cond-2} @i{hand-2})
                 ...)
  @i{body})
@end lisp

Each @i{cond-n} is either the name of a condition, or a list of names of conditions,
or @code{nil}.  If it is @code{nil}, a handler is set up for @i{all} conditions
(this does not mean that the handler really has to handle all
conditions, but it will be offered the chance to do so, and can return
@code{nil} for conditions which it is not interested in).
Each @i{hand-n} is a form which is evaluated to produce a handler function.
The handlers are established sequentially such that the @i{cond-1}
handler would be looked at first.

@lisp
@exdent Example:
(condition-bind ((:wrong-type-argument 'my-wta-handler)
                 ((lossage-1 lossage-2) lossage-handler))
    (princ "Hello there.")
    (= t 69))
@end lisp

This first sets up the function @code{my-wta-handler} to handle
the @code{:wrong-type-argument} condition.  Then, it sets up the binding
of the symbol @code{lossage-handler} to handle both the @code{lossage-1}
and @code{lossage-2} conditions.  With these handlers set up, it prints out a message and
then runs headlong into a wrong-type-argument error by calling the
function @code{=} with an argument which is not a number.
The condition handler @code{my-wta-handler} will be given a chance to
handle the error.  @code{condition-bind}
makes use of ordinary variable binding, so that if the
@code{condition-bind} form is thrown through, the handlers will be
disestablished.  This also means that condition handlers are established
only within the current stack-group.
@end defspec

@subsection Error Conditions

The use of the condition mechanism by the error system defines an
additional protocol for what arguments are passed to error-condition
handlers and what values they may return.

There are basically four possible responses to an error: @i{proceeding},
@i{restarting}, @i{throwing}, or entering the @i{debugger}.
The default action, taken if no handler exists or deigns to handle
the error (returns non-@code{nil}), is to enter the debugger.
A handler may give up on the execution that produced the error by
throwing (see @code{*throw}, (*throw-fun)).  @i{Proceeding} means to
repair the error and continue execution.  The exact meaning of this
depends on the particular error, but it generally takes the form of
supplying a replacement for an unacceptable argument to some function,
and retrying the invocation of that function.  @i{Restarting} means
throwing to a special standard catch-tag, @code{error-restart}.  Handlers
cause proceeding and restarting by returning certain special values,
described below.

Each error condition is signalled with some parameters, the meanings of which
depend on the condition.  For example, the condition @code{:unbound-variable},
which means that something tried to find the value of a symbol which was unbound,
is signalled with one parameter, the unbound symbol.  It is always
all right to signal an error condition with extra parameters.

An error condition handler is applied to several arguments.  The first
argument is the name of the condition that was signalled (a symbol).
This allows the same function to handle several different conditions,
which is useful if the handling of those conditions is very similar.
(The first argument is also the name of the condition for non-error conditions.)
The second argument is a @code{format} control string (see the description
of @code{format}, on (format-fun)).  The third argument
is @code{t} if the error is @i{proceedable}; otherwise it is @code{nil}.  The
fourth argument is @code{t} if the error is @i{restartable}; otherwise it
is @code{nil}.
The fifth argument is the name of the function that signalled the
error, or @code{nil} if the signaller can't figure out the correct name to pass.
The rest of the arguments are the parameters with which the condition was signalled.
If the @code{format} control string is used with these parameters,
a readable English message should be produced.  Since more
information than just the parameters might be needed to print a reasonable
message, the program signalling the condition is free to pass any extra
parameters it wants to, after the parameters which the condition is @i{defined}
to take.  This means that every handler must expect to be called
with an arbitrarily high number of arguments, so every handler should
have a @code{&rest} argument (see (&rest)).

An error condition handler may return any of several values.  If it
returns @code{nil}, then it is stating that it does not wish to handle
the condition after all; the process of signalling will continue
looking for a prior handler (established farther down on the stack) as
if the handler which returned @code{nil} had not existed at all.
(This is also true for non-error conditions.)
If the handler does wish to handle the condition, it can try to
proceed from the error if it is proceedable, or restart from it if it
is restartable, or it can throw to a catch tag.
Proceeding and restarting are done by returning two values.
To proceed, return the symbol @code{return} as the first value, and the
value to be returned by the function @code{cerror} as the second.
To restart, return the symbol @code{error-restart} as the first value,
and the value to be thrown to the tag @code{error-restart} as the second.
The condition handler must not return any other sort of values.  However,
it can legitimately throw to any tag instead of returning at all.
If a handler tries to proceed an unproceedable error or
restart an unrestartable one, an error is signalled.

Note that if the handler returns @code{nil}, it is not said to have
handled the error; rather, it has decided not to handle it, but to "continue to signal"
it so that someone else may handle it.  If an error is signalled
and none of the handlers for the condition decide to handle it, the
debugger is entered.

Here is an example of an excessively simple handler for the @code{:wrong-type-argument}
condition.

@lisp
;;; This function handles the :wrong-type-argument condition,
;;; which takes two defined parameters: a symbol indicating
;;; the correct type, and the bad value.
(defun sample-wta-handler (condition control-string proceedable-flag
                           restartable-flag function
                           correct-type bad-value &rest rest)
 (prog ()
   (format error-output "~%There was an error in ~S~%" function)
   (lexpr-funcall (function format)
                  control-string correct-type bad-value rest)
   (cond ((and proceedable-flag
               (yes-or-no-p query-io "Do you want use nil instead?"))
          (return 'return nil))
         (t (return nil))))) ;don't handle
@end lisp

If an error condition reaches the error handler, the control-C command may be
used to continue from it.  If the condition name has a @code{si:eh-proceed} property,
that property is called as a function with two arguments, the stack-group and
the "ete" (an internal error-handler data structure).  Usually it will ignore
these arguments.  If this function returns, its value will be returned from the
@code{ferror} or @code{cerror} that signalled the condition.  If no such property
exists, the error-handler asks the user for a form, evaluates it, and causes
@code{ferror} or @code{cerror} to return that value.  Putting such a property on can
be used to change the prompt for this form, avoid asking the user, or change
things in more far-reaching ways.

@subsection Signalling Errors
@cindex signalling errors

Some error conditions are signalled by the Lisp system when it detects
that something has gone wrong.  Lisp programs can also signal errors,
by using any of the functions @code{ferror}, @code{cerror}, or @code{error}.
@code{ferror} is the most commonly used of these.  @code{cerror} is used
if the signaller of the error wishes to make the error be @i{proceedable}
or @i{restartable}, or both.  @code{error} is provided for Maclisp compatibility.

A @code{ferror} or @code{cerror} that doesn't have any particular
condition to signal should use @code{nil} as the condition name.  The
only kind of handler that will be invoked by the signaller in this case is the kind
that handles @i{all} conditions, such as is set up by

@lisp
(condition-bind ((nil @i{something}) ...) ...)
@end lisp

In practice, the @code{nil} condition is used a great deal.
@cindex nil, used as a condition name

@defun ferror condition-name control-string &rest params
@code{ferror} signals the condition @i{condition-name}.  Any
handler(s) invoked will be passed @i{condition-name} and @i{control-string}
as their first and second arguments, @code{nil} and @code{nil} for the third and fourth
arguments (i.e. the error will be neither proceedable nor restartable), the name
of the function that called @code{ferror} for the fifth argument, and
@i{params} as the rest of their arguments.

Note that @i{condition-name} can be @code{nil}, in which case no handler
will probably be found and the debugger will be entered.

@lisp
@exdent Examples:
(cond ((> sz 60)
       (ferror nil
               "The size, ~S, was greater then the maximum"
               sz))
      (t (foo sz)))

(defun func (a b)
   (cond ((and (> a 3) (not (symbolp b)))
          (ferror ':wrong-type-argument
                  "The name, ~1G~S, must be a symbol"
                  'symbolp
                  b))
         (t (func-internal a b))))
@end lisp
@end defun

@defun cerror proceedable-flag restartable-flag condition-name control-string &rest params
@code{cerror} is just like @code{ferror} (see (ferror-fun)) except that the handler
is passed @i{proceedable-flag} and @i{restartable-flag} as its
third and fourth arguments.  If @code{cerror} is called with a
non-@code{nil} @i{proceedable-flag}, the caller should be prepared
to accept the returned value of @code{cerror} and use it to restart the
error.  Similarly, if he passes @code{cerror} a non-@code{nil} @i{restartable-flag},
he should be sure that there is a @code{*catch} above him for the tag @code{error-restart}.

If @i{proceedable-flag} is @code{t}, the user will be asked for a replacement
object which @code{cerror} will return.  If @i{proceedable-flag} is not
@code{t} and not @code{nil}, @code{cerror} will return without asking for
any particular object.

Note:  Many programs that want to signal restartable errors will want to use
the @code{error-restart} special form; see (error-restart-fun).

@lisp
@exdent Example:
(do ()
    ((symbolp a))
  @r{; Do this stuff until }a@r{ becomes a symbol.}
  (setq a (cerror t nil ':wrong-type-argument
             "The argument ~2G~A was ~1G~S, which is not ~3G~A"
             'symbolp a 'a "a symbol")))
@end lisp

Note: the form in this example is so useful that there is a standard
special form to do it, called @code{check-arg} (see (check-arg-fun)).
@end defun

@defun error message &optional object interrupt
@code{error} is provided for Maclisp compatibility.  In Maclisp,
the functionality of @code{error} is, essentially, that @i{message}
gets printed, preceeded by @i{object} if present, and that
@i{interrupt}, if present, is a user interrupt channel to be invoked.

In order to fit this definition into the Lisp Machine way of handling
errors, @code{error} is defined to be:

@lisp
(cerror (not (null @i{interrupt}))
        nil
        (or (get @i{interrupt} 'si:condition-name)
            @i{interrupt})
        (cond ((missing @i{object}) ;@r{If no @code{object} given}
               "~*~a")
              (t "~s ~a"))
        @i{object}
        @i{message})
@end lisp

Here is what that means in English: first of all, the condition
to be signalled is @code{nil} if @i{interrupt} is @code{nil}.  If there is some
condition whose meaning is close to that of one of the Maclisp user interrupt
channels, the name of that channel has an @code{si:condition-name} property,
and the value of that property is the name of the condition to signal.
Otherwise, @i{interrupt} is the name of the condition to signal; probably
there will be no handler and the debugger will be entered.

If @i{interrupt} is specified, the error will be proceedable.
The error will not be restartable.  The @code{format} control string
and the arguments are chosen so that the right error message gets printed,
and the handler is passed everything there is to pass.
@end defun

@defmac error-restart
@code{error-restart} is useful for denoting a section of a program
that can be restarted if certain errors occur during its execution.
An @code{error-restart} form looks like:

@lisp
(error-restart
  @i{form-1}
  @i{form-2}
  @i{...})
@end lisp

The forms of the body are evaluated sequentially.  If an error occurs
within the evaluation of the body and is restarted (by a condition handler
or the debugger), the evaluation resumes at the beginning of the @code{error-restart}'s
body.

@lisp
@exdent Example:
(error-restart
  (setq a (* b d))
  (cond ((> a maxtemp)
         (cerror nil t 'overheat
                 "The frammistat will overheat by ~D. degrees!"
                 (- a maxtemp))))
  (setq q (cons a a)))
@end lisp

If the @code{cerror} happens, and the handler invoked (or the debugger) restarts
the error, then evaluation will continue with the @code{(setq a (* b d))},
and the condition @code{(> a maxtemp)} will get checked again.

@lisp
@r{@code{error-restart} is implemented as a macro that expands into:}
(prog ()
 loop (*catch 'error-restart
              (return (progn
                         @i{form-1}
                         @i{form-2}
                         @i{...})))
      (go loop))
@end lisp
@end defmac

@defmac check-arg
The @code{check-arg} form is useful for checking arguments
to make sure that they are valid.  A simple example is:

@lisp
(check-arg foo stringp "a string")
@end lisp

@code{foo} is the name of an argument whose value should be a string.
@code{stringp} is a predicate of one argument, which returns @code{t}
if the argument is a string.  @code{"a string"} is an English description
of the correct type for the variable.

The general form of @code{check-arg} is

@lisp
(check-arg @i{var-name}
           @i{predicate}
           @i{description}
           @i{type-symbol})
@end lisp

@i{var-name} is the name of the variable
whose value is of the wrong type.  If the error is proceeded this variable will
be @code{setq}'ed to a replacement value.  @i{predicate} is a test for whether the
variable is of the correct type.  It can be either a symbol whose function definition
takes one argument and returns non-@code{nil} if the type is correct, or it can be a non-atomic
form which is evaluated to check the type, and presumably contains a reference to
the variable @i{var-name}.  @i{description} is a string which expresses @i{predicate}
in English, to be used in error messages.  @i{type-symbol} is a symbol which
is used by condition handlers to determine what type of argument was expected.
It may be omitted if it is to be the same as @i{predicate}, which must be a symbol
in that case.

The use of the @i{type-symbol} is not really well-defined yet, but the intention
is that if it is @code{numberp} (for example), the
condition handlers can tell that a number was needed, and might try to
convert the actual supplied value to a number and proceed.

[We need to establish a conventional way of "registering" the
type-symbols to be used for various expected types.  It might as well
be in the form of a table right here.]

The @i{predicate} is usually a symbol such as @code{fixp}, @code{stringp},
@code{listp}, or @code{closurep}, but when there isn't any convenient predefined
predicate, or when the condition is complex, it can be a form.  In this case
you should supply a @i{type-symbol} which encodes the type.  For example:

@lisp
(check-arg a
           (and (numberp a) ( a 10.) (> a 0.))
           "a number from one to ten"
           one-to-ten)
@end lisp

If this error got to the debugger, the message

@lisp
The argument a was 17, which is not a number from one to ten.
@end lisp

would be printed.

In general, what constitutes a valid argument is specified in three
ways in a @code{check-arg}.  @i{description} is human-understandable,
@i{type-symbol} is program-understandable, and @i{predicate} is
executable.  It is up to the user to ensure that these three
specifications agree.

@code{check-arg} uses @i{predicate} to determine
whether the value of the variable is of the correct type.  If it is not,
@code{check-arg} signals the @code{:wrong-type-argument} condition, with four
parameters.  First, @i{type-symbol} if it was supplied, or else @i{predicate}
if it was atomic, or else @code{nil}.  Second, the bad value.
Third, the name of the argument (@i{var-name}).
Fourth, a string describing the proper type (@i{description}).
If the error is proceeded, the variable is set to the value returned,
and @code{check-arg} starts over, checking the type again.
Note that only the first two of these parameters are defined for
the @code{:wrong-type-argument} condition, and so @code{:wrong-type-argument}
handlers should only depend on the meaning of these two.
@end defmac

@subsection Standard Condition Names

Some condition names are used by the kernel Lisp system, and are
documented below; since they are of global interest, they are on
the keyword package.  Programs outside the kernel system are free
to define their own condition names; it is intended that the
description of a function include a description of any conditions
that it may signal, so that people writing programs that call
that function may handle the condition if they desire.  When you
decide what package your condition names should be in, you should
apply the same criteria you would apply for determining which package
a function name should be in; if a program
defines its own condition names, they should @i{not} be on the
keyword package. For example, the condition names @code{chaos:bad-packet-format}
and @code{arpa:bad-packet-format} should be distinct.  For further
discussion, see (package).

The following table lists all standard conditions and the
parameters they take; more will be added in the future.
These are all error-conditions, so in addition to the condition name
and the parameters, the handler receives the other arguments described above.

@table @code

@item :wrong-type-argument @i{type-name} @i{value}
@i{value} is the offending argument, and @i{type-name} is
a symbol for what type is required.  Often, @i{type-name}
is a predicate which returns non-@code{nil} if applied to an acceptable value.
If the error is proceeded, the value returned by the handler
should be a new value for the argument to be used instead of
the one which was of the wrong type.

@item :inconsistent-arguments @i{list-of-inconsistent-argument-values}
These arguments were inconsistent with each other, but the fault
does not belong to any particular one of them.
This is a catch-all, and it would be good to identify subcases
in which a more specific categorization can be made.
If the error is proceeded, the value returned by the
handler will be returned by the function whose arguments were inconsistent.

@item :wrong-number-of-arguments @i{function} @i{number-of-args-supplied} @i{list-of-args-supplied}
@i{function} was invoked with the wrong number of arguments.
The elements of @i{list-of-args-supplied} have already been evaluated.
If the error is proceeded, the value returned should be
a value to be returned by @i{function}.

@item :invalid-function @i{function-name}
The name had a function definition but it was no good for calling.
You can proceed, supplying a value to return as the value of the
call to the function.

@item :invalid-form @i{form}
The so-called @i{form} was not a meaningful form for @code{eval}.
Probably it was of a bad data type.
If the error is proceeded, the value returned
should be a new form; @code{eval} will use it instead.

@item :undefined-function @i{function-name}
The symbol @i{function-name} was not defined as a function.
If the error is proceeded, then the symbol will be
defined to the function returned, and that function will be
used to continue execution.

@item :unbound-variable @i{variable-name}
The symbol @i{variable-name} had no value.
If the error is proceeded, then the symbol will be set to the value returned
by the handler, and that value will be used to continue execution.

@c It's a crock that the above two clobber the original symbol.  Will be fixed some day.

@end table

Currently, errors detected by microcode do not signal conditions.
Generally this means that errors in interpreted code signal conditions
and some errors in compiled code do not.  This will be corrected some
time in the future.

@subsection Errset

As in Maclisp, there is an @i{errset} facility which allows a very simple
form of error handling.  If an error occurs inside an errset, and no condition
handler handles it, i.e. the debugger would be entered, control is
returned (@i{thrown}) to the errset.  The errset can control whether or
not the debugger's error message is printed.

A problem with @code{errset} is that it is @i{too} powerful;
it will apply to any unhandled error at all.  If you are writing code
that anticipates some specific error, you should find out what condition
that error signals and set up a handler.  If you use @code{errset} and
some unanticipated error crops up, you may not be told--this can cause
very strange bugs.

@defspec errset
The special form @code{(errset @i{form} @i{flag})} catches errors during
the evaluation of @i{form}.  If an error occurs, the usual error message
is printed unless @i{flag} is @code{nil}; then, control is thrown and the errset-form
returns @code{nil}.  @i{flag} is evaluated first and is optional, defaulting to @code{t}.
If no error occurs, the value of the errset-form is a list of one element,
the value of @i{form}.
@end defspec

@defvar errset
If this variable is non-@code{nil}, errset-forms are not allowed to trap errors.
The debugger is entered just as if there was no errset.  This is intended mainly
for debugging errsets.  The initial value of @code{errset} is @code{nil}.
@end defvar

@defspec err
This is for Maclisp compatibility.

@code{(err)} is a dumb way to cause an error.  If executed inside an errset,
that errset returns @code{nil}, and no message is printed.
Otherwise an unseen throw-tag error occurs.

@code{(err @i{form})} evaluates @i{form} and causes the containing errset
to return the result.  If executed when not inside an errset, an unseen throw-tag error occurs.

@code{(err @i{form} @i{flag})}, which exists in Maclisp, is not supported.
@end defspec

@section The Debugger
@cindex debugger

When an error condition is signalled and no handlers decide to
handle the error, an interactive debugger is entered to allow the user to
look around and see what went wrong, and to help him continue the program
or abort it.  This section describes how to use the debugger.

The user interface described herein is not thought too well of,
and we hope to redesign it sometime soon.

@subsection Entering the Debugger

There are two kinds of errors; those generated by the Lisp Machine's
microcode, and those generated by Lisp programs (by using @code{ferror} or
related functions).  When there
is a microcode error, the debugger prints out a message such as the following:

@lisp
>>TRAP 5543 (TRANS-TRAP)
The symbol FOOBAR is unbound.
While in the function *EVAL  SI:LISP-TOP-LEVEL1
@end lisp

The first line of this error message indicates entry to
the debugger and contains some mysterious internal microcode information:
the micro program address, the microcode trap name and parameters, and a microcode backtrace.
Users can ignore this line in most cases.  The second line contains a description
of the error in English.  The third line indicates where the error
happened by printing a very abbreviated "backtrace" of the stack (see
below); in the example, it is saying that the error was signalled inside the
function @code{*eval}, which was called by @code{si:lisp-top-level1}.

Here is an example of an error from Lisp code:

@lisp
>>ERROR: The argument X was 1, which is not a symbol,
While in the function @{ FERROR  @} FOO  *EVAL
@end lisp

Here the first line contains the English description of the
error message, and the second line contains the abbreviated backtrace.
The backtrace indicates that the function which actually entered
the error handler was @code{ferror}, but that function is enclosed in
braces because it is not very important; the useful information here is
that the function @code{foo} is what called @code{ferror} and thus signalled
the error.

There is not any good way to manually get into the debugger;
the interface will someday be fixed so that you can enter it at any
time if you want to use its facilities to examine the state of the Lisp
environment and so on.  In the meantime, just type an unbound symbol
at Lisp top level.

@subsection How to Use the Debugger

Once inside the debugger, the user may give a wide variety
of commands.  This section describes how to give the commands, and then
explains them in approximate order of usefulness.  A summary is provided
at the end of the listing.

When the error hander is waiting for a command, it prompts
with an arrow:

@lisp

@end lisp

At this point, you may either type in a Lisp expression, or
type a command (a Control or Meta character is interpreted as a command,
whereas a normal character is interpreted as the first character of
an expression).  If you type a Lisp expression, it will be interpreted
as a Lisp form, and will be evaluated in the context of the function
which got the error.  (That is, all bindings which were in effect at
the time of the error will be in effect when your form is evaluated.)
The result of the evaluation will be printed, and the debugger
will prompt again with an arrow.  If, during the typing of the form,
you change your mind and want to get back to the debugger's
command level, type a Control-Z; the debugger will respond with
an arrow prompt.  In fact, at any time that typein is expected from
you, you may type a Control-Z to flush what you are doing and get back
to command level.  This @code{read-eval-print} loop maintains the values
of @code{+}, @code{*}, and @code{-} just as the top-level one does.

Various debugger commands ask for Lisp objects, such as an
object to return, or the name of a catch-tag.  Whenever it tries to get
a Lisp object from you, it expects you to type in a @i{form}; it will
evaluate what you type in.  This provides greater generality, since
there are objects to which you might want to refer that cannot be
typed in (such as arrays).  If the form you type is non-trivial (not
just a constant form), the debugger will show you the result of
the evaluation, and ask you if it is what you intended.  It expects a Y
or N answer (see the function @code{y-or-n-p}, (y-or-n-p-fun)), and if you answer negatively
it will ask you for another form.  To quit out of the command, just type
Control-Z.

@subsection Debugger Commands

All debugger commands are single characters, usually with the
Control or Meta bits.  The single most useful command is Control-Z, which
exits from the debugger and throws back to the Lisp top level loop.
ITS users should note that Control-Z is not Call.
Often you are not interested in using the debugger at all and just
want to get back to Lisp top level; so you can do this in one character.
This is similar to Control-G in Maclisp.

Self-documentation is provided by the Help (top-H) or "?" command,
which types out some documentation on the debugger commands.

Often you want to try to continue from the error.  To do this,
use the Control-C command.  The exact way Control-C works depends on
the kind of error that happened.  For some errors, there is no standard
way to continue at all, and Control-C will just tell you this and
return to the debugger's command level.  For the very common "unbound symbol" error,
it will get a Lisp object from you, which it will store back into the
symbol.  Then it will continue as if the symbol had been bound to
that object in the first place.  For unbound-variable or undefined-function
errors, you can also just type Lisp forms to set the variable or define
the function, and then type Control-C; it will proceed without asking
anything.

Several commands are provided to allow you to examine the
Lisp control stack (regular pdl), which keeps a record of all functions which are currently
active.  If you call @code{foo} at Lisp's top level, and it calls @code{bar},
which in turn calls @code{baz}, and @code{baz} gets an error, then a
backtrace (a backwards trace of the stack) would show all of this
information.  The debugger has two backtrace commands.  Control-B
simply prints out the names of the functions on the stack; in the above
example it would print

@lisp
BAZ  BAR  FOO  *SI:EVAL  SI:LISP-TOP-LEVEL1  SI:LISP-TOP-LEVEL
@end lisp

The arrows indicate the direction of calling.  The Meta-B command prints
a more extensive backtrace, indicating the names of the arguments to the functions
and their current values, and also the saved address at which the function was
executing (in case you want to look at the code generated by the compiler);
for the example above it might look like:

@lisp
FOO: (P.C. = 23)
   Arg 0 (X): 13
   Arg 1 (Y): 1

BAR: (P.C. = 120)
   Arg 0 (ADDEND): 13
@end lisp

and so on.  This means that @code{foo} was executing at instruction 23, and was called
with two arguments, whose names (in the Lisp source code) are @code{x} and @code{y}.
The current values of @code{x} and @code{y} are @code{13} and @code{1} respectively.

The debugger knows about a "current stack frame", and there
are several commands which use it.  The initially "current" stack frame
is the one which signalled the error; either the one which got the microcode
error, or the one which called @code{ferror} or @code{error}.

The command Control-L (or Form) clears the screen, retypes the
error message that was initially printed when the debugger was
entered, and then prints out a description of the current frame, in the
format used by Meta-B.  The Control-N command moves "down" to the "next" frame
(that is, it changes the current frame to be the frame which called it), and prints
out the frame in this same format.  Control-P moves "up" to the "previous" frame
(the one which this one called),
and prints out the frame in the same format.  Meta-< moves to the
top of the stack, and Meta-> to the bottom; both print out the new current
frame.  Control-S asks you for a string, and searches the stack for a frame
whose executing function's name contains that string.  That frame becomes current
and is printed out.  These commands are easy to remember since they are analogous
to editor commands.

Meta-L prints out the current frame in "full screen" format, which
shows the arguments and their values, the local variables and their values,
and the machine code with an arrow pointing to the next instruction
to be executed.
Meta-N moves to the next frame and prints
it out in full-screen format, and Meta-P moves to the previous frame and
prints it out in full-screen format.  Meta-S is like Control-S but does a full-screen display.

Control-A prints out the argument list for the function of the
current frame, as would be returned by the function @code{arglist} (see (arglist-fun)).
Control-R is used to return a value from the current frame; the frame
that called that frame continues running as if the function of the current frame
had returned.  This command prompts you for a form, which it will evaluate;
it returns the resulting value, possibly after confirming it with you.
Meta-R is used to return multiple values from the current frame, but
it is not currently implemented.  The Control-T command does a @i{throw}
to a given tag with a given value; you are prompted for the tag and the value.

Commands such as Control-N and meta-N, which are meaningful to repeat,
take a prefix numeric argument and repeat that many types.  The numeric argument
is typed by using Control- or Meta- and the number keys, as in the editor.

Control-Meta-A takes a numeric argument @i{n}, and prints out
the value of the @i{n}th argument of the current frame.  It leaves @code{*}
set to the value of the argument, so that you can use the Lisp @code{read-eval-print}
loop to examine it.  It also leaves @code{+} set to a locative pointing to the
argument on the stack, so that you can change that argument (by calling
@code{rplaca} or @code{rplacd} on the locative).  Control-Meta-L is similar,
but refers to the @i{n}th local variable of the frame.

@subsection Summary of Commands

@table @r
@item Control-A
Print argument list of function in current frame.
@item Control-Meta-A
Examine or change the @i{n}th argument of the current frame.
@item Control-B
Print brief backtrace.
@item Meta-B
Print longer backtrace.
@item Control-C
Attempt to continue.
@item Meta-C
Attempt to restart.
@item Control-G
Quit to command level.
@item Control-L
Redisplay error message and current frame.
@item Meta-L
Full-screen typeout of current frame.
@item Control-N
Move to next frame.  With argument, move down @i{n} frames.
@item Meta-N
Move to next frame with full-screen typeout.  With argument, move down @i{n} frames.
@item Control-P
Move to previous frame.  With argument, move up @i{n} frames.
@item Meta-P
Move to previous frame with full-screen typeout.  With argument, move up @i{n} frames.
@item Control-R
Return a value from the current frame.
@item Meta-R
Return several values from the current frame.  (doesn't work)
@item Control-S
Search for a frame containing a specified function.
@item Meta-S
Same as control-S but does a full display.
@item Control-T
Throw a value to a tag.
@item Control-Z
Throw back to Lisp top level.
@item ? or Help
Print a help message.
@item Meta-<
Go to top of stack.
@item Meta->
Go to bottom of stack.
@item Form
Same as Control-L.
@item Line
Move to next frame.  With argument, move down @i{n} frames.
Same as Control-N.
@item Return
Move to previous frame.  With argument, move up @i{n} frames.
Same as control-P.
@end table

@subsection Miscellany

Sometimes, e.g. when the debugger is running,
microcode trapping is "disabled": any attempt by the
microcode to trap will cause the machine to halt.

@defun trapping-enabled-p
This predicate returns @code{t} if trapping is enabled; otherwise
it returns @code{nil}.
@end defun

@defun enable-trapping &optional (arg @code{1})
If @i{arg} is @code{1}, trapping is enabled.  If it is @code{0},
trapping is disabled.
@end defun

@c DSK:LMMAN;DB.AID 35
@c This file is part of the Lisp Machine Manual.  -*-Text-*-
@c  Debugging: Various Debuggingc Aids

@section Trace

The @i{trace} facility allows the user to trace some functions.
When a function is traced, certain special actions will be taken when it is
called, and when it returns.  The function @code{trace} allows the user to
specify this.

The trace facility is closely compatible with Maclisp.
Although the functions of the trace system which are presented here are
really functions, they are implemented as special forms because that
is the way Maclisp did it.

Alternatively, you can use the trace system by clicking "trace"
in the system menu, or by using the "meta-X trace" command in the editor.
This allows you to select the trace options from a menu instead of having
to remember the following syntax.

@defspec trace
A @code{trace} form looks like:

@lisp
(trace @i{spec-1} @i{spec-2} ...)
@end lisp

A @i{spec} may be either a symbol, which is interpreted as a function
name, or a list of the form @code{(@i{function-name} @i{option-1} @i{option-2} ...)}.
If @i{spec} is a symbol, it is the same as giving the function name with
no options.  Some options take "arguments", which should be given immediately
following the option name.
@end defspec

The following options exist:

@table @code
@item :break @i{pred}
Causes a breakpoint to be entered after printing
the entry trace information but before applying the traced function to its
arguments, if and only if @i{pred} evaluates to non-@code{nil}.
@item :exitbreak @i{pred}
This is just like @code{break} except that the
breakpoint is entered after the function has been executed and the exit trace information
has been printed, but before control returns.
@item :step
Causes the function to be single-stepped whenever it is called.
See the documentation on the step facility below.
@item :entrycond @i{pred}
Causes trace information to be printed on function
entry only if @i{pred} evaluates to non-@code{nil}.
@item :exitcond @i{pred}
Causes trace information to be printed on function
exit only if @i{pred} evaluates to non-@code{nil}.
@item :cond @i{pred}
This specifies both @code{exitcond} and @code{entrycond}
together.
@item :wherein @i{function}
Causes the function to be traced only when called, directly or indirectly,
from the specified function @i{function}.  One can give several trace specs to
@code{trace}, all specifying the same function but with different @code{wherein}
options, so that the function is traced in different ways when called from
different functions.
@item :argpdl @i{pdl}
This specifies a symbol @i{pdl}, whose value is
initially set to @code{nil} by @code{trace}.  When the function is traced, a
list of the current recursion level for the function, the function's
name, and a list of arguments is consed onto the @i{pdl} when the
function is entered, and cdr'ed back off when the function is exited.
The @i{pdl} can be inspected from within a breakpoint, for example, and
used to determine the very recent history of the function. This option
can be used with or without printed trace output.  Each function can be
given its own pdl, or one pdl may serve several functions.
@item :entryprint @i{form}
The @i{form} is evaluated and the value is included in the trace message
for calls to the function.  You can give this option more than once, and
all the values will appear, preceded by @code{\\}.
@item :exitprint @i{form}
The @i{form} is evaluated and the value is included in the trace message
for returns from the function.  You can give this option more than once, and
all the values will appear, preceded by @code{\\}.
@item :print @i{form}
The @i{form} is evaluated and the value is included in the trace messages
for both calls to and returns from the function.  You can give this option more than once, and
all the values will appear, preceded by @code{\\}.
@item :entry @i{list}
This specifies a list of arbitrary forms whose
values are to be printed along with the usual entry-trace.  The list of
resultant values, when printed, is preceded by a @code{\\} to separate it
from the other information.
@item :exit @i{list}
This is similar to @code{entry}, but specifies expressions
whose values are printed with the exit-trace.  Again, the list of
values printed is preceded by @code{\\}.
@item :arg :value :both nil
These specify which of the usual trace
printout should be enabled.  If @code{arg} is specified, then on function
entry the name of the function and the values of its arguments will be
printed.  If @code{value} is specified, then on function exit the returned
value(s) of the function will be printed.  If @code{both} is specified,
both of these will be printed.  If @code{nil} is specified, neither will
be printed.  If none of these four options are specified the default is
to @code{both}.  If any further @i{options} appear after one of these,
they will not be treated as options! Rather, they will be considered to
be arbitrary forms whose values are to be printed on entry and/or exit
to the function, along with the normal trace information. The values
printed will be preceded by a @code{//}, and follow any values specified
by @code{entry} or @code{exit}.  Note that since these options "swallow" all
following options, if one is given it should be the last option
specified.
@end table

If the variable @code{arglist} is used in any of the expressions given for
the @code{cond, break, entry, }or@code{ exit} options, or after the @code{arg,
value, both, }or@code{ nil} option, when those expressions are evaluated
the value of @code{arglist} will be bound to a list of the arguments
given to the traced function.  Thus

@lisp
(trace (foo break (null (car arglist))))
@end lisp

would cause a break in @code{foo} if and only if the first
argument to @code{foo} is @code{nil}.
@code{arglist} should have a colon, but it is omitted because this is
the name of a system function and therefore global.

Similarly, the variable @code{si:fnvalues} will
be a list of the resulting values of the traced function.  For obvious
reasons, this should only be used with the @code{exit} option.

The trace specifications may be "factored."  For example,

@lisp
(trace ((foo bar) wherein baz value))
@r{is equivalent to}
(trace (foo wherein baz value) (bar wherein baz value))
@end lisp

Since a list as a function name is interpreted as a list of
functions, non-atomic function names (see (fdefine-fun))
are specified as follows:

@lisp
(trace (:function (:method foo-class bar) :break t))
@end lisp

All output printed by trace can be ground into an indented,
readable format, by simply setting the variable @code{sprinter} to @code{t}.
Setting @code{sprinter} to @code{nil} changes the output back to use
the ordinary print function, which is faster and uses less
storage but is less readable for large list structures.
This is not yet supported.

@code{trace} returns as its value a list of names of all functions
traced; for any functions traced with the @code{wherein}
option, say @code{(trace (foo wherein bar))}, instead of putting
just @code{foo} in the list it puts in a 3-list @code{(foo wherein bar)}.

If you attempt to specify to @code{trace} a function already
being traced, @code{trace} calls @code{untrace} before setting up the new
trace.

It is possible to call @code{trace} with no arguments.  @code{(trace)}
evaluates to a list of all the functions currently
being traced.

@defspec untrace
@code{untrace} is used to undo the effects of @code{trace} and restore
functions to their normal, untraced state.  The argument
to @code{untrace} for a given function should be what
@code{trace} returned for it; i.e. if @code{trace} returned @code{foo}, use
@code{(untrace foo)}; if @code{trace} returned @code{(foo wherein bar)} use
@code{(untrace (foo wherein bar))}.  @code{untrace} will take multiple
specifications, e.g. @code{(untrace foo quux (bar wherein baz) fuphoo)}.
Calling @code{untrace} with no arguments will untrace all functions currently being traced.
@end defspec

Unlike Maclisp, if there is an error @code{trace} (or @code{untrace}) will
invoke
'c shaft you by invoking
the error system and give an English message, instead of returning
lists with question marks in them.  Also, the @code{remtrace} function
is not provided, since it is unnecessary.

@defvar trace-compile-flag
If the value of @code{trace-compile-flag} is non-@code{nil}, the functions
created by @code{trace} will get compiled, allowing you to trace special
forms such as @code{cond} without interfering with the execution of the
tracing functions.  The default value of this flag is @code{nil}.
@end defvar

@section The Stepper

The Step facility provides the ability to follow every step of
the evaluation of a form, and examine what is going on.  It is
analogous to a single-step proceed facility often found in
machine-language debuggers.  If your program is doing something
strange, and it isn't obvious how it's getting into its strange state,
then the stepper is for you.

@subsection How to Get Into the Stepper.

There are two ways to enter the stepper.  One is by use of the
@code{step} function.

@defun step form
This evaluates @i{form} with single stepping.  It returns
the value of @i{form}.
@end defun

For example, if you have a function named @code{foo}, and typical arguments
to it might be @code{t} and @code{3}, you could say

@lisp
(step '(foo t 3))
@end lisp

and the form @code{(foo t 3)} will be evaluated with single stepping.

The other way to get into the stepper is to use the @code{step} option
of @code{trace} (see (trace-fun)).  If a function is traced with the @code{step} option, then
whenever that function is called it will be single stepped.

Note that any function to be stepped must be interpreted; that is, it
must be a lambda-expression.  Compiled code cannot be stepped by the stepper.

@subsection How to Use the Stepper

When evaluation is proceeding with single stepping, before any
form is evaluated, it is (partially) printed out, preceded by a forward
arrow (@code{}) character  When a macro is expanded, the expansion is
printed out preceded by a double arrow (@code{}) character.  When a form
returns a value, the form and the values are printed out preceded by a
backwards arrow (@code{}) character; if there is more than one value being
returned, an and-sign (@code{}) character is printed between the values.

Since the forms may be very long, the stepper does not print all
of a form; it truncates the printed representation after a certain number
of characters.  Also, to show the recursion pattern of who calls whom in
a graphic fashion, it indents each form proportionally to its level
of recursion.

After the stepper prints any of these things, it waits for a
command from the user.  There are several commands to tell the stepper
how to proceed, or to look at what is happening. The commands are:

@table @r
@item Control-N (Next)
Step to the Next thing.  The stepper continues until the next thing
to print out, and it accepts another command.
@item Space
Go to the next thing at this level.  In other words, continue to
evaluate at this level, but don't step anything at lower levels.  This is a good
way to skip over parts of the evaluation that don't interest you.
@item Control-U (Up)
Continue evaluating until we go up one level.  This is like
the space command, only more so; it skips over anything on the current level
as well as lower levels.
@item Control-X (eXit)
Exit; finish evaluating without any more stepping.
@item Control-T (Type)
Retype the current form in full (without truncation).
@item Control-G (Grind)
Grind (i.e. prettyprint) the current form.
@item Control-E (Editor)
Editor escape (enter the Eine editor).
@item Control-B (Breakpoint)
Breakpoint.  This command puts you into a breakpoint (i.e.
a read-eval-print loop) from which you can examine the values of
variables and other aspects of the current environment.  From
within this loop, the following variables are available:
@table @code
@item step-form
which is the current form.
@item step-values
which is the list of returned values.
@item step-value
which is the first returned value.
@end table

If you change the values of these variables, it will work.
@item Control-L
Clear the screen and redisplay the last 10. pending forms (forms
which are being evaluated).
@item Meta-L
Like Control-L, but doesn't clear the screen.
@item Control-Meta-L
Like Control-L, but redisplays all pending forms.
@item ? or Help
Prints documentation on these commands.
@end table

It is strongly suggested that you write some little function
and try the stepper on it.  If you get a feel for what the stepper does
and how it works, you will be able to tell when it is the right thing to use
to find bugs.

@section The MAR

The MAR facility allows any word or contiguous set of words to
be monitored constantly, and can cause an error if the words are
referenced in a specified manner.  The name MAR is from the similar
device on the ITS PDP-10's; it is an acronym for "Memory Address
Register".  The MAR checking is done by the Lisp Machine's memory
management hardware, and so the speed of general execution when the MAR is
enabled is not significantly slowed down.  However, the speed of accessing
pages of memory containing the locations being checked is slowed down, since every
reference involves a microcode trap.

These are the functions that control the MAR:

@defun set-mar location cycle-type &optional n-words
The @code{set-mar} function clears any previous setting of the
MAR, and sets the MAR on @i{n-words} words, starting at @i{location}.
@i{location} may be any object.  @i{n-words} currently defaults to 1,
but eventually it will default to the size of the object.
@i{cycle-type} says under what conditions to trap.  @code{:read} means that
only reading the location should cause an error, @code{:write} means that
only writing the location should, @code{t} means that both should.
To set the MAR on the value of a variable, use

@lisp
(set-mar (value-cell-location @i{symbol}) :write)
@end lisp
@end defun

@defun clear-mar
This turns off the MAR.  Restarting the machine disables the
MAR but does not turn it off, i.e. references to the MARed pages
are still slowed down.  @code{clear-mar} does not currently speed
things back up until the next time the pages are swapped out;
this may be fixed some day.
@end defun

@defvar si:%mar-low
@defvarx si:%mar-high
These two fixnums are the inclusive boundaries of the area
of memory monitored by the MAR.  The values of these variables live
inside the microcode.
@end defvar

@defun mar-mode
@code{(mar-mode)} returns a symbol indicating the current state of
the MAR.  It returns one of:

@table @code
@item nil
The MAR is not set.
@item :read
The MAR will cause an error if there is a read.
@item :write
The MAR will cause an error if there is a write.
@item t
The MAR will cause an error if there is any reference.
@end table

@end defun

Note that using the MAR makes the pages on which it is set
considerably slower to access, until the next time they are
swapped out and back in again after the MAR is shut off.
Also, use of the MAR currently breaks the read-only feature
if those pages were read-only.  Currently it is not possible
to proceed from a MAR trrap, because some machine state is lost.
Eventually, most MAR traps will be continuable.

@c DSK:LMMAN;PROGS -- missing

@c DSK:LMMAN;FD.HAC 50
@c This file is part of the Lisp Machine Manual.		-*-Text-*-

@c This file documents those functions in lmio; hacks
@c and various other useful functions from places like qmisc
@c which are in the global package and seem generally useful.
@c It is not clear how to organize this, so we will do that later;
@c this file is here so that the function descriptions can live
@c somewhere until we sort them out.

@section Useful Commands

@defun who-calls x &optional package
@defunx who-uses x &optional package
@i{x} must be a symbol.  @code{who-calls} tries
to find all of the compiled functions in the Lisp world
which call @i{x} as a function, use @i{x} as a variable,
or use @i{x} as a constant.  (It won't find things
that use constants which contain @i{x}, such as a list one
of whose elements is @i{x}; it will only find it if @i{x}
itself is used as a constant.)  It tries to find all of the compiled
code objects by searching all of the function cells of
all of the symbols on @i{package} and @i{package}'s decendants.
@i{package} defaults to the @code{global} package, and so normally
all packages are checked.

If @code{who-calls} encounters an interpreted function definition, it
simply tells you if @i{x} appears anywhere in the interpreted code.

@code{who-uses} is currently the same thing as @code{who-calls}.

The symbol @code{unbound-function} is treated specially by @code{who-calls}.
@code{(who-calls 'unbound-function)} will search the compiled
code objects for any calls through a symbol which is not currently
defined as a function.  This is useful for finding errors.
@end defun

@defun apropos string &optional package
@code{(apropos @i{string})} tries to find all symbols whose
print-names contain @i{string} as a substring.  Whenever it
finds a symbol, it prints out the symbol's name; if the symbol
is defined as a function and/or bound, it tells you so, and prints
the function (if any).  It finds the symbols on @i{package} and
@i{package}'s decendants.  @i{package} defaults to the @code{global}
package, so normally all packages are searched.
@end defun

@defun where-is pname &optional package
Prints the names of all packages which contain a symbol with the print-name
@i{pname}.  @i{pname} gets upper-cased.  The package @i{package} and
all its sub-packages are searched; @i{package} defaults to the @code{global} package,
which causes all packages to be searched.
@end defun

@defun describe x
@code{describe} tries to tell you all of the interesting information
about any object @i{x} (except for array contents).  @code{describe} knows
about arrays, symbols, flonums, packages, stack groups, closures, and FEFs, and prints
out the attributes of each in human-readable form.  Sometimes
it will describe something which it finds inside something else;
such recursive descriptions are indented appropriately.  For instance,
@code{describe} of a symbol will tell you about the symbol's value,
its definition, and each of its properties.  @code{describe} of a flonum
(regular or small) will show you its internal representation in a way
which is useful for tracking down roundoff errors and the like.

If @i{x} is a named-structure, @code{describe} handles it specially.
To understand this, you should read the section on named structures
(see (named-structure)).
First it gets the named-structure symbol, and sees whether its function knows
about the @code{:describe} operation.  If the operation is known, it applies
the function to two arguments: the symbol @code{:describe}, and the named-structure
itself.  Otherwise, it looks on the named-structure symbol for information
which might have been left by @code{defstruct}; this information would
tell it what the symbolic names for the entries in the structure are,
and @code{describe} knows how to use the names to print out what each field's
name and contents is.
@end defun

@defun describe-file filename
This prints what the system knows about the file @i{filename}.
It tells you what package it is in and what version of it is loaded.
@end defun

@defun describe-package package-name
@code{(describe-package @i{package-name})} is equivalent to
@code{(describe (pkg-find-package @i{package-name}))};
that is, it describes the package whose name is @i{package-name}.
@end defun

@defun describe-area area
@i{area} may be the name or the number of an area.  Various
attributes of the area are printed.
@end defun

@defun room &optional arg
@i{room} tells you how much room is left in some areas.  For each
area it tells you about, it prints out the name of the area, the number
of words used in the area, the size of the area, and the percentage
of words which are used in the area.

If @i{arg} is not given, the value of @code{room} should be a list
of area numbers and/or area names; @code{room} describes those areas.
If @i{arg} is a fixnum, @code{room} describes that area.  If @i{arg} is
@code{t}, @code{room} describes all areas.
@end defun

@defvar room
The value of @code{room} is a list of area names and/or area numbers,
denoting the areas which the function @code{room} will describe if given
no arguments.  Its initial value is:

@lisp
(working-storage-area macro-compiled-program)
@end lisp
@end defvar

@defun set-memory-size n-words
@code{set-memory-size} tells the virtual memory system to only use
@i{n-words} words of main memory for paging.  Of course, @i{n-words} may
not exceed the amount of main memory on the machine.
@end defun

@defun recompile-world &rest keywords
@code{recompile-world} is a rather ad-hoc tool for recompiling all
of the Lisp Machine system packages.  It works by calling the @code{pkg-load}
facility (see (pkg-load-fun)).
It will find all files that need recompiling from any of the packages:

@lisp
system-internals format compiler
chaos supdup peek eine
@end lisp

@i{keywords} is a list of keywords; usually it is empty.
The useful keywords are:

@table @code
@item load
After compiling, load in any files which are not loaded.
@item noconfirm
Don't ask for confirmation for each package.
@item selective
Ask for confirmation for each file.
@end table

Any of the other keywords accepted by @code{pkg-load} will also work.
@c These keywords are missing their colons because they are in KWDPKG.
@end defun

@defun qld &optional restart-p
@code{qld} is used to generate a new Lisp Machine system after
the cold-load is loaded in.  If you don't know how to use this,
you don't need it.  If @code{restart-p} is non-@code{nil}, then
it ignores that it has done anything, and starts from scratch.
@end defun

@defun disassemble function
@i{function} should be a FEF, or a symbol which is defined as a FEF.
This prints out a human-readable version of the macro-instructions
in @i{function}.  The macro-code instruction set is explained on (macro-code).
@end defun

@defun print-disk-label
Tells you what is on the disk.
@end defun

@defun set-current-band band
Sets which "band" (saved virtual memory image) is to be loaded
when the machine is started.  Use with caution!
@end defun

@defun set-current-microload band
Sets which microload (MCR1 or MCR2) is to be loaded when the machine
is started.  Use with caution!
@end defun

@section Querying the User

@defun y-or-n-p &optional stream message
This is used for asking the user a question whose answer is either
"Yes" or "No".  It types out @i{message} (if any) and reads in one
character from the keyboard.  If the character is Y, T, or space, it
returns @code{t}.  If the character is N or rubout, it returns @code{nil}.
Otherwise it prints out @i{message} (if any), followed by "(Y or N)",
to @i{stream} and tries again.  @i{stream} defaults to
@code{standard-output}.

@code{y-or-n-p} should only be used for questions which the user knows
are coming.  If the user is not going to be anticipating the question
(e.g., if the question is "Do you really want to delete all of your files?"
out of the blue)
then @code{y-or-n-p} should not be used, because the user might type ahead
a T, Y, N, space, or rubout, and therefore accidentally answer the question.
In such cases, use @code{yes-or-no-p}.
@end defun

@defun yes-or-no-p &optional stream message
This is used for asking the user a question whose answer is either
"Yes" or "No".  It types out @i{message} (if any) and reads in a line
from the keyboard.  If the line is the string "Yes", it returns @code{t}.
If the line is "No", it returns @code{nil}.  (Case is ignored, as are
leading and trailing spaces and tabs.) Otherwise it prints out
@i{message} (if any), followed by `Please type either "Yes" or "No"' to
@i{stream} and tries again.  @i{stream} defaults to
@code{standard-output}.

To allow the user to answer a yes-or-no question with a single
character, use @code{y-or-n-p}.  @code{yes-or-no-p} should be
used for unanticipated or momentous questions.
@end defun

@defun setup-keyboard-dispatch-table array lists
Several programs on the Lisp Machine accept characters from
the keyboard and take a different action on each key. This function
helps the programmer initialize a dispatch table for the keyboard.

@i{array} should be a two-dimensional array with dimensions @code{(4 220)}.
The first subscript to the array represents the Control and Meta keys;
the Control key is the low order bit and the Meta key is the high order bit.
The second subscript is the character typed, with the Control and Meta bits
stripped off.  In other words, the first subscript is the @code{%%kbd-control-meta}
part of the character and the second is the @code{%%kbd-char} part.

@i{lists} should be a list of four lists.  Each of these lists
describes a row of the table.  The elements of one of these lists are
called @i{items},  and may be any of a number of things.  If the item
is not a list, it is simply stored into the next location of the row.
If the item is a list, then its first element is inspected.  If the
first element is the symbol @code{:repeat}, then the second element should
be a fixnum @i{n}, and the third element is stored into the next @i{n}
locations of the row.  If the first element is @code{:repeat-eval}, it is
treated as is @code{:repeat} except that the third element of the item is
a form which is evaluated before being put into the array.  The form
may take advantage of the symbol @code{si:rpcnt}, which is set to @code{0}
the first time the form is evaluated, and is increased by one every
subsequent time.  If the first element of an item is @code{:eval}, then the second
element is evaluated, and the result is stored into the next location of
the row.  Otherwise, the item itself is stored in the next location of the row.
Altogether exactly all 220 locations of the row must be filled in, or else
an error will be signalled.
@end defun

@section Stuff That Doesn't Fit Anywhere Else

@defun time
@code{(time)} returns a number which increases by 1 every 1/60
of a second, and wraps around at some point (currently after 18 bits' worth).
Use the @code{time-lessp} and @code{time-difference} functions to avoid
getting in trouble due to the wrap-around.
The most important thing about @code{time} is
that it is completely incompatible with Maclisp; this will get
changed.
@end defun

@defun time-lessp time1 time2
@code{t} if @i{time1} is earlier than @i{time2}, compensating for wrap-around,
otherwise @code{nil}.
@end defun

@defun time-difference time1 time2
Assuming @i{time1} is later than @i{time2}, returns the number of 60ths
of a second difference between them, compensating for wrap-around.
@end defun

@defun defun-compatibility x
This function is used by @code{defun} and the compiler to convert
Maclisp-style @code{defun}s to Lisp Machine definitions.  @i{x} should be
the cdr of a @code{(defun ...)} form.  @code{defun-compatibility} will return
a corresponding @code{(defun ...)} or @code{(macro ...)} form, in the usual Lisp
Machine format.
@end defun

@defun set-error-mode &optional (car-sym-mode @code{1}) (cdr-sym-mode @code{1}) (car-num-mode @code{0}) (cdr-num-mode @code{0})
@code{set-error-mode} sets the four "error mode" variables.  See the documentation
of @code{car} and @code{cdr} ((car-fun)) which explains what these mean.
@end defun

@defun print-error-mode &optional mode stream
This prints an English description of the error-mode number @i{mode}
onto the output stream @i{stream}.  @i{mode} defaults to the mode currently
in effect, and @i{stream} defaults to @code{standard-output}.
@end defun

@defun *rset flag
Sets the variable @code{*rset} to @i{flag}.  Nothing looks at this variable;
it is a vestigial crock left over from Maclisp.
@end defun

@defun disk-restore &optional partition
@i{partition} may be the name or the number of a disk partition
containing a virtual-memory load, or @code{nil} or omitted, meaning
to use the default load, which is the one the machine loads automatically
when it is booted.  The specified partition is copied into the paging
area of the disk and then started.  Lisp-machine disks currently contain
seven partitions on which copies of virtual-memory may be saved for
later execution in this way.

@code{disk-restore} asks the user for confirmation before doing it.
@end defun

@defun disk-save partition
@i{partition} may be the name or the number of a disk partition
containing a virtual-memory load, or @code{nil}, meaning
to use the default load, which is the one the machine loads automatically
when it is booted.  The current contents of virtual memory are copied
from main memory and the paging area of the disk into the specified
partition, and then restarted as if it had just been reloaded.

@code{disk-save} asks the user for confirmation before doing it.
@end defun

@section Status and SStatus

The @code{status} and @code{sstatus} special forms exist for compatibility
with Maclisp.  Programs that wish to run in both Maclisp and Lisp Machine Lisp
can use @code{status} to determine which of these they are running in.  Also,
@code{(sstatus feature ...)} can be used as it is in Maclisp.

@defspec status
@code{(status features)} returns a list of symbols indicating features
of the Lisp environment.  The complete list of all symbols which may
appear on this list, and their meanings, is given in the Maclisp
manual.  The default list for the Lisp Machine is:

@lisp
(sort fasload string newio roman trace grindef grind lispm)
@end lisp

The value of this list will be kept up to date as features are added
or removed from the Lisp Machine system.  Most important is the symbol
@code{lispm}, which is the last element of the list; this indicates
that the program is executing on the Lisp Machine.

@code{(status feature @i{symbol})} returns @code{t} if @i{symbol}
is on the @code{(status features)} list, otherwise @code{nil}.

@code{(status nofeature @i{symbol})} returns @code{t} if @i{symbol}
is not on the @code{(status features)} list, otherwise @code{nil}.

@code{(status status)} returns a list of all @code{status} operations.

@code{(status sstatus)} returns a list of all @code{sstatus} operations.
@end defspec

@defspec sstatus
@code{(sstatus feature @i{symbol})} adds @i{symbol} to the list
of features.

@code{(sstatus nofeature @i{symbol})} removes @i{symbol} from
the list of features.
@end defspec

@c DSK:LMMAN;TOPLEV 15
@c This file is part of the Lisp Machine manual.	-*-Text-*-

@section The Lisp Top Level

These functions constitute the Lisp top level,
and its associated functions.

[This whole section needs to be rewritten.]

@defun si:lisp-top-level
This is the first function called in the initial Lisp environment.
It calls @code{lisp-reinitialize}, clears the screen, and calls @code{si:lisp-top-level1}.
@end defun

@defun lisp-reinitialize
This function does a wide variety of things, such as resetting the values
of various global constants and initializing the error system.
@end defun

@defun si:lisp-top-level1
This is the actual top level loop.  It prints out "@code{105 FOOBAR}" and
then goes into a loop reading a form from @code{standard-input},
evaluating it, and printing the result (with slashification) to
@code{standard-output}.  If several values are returned by the form
all of them will be printed.  Also the values of @code{*}, @code{+}, @code{-}, @code{//},
@code{++}, @code{**}, @code{+++}, and @code{***}
are maintained (see below).
@end defun

@defspec break
@code{break} is used to enter a breakpoint loop, which is similar
to a Lisp top level loop.  @code{(break @i{tag})} will always
enter the loop; @code{(break @i{tag} @i{conditional-form})}
will evaluate @i{conditional-form} and only enter the break loop
if it returns non-@code{nil}.  If the break loop is entered, @code{break}
prints out

@lisp
;bkpt @i{tag}
@end lisp

and then enters a loop reading, evaluating, and printing forms.
A difference between a break loop and the top level loop
is that after reading a form, @code{break} checks for the
following special cases: if the symbol @code{g} is typed,
@code{break} throws back to the Lisp top level.  If @code{p}
is typed, @code{break} returns @code{nil}.  If @code{(return @i{form})}
is typed, @code{break} evaluates @i{form} and returns the result.
@end defspec

@defvar -
While a form is being evaluated by a read-eval-print loop,
@code{-} is bound to the form itself.
@end defvar

@defvar +
While a form is being evaluated by a read-eval-print loop,
@code{+} is bound to the previous form that was read by the loop.
@end defvar

@defvar *
While a form is being evaluated by a read-eval-print loop,
@code{*} is bound to the result printed the last time through
the loop.  If there were several values printed (because
of a multiple-value return), @code{*} is bound to the first
value.
@end defvar

@defvar //
While a form is being evaluated by a read-eval-print loop,
@code{//} is bound to a list of the results printed the last
time through the loop.
@end defvar

@defvar ++
@code{++} holds the previous value of @code{+}, that is, the form evaluated
two interactions ago.
@end defvar

@defvar +++
@code{+++} holds the previous value of @code{++}.
@end defvar

@defvar **
@code{**} holds the previous value of @code{*}, that is, the result of the
form evaluated two interactions ago.
@end defvar

@defvar ***
@code{***} holds the previous value of @code{**}.
@end defvar

@defvar lisp-initialization-list
The value of @code{lisp-initialization-list} is a list of forms, which
are sequentially evaluated by @code{lisp-reinitialize}.
@end defvar

@defvar lisp-crash-list
The value of @code{lisp-crash-list} is a list of forms.
@code{lisp-reinitialize} sequentially evaluates these
forms, and then sets @code{lisp-crash-list} to @code{nil}.
@end defvar

@section Logging In

Logging in tells the Lisp Machine who you are, so that
other users can see who is logged in, you can receive messages,
and your INIT file can be run.  An INIT file is a Lisp program
which gets loaded when you log in; it can be used to set up
a personalized environment.  The init file is named @i{user}; .LISPM (INIT)
if you have a directory.

When you log out, it should be possible to undo any
personalizations you have made so that they do not affect the next user
of the machine.  Therefore, anything done by an INIT file should be
undoable.  In order to do this, for every form in the INIT file, a Lisp
form to undo its effects should be added to the list which is the value
of @code{logout-list}.  The functions @code{login-setq} and @code{login-eval}
help make this easy; see below.

@defvar user-id
The value of @code{user-id} is either the name of the logged in user, as a string,
or else an empty string if there is no user logged in.
It appears in the who-line.
@end defvar

@defvar logout-list
The value of @code{logout-list} is a list of forms which are evaluated
when a user logs out.
@end defvar

@defun login name
If anyone is logged into the machine, @code{login} logs him out.
(See @code{logout}.)
Then @code{user-id} is set from @i{name}.
Finally @code{login} attempts to find your INIT file.
It first looks in "@i{user-id}; .LISPM (INIT)",
then in "(INIT); @i{user-id} .LISPM",
and finally in the default init file "(INIT); * .LISPM".
When it finds one of these that exists, it loads it in.
@code{login} returns @code{t}.
@end defun

@defun logout
First, @code{logout} evaluates the forms on @code{logout-list}.
Then it tries to find a file to run, looking
first in "@i{user-id}; .LSPM_ (INIT)",
then in "(INIT); @i{user-id} .LSPM_",
and finally in the default file "(INIT); * .LSPM_".
If and when it finds one it these that exists, it loads it in.
Then it sets @code{user-id} to an empty string and @code{logout-list}
to @code{nil}, and returns @code{t}.
@end defun

@defspec login-setq
@code{login-setq} is like @code{setq} except that it puts
a @code{setq} form on @code{logout-list} to set the variables
to their previous values.
@end defspec

@defun login-eval x
@code{login-eval} is used for functions which are "meant to be called"
from INIT files, such as @code{eine:ed-redefine-keys}, which conveniently
return a form to undo what they did.  @code{login-eval} adds
the result of the form @i{x} to the @code{logout-list}.
@end defun

@unnumbered Concept Index
@printindex cp

@unnumbered Variable Index
@printindex vr

@unnumbered Function index
@printindex fn

@bye
